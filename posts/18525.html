<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>AI-07-MCP | YouNeed</title><meta name="keywords" content="AI"><meta name="author" content="Waylon Yan"><meta name="copyright" content="Waylon Yan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MCP">
<meta property="og:type" content="article">
<meta property="og:title" content="AI-07-MCP">
<meta property="og:url" content="http://example.com/posts/18525.html">
<meta property="og:site_name" content="YouNeed">
<meta property="og:description" content="MCP">
<meta property="og:locale">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png">
<meta property="article:published_time" content="2025-06-08T06:19:30.000Z">
<meta property="article:modified_time" content="2025-08-04T19:33:33.199Z">
<meta property="article:author" content="Waylon Yan">
<meta property="article:tag" content="AI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/posts/18525"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'AI-07-MCP',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-05 03:33:33'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">271</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">42</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">26</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Catagroires</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">YouNeed</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Catagroires</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">AI-07-MCP</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-06-08T06:19:30.000Z" title="Created 2025-06-08 14:19:30">2025-06-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-08-04T19:33:33.199Z" title="Updated 2025-08-05 03:33:33">2025-08-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/AI/">AI</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="AI-07-MCP"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>MCP</p>
<span id="more"></span>



<h2 id="Agent，Function-Calling，MCP之间的关系"><a href="#Agent，Function-Calling，MCP之间的关系" class="headerlink" title="Agent，Function Calling，MCP之间的关系"></a>Agent，Function Calling，MCP之间的关系</h2><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h3><blockquote>
<p>能不能让AI自己动手做事情呢？第一个做出尝试的是AutoGPT开源项目，是一个本地运行的小程序。</p>
</blockquote>
<ol>
<li><p>想让AI帮你做事情，先写小工具，注册带AutoGPT中，AutoGPT将其转化为system prompt，如果模型足够聪明，模型进行回答的时候，就会返回想要调用的工具以及函数<img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250610020838730.png" alt="image-20250610020838730"></p>
</li>
<li><p>负责和工具以及模型，在中间“传话”的程序叫Agent，提供给Agent调用的函数或者服务，叫Agent Tools</p>
</li>
</ol>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>这个架构存在一些小问题，模型始终是种概率模型，始终会有返回不对的情况，Cline采用重试解决。</p>
<h3 id="Function-Calling"><a href="#Function-Calling" class="headerlink" title="Function Calling"></a>Function Calling</h3><blockquote>
<p>大模型厂商出手，Claude，Gemini，OpenAI推出了Function Calling功能，核心思想是统一格式，规范描述</p>
<p>添加了工具tool的字段，所有的工具描述放在相同的地方；包括工具名称，描述，参数，统一用json描述；system prompt格式定义就被取代了，不能随意描述。人们就根据这种模式更加有效的训练模型，让它理解这种调用场景</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250610021523716.png" alt="image-20250610021523716"></p>
<h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h4><p>每家模型厂商定义的api不一样，很多开源模型不支持Function Calling，真的要写出一个跨模型通用的AI Agent，实现很麻烦</p>
<h3 id="AI-Agent与模型的通信"><a href="#AI-Agent与模型的通信" class="headerlink" title="AI Agent与模型的通信"></a>AI Agent与模型的通信</h3><p>上面提到的System Prompt和FunctionCalling都是<strong>AI Agent和模型之间</strong>的通讯方式</p>
<h3 id="AI-Agent-如何与Tools进行通信"><a href="#AI-Agent-如何与Tools进行通信" class="headerlink" title="AI Agent 如何与Tools进行通信"></a>AI Agent 如何与Tools进行通信</h3><blockquote>
<p>最简单的做法是吧Agent 和Tool写在同一个应用程序里面，直接通过函数调用搞定，也是大多数Agent的做法</p>
<img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250610022312112.png" alt="image-20250610022312112" style="zoom:20%;" />

<p>后来发现，有些tool功能挺通用的，必须浏览网页的工具，查询天气的工具，每个agent如果都需要，那不能拷贝代码到每个agent程序里面吧，太麻烦了，也不优雅。所以想到一个办法，把tool变成服务统一托管，让所有的agent都可以调用，这就是MCP</p>
</blockquote>
<h3 id="MCP"><a href="#MCP" class="headerlink" title="MCP"></a>MCP</h3><p>MCP是通信协议，专门用来规范Agent和Tool之间服务怎么交互的。</p>
<p>提供服务的叫mcp server，调用服务的叫mcp client；mcp规范提出了server需要提供哪些接口，包括tool列表，需要哪些参数等等。</p>
<img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250610022654261.png" alt="image-20250610022654261" style="zoom:20%;" />

<p>MCP Server可以和Agent跑在同一台服务器上，通过标准输入输出Stdio交互通信；也可以通过SSE（http）进行通信。</p>
<p>MCP本身和AI模型没有关系，并不关心Agent用的是哪个模型，只负责帮Agent管理工具、资源、提示词。</p>
<h5 id="交互过程"><a href="#交互过程" class="headerlink" title="交互过程"></a>交互过程</h5><ol>
<li><strong>当向Agent进行提问时，Agent会把问题包装在User Prompt里面；作为MCP Client，Agent通过MCP协议从MCP Server中获取所有Tool信息；AI Agent会把这些Tool信息可能转化为System Prompt，也可能转化为Function Calling的格式，然后和用户请求的User Prompt，一起发给模型API；</strong></li>
<li>模型通过普通回复或者Function Calling的格式，产生一个调用tool的请求，返回给Agent，Agent通过MCP 协议，去调用MCP Server里的工具web_browse，web_browse访问目标网页后，返回结果给到AI Agent，Agent转发给模型，模型总结返回给Agent，Agent将结果展示给用户。</li>
</ol>
<img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250610023109645.png" alt="image-20250610023109645" style="zoom:30%;" />

<h1 id="MCP基础"><a href="#MCP基础" class="headerlink" title="MCP基础"></a>MCP基础</h1><blockquote>
<p>MCP主要规范了两个部分的内容，可以总结为函数的<strong>注册与使用</strong>，也可以称为<strong>函数的发现与调用协议</strong>:（脱离大模型也是可以直接用的，只不过没有人这么用而已）</p>
<ol>
<li>每个MCP Server有哪些函数(tools)可以用</li>
<li>如何调用这些函数，函数的调用方法</li>
</ol>
<p>MCP 协议本身并没有规定 如何与模型进行交互，协议是给模型服务的</p>
</blockquote>
<h3 id="模型是否具有Function-Calling能力"><a href="#模型是否具有Function-Calling能力" class="headerlink" title="模型是否具有Function Calling能力"></a>模型是否具有Function Calling能力</h3><ul>
<li>如果模型能够挑选函数（模型能够解析请求参数中的工具列表字段）</li>
<li>解析函数执行结果（能够挑选出工具并给出参数）</li>
<li>并且根据结果给出最终答案（能解析工具的执行结果）</li>
</ul>
<p>-&gt; 模型就具有Function Calling的能力</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250608165725650.png" alt="image-20250608165725650"></p>
<blockquote>
<ol>
<li>使用cline工具注册mcp server 的时候，cline与mcp server的交互就完成了，cline就具有了mcp server提供的 tools列表以及出入参规范</li>
<li>通过cline提问的时候，cline通知mcp server，我要调用某个函数方法，入参是什么。 mcp server 完成调用返回结果</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250608181646198.png" alt="image-20250608181646198"></p>
</blockquote>
<blockquote>
<p>不同的MCP Host与模型交互是有差异的，比如Cline是通过XML与模型沟通的，这是Cline规定的，Cline负责解析XML，帮助模型调用它想要调用的工具。已连接的mcp server ，server下面的工具，会被Cline写在system prompt里面。</p>
<p>CherryStudio是通过FunctionCalling与模型沟通的。</p>
<p>MCP协议并没有规定MCP Host与模型是如何交互的。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250608183133075.png" alt="image-20250608183133075"></p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250608183604129.png" alt="image-20250608183604129"></p>
<h3 id="Cline的XML协议与ReAct（Thought-Action-Observation）之间的关系"><a href="#Cline的XML协议与ReAct（Thought-Action-Observation）之间的关系" class="headerlink" title="Cline的XML协议与ReAct（Thought Action Observation）之间的关系"></a>Cline的XML协议与ReAct（Thought Action Observation）之间的关系</h3><blockquote>
<p>ReAct是2022年一篇论文提出来的；它是reasoning和acting两个单词的合体；论文中提到的ReAct理念可以再不需要人干预的情况下让模型自主思考，自主调用外部工具，从而完成用户的请求。就像Cline一样，说白了就是Agent，Cline也是根据ReAct思想来构建它的Agent流程的。</p>
<p>Agent：持续思考，持续调用外部工具的能力，从而解决用户问题。</p>
<p>Cline只是借助了这个思想，通过XML协议完成与模型的沟通，XML比直接写Thought Action Observation更精确。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250608184414840.png" alt="image-20250608184414840"></p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/image-20250608184807448.png" alt="image-20250608184807448"></p>
</blockquote>
<p>MCP，即<strong>模型上下文协议（Model Context Protocol）</strong>，让模型感知外部信息（天气，文件，网络）的一个协议。是 Anthropic Claude 的一个开源开放协议，旨在建立 AI 模型和开发环境之间的统一上下文交互，通过提供标准化的上下文信息访问，使 AI 模型能够更好地理解和处理代码。就像给它们之间搭建了一座桥梁，使得开发者可以通过一套标准将 AI 应用和数据源连接起来 。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747899253691.png" alt="null"></p>
<p>简单来说，MCP 就像给 AI 装上了一个”万能接口”，让 AI 能够与各种外部系统和数据源实现标准化的双向通信。正如 USB-C 提供了连接各种设备的标准化方式，MCP 也为连接 AI 模型和不同数据源提供了统一的方法。例如，在实际应用中借助 MCP 协议，AI 可以帮用户管理 GitHub 项目，从创建项目到提交代码请求等复杂任务都能轻松完成，而且速度很快。这一协议的出现，有望彻底解决 LLM（大型语言模型）应用连接数据难的痛点，让前沿模型生成更好、更相关的响应，不再需要为每个数据源写定制的集成代码，一个 MCP 协议就可以搞定与多种数据源的连接 。</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p><strong>代码管理与开发</strong></p>
<p>在代码开发方面，Claude 通过 MCP 协议可以直接连接 GitHub。开发人员可以利用 Claude 自动化编程，例如让 AI 自己写代码、创建仓库、Push 代码、创建 Issue、创建分支、创建 PR 等操作，全程无需离开聊天界面，开发人员仅需提出需求即可 。这大大提高了开发效率，将开发人员从繁琐的代码操作中部分解放出来，更多地扮演需求提出者的角色。</p>
<p><strong>本地资源管理</strong></p>
<p>MCP 协议支持对本地资源的管理，如电脑里的文件、数据库（像 SQLite 数据库）等。开发人员可以使用 MCP 协议让桌面版 Claude 安全连接本地服务，进行文件的创建、读取、编辑等操作，还能对数据库中的数据进行交互操作，例如查询、更新等 。</p>
<p><strong>远程资源交互</strong></p>
<p>对于远程资源，如 <code>GoogleDrive</code>、<code>Slack</code> 等平台的数据，Claude 借助 MCP 协议可以直接进行控制和访问。这使得企业和开发者在构建 AI 应用时，能够轻松整合不同来源的数据，如从商业工具、软件、内容库、应用程序开发环境等各种来源提取资料，协助模型产生与指令更相关的回复 。</p>
<p><strong>构建智能助手应用</strong></p>
<p>随着大模型从纯聊天机器人走向以智能助手为代表的 Agent 应用，MCP 协议可以让 AI 系统更加智能和强大。开发人员通过 MCP 协议将 AI 系统与多个数据源相连接后，AI 工具不再只是简单的问答系统，而是变成了一个能够执行复杂任务、管理代码、处理文件和与外部系统通信的强大工具。例如，在构建一个企业内部的智能助手时，可以利用 MCP 协议连接企业内部的各种数据资源（如数据库、文件服务器等）以及外部相关的业务工具（如项目管理工具等），为企业员工提供更全面、更高效的服务。</p>
<h2 id="为什么需要-MCP"><a href="#为什么需要-MCP" class="headerlink" title="为什么需要 MCP"></a>为什么需要 MCP</h2><p>前面我们提到 MCP 就像给 AI 装上了一个”万能接口”，让 AI 能够与各种外部系统和数据源实现标准化的双向通信。在 AI 应用中，数据源的连接和交互是一个重要的问题。传统的做法是，每个数据源都需要单独的集成代码，这不仅增加了开发成本，还可能导致数据泄露和安全问题。所以急需要一个标准化的协议，使得 AI 应用可以与各种数据源进行交互。无论是本地资源，还是远程资源，都可以通过改协议进行连接和交互。这不仅提高了开发效率，还保证了数据的安全性。</p>
<p>比如我们想让 AI 获取天气信息，如果没有 MCP 协议的话，我们需要怎么实现呢？如下代码所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main.py</span></span><br><span class="line"><span class="keyword">import</span> openai</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建议从环境变量加载 API 密钥，更安全</span></span><br><span class="line"><span class="comment"># os.environ[&quot;OPENAI_API_KEY&quot;] = &quot;YOUR_API_KEY&quot;</span></span><br><span class="line"><span class="comment"># 如果你没有设置环境变量，可以直接取消下面一行的注释并填入你的 API Key</span></span><br><span class="line"><span class="comment"># openai.api_key = &quot;sk-YOUR_API_KEY_HERE&quot; # 请替换成你的真实 API Key</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 1. 定义智能体可以调用的工具 ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_current_weather</span>(<span class="params">location, unit=<span class="string">&quot;celsius&quot;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取指定地点的当前天气信息</span></span><br><span class="line"><span class="string">    实际的天气信息需要通过 API 获取，这里只是模拟返回一些数据</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;tokyo&quot;</span> <span class="keyword">in</span> location.lower():</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;location&quot;</span>: <span class="string">&quot;Tokyo&quot;</span>, <span class="string">&quot;temperature&quot;</span>: <span class="string">&quot;10&quot;</span>, <span class="string">&quot;unit&quot;</span>: unit, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Sunny&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;san francisco&quot;</span> <span class="keyword">in</span> location.lower():</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;location&quot;</span>: <span class="string">&quot;San Francisco&quot;</span>, <span class="string">&quot;temperature&quot;</span>: <span class="string">&quot;72&quot;</span>, <span class="string">&quot;unit&quot;</span>: unit, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Cloudy&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;paris&quot;</span> <span class="keyword">in</span> location.lower():</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;location&quot;</span>: <span class="string">&quot;Paris&quot;</span>, <span class="string">&quot;temperature&quot;</span>: <span class="string">&quot;22&quot;</span>, <span class="string">&quot;unit&quot;</span>: unit, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Rainy&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;location&quot;</span>: location, <span class="string">&quot;temperature&quot;</span>: <span class="string">&quot;unknown&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Weather information not available&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DemoAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model=<span class="string">&quot;deepseek-chat&quot;</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.model = model</span><br><span class="line">        <span class="variable language_">self</span>.messages = [] <span class="comment"># 用于存储对话历史</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_conversation</span>(<span class="params">self, user_input</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行与智能体的对话&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.messages.append(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_input&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 2. 定义智能体可用的函数描述 ---</span></span><br><span class="line">        tools = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">                <span class="string">&quot;function&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;get_current_weather&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;获取一个指定地点的当前天气情况&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;城市名称，例如：San Francisco&quot;</span>,</span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="string">&quot;unit&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>, <span class="string">&quot;enum&quot;</span>: [<span class="string">&quot;celsius&quot;</span>, <span class="string">&quot;fahrenheit&quot;</span>]&#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;location&quot;</span>],</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 3. 调用 OpenAI API ---</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = openai.chat.completions.create(</span><br><span class="line">                model=<span class="variable language_">self</span>.model,</span><br><span class="line">                messages=<span class="variable language_">self</span>.messages,</span><br><span class="line">                tools=tools,</span><br><span class="line">                tool_choice=<span class="string">&quot;auto&quot;</span>,  <span class="comment"># 让模型自动选择是否调用函数</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> openai.AuthenticationError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;OpenAI API 认证失败，请检查你的 API Key 是否正确或已设置。&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误详情: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;API 认证失败，无法处理请求。&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;调用 OpenAI API 时发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;与 OpenAI 服务通信时发生错误。&quot;</span></span><br><span class="line"></span><br><span class="line">        response_message = response.choices[<span class="number">0</span>].message</span><br><span class="line">        tool_calls = response_message.tool_calls</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 4. 处理模型的响应，检查是否需要调用工具 ---</span></span><br><span class="line">        <span class="keyword">if</span> tool_calls:</span><br><span class="line">            <span class="variable language_">self</span>.messages.append(response_message)  <span class="comment"># 将助手的回复（包含函数调用请求）添加到历史记录</span></span><br><span class="line"></span><br><span class="line">            available_functions = &#123;</span><br><span class="line">                <span class="string">&quot;get_current_weather&quot;</span>: get_current_weather,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> tool_call <span class="keyword">in</span> tool_calls:</span><br><span class="line">                function_name = tool_call.function.name</span><br><span class="line">                function_to_call = available_functions[function_name]</span><br><span class="line">                function_args = json.loads(tool_call.function.arguments)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\n🤖 模型请求调用函数: <span class="subst">&#123;function_name&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;   参数: <span class="subst">&#123;function_args&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">                function_response = function_to_call(</span><br><span class="line">                    location=function_args.get(<span class="string">&quot;location&quot;</span>),</span><br><span class="line">                    unit=function_args.get(<span class="string">&quot;unit&quot;</span>),</span><br><span class="line">                )</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;🔧 函数返回: <span class="subst">&#123;function_response&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">self</span>.messages.append(</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;tool_call_id&quot;</span>: tool_call.<span class="built_in">id</span>,</span><br><span class="line">                        <span class="string">&quot;role&quot;</span>: <span class="string">&quot;tool&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>: function_name,</span><br><span class="line">                        <span class="string">&quot;content&quot;</span>: function_response,</span><br><span class="line">                    &#125;</span><br><span class="line">                ) <span class="comment"># 将函数执行结果添加进历史记录</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- 5. 将函数执行结果发送给模型，获取最终回复 ---</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                second_response = openai.chat.completions.create(</span><br><span class="line">                    model=<span class="variable language_">self</span>.model,</span><br><span class="line">                    messages=<span class="variable language_">self</span>.messages,</span><br><span class="line">                )</span><br><span class="line">                final_response = second_response.choices[<span class="number">0</span>].message.content</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;调用 OpenAI API (第二次) 时发生错误: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;处理函数调用结果时发生错误。&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 如果模型没有调用工具，直接返回其内容</span></span><br><span class="line">            final_response = response_message.content</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.messages.append(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;content&quot;</span>: final_response&#125;)</span><br><span class="line">        <span class="keyword">return</span> final_response</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 主程序运行 ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 确保你已经设置了 OPENAI_API_KEY 环境变量</span></span><br><span class="line">    <span class="comment"># 或者在代码中直接提供了 openai.api_key</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> openai.api_key <span class="keyword">and</span> <span class="keyword">not</span> os.getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;错误：请设置 OPENAI_API_KEY 环境变量或在代码中直接提供 API Key。&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;例如：export OPENAI_API_KEY=&#x27;your-api-key-here&#x27;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;或者在代码中: openai.api_key = &#x27;your-api-key-here&#x27;&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">    agent = DemoAgent()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你好！我是 AI 天气助手。你可以问我某个城市的天气。输入 &#x27;退出&#x27; 来结束对话。&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        user_input = <span class="built_in">input</span>(<span class="string">&quot;你: &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> user_input.lower() == <span class="string">&#x27;退出&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;再见！&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        ai_response = agent.run_conversation(user_input)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;AI助手: <span class="subst">&#123;ai_response&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<p>上面代码的实现很简单，也是我们非常熟悉的方式，其核心就是通过 OpenAI 的 function tools 功能（也可以通过提示词的方式，但是效果差点），将天气查询功能封装成一个函数，然后通过 LLM 去决定什么时候调用这个函数。我们可以直接运行上面的代码来进行测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ python main.py</span><br><span class="line">你好！我是 AI 天气助手。你可以问我某个城市的天气。输入 <span class="string">&#x27;退出&#x27;</span> 来结束对话。</span><br><span class="line">你: 查询下paris的天气</span><br><span class="line"></span><br><span class="line">🤖 模型请求调用函数: get_current_weather</span><br><span class="line">   参数: &#123;<span class="string">&#x27;location&#x27;</span>: <span class="string">&#x27;Paris&#x27;</span>, <span class="string">&#x27;unit&#x27;</span>: <span class="string">&#x27;celsius&#x27;</span>&#125;</span><br><span class="line">🔧 函数返回: &#123;<span class="string">&quot;location&quot;</span>: <span class="string">&quot;Paris&quot;</span>, <span class="string">&quot;temperature&quot;</span>: <span class="string">&quot;22&quot;</span>, <span class="string">&quot;unit&quot;</span>: <span class="string">&quot;celsius&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Rainy&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">AI助手: 目前巴黎的天气为 **雨天**，气温 **22°C**。</span><br><span class="line"></span><br><span class="line">建议外出时携带雨具，注意保暖！如需更详细的天气预报（如湿度、风速等），可以告诉我哦~ 🌧️☔</span><br><span class="line">--------------------</span><br><span class="line">你:</span><br></pre></td></tr></table></figure>

<p>如果我们还需要集成其他功能，比如获取新闻、获取股票信息、获取汇率等，同样我们需要在代码中添加对应的函数，然后通过 Tools 功能去调用这些函数。这样就会造成一个问题是每个开发者要开发一个智能体，都需要重复去实现这些功能函数，这无疑增加了开发成本，也不利于 AI 应用的传播复用。</p>
<p>但是如果我们使用 MCP 协议，就可以将这些功能封装成一个一个的 MCP 服务器，然后我们在客户端可以直接去调用这些功能，而这些 MCP 服务器是完全可以复用的，所有人都可以直接使用这些 MCP 服务器，完全不用重新开发，这就大大降低了开发成本，理论上就无限扩大了 AI 应用的功能了，这就是 MCP 协议的强大之处，也是为什么我们要学习 MCP 协议的原因。</p>
<h2 id="MCP-架构"><a href="#MCP-架构" class="headerlink" title="MCP 架构"></a>MCP 架构</h2><p>接下来我们来了解下 MCP 的架构，以及它是如何工作的。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747965506965.png" alt="null"></p>
<p>MCP 协议遵循客户端-主机-服务器架构，其中每个主机可以运行多个客户端实例。该架构使用户能够跨应用程序集成 AI 能力，同时保持清晰的安全边界并隔离问题。MCP 基于 <code>JSON-RPC</code> 构建，提供了一个有状态会话协议，专注于客户端和服务器之间的上下文交换和采样协调。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    subgraph &quot;应用程序主机进程&quot;</span><br><span class="line">        H[主机]</span><br><span class="line">        C1[客户端 1]</span><br><span class="line">        C2[客户端 2]</span><br><span class="line">        C3[客户端 3]</span><br><span class="line">        H --&gt; C1</span><br><span class="line">        H --&gt; C2</span><br><span class="line">        H --&gt; C3</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    subgraph &quot;本地机器&quot;</span><br><span class="line">        S1[服务器 1&lt;br&gt;文件 &amp; Git]</span><br><span class="line">        S2[服务器 2&lt;br&gt;数据库]</span><br><span class="line">        R1[(&quot;本地&lt;br&gt;资源 A&quot;)]</span><br><span class="line">        R2[(&quot;本地&lt;br&gt;资源 B&quot;)]</span><br><span class="line"></span><br><span class="line">        C1 --&gt; S1</span><br><span class="line">        C2 --&gt; S2</span><br><span class="line">        S1 &lt;--&gt; R1</span><br><span class="line">        S2 &lt;--&gt; R2</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    subgraph &quot;互联网&quot;</span><br><span class="line">        S3[服务器 3&lt;br&gt;外部 API]</span><br><span class="line">        R3[(&quot;远程&lt;br&gt;资源 C&quot;)]</span><br><span class="line"></span><br><span class="line">        C3 --&gt; S3</span><br><span class="line">        S3 &lt;--&gt; R3</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<p>这里主要涉及到三个角色：<strong>主机</strong>、<strong>服务器</strong>和<strong>客户端</strong>。</p>
<ol>
<li>**MCP 主机(Host)**：通常是发起连接的 LLM 应用程序，如 Claude Desktop 或其他 AI 工具。它负责管理 MCP Client 与 Server 的连线。</li>
<li>**MCP 客户端(Client)**：在主机应用程序内部与服务器保持 1:1 连接，负责协议通信。它负责 AI 和 MCP Server 之间的沟通。</li>
<li>**MCP 服务器(Server)**：轻量级程序，负责暴露特定的数据源或工具功能，并通过标准化协议与客户端交互。它管理本地数据库要输出的内容指令，让 Client 可以自选指令来运作。</li>
</ol>
<p>MCP 的通信基于 <code>JSON-RPC</code> 2.0，支持请求、响应和通知三种消息类型，确保通信的标准化和一致性。整个流程如下：</p>
<ol>
<li>用户通过 AI 应用（主机）发送请求</li>
<li>AI 应用（主机）通过 MCP 客户端向 MCP 服务器发送请求</li>
<li>MCP 服务器处理请求，访问相应的数据源或执行工具功能</li>
<li>服务器将结果返回给客户端</li>
<li>客户端将信息传递给 AI 模型</li>
<li>AI 模型基于这些信息生成响应</li>
</ol>
<h2 id="MCP-协议"><a href="#MCP-协议" class="headerlink" title="MCP 协议"></a>MCP 协议</h2><p>MCP 协议遵循客户端-主机-服务器架构，MCP 协议其实就是规定的组件之间的通信协议，而 MCP 中的所有消息必须遵循 <code>JSON-RPC 2.0</code> 规范。</p>
<h3 id="消息类型"><a href="#消息类型" class="headerlink" title="消息类型"></a>消息类型</h3><p>MCP 协议定义了三种类型的消息：</p>
<ul>
<li><code>request</code>：请求消息，用于客户端向服务器发送请求，也可以从服务器发送到客户端。</li>
<li><code>response</code>：响应消息，用于对请求的响应。</li>
<li><code>notification</code>：通知消息，用于服务器向客户端发送通知。</li>
</ul>
<p><strong>请求消息</strong></p>
<p>双向消息，可以从客户端发送到服务器，也可以反向发送。如下所示就是一个请求消息的示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string | number&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;param?&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在请求消息中，有一些需要注意的点：</p>
<ul>
<li>必须包含字符串或整数类型的 ID</li>
<li>ID 不能为 null</li>
<li>在同一会话中，请求方不能重复使用相同的 ID</li>
<li>可以包含可选的参数对象</li>
</ul>
<p><strong>响应消息</strong></p>
<p>响应消息是对请求的回复，响应消息的结构如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string | number&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result?&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;[key: string]&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;error?&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;number&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data?&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>同样，在响应消息中，也有一些需要注意的点：</p>
<ul>
<li>必须包含与对应请求相同的 ID</li>
<li>必须设置 <code>result</code> 或 <code>error</code> 其中之一，不能同时设置</li>
<li>错误码必须是整数</li>
<li>可以包含可选的结果数据</li>
</ul>
<p><strong>通知消息</strong></p>
<p>通知是一种单向消息，不需要响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params?&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;[key: string]&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在通知消息中，有一些需要注意的点：</p>
<ul>
<li>不能包含 ID 字段</li>
<li>用于状态更新和事件通知</li>
<li>可以包含可选的参数对象</li>
<li>减少通信开销，支持异步操作</li>
</ul>
<h3 id="四大核心功能"><a href="#四大核心功能" class="headerlink" title="四大核心功能"></a>四大核心功能</h3><p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747980177944.png" alt="null"></p>
<p>MCP 提供了四种核心原语（服务器端原语），用于规范客户端和服务器之间的交互，分别是：</p>
<ul>
<li>资源(Resources)</li>
<li>提示(Prompts)</li>
<li>工具(Tools)</li>
<li>采样(Sampling)</li>
</ul>
<p><strong>1. 资源(Resources)</strong></p>
<p>资源表示 MCP 服务器想要向客户端提供的任何类型数据，可包括：</p>
<ul>
<li>文件内容</li>
<li>数据库记录</li>
<li>API 响应</li>
<li>实时系统数据</li>
<li>截图和图片</li>
<li>日志文件</li>
</ul>
<p>每个资源由唯一的 URI 标识，并且可以包含文本或二进制数据。</p>
<p><strong>2. 提示词(Prompts)</strong></p>
<p>MCP 中的提示是预定义的模板，可以：</p>
<ul>
<li>接受动态参数</li>
<li>上下文</li>
<li>链接多个交互</li>
<li>指导特定工作流程</li>
<li>作为 UI 元素（如斜线命令）</li>
</ul>
<p><strong>3. 工具(Tools)</strong></p>
<p>MCP 中的工具允许服务器公开可由客户端调用的可执行函数。工具的关键方面包括：</p>
<ul>
<li>发现(tools/list)：客户端可以列出可用的工具</li>
<li>调用(tools/call)：服务器执行请求的操作并返回结果</li>
<li>灵活性：工具范围从简单的计算到复杂的 API 交互</li>
</ul>
<p><strong>4. 采样(Sampling)</strong></p>
<p>采样是 MCP 的一项强大功能，允许服务器通过客户端请求 LLM 完成，从而实现复杂的代理行为，同时保持安全性和隐私性。这种人机交互设计确保用户可以控制 LLM 所看到和生成的内容。</p>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>MCP 为客户端-服务器连接定义了严格的生命周期，确保连接的可靠性和稳定性。主要分为三个阶段：</p>
<ul>
<li>初始化：能力协商和协议版本约定</li>
<li>操作：正常协议通信</li>
<li>关闭：正常终止连接</li>
</ul>
<p>如下图所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant 客户端</span><br><span class="line">    participant 服务器</span><br><span class="line"></span><br><span class="line">    Note over 客户端,服务器: 初始化阶段</span><br><span class="line">    activate 客户端</span><br><span class="line">    客户端-&gt;&gt;+服务器: 初始化请求</span><br><span class="line">    服务器--&gt;&gt;客户端: 初始化响应</span><br><span class="line">    客户端--)服务器: 初始化完成通知</span><br><span class="line"></span><br><span class="line">    Note over 客户端,服务器: 运行阶段</span><br><span class="line">    rect rgb(200, 220, 250)</span><br><span class="line">        note over 客户端,服务器: 正常协议操作</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    Note over 客户端,服务器: 关闭阶段</span><br><span class="line">    客户端--)-服务器: 断开连接</span><br><span class="line">    deactivate 服务器</span><br><span class="line">    Note over 客户端,服务器: 连接已关闭</span><br></pre></td></tr></table></figure>

<p><strong>初始化阶段</strong></p>
<p>初始化阶段必须是客户端和服务器之间的第一次交互。在此阶段，双方：</p>
<ul>
<li>建立协议版本兼容性</li>
<li>交换和协商能力</li>
<li>共享实现细节</li>
</ul>
<p>初始化请求示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;initialize&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-11-05&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;roots&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sampling&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;clientInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ExampleClient&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>要注意 ⚠️ 在初始化请求中，客户端必须发送其支持的协议版本，上面 json 中的 <code>params.protocolVersion</code> 字段就是来指定协议版本的。</p>
<ul>
<li>客户端应发送其支持的最新版本</li>
<li>服务器必须响应相同版本或其支持的其他版本</li>
<li>如果客户端不支持服务器的版本，应断开连接</li>
</ul>
<p>而 <code>params.capabilities</code> 字段用于能力协商，客户端和服务器能力确定会话期间可用的可选协议功能。在请求中我们指定客户端的能力，在响应中服务器会指定其能力，客户端可以指定如下能力：</p>
<ul>
<li><code>roots</code>：提供文件系统根目录的能力</li>
<li><code>sampling</code>：支持 LLM 采样请求</li>
<li><code>experimental</code>：描述对非标准实验性功能的支持</li>
</ul>
<p>初始化响应示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-11-05&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;prompts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;resources&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;subscribe&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tools&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;serverInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ExampleServer&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在初始化响应中，服务器必须响应相同版本或其支持的其他版本。此外服务器会响应其能力，如下：</p>
<ul>
<li><code>logging</code>：提供日志记录的能力</li>
<li><code>prompts</code>：提供提示词的模板能力</li>
<li><code>resources</code>：提供资源管理的能力</li>
<li><code>tools</code>：提供工具调用的能力</li>
<li><code>experimental</code>：描述对非标准实验性功能的支持</li>
</ul>
<p>初始化完成后，服务器会发送初始化完成通知，如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;initialized&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>操作阶段</strong></p>
<p>初始化完成后，客户端和服务器就可以进行正常的协议通信了，也就是上面的操作阶段，客户端和服务器根据协商的能力交换消息。</p>
<ul>
<li>遵守协商的协议版本</li>
<li>仅使用成功协商的能力</li>
</ul>
<p><strong>关闭阶段</strong></p>
<p>当客户端或服务器决定关闭连接时，会发送断开连接通知，在关闭阶段，连接被优雅地终止。</p>
<ul>
<li>客户端发送断开连接通知</li>
<li>服务器关闭连接</li>
<li>清理相关资源</li>
</ul>
<p>这样 MCP 的一个完整生命周期就结束了。</p>
<h3 id="传输机制"><a href="#传输机制" class="headerlink" title="传输机制"></a>传输机制</h3><p>上面我们介绍了 MCP 协议的消息类型和生命周期，但是这些消息是如何在客户端和服务器之间传输的呢？MCP 协议定义了两种标准的客户端-服务器通信传输机制：</p>
<ul>
<li><code>stdio</code>（标准输入输出）</li>
<li>基于 <code>SSE</code>（Server-Sent Events）的 HTTP</li>
<li>Streamable HTTP（2025-03-26 版本）</li>
</ul>
<p>需要注意，客户端应尽可能支持 <code>stdio</code>，此外，客户端和服务器也可以以可插拔的方式实现自定义传输机制。</p>
<p><strong>标准输入输出（stdio）</strong></p>
<p>在 stdio 传输机制中：</p>
<ul>
<li>客户端将 MCP 服务器作为子进程启动</li>
<li>服务器通过标准输入（<code>stdin</code>）接收 <code>JSON-RPC</code> 消息，并通过标准输出（<code>stdout</code>）写入响应</li>
<li>消息以换行符分隔，且<strong>不能</strong>包含嵌入的换行符</li>
<li>服务器<strong>可以</strong>将 UTF-8 字符串写入标准错误（<code>stderr</code>）用于日志记录。客户端<strong>可以</strong>捕获、转发或忽略这些日志</li>
<li>服务器<strong>不得</strong>向标准输出（<code>stdout</code>）写入任何无效 <code>MCP</code> 消息的内容</li>
<li>客户端<strong>不得</strong>向服务器的标准输入（<code>stdin</code>）写入任何无效 <code>MCP</code> 消息的内容</li>
</ul>
<p>下图展示了 <code>stdio</code> 传输机制的交互过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant 客户端</span><br><span class="line">    participant 服务器进程</span><br><span class="line"></span><br><span class="line">    客户端-&gt;&gt;+服务器进程: 启动子进程</span><br><span class="line">    loop 消息交换</span><br><span class="line">        客户端-&gt;&gt;服务器进程: 写入标准输入</span><br><span class="line">        服务器进程-&gt;&gt;客户端: 写入标准输出</span><br><span class="line">        服务器进程--)客户端: 可选的标准错误日志</span><br><span class="line">    end</span><br><span class="line">    客户端-&gt;&gt;服务器进程: 关闭标准输入，终止子进程</span><br><span class="line">    deactivate 服务器进程</span><br></pre></td></tr></table></figure>

<p><strong>基于 SSE 的 HTTP</strong></p>
<p><code>SSE</code> 全称是 <code>Server-Sent Events</code>，是一种 HTTP 服务器推送技术，允许服务器向客户端发送实时更新。在 MCP 的 SSE 传输机制中，服务器作为独立进程运行，可以处理多个客户端连接。</p>
<p>首先服务器<strong>必须</strong>提供两个端点：</p>
<ul>
<li>SSE 端点 - 用于客户端建立连接并接收来自服务器的消息</li>
<li>HTTP POST 端点 - 用于客户端向服务器发送消息</li>
</ul>
<p>当客户端连接时，服务器<strong>必须</strong>发送一个包含客户端用于发送消息的 URI 的 endpoint 事件。所有后续的客户端消息必须作为 HTTP POST 请求发送到此端点。服务器消息作为 SSE message 事件发送，消息内容以 JSON 格式编码在事件数据中。</p>
<p>下图展示了基于 SSE 的 HTTP 传输机制的交互过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant 客户端</span><br><span class="line">    participant 服务器</span><br><span class="line"></span><br><span class="line">    客户端-&gt;&gt;服务器: 打开 SSE 连接</span><br><span class="line">    服务器-&gt;&gt;客户端: endpoint 事件</span><br><span class="line">    loop 消息交换</span><br><span class="line">        客户端-&gt;&gt;服务器: HTTP POST 消息</span><br><span class="line">        服务器-&gt;&gt;客户端: SSE message 事件</span><br><span class="line">    end</span><br><span class="line">    客户端-&gt;&gt;服务器: 关闭 SSE 连接</span><br></pre></td></tr></table></figure>

<p><strong>Streamable HTTP</strong></p>
<p>Streamable HTTP 是 MCP 协议的最新版本，它提供了更高效的传输机制。Streamable HTTP 使用 HTTP/2 流式传输，可以实现更低的延迟和更高的吞吐量。</p>
<p><strong>自定义传输机制</strong></p>
<p>客户端和服务器<strong>可以</strong>以可插拔的方式实现自定义传输机制。该协议与传输无关，可以在任何支持双向消息交换的通信通道上实现。</p>
<p>选择支持自定义传输的实施者<strong>必须</strong>确保他们保留 MCP 定义的 <code>JSON-RPC</code> 消息格式和生命周期要求。自定义传输<strong>应该</strong>记录其特定的连接建立和消息交换模式，以帮助互操作性。</p>
<h2 id="快速使用"><a href="#快速使用" class="headerlink" title="快速使用"></a>快速使用</h2><p>在了解了 MCP 的一些基础知识后，接下来我们将通过一个简单的示例来演示如何使用 MCP 协议。</p>
<p>这里我们将通过 MCP 协议将 Cursor（已经支持 MCP 协议）连接到本地 SQLite 数据库，并进行查询和安全分析，整个流程如下图所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">    subgraph &quot;你的电脑&quot;</span><br><span class="line">        direction LR</span><br><span class="line">        Cursor[&quot;Cursor&quot;]</span><br><span class="line">        MCP[&quot;SQLite MCP 服务器&quot;]</span><br><span class="line">        DB[(SQLite 数据库~/test.db)]</span><br><span class="line"></span><br><span class="line">        Cursor &lt;--&gt;|&quot;MCP 协议(查询和结果)&quot;| MCP</span><br><span class="line">        MCP &lt;--&gt;|&quot;本地访问(SQL 操作)&quot;| DB</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<p>这里的 SQLite MCP 服务器和本地 SQLite 数据库之间的通信完全在您的计算机上。MCP 协议确保 Cursor 只能通过明确定义的接口执行批准的数据库操作。这为您提供了一种安全的方式让 Cursor 分析你的本地数据并与之交互，同时保持对其可以访问的内容的完全控制。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>在开始之前，请确保你的系统已经安装了以下必备组件:</p>
<ul>
<li>macOS 或 Windows 操作系统</li>
<li>最新版本的 Claude Desktop</li>
<li>uv 0.4.18 或更高版本 (使用 <code>uv --version</code> 检查)</li>
<li>Git (<code>git --version</code> 检查)</li>
<li>SQLite (<code>sqlite3 --version</code> 检查)</li>
</ul>
<p>对于 macOS 用户，可以使用 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://brew.sh/">Homebrew</a> 安装这些组件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using Homebrew</span></span><br><span class="line">brew install uv git sqlite3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接下载：</span></span><br><span class="line"><span class="comment"># uv: https://docs.astral.sh/uv/</span></span><br><span class="line"><span class="comment"># Git: https://git-scm.com</span></span><br><span class="line"><span class="comment"># SQLite: https://www.sqlite.org/download.html</span></span><br></pre></td></tr></table></figure>

<p>而对于 Windows 用户，可以使用 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.microsoft.com/en-us/windows/package-manager/winget/">winget</a> 安装这些组件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 winget 安装</span></span><br><span class="line">winget install --<span class="built_in">id</span>=astral-sh.uv -e</span><br><span class="line">winget install git.git sqlite.sqlite</span><br><span class="line"></span><br><span class="line"><span class="comment"># Or download directly:</span></span><br><span class="line"><span class="comment"># uv: https://docs.astral.sh/uv/</span></span><br><span class="line"><span class="comment"># Git: https://git-scm.com</span></span><br><span class="line"><span class="comment"># SQLite: https://www.sqlite.org/download.html</span></span><br></pre></td></tr></table></figure>

<p>接下来我们会以 MacOS 为例进行说明，Windows 用户可以参考 MacOS 的安装步骤。</p>
<h3 id="创建-SQLite-数据库"><a href="#创建-SQLite-数据库" class="headerlink" title="创建 SQLite 数据库"></a>创建 SQLite 数据库</h3><p>首先我们来创建一个简单的 SQLite 数据库，并插入一些数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个新的 SQLite 数据库</span></span><br><span class="line">sqlite3 ~/test.db &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">CREATE TABLE products (</span></span><br><span class="line"><span class="string">  id INTEGER PRIMARY KEY,</span></span><br><span class="line"><span class="string">  name TEXT,</span></span><br><span class="line"><span class="string">  price REAL</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INSERT INTO products (name, price) VALUES</span></span><br><span class="line"><span class="string">  (&#x27;Widget&#x27;, 19.99),</span></span><br><span class="line"><span class="string">  (&#x27;Gadget&#x27;, 29.99),</span></span><br><span class="line"><span class="string">  (&#x27;Gizmo&#x27;, 39.99),</span></span><br><span class="line"><span class="string">  (&#x27;Smart Watch&#x27;, 199.99),</span></span><br><span class="line"><span class="string">  (&#x27;Wireless Earbuds&#x27;, 89.99),</span></span><br><span class="line"><span class="string">  (&#x27;Portable Charger&#x27;, 24.99),</span></span><br><span class="line"><span class="string">  (&#x27;Bluetooth Speaker&#x27;, 79.99),</span></span><br><span class="line"><span class="string">  (&#x27;Phone Stand&#x27;, 15.99),</span></span><br><span class="line"><span class="string">  (&#x27;Laptop Sleeve&#x27;, 34.99),</span></span><br><span class="line"><span class="string">  (&#x27;Mini Drone&#x27;, 299.99),</span></span><br><span class="line"><span class="string">  (&#x27;LED Desk Lamp&#x27;, 45.99),</span></span><br><span class="line"><span class="string">  (&#x27;Keyboard&#x27;, 129.99),</span></span><br><span class="line"><span class="string">  (&#x27;Mouse Pad&#x27;, 12.99),</span></span><br><span class="line"><span class="string">  (&#x27;USB Hub&#x27;, 49.99),</span></span><br><span class="line"><span class="string">  (&#x27;Webcam&#x27;, 69.99),</span></span><br><span class="line"><span class="string">  (&#x27;Screen Protector&#x27;, 9.99),</span></span><br><span class="line"><span class="string">  (&#x27;Travel Adapter&#x27;, 27.99),</span></span><br><span class="line"><span class="string">  (&#x27;Gaming Headset&#x27;, 159.99),</span></span><br><span class="line"><span class="string">  (&#x27;Fitness Tracker&#x27;, 119.99),</span></span><br><span class="line"><span class="string">  (&#x27;Portable SSD&#x27;, 179.99);</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>然后下载最新的 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cursor.com/cn/downloads">Cursor</a>，直接安装即可。然后打开 Cursor Settings 页面，切换到 MCP 标签页，点击右上角的 <strong>+ Add new global MCP server</strong> 按钮。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747981060263.png" alt="null"></p>
<p>然后会跳转到一个全局的 MCP 配置文件，该文件是一个 JSON 格式的文件，可以在里面定义所有 MCP 服务器，这里我们添加一个名为 <code>mcp-server-sqlite</code> 的 MCP 服务器，如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;sqlite&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uvx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mcp-server-sqlite&quot;</span><span class="punctuation">,</span> <span class="string">&quot;--db-path&quot;</span><span class="punctuation">,</span> <span class="string">&quot;/Users/YOUR_USERNAME/test.db&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>需要将 <code>YOUR_USERNAME</code> 替换为你的实际用户名。上面的配置文件表示我们定义了名为 <code>sqlite</code> 的 MCP 服务器，并指定使用 <code>uvx</code> 命令来启动该服务器，在 <code>args</code> 参数里面指定了 MCP 服务器以及实际的数据库路径为 <code>/Users/YOUR_USERNAME/test.db</code>。</p>
<p>我们也可以在特定的项目根目录下面创建 <code>.cursor/mcp.json</code> 文件，来配置特定项目中使用的 MCP 服务器，这样就可以在不同的项目中使用不同的 MCP 服务器了。</p>
<p>保存上面的配置后，回到 Cursor 中的 MCP 设置页面，正常一会儿就可以看到 <code>sqlite</code> 的 MCP 服务器了。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747981362810.png" alt="null"></p>
<p>其中会将该 MCP 服务器提供的所有 Tools 都列出来，然后我们就可以在 Cursor 中直接使用这些 Tools 了。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>接下来我们就可以在 Cursor 中来测试下这个 MCP 服务器了。比如我们发送如下所示的提示词到 Cursor 中（需要使用 Agent 模式）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">你能连接到我的 SQLite 数据库并告诉我有哪些产品及其价格吗？</span><br></pre></td></tr></table></figure>

<p>然后 Cursor 就会根据我们的提示词去查询我们的 SQLite 数据库，可以看到这里会选择使用 <code>list-tables</code> 的 MCP 工具查询数据库中有哪些表，然后调用 <code>describe_table</code> 工具查看这个表的结构。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747981724500.png" alt="null"></p>
<p>接着会去查询数据库获取产品和对应的价格，甚至最后还提供了额外的统计信息，也是通过 <code>read_query</code> 工具来实现的。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747981836636.png" alt="null"></p>
<h3 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h3><p>可能大家还是会有很多疑问，为什么我们只是在 Cursor 中添加了一个 sqlite 的 MCP 服务器，就可以查询到数据库中的数据了？这幕后到底发生了什么？</p>
<p>MCP 与 Cursor 交互的流程如下所示：</p>
<ol>
<li><p><strong>服务器发现</strong>：Cursor 在启动时连接到您配置的 MCP 服务器</p>
</li>
<li><p><strong>协议握手</strong>：当你询问数据时，Cursor：</p>
</li>
<li><p>确定（通过 LLM）哪个 MCP 服务器可以提供帮助（在本例中为 sqlite）</p>
</li>
<li><p>通过协议协商能力</p>
</li>
<li><p>从 MCP 服务器请求数据或操作</p>
</li>
<li><p><strong>交互流程</strong>：</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">   participant C as Cursor</span><br><span class="line">   participant M as MCP 服务器</span><br><span class="line">   participant D as SQLite 数据库</span><br><span class="line"></span><br><span class="line">   C-&gt;&gt;M: 初始化连接</span><br><span class="line">   M--&gt;&gt;C: 返回可用功能</span><br><span class="line"></span><br><span class="line">   C-&gt;&gt;M: 查询请求</span><br><span class="line">   M-&gt;&gt;D: SQL 查询</span><br><span class="line">   D--&gt;&gt;M: 返回结果</span><br><span class="line">   M--&gt;&gt;C: 格式化结果</span><br></pre></td></tr></table></figure>

<ol>
<li><strong>安全</strong>:</li>
</ol>
<ul>
<li>MCP 服务器仅暴露特定的、受控的功能</li>
<li>MCP 服务器在你的本地计算机上运行，它们访问的资源不会暴露在互联网上</li>
<li>Cursor 需要用户确认敏感操作</li>
</ul>
<p>这里可能大家还有点疑问就是 MCP 服务器，我们并没有编写任何代码啊？其实是因为 Cursor 已经 内置实现了一系列的 MCP 服务器，其中就包括 SQLite 的 MCP 服务器，我们只需要配置好数据库路径即可。我们可以在官方的 git 仓库中查看<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/modelcontextprotocol/servers/tree/main/src">内置的 MCP 服务器列表</a>。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747982021937.png" alt="null"></p>
<p>可以看到其中就包含一个 SQLite 的 MCP 服务器。通过 SQLite 提供数据库交互和智能业务能力，该服务器支持运行 SQL 查询、分析业务数据等，所以我们直接配置即可使用了。如果我们有自己的业务需求，也可以参考这些内置的实现自定义一个 MCP 服务器即可。</p>
<h2 id="开发-MCP-服务器"><a href="#开发-MCP-服务器" class="headerlink" title="开发 MCP 服务器"></a>开发 MCP 服务器</h2><p>在了解了 MCP 的一些基础知识后，接下来我们将通过一个简单的示例来演示如何开发一个 MCP 服务器。</p>
<p>接下来我们将通过 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/modelcontextprotocol/python-sdk">MCP Python SDK</a> 来演示如何编写一个 MCP 服务器。我们将创建一个天气服务器，提供当前天气数据作为资源，并让 Cursor 使用工具获取天气预报。</p>
<p>这里我们需要使用 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://openweathermap.org/api">OpenWeatherMap API</a> 来获取天气数据，直接注册然后在 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://home.openweathermap.org/api_keys">API keys</a> 页面即可获取一个免费的 API 密钥。</p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>这里我们还是使用 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.astral.sh/uv/">uv</a> 来管理 Python 环境。</p>
<p>首先使用下面的命令初始化一个 uv 管理的项目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uv init mcp-server-weather --python 3.13 <span class="comment"># 最好指定下版本</span></span><br><span class="line"><span class="built_in">cd</span> mcp-server-weather</span><br></pre></td></tr></table></figure>

<p>然后安装 MCP Python SDK 依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv add <span class="string">&quot;mcp[cli]&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后我们就可以使用下面的命令来运行 <code>mcp</code> 这个开发工具命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ uv run mcp</span><br><span class="line"></span><br><span class="line"> Usage: mcp [OPTIONS] COMMAND [ARGS]...</span><br><span class="line"></span><br><span class="line"> MCP development tools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">╭─ Options ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮</span><br><span class="line">│ --<span class="built_in">help</span>          Show this message and <span class="built_in">exit</span>.                                                                                                                      │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line">╭─ Commands ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮</span><br><span class="line">│ version   Show the MCP version.                                                                                                                                  │</span><br><span class="line">│ dev       Run a MCP server with the MCP Inspector.                                                                                                               │</span><br><span class="line">│ run       Run a MCP server.                                                                                                                                      │</span><br><span class="line">│ install   Install a MCP server <span class="keyword">in</span> the Claude desktop app.                                                                                                        │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br></pre></td></tr></table></figure>

<h3 id="实现-MCP-服务器"><a href="#实现-MCP-服务器" class="headerlink" title="实现 MCP 服务器"></a>实现 MCP 服务器</h3><p>接下来我们就可以开始实现我们的 MCP 服务器了。</p>
<p>直接在 <code>main.py</code> 文件中实现一个天气 MCP 服务器，如下代码所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">MCP Weather Server</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">一个基于 OpenWeatherMap API 的天气 MCP 服务器</span></span><br><span class="line"><span class="string">提供获取当前天气信息和天气预报的功能</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mcp.server.fastmcp <span class="keyword">import</span> FastMCP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 MCP 服务器</span></span><br><span class="line">mcp = FastMCP(<span class="string">&quot;Weather&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># OpenWeatherMap API 配置</span></span><br><span class="line">OPENWEATHER_API_KEY = os.getenv(<span class="string">&quot;OPENWEATHER_API_KEY&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> OPENWEATHER_API_KEY:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;警告: 未找到 OPENWEATHER_API_KEY 环境变量&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;请在 .env 文件中设置你的 OpenWeatherMap API 密钥&quot;</span>)</span><br><span class="line"></span><br><span class="line">OPENWEATHER_BASE_URL = <span class="string">&quot;https://api.openweathermap.org/data/2.5&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_temperature</span>(<span class="params">temp_kelvin: <span class="built_in">float</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;格式化温度显示（开尔文转摄氏度）&quot;&quot;&quot;</span></span><br><span class="line">    celsius = temp_kelvin - <span class="number">273.15</span></span><br><span class="line">    fahrenheit = celsius * <span class="number">9</span>/<span class="number">5</span> + <span class="number">32</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;celsius:<span class="number">.1</span>f&#125;</span>°C (<span class="subst">&#123;fahrenheit:<span class="number">.1</span>f&#125;</span>°F)&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_weather_info</span>(<span class="params">weather_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;格式化天气信息为易读的字符串&quot;&quot;&quot;</span></span><br><span class="line">    main = weather_data.get(<span class="string">&quot;main&quot;</span>, &#123;&#125;)</span><br><span class="line">    weather = weather_data.get(<span class="string">&quot;weather&quot;</span>, [&#123;&#125;])[<span class="number">0</span>]</span><br><span class="line">    wind = weather_data.get(<span class="string">&quot;wind&quot;</span>, &#123;&#125;)</span><br><span class="line">    clouds = weather_data.get(<span class="string">&quot;clouds&quot;</span>, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">    location = weather_data.get(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;未知位置&quot;</span>)</span><br><span class="line">    country = weather_data.get(<span class="string">&quot;sys&quot;</span>, &#123;&#125;).get(<span class="string">&quot;country&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> country:</span><br><span class="line">        location += <span class="string">f&quot;, <span class="subst">&#123;country&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 基本天气信息</span></span><br><span class="line">    description = weather.get(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;&quot;</span>).title()</span><br><span class="line">    temp = format_temperature(main.get(<span class="string">&quot;temp&quot;</span>, <span class="number">0</span>))</span><br><span class="line">    feels_like = format_temperature(main.get(<span class="string">&quot;feels_like&quot;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 详细信息</span></span><br><span class="line">    humidity = main.get(<span class="string">&quot;humidity&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    pressure = main.get(<span class="string">&quot;pressure&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    wind_speed = wind.get(<span class="string">&quot;speed&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    wind_deg = wind.get(<span class="string">&quot;deg&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    cloudiness = clouds.get(<span class="string">&quot;all&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可见度（以米为单位，转换为公里）</span></span><br><span class="line">    visibility = weather_data.get(<span class="string">&quot;visibility&quot;</span>, <span class="number">0</span>) / <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    result = <span class="string">f&quot;&quot;&quot;🌍 **<span class="subst">&#123;location&#125;</span>**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">🌤️ **当前天气**: <span class="subst">&#123;description&#125;</span></span></span><br><span class="line"><span class="string">🌡️ **温度**: <span class="subst">&#123;temp&#125;</span></span></span><br><span class="line"><span class="string">🤒 **体感温度**: <span class="subst">&#123;feels_like&#125;</span></span></span><br><span class="line"><span class="string">💧 **湿度**: <span class="subst">&#123;humidity&#125;</span>%</span></span><br><span class="line"><span class="string">🌪️ **气压**: <span class="subst">&#123;pressure&#125;</span> hPa</span></span><br><span class="line"><span class="string">💨 **风速**: <span class="subst">&#123;wind_speed&#125;</span> m/s</span></span><br><span class="line"><span class="string">🧭 **风向**: <span class="subst">&#123;wind_deg&#125;</span>°</span></span><br><span class="line"><span class="string">☁️ **云量**: <span class="subst">&#123;cloudiness&#125;</span>%</span></span><br><span class="line"><span class="string">👁️ **能见度**: <span class="subst">&#123;visibility:<span class="number">.1</span>f&#125;</span> km&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加日出日落时间（如果有的话）</span></span><br><span class="line">    sys_info = weather_data.get(<span class="string">&quot;sys&quot;</span>, &#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;sunrise&quot;</span> <span class="keyword">in</span> sys_info <span class="keyword">and</span> <span class="string">&quot;sunset&quot;</span> <span class="keyword">in</span> sys_info:</span><br><span class="line">        sunrise = datetime.fromtimestamp(sys_info[<span class="string">&quot;sunrise&quot;</span>]).strftime(<span class="string">&quot;%H:%M&quot;</span>)</span><br><span class="line">        sunset = datetime.fromtimestamp(sys_info[<span class="string">&quot;sunset&quot;</span>]).strftime(<span class="string">&quot;%H:%M&quot;</span>)</span><br><span class="line">        result += <span class="string">f&quot;\n🌅 **日出**: <span class="subst">&#123;sunrise&#125;</span>&quot;</span></span><br><span class="line">        result += <span class="string">f&quot;\n🌇 **日落**: <span class="subst">&#123;sunset&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_forecast_info</span>(<span class="params">forecast_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;格式化天气预报信息&quot;&quot;&quot;</span></span><br><span class="line">    city = forecast_data.get(<span class="string">&quot;city&quot;</span>, &#123;&#125;)</span><br><span class="line">    location = city.get(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;未知位置&quot;</span>)</span><br><span class="line">    country = city.get(<span class="string">&quot;country&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> country:</span><br><span class="line">        location += <span class="string">f&quot;, <span class="subst">&#123;country&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    forecasts = forecast_data.get(<span class="string">&quot;list&quot;</span>, [])</span><br><span class="line"></span><br><span class="line">    result = <span class="string">f&quot;📅 **<span class="subst">&#123;location&#125;</span> - 5天天气预报**\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按日期分组预报数据</span></span><br><span class="line">    daily_forecasts: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]] = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> forecast <span class="keyword">in</span> forecasts:</span><br><span class="line">        dt = datetime.fromtimestamp(forecast[<span class="string">&quot;dt&quot;</span>])</span><br><span class="line">        date_key = dt.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> date_key <span class="keyword">not</span> <span class="keyword">in</span> daily_forecasts:</span><br><span class="line">            daily_forecasts[date_key] = []</span><br><span class="line">        daily_forecasts[date_key].append(forecast)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 显示每天的天气预报</span></span><br><span class="line">    <span class="keyword">for</span> date_key, day_forecasts <span class="keyword">in</span> <span class="built_in">list</span>(daily_forecasts.items())[:<span class="number">5</span>]:  <span class="comment"># 只显示5天</span></span><br><span class="line">        date_obj = datetime.strptime(date_key, <span class="string">&quot;%Y-%m-%d&quot;</span>)</span><br><span class="line">        date_str = date_obj.strftime(<span class="string">&quot;%m月%d日 (%A)&quot;</span>)</span><br><span class="line"></span><br><span class="line">        result += <span class="string">f&quot;**<span class="subst">&#123;date_str&#125;</span>**\n&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取当天的温度范围</span></span><br><span class="line">        temps = [f[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;temp&quot;</span>] <span class="keyword">for</span> f <span class="keyword">in</span> day_forecasts]</span><br><span class="line">        min_temp = format_temperature(<span class="built_in">min</span>(temps))</span><br><span class="line">        max_temp = format_temperature(<span class="built_in">max</span>(temps))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取主要天气描述（出现频率最高的）</span></span><br><span class="line">        descriptions = [f[<span class="string">&quot;weather&quot;</span>][<span class="number">0</span>][<span class="string">&quot;description&quot;</span>] <span class="keyword">for</span> f <span class="keyword">in</span> day_forecasts]</span><br><span class="line">        main_desc = <span class="built_in">max</span>(<span class="built_in">set</span>(descriptions), key=descriptions.count).title()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取平均湿度和风速</span></span><br><span class="line">        avg_humidity = <span class="built_in">sum</span>(f[<span class="string">&quot;main&quot;</span>][<span class="string">&quot;humidity&quot;</span>] <span class="keyword">for</span> f <span class="keyword">in</span> day_forecasts) / <span class="built_in">len</span>(day_forecasts)</span><br><span class="line">        avg_wind_speed = <span class="built_in">sum</span>(f[<span class="string">&quot;wind&quot;</span>][<span class="string">&quot;speed&quot;</span>] <span class="keyword">for</span> f <span class="keyword">in</span> day_forecasts) / <span class="built_in">len</span>(day_forecasts)</span><br><span class="line"></span><br><span class="line">        result += <span class="string">f&quot;  🌤️ <span class="subst">&#123;main_desc&#125;</span>\n&quot;</span></span><br><span class="line">        result += <span class="string">f&quot;  🌡️ <span class="subst">&#123;min_temp&#125;</span> - <span class="subst">&#123;max_temp&#125;</span>\n&quot;</span></span><br><span class="line">        result += <span class="string">f&quot;  💧 湿度: <span class="subst">&#123;avg_humidity:<span class="number">.0</span>f&#125;</span>%\n&quot;</span></span><br><span class="line">        result += <span class="string">f&quot;  💨 风速: <span class="subst">&#123;avg_wind_speed:<span class="number">.1</span>f&#125;</span> m/s\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@mcp.tool()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_current_weather</span>(<span class="params">city: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取指定城市的当前天气信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        city: 城市名称（英文或中文）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        格式化的当前天气信息</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> OPENWEATHER_API_KEY:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;❌ 错误: 未配置 OpenWeatherMap API 密钥。请设置 OPENWEATHER_API_KEY 环境变量。&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;正在获取 <span class="subst">&#123;city&#125;</span> 的当前天气信息...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;OPENWEATHER_BASE_URL&#125;</span>/weather&quot;</span>,</span><br><span class="line">            params=&#123;</span><br><span class="line">                <span class="string">&quot;q&quot;</span>: city,</span><br><span class="line">                <span class="string">&quot;appid&quot;</span>: OPENWEATHER_API_KEY,</span><br><span class="line">                <span class="string">&quot;lang&quot;</span>: <span class="string">&quot;zh_cn&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            timeout=<span class="number">10</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">404</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;❌ 错误: 找不到城市 &#x27;<span class="subst">&#123;city&#125;</span>&#x27;。请检查城市名称是否正确。&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> response.status_code == <span class="number">401</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;❌ 错误: API 密钥无效。请检查 OPENWEATHER_API_KEY 配置。&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> response.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;❌ 错误: API 请求失败 (状态码: <span class="subst">&#123;response.status_code&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">        weather_data = response.json()</span><br><span class="line">        <span class="keyword">return</span> format_weather_info(weather_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> requests.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;❌ 网络错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;❌ 未知错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@mcp.tool()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_weather_forecast</span>(<span class="params">city: <span class="built_in">str</span>, days: <span class="built_in">int</span> = <span class="number">5</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取指定城市的天气预报</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        city: 城市名称（英文或中文）</span></span><br><span class="line"><span class="string">        days: 预报天数（1-5天，默认5天）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        格式化的天气预报信息</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> OPENWEATHER_API_KEY:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;❌ 错误: 未配置 OpenWeatherMap API 密钥。请设置 OPENWEATHER_API_KEY 环境变量。&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> days &lt; <span class="number">1</span> <span class="keyword">or</span> days &gt; <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;❌ 错误: 预报天数必须在 1-5 天之间。&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;正在获取 <span class="subst">&#123;city&#125;</span> 的 <span class="subst">&#123;days&#125;</span> 天天气预报...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;OPENWEATHER_BASE_URL&#125;</span>/forecast&quot;</span>,</span><br><span class="line">            params=&#123;</span><br><span class="line">                <span class="string">&quot;q&quot;</span>: city,</span><br><span class="line">                <span class="string">&quot;appid&quot;</span>: OPENWEATHER_API_KEY,</span><br><span class="line">                <span class="string">&quot;lang&quot;</span>: <span class="string">&quot;zh_cn&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            timeout=<span class="number">10</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">404</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;❌ 错误: 找不到城市 &#x27;<span class="subst">&#123;city&#125;</span>&#x27;。请检查城市名称是否正确。&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> response.status_code == <span class="number">401</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;❌ 错误: API 密钥无效。请检查 OPENWEATHER_API_KEY 配置。&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> response.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;❌ 错误: API 请求失败 (状态码: <span class="subst">&#123;response.status_code&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">        forecast_data = response.json()</span><br><span class="line">        <span class="keyword">return</span> format_forecast_info(forecast_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> requests.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;❌ 网络错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;❌ 未知错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@mcp.resource(<span class="params"><span class="string">&quot;weather://current/&#123;city&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_current_weather_resource</span>(<span class="params">city: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取指定城市当前天气的资源&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;当前天气信息资源: <span class="subst">&#123;city&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@mcp.resource(<span class="params"><span class="string">&quot;weather://forecast/&#123;city&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_forecast_resource</span>(<span class="params">city: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取指定城市天气预报的资源&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;天气预报资源: <span class="subst">&#123;city&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@mcp.resource(<span class="params"><span class="string">&quot;weather://api-status&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_api_status</span>() -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取 API 状态信息&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> OPENWEATHER_API_KEY:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;✅ OpenWeatherMap API 密钥已配置&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;❌ OpenWeatherMap API 密钥未配置&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;运行 MCP 服务器&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;🌤️ 启动天气 MCP 服务器...&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;📍 支持的功能:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  - 获取当前天气 (get_current_weather)&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  - 获取天气预报 (get_weather_forecast)&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> OPENWEATHER_API_KEY:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;⚠️  警告: 未配置 OpenWeatherMap API 密钥&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;请创建 .env 文件并添加以下内容:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;OPENWEATHER_API_KEY=your_api_key_here&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;获取 API 密钥: https://openweathermap.org/api&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">    mcp.run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>上面代码其实很简单，上面大部分都是我们去请求 OpenWeatherMap API 获取天气数据，然后组装成我们想要的数据格式。核心的代码其实就只有 <code>@mcp.tool()</code> 装饰器修饰的两个工具函数，分别对应获取当前天气和获取天气预报。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@mcp.tool()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_current_weather</span>(<span class="params">city: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line"></span><br><span class="line"><span class="meta">@mcp.tool()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_weather_forecast</span>(<span class="params">city: <span class="built_in">str</span>, days: <span class="built_in">int</span> = <span class="number">5</span></span>) -&gt; <span class="built_in">str</span>:</span><br></pre></td></tr></table></figure>

<p>这里我们使用 <code>mcp</code> 对象的 <code>tool</code> 方法来装饰这两个工具函数即可，这样包装后我们实现的方法会返回一个 MCP 的工具对象，该对象包含工具的名称、描述、参数和返回值等信息。而 <code>mcp</code> 对象是通过前面的 <code>FastMCP</code> 类创建的，该类是 MCP 服务器的一个实现，提供了一些便捷的方法来创建 MCP 服务器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mcp.server.fastmcp <span class="keyword">import</span> FastMCP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 MCP 服务器</span></span><br><span class="line">mcp = FastMCP(<span class="string">&quot;Weather&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>当然出来 tools 之外，如果还想提供 resources 资源，我们也可以使用 <code>mcp</code> 对象的 <code>resource</code> 方法来装饰一个资源函数即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@mcp.resource(<span class="params"><span class="string">&quot;weather://current/&#123;city&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_current_weather_resource</span>(<span class="params">city: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取指定城市当前天气的资源&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;当前天气信息资源: <span class="subst">&#123;city&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后我们在项目根目录下面创建一个 <code>.env</code> 文件，并添加如下所示的环境变量即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPENWEATHER_API_KEY=your_api_key_here</span><br></pre></td></tr></table></figure>

<h3 id="调试-MCP-服务器"><a href="#调试-MCP-服务器" class="headerlink" title="调试 MCP 服务器"></a>调试 MCP 服务器</h3><p>然后我们可以使用下面的命令来调试该 MCP 服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ mcp dev main.py</span><br><span class="line">Starting MCP inspector...</span><br><span class="line">⚙️ Proxy server listening on port 6277</span><br><span class="line">New connection</span><br><span class="line"><span class="comment"># ......</span></span><br><span class="line">Stdio transport: <span class="built_in">command</span>=/opt/homebrew/bin/uv, args=run,--with,mcp,mcp,run,main.py</span><br><span class="line">Spawned stdio transport</span><br><span class="line">Connected MCP client to backing server transport</span><br><span class="line">Created web app transport</span><br><span class="line">Set up MCP proxy</span><br><span class="line">🔍 MCP Inspector is up and running at http://127.0.0.1:6274 🚀</span><br><span class="line">New connection</span><br></pre></td></tr></table></figure>

<p>该命令会启动一个 MCP Inspector 的调试器，我们可以通过浏览器 <code>http://127.0.0.1:6274</code> 进行访问，点击左侧的 <code>Connect</code> 按钮，就可以连接到当前的 MCP 服务器上，我们可以切换到 <code>Tools</code> 标签页，点击 <code>List Tools</code> 就可以看到该服务器提供的所有工具了。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747987799024.png" alt="null"></p>
<p>我们可以看到当前的 MCP 服务器提供了两个工具，分别是 <code>get_current_weather</code> 和 <code>get_weather_forecast</code>，我们可以点击其中一个工具，然后输入参数，点击 <code>Run Tool</code> 按钮，就可以看到该工具的返回结果了。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747987923331.png" alt="null"></p>
<h3 id="在-Cursor-中测试"><a href="#在-Cursor-中测试" class="headerlink" title="在 Cursor 中测试"></a>在 Cursor 中测试</h3><p>在 MCP Inspector 中测试没有问题，那么我们就可以将该 MCP 服务器安装到 Cursor 中，然后就可以在 Cursor 中使用该 MCP 服务器了。</p>
<p>同样在 Cursor 设置页面，切换到 <code>MCP</code> 标签页，点击右上角的 <code>+ Add new global MCP server</code> 按钮，在弹出的 <code>mcp.json</code> 文件中添加如下所示的配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;weather&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uv&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;--directory&quot;</span><span class="punctuation">,</span> <span class="string">&quot;/Users/cnych/your-mcp-path&quot;</span><span class="punctuation">,</span> <span class="string">&quot;run&quot;</span><span class="punctuation">,</span> <span class="string">&quot;main.py&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;OPENWEATHER_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxxx&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>保存后，我们就可以在 Cursor 中看到该 MCP 服务器了，并有两个 Tools 工具。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747988557742.png" alt="null"></p>
<p>然后我们可以在 Cursor Agent 模式下面询问关于天气的问题。</p>
<p><img src="https://raw.githubusercontent.com/Waylonwhynot/whatyouneed_blog_pic/main/pic/1747988679505.png" alt="null"><br><img src="https://picdn.youdianzhishi.com/images/1747988971960.png" alt="null"></p>
<p>当我们询问今天天气的时候可以看到 Cursor 会去主动调用 <code>get_current_weather</code> 工具查询当前城市的天气，同样询问未来天气的时候则会调用 <code>get_weather_forcaset</code> 工具查询数据。</p>
<p>最后我们可以将这个 weather mcp 服务器打包后发布到 pypi 上面去，则其他用户就可以直接指定我们这个包来安装这个 MCP 服务器了。</p>
<p>我们这里实现的这个 MCP 服务器是一个典型的 stdio 类型的 MCP 服务器，它通过标准输入输出与客户端进行交互，此外还可以通过 SSE 和 Streamable HTTP 等方式与客户端进行交互。</p>
<h2 id="开发-MCP-客户端"><a href="#开发-MCP-客户端" class="headerlink" title="开发 MCP 客户端"></a>开发 MCP 客户端</h2><p>上面我们自己实现了一个简单的 MCP 服务器，并在 Cursor 中测试了该服务器，那如果想要在其他地方使用该 MCP 服务器呢？这个就需要我们去实现一个 MCP 客户端了。</p>
<p>MCP Python SDK 提供了一个高级客户端接口，用于使用各种方式连接到 MCP 服务器，如下代码所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> ClientSession, StdioServerParameters, types</span><br><span class="line"><span class="keyword">from</span> mcp.client.stdio <span class="keyword">import</span> stdio_client</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 stdio 类型的 MCP 服务器参数</span></span><br><span class="line">server_params = StdioServerParameters(</span><br><span class="line">    command=<span class="string">&quot;python&quot;</span>,  <span class="comment"># 可执行文件</span></span><br><span class="line">    args=[<span class="string">&quot;example_server.py&quot;</span>],  <span class="comment"># 可选的命令行参数</span></span><br><span class="line">    env=<span class="literal">None</span>,  <span class="comment"># 可选的环境变量</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> stdio_client(server_params) <span class="keyword">as</span> (read, write):  <span class="comment"># 创建一个 stdio 类型的客户端</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> ClientSession(read, write) <span class="keyword">as</span> session:  <span class="comment"># 创建一个客户端会话</span></span><br><span class="line">            <span class="comment"># 初始化连接</span></span><br><span class="line">            <span class="keyword">await</span> session.initialize()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 列出可用的提示词</span></span><br><span class="line">            prompts = <span class="keyword">await</span> session.list_prompts()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取一个提示词</span></span><br><span class="line">            prompt = <span class="keyword">await</span> session.get_prompt(</span><br><span class="line">                <span class="string">&quot;example-prompt&quot;</span>, arguments=&#123;<span class="string">&quot;arg1&quot;</span>: <span class="string">&quot;value&quot;</span>&#125;</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 列出可用的资源</span></span><br><span class="line">            resources = <span class="keyword">await</span> session.list_resources()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 列出可用的工具</span></span><br><span class="line">            tools = <span class="keyword">await</span> session.list_tools()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 读取一个资源</span></span><br><span class="line">            content, mime_type = <span class="keyword">await</span> session.read_resource(<span class="string">&quot;file://some/path&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 调用一个工具</span></span><br><span class="line">            result = <span class="keyword">await</span> session.call_tool(<span class="string">&quot;tool-name&quot;</span>, arguments=&#123;<span class="string">&quot;arg1&quot;</span>: <span class="string">&quot;value&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line">    asyncio.run(run())</span><br></pre></td></tr></table></figure>

<p>上面代码中我们创建了一个 stdio 类型的 MCP 客户端，并使用 <code>stdio_client</code> 函数创建了一个客户端会话，然后通过 <code>ClientSession</code> 类创建了一个客户端会话，然后通过 <code>session.initialize()</code> 方法初始化连接，然后通过 <code>session.list_prompts()</code> 方法列出可用的提示词，然后通过 <code>session.get_prompt()</code> 方法获取一个提示词，然后通过 <code>session.list_resources()</code> 方法列出可用的资源，然后通过 <code>session.list_tools()</code> 方法列出可用的工具，然后通过 <code>session.read_resource()</code> 方法读取一个资源，然后通过 <code>session.call_tool()</code> 方法调用一个工具，这些都是 MCP 客户端的常用方法。</p>
<p>但是在实际的 MCP 客户端或者主机中我们一般会结合 LLM 来实现更加智能的交互，比如我们要实现一个基于 OpenAI 的 MCP 客户端，那要怎么实现呢？我们可以参考 Cursor 的方式：</p>
<ul>
<li>首先通过一个 JSON 配置文件来配置 MCP 服务器</li>
<li>读取该配置文件，加载 MCP 服务器列表</li>
<li>获取 MCP 服务器提供的可用工具列表</li>
<li>然后根据用户的输入，以及 Tools 列表传递给 LLM（如果 LLM 不支持工具调用，那么就需要在 System 提示词中告诉 LLM 如何调用这些工具）</li>
<li>根据 LLM 的返回结果，循环调用所有的 MCP 服务器提供的工具</li>
<li>得到 MCP 工具的返回结果后，可以将返回结果发送给 LLM 得到更符合用户意图的回答</li>
</ul>
<p>这个流程更符合我们实际情况的交互流程，下面我们实现一个基于 OpenAI 来实现一个简单的 MCP 客户端，完整代码如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">MyMCP 客户端 - 使用 OpenAI 原生 tools 调用</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> AsyncOpenAI</span><br><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> StdioServerParameters</span><br><span class="line"><span class="keyword">from</span> mcp.client.stdio <span class="keyword">import</span> stdio_client</span><br><span class="line"><span class="keyword">from</span> mcp.client.session <span class="keyword">import</span> ClientSession</span><br><span class="line"><span class="keyword">from</span> mcp.types <span class="keyword">import</span> Tool, TextContent</span><br><span class="line"><span class="keyword">from</span> rich.console <span class="keyword">import</span> Console</span><br><span class="line"><span class="keyword">from</span> rich.prompt <span class="keyword">import</span> Prompt</span><br><span class="line"><span class="keyword">from</span> rich.panel <span class="keyword">import</span> Panel</span><br><span class="line"><span class="keyword">from</span> rich.markdown <span class="keyword">import</span> Markdown</span><br><span class="line"><span class="keyword">from</span> rich.table <span class="keyword">import</span> Table</span><br><span class="line"><span class="keyword">from</span> rich.spinner <span class="keyword">import</span> Spinner</span><br><span class="line"><span class="keyword">from</span> rich.live <span class="keyword">import</span> Live</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载环境变量</span></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 Rich console</span></span><br><span class="line">console = Console()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MCPServerConfig</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;MCP 服务器配置&quot;&quot;&quot;</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    command: <span class="built_in">str</span></span><br><span class="line">    args: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    description: <span class="built_in">str</span></span><br><span class="line">    env: <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyMCPClient</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;MyMCP 客户端&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_path: <span class="built_in">str</span> = <span class="string">&quot;mcp.json&quot;</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.config_path = config_path</span><br><span class="line">        <span class="variable language_">self</span>.servers: <span class="type">Dict</span>[<span class="built_in">str</span>, MCPServerConfig] = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.all_tools: <span class="type">List</span>[<span class="built_in">tuple</span>[<span class="built_in">str</span>, <span class="type">Any</span>]] = []  <span class="comment"># (server_name, tool)</span></span><br><span class="line">        <span class="variable language_">self</span>.openai_client = AsyncOpenAI(</span><br><span class="line">            api_key=os.getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_config</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从配置文件加载 MCP 服务器配置&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.config_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                config = json.load(f)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> name, server_config <span class="keyword">in</span> config.get(<span class="string">&quot;mcpServers&quot;</span>, &#123;&#125;).items():</span><br><span class="line">                env_dict = server_config.get(<span class="string">&quot;env&quot;</span>, &#123;&#125;)</span><br><span class="line">                <span class="variable language_">self</span>.servers[name] = MCPServerConfig(</span><br><span class="line">                    name=name,</span><br><span class="line">                    command=server_config[<span class="string">&quot;command&quot;</span>],</span><br><span class="line">                    args=server_config.get(<span class="string">&quot;args&quot;</span>, []),</span><br><span class="line">                    description=server_config.get(<span class="string">&quot;description&quot;</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">                    env=env_dict <span class="keyword">if</span> env_dict <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            console.<span class="built_in">print</span>(<span class="string">f&quot;[green]✓ 已加载 <span class="subst">&#123;<span class="built_in">len</span>(self.servers)&#125;</span> 个 MCP 服务器配置[/green]&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            console.<span class="built_in">print</span>(<span class="string">f&quot;[red]✗ 加载配置文件失败: <span class="subst">&#123;e&#125;</span>[/red]&quot;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_tools_from_server</span>(<span class="params">self, name: <span class="built_in">str</span>, config: MCPServerConfig</span>) -&gt; <span class="type">List</span>[Tool]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从单个服务器获取工具列表&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            console.<span class="built_in">print</span>(<span class="string">f&quot;[blue]→ 正在连接服务器: <span class="subst">&#123;name&#125;</span>[/blue]&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 准备环境变量</span></span><br><span class="line">            env = os.environ.copy()</span><br><span class="line">            <span class="keyword">if</span> config.env:</span><br><span class="line">                env.update(config.env)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 创建服务器参数</span></span><br><span class="line">            server_params = StdioServerParameters(</span><br><span class="line">                command=config.command,</span><br><span class="line">                args=config.args,</span><br><span class="line">                env=env</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 使用 async with 上下文管理器（双层嵌套）</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> stdio_client(server_params) <span class="keyword">as</span> (read, write):</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> ClientSession(read, write) <span class="keyword">as</span> session:</span><br><span class="line">                    <span class="keyword">await</span> session.initialize()</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 获取工具列表</span></span><br><span class="line">                    tools_result = <span class="keyword">await</span> session.list_tools()</span><br><span class="line">                    tools = tools_result.tools</span><br><span class="line"></span><br><span class="line">                    console.<span class="built_in">print</span>(<span class="string">f&quot;[green]✓ <span class="subst">&#123;name&#125;</span>: <span class="subst">&#123;<span class="built_in">len</span>(tools)&#125;</span> 个工具[/green]&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span> tools</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            console.<span class="built_in">print</span>(<span class="string">f&quot;[red]✗ 连接服务器 <span class="subst">&#123;name&#125;</span> 失败: <span class="subst">&#123;e&#125;</span>[/red]&quot;</span>)</span><br><span class="line">            console.<span class="built_in">print</span>(<span class="string">f&quot;[red]  错误类型: <span class="subst">&#123;<span class="built_in">type</span>(e).__name__&#125;</span>[/red]&quot;</span>)</span><br><span class="line">            <span class="keyword">import</span> traceback</span><br><span class="line">            console.<span class="built_in">print</span>(<span class="string">f&quot;[red]  详细错误: <span class="subst">&#123;traceback.format_exc()&#125;</span>[/red]&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">load_all_tools</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载所有服务器的工具&quot;&quot;&quot;</span></span><br><span class="line">        console.<span class="built_in">print</span>(<span class="string">&quot;\n[blue]→ 正在获取可用工具列表...[/blue]&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> name, config <span class="keyword">in</span> <span class="variable language_">self</span>.servers.items():</span><br><span class="line">            tools = <span class="keyword">await</span> <span class="variable language_">self</span>.get_tools_from_server(name, config)</span><br><span class="line">            <span class="keyword">for</span> tool <span class="keyword">in</span> tools:</span><br><span class="line">                <span class="variable language_">self</span>.all_tools.append((name, tool))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">display_tools</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;显示所有可用工具&quot;&quot;&quot;</span></span><br><span class="line">        table = Table(title=<span class="string">&quot;可用 MCP 工具&quot;</span>, show_header=<span class="literal">True</span>)</span><br><span class="line">        table.add_column(<span class="string">&quot;服务器&quot;</span>, style=<span class="string">&quot;cyan&quot;</span>)</span><br><span class="line">        table.add_column(<span class="string">&quot;工具名称&quot;</span>, style=<span class="string">&quot;green&quot;</span>)</span><br><span class="line">        table.add_column(<span class="string">&quot;描述&quot;</span>, style=<span class="string">&quot;white&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 按服务器分组</span></span><br><span class="line">        current_server = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> server_name, tool <span class="keyword">in</span> <span class="variable language_">self</span>.all_tools:</span><br><span class="line">            <span class="comment"># 只在服务器名称变化时显示服务器名称</span></span><br><span class="line">            display_server = server_name <span class="keyword">if</span> server_name != current_server <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            current_server = server_name</span><br><span class="line"></span><br><span class="line">            table.add_row(</span><br><span class="line">                display_server,</span><br><span class="line">                tool.name,</span><br><span class="line">                tool.description <span class="keyword">or</span> <span class="string">&quot;无描述&quot;</span></span><br><span class="line">            )</span><br><span class="line">        console.<span class="built_in">print</span>(table)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_openai_tools</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;构建 OpenAI tools 格式的工具定义&quot;&quot;&quot;</span></span><br><span class="line">        openai_tools = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> server_name, tool <span class="keyword">in</span> <span class="variable language_">self</span>.all_tools:</span><br><span class="line">            <span class="comment"># 构建 OpenAI function 格式</span></span><br><span class="line">            function_def = &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">                <span class="string">&quot;function&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;server_name&#125;</span>_<span class="subst">&#123;tool.name&#125;</span>&quot;</span>,  <span class="comment"># 添加服务器前缀避免冲突</span></span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">f&quot;[<span class="subst">&#123;server_name&#125;</span>] <span class="subst">&#123;tool.description <span class="keyword">or</span> <span class="string">&#x27;无描述&#x27;</span>&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;parameters&quot;</span>: tool.inputSchema <span class="keyword">or</span> &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>, <span class="string">&quot;properties&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            openai_tools.append(function_def)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> openai_tools</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_tool_name</span>(<span class="params">self, function_name: <span class="built_in">str</span></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析工具名称，提取服务器名称和工具名称&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 格式: server_name_tool_name</span></span><br><span class="line">        parts = function_name.split(<span class="string">&#x27;_&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(parts) == <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> parts[<span class="number">0</span>], parts[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 如果没有下划线，假设是第一个服务器的工具</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.all_tools:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">self</span>.all_tools[<span class="number">0</span>][<span class="number">0</span>], function_name</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>, function_name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">call_tool</span>(<span class="params">self, server_name: <span class="built_in">str</span>, tool_name: <span class="built_in">str</span>, arguments: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;调用指定的工具&quot;&quot;&quot;</span></span><br><span class="line">        config = <span class="variable language_">self</span>.servers.get(server_name)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> config:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;服务器 <span class="subst">&#123;server_name&#125;</span> 不存在&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 准备环境变量</span></span><br><span class="line">            env = os.environ.copy()</span><br><span class="line">            <span class="keyword">if</span> config.env:</span><br><span class="line">                env.update(config.env)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 创建服务器参数</span></span><br><span class="line">            server_params = StdioServerParameters(</span><br><span class="line">                command=config.command,</span><br><span class="line">                args=config.args,</span><br><span class="line">                env=env</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 使用 async with 上下文管理器（双层嵌套）</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> stdio_client(server_params) <span class="keyword">as</span> (read, write):</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> ClientSession(read, write) <span class="keyword">as</span> session:</span><br><span class="line">                    <span class="keyword">await</span> session.initialize()</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 调用工具</span></span><br><span class="line">                    result = <span class="keyword">await</span> session.call_tool(tool_name, arguments)</span><br><span class="line">                    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            console.<span class="built_in">print</span>(<span class="string">f&quot;[red]✗ 调用工具 <span class="subst">&#123;tool_name&#125;</span> 失败: <span class="subst">&#123;e&#125;</span>[/red]&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_text_content</span>(<span class="params">self, content_list: <span class="type">List</span>[<span class="type">Any</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从 MCP 响应中提取文本内容&quot;&quot;&quot;</span></span><br><span class="line">        text_parts: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line">        <span class="keyword">for</span> content <span class="keyword">in</span> content_list:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(content, TextContent):</span><br><span class="line">                text_parts.append(content.text)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">hasattr</span>(content, <span class="string">&#x27;text&#x27;</span>):</span><br><span class="line">                text_parts.append(<span class="built_in">str</span>(content.text))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 处理其他类型的内容</span></span><br><span class="line">                text_parts.append(<span class="built_in">str</span>(content))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\n&quot;</span>.join(text_parts) <span class="keyword">if</span> text_parts <span class="keyword">else</span> <span class="string">&quot;✅ 操作完成，但没有返回文本内容&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_user_input</span>(<span class="params">self, user_input: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理用户输入并返回最终响应&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建工具定义</span></span><br><span class="line">        openai_tools = <span class="variable language_">self</span>.build_openai_tools()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 第一次调用 - 让 LLM 决定是否需要使用工具</span></span><br><span class="line">            messages = [</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;你是一个智能助手，可以使用各种 MCP 工具来帮助用户完成任务。如果不需要使用工具，直接返回回答。&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_input&#125;</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 调用 OpenAI API</span></span><br><span class="line">            kwargs = &#123;</span><br><span class="line">                <span class="string">&quot;model&quot;</span>: <span class="string">&quot;deepseek-chat&quot;</span>,</span><br><span class="line">                <span class="string">&quot;messages&quot;</span>: messages,</span><br><span class="line">                <span class="string">&quot;temperature&quot;</span>: <span class="number">0.7</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 只有当有工具时才添加 tools 参数</span></span><br><span class="line">            <span class="keyword">if</span> openai_tools:</span><br><span class="line">                kwargs[<span class="string">&quot;tools&quot;</span>] = openai_tools</span><br><span class="line">                kwargs[<span class="string">&quot;tool_choice&quot;</span>] = <span class="string">&quot;auto&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 使用 loading 特效</span></span><br><span class="line">            <span class="keyword">with</span> Live(Spinner(<span class="string">&quot;dots&quot;</span>, text=<span class="string">&quot;[blue]正在思考...[/blue]&quot;</span>), console=console, refresh_per_second=<span class="number">10</span>):</span><br><span class="line">                response = <span class="keyword">await</span> <span class="variable language_">self</span>.openai_client.chat.completions.create(**kwargs)  <span class="comment"># type: ignore</span></span><br><span class="line">            message = response.choices[<span class="number">0</span>].message</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 检查是否有工具调用</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(message, <span class="string">&#x27;tool_calls&#x27;</span>) <span class="keyword">and</span> message.tool_calls:  <span class="comment"># type: ignore</span></span><br><span class="line">                <span class="comment"># 添加助手消息到历史</span></span><br><span class="line">                messages.append(&#123;  <span class="comment"># type: ignore</span></span><br><span class="line">                    <span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;content&quot;</span>: message.content,</span><br><span class="line">                    <span class="string">&quot;tool_calls&quot;</span>: [</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="string">&quot;id&quot;</span>: tc.<span class="built_in">id</span>,</span><br><span class="line">                            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;function&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;name&quot;</span>: tc.function.name,</span><br><span class="line">                                <span class="string">&quot;arguments&quot;</span>: tc.function.arguments</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">for</span> tc <span class="keyword">in</span> message.tool_calls  <span class="comment"># type: ignore</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 执行每个工具调用</span></span><br><span class="line">                <span class="keyword">for</span> tool_call <span class="keyword">in</span> message.tool_calls:</span><br><span class="line">                    function_name = tool_call.function.name  <span class="comment"># type: ignore</span></span><br><span class="line">                    arguments = json.loads(tool_call.function.arguments)  <span class="comment"># type: ignore</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># 解析服务器名称和工具名称</span></span><br><span class="line">                    server_name, tool_name = <span class="variable language_">self</span>.parse_tool_name(function_name)  <span class="comment"># type: ignore</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="comment"># 使用 loading 特效调用工具</span></span><br><span class="line">                        <span class="keyword">with</span> Live(Spinner(<span class="string">&quot;dots&quot;</span>, text=<span class="string">f&quot;[cyan]正在调用 <span class="subst">&#123;server_name&#125;</span>.<span class="subst">&#123;tool_name&#125;</span>...[/cyan]&quot;</span>), console=console, refresh_per_second=<span class="number">10</span>):</span><br><span class="line">                            result = <span class="keyword">await</span> <span class="variable language_">self</span>.call_tool(server_name, tool_name, arguments)</span><br><span class="line"></span><br><span class="line">                        <span class="comment"># 从 MCP 响应中提取文本内容</span></span><br><span class="line">                        result_content = <span class="variable language_">self</span>.extract_text_content(result.content)</span><br><span class="line">                        <span class="comment"># 添加工具调用结果</span></span><br><span class="line">                        messages.append(&#123;</span><br><span class="line">                            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;tool&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;tool_call_id&quot;</span>: tool_call.<span class="built_in">id</span>,</span><br><span class="line">                            <span class="string">&quot;content&quot;</span>: result_content</span><br><span class="line">                        &#125;)</span><br><span class="line">                        console.<span class="built_in">print</span>(<span class="string">f&quot;[green]✓ <span class="subst">&#123;server_name&#125;</span>.<span class="subst">&#123;tool_name&#125;</span> 调用成功[/green]&quot;</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        <span class="comment"># 添加错误信息</span></span><br><span class="line">                        messages.append(&#123;</span><br><span class="line">                            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;tool&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;tool_call_id&quot;</span>: tool_call.<span class="built_in">id</span>,</span><br><span class="line">                            <span class="string">&quot;content&quot;</span>: <span class="string">f&quot;错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line">                        &#125;)</span><br><span class="line">                        console.<span class="built_in">print</span>(<span class="string">f&quot;[red]✗ <span class="subst">&#123;server_name&#125;</span>.<span class="subst">&#123;tool_name&#125;</span> 调用失败: <span class="subst">&#123;e&#125;</span>[/red]&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 获取最终响应</span></span><br><span class="line">                <span class="keyword">with</span> Live(Spinner(<span class="string">&quot;dots&quot;</span>, text=<span class="string">&quot;[blue]正在生成最终响应...[/blue]&quot;</span>), console=console, refresh_per_second=<span class="number">10</span>):</span><br><span class="line">                    final_response = <span class="keyword">await</span> <span class="variable language_">self</span>.openai_client.chat.completions.create(</span><br><span class="line">                        model=<span class="string">&quot;deepseek-chat&quot;</span>,</span><br><span class="line">                        messages=messages,  <span class="comment"># type: ignore</span></span><br><span class="line">                        temperature=<span class="number">0.7</span></span><br><span class="line">                    )</span><br><span class="line"></span><br><span class="line">                final_content = final_response.choices[<span class="number">0</span>].message.content</span><br><span class="line">                <span class="keyword">return</span> final_content <span class="keyword">or</span> <span class="string">&quot;抱歉，我无法生成最终回答。&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 没有工具调用，直接返回响应</span></span><br><span class="line">                <span class="keyword">return</span> message.content <span class="keyword">or</span> <span class="string">&quot;抱歉，我无法生成回答。&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            console.<span class="built_in">print</span>(<span class="string">f&quot;[red]✗ 处理请求时出错: <span class="subst">&#123;e&#125;</span>[/red]&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;抱歉，处理您的请求时出现错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">interactive_loop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;交互式循环&quot;&quot;&quot;</span></span><br><span class="line">        console.<span class="built_in">print</span>(Panel.fit(</span><br><span class="line">            <span class="string">&quot;[bold cyan]MyMCP 客户端已启动[/bold cyan]\n&quot;</span></span><br><span class="line">            <span class="string">&quot;输入您的问题，我会使用可用的 MCP 工具来帮助您。\n&quot;</span></span><br><span class="line">            <span class="string">&quot;输入 &#x27;tools&#x27; 查看可用工具\n&quot;</span></span><br><span class="line">            <span class="string">&quot;输入 &#x27;exit&#x27; 或 &#x27;quit&#x27; 退出。&quot;</span>,</span><br><span class="line">            title=<span class="string">&quot;欢迎使用 MCP 客户端&quot;</span></span><br><span class="line">        ))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 获取用户输入</span></span><br><span class="line">                user_input = Prompt.ask(<span class="string">&quot;\n[bold green]您[/bold green]&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> user_input.lower() <span class="keyword">in</span> [<span class="string">&#x27;exit&#x27;</span>, <span class="string">&#x27;quit&#x27;</span>, <span class="string">&#x27;q&#x27;</span>]:</span><br><span class="line">                    console.<span class="built_in">print</span>(<span class="string">&quot;\n[yellow]再见！[/yellow]&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> user_input.lower() == <span class="string">&#x27;tools&#x27;</span>:</span><br><span class="line">                    <span class="variable language_">self</span>.display_tools()</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 处理用户输入</span></span><br><span class="line">                response = <span class="keyword">await</span> <span class="variable language_">self</span>.process_user_input(user_input)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 显示响应</span></span><br><span class="line">                console.<span class="built_in">print</span>(<span class="string">&quot;\n[bold blue]助手[/bold blue]:&quot;</span>)</span><br><span class="line">                console.<span class="built_in">print</span>(Panel(Markdown(response), border_style=<span class="string">&quot;blue&quot;</span>))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">                console.<span class="built_in">print</span>(<span class="string">&quot;\n[yellow]已中断[/yellow]&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                console.<span class="built_in">print</span>(<span class="string">f&quot;\n[red]错误: <span class="subst">&#123;e&#125;</span>[/red]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行客户端&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 加载配置</span></span><br><span class="line">        <span class="variable language_">self</span>.load_config()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.servers:</span><br><span class="line">            console.<span class="built_in">print</span>(<span class="string">&quot;[red]✗ 没有配置的服务器[/red]&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取所有工具</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>.load_all_tools()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.all_tools:</span><br><span class="line">            console.<span class="built_in">print</span>(<span class="string">&quot;[red]✗ 没有可用的工具[/red]&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 显示可用工具</span></span><br><span class="line">        <span class="variable language_">self</span>.display_tools()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 进入交互循环</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">self</span>.interactive_loop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主函数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 检查 OpenAI API Key</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>):</span><br><span class="line">        console.<span class="built_in">print</span>(<span class="string">&quot;[red]✗ 请设置环境变量 OPENAI_API_KEY[/red]&quot;</span>)</span><br><span class="line">        console.<span class="built_in">print</span>(<span class="string">&quot;提示: 创建 .env 文件并添加: OPENAI_API_KEY=your-api-key&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建并运行客户端</span></span><br><span class="line">    client = MyMCPClient()</span><br><span class="line">    <span class="keyword">await</span> client.run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        asyncio.run(main())</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        console.<span class="built_in">print</span>(<span class="string">&quot;\n[yellow]程序已退出[/yellow]&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        console.<span class="built_in">print</span>(<span class="string">f&quot;\n[red]程序错误: <span class="subst">&#123;e&#125;</span>[/red]&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>上面代码中我们首先加载 <code>mcp.json</code> 文件，配置格式和 Cursor 的一致，来获取所有我们自己配置的 MCP 服务器，比如我们配置如下所示的 <code>mcp.json</code> 文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;weather&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uv&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;--directory&quot;</span><span class="punctuation">,</span> <span class="string">&quot;.&quot;</span><span class="punctuation">,</span> <span class="string">&quot;run&quot;</span><span class="punctuation">,</span> <span class="string">&quot;main.py&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;天气信息服务器 - 获取当前天气和天气预报&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;OPENWEATHER_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxx&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;filesystem&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;-y&quot;</span><span class="punctuation">,</span> <span class="string">&quot;@modelcontextprotocol/server-filesystem&quot;</span><span class="punctuation">,</span> <span class="string">&quot;/tmp&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;文件系统操作服务器 - 文件读写和目录管理&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后在 <code>run</code> 方法中接着我们调用 <code>load_all_tools</code> 方法加载所有的工具列表，这里的实现核心就是去调用 MCP 服务器端的工具列表，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_tools_from_server</span>(<span class="params">self, name: <span class="built_in">str</span>, config: MCPServerConfig</span>) -&gt; <span class="type">List</span>[Tool]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从单个服务器获取工具列表&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        console.<span class="built_in">print</span>(<span class="string">f&quot;[blue]→ 正在连接服务器: <span class="subst">&#123;name&#125;</span>[/blue]&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 准备环境变量</span></span><br><span class="line">        env = os.environ.copy()</span><br><span class="line">        <span class="keyword">if</span> config.env:</span><br><span class="line">            env.update(config.env)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建服务器参数</span></span><br><span class="line">        server_params = StdioServerParameters(</span><br><span class="line">            command=config.command,</span><br><span class="line">            args=config.args,</span><br><span class="line">            env=env</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 使用 async with 上下文管理器（双层嵌套）</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> stdio_client(server_params) <span class="keyword">as</span> (read, write):</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> ClientSession(read, write) <span class="keyword">as</span> session:</span><br><span class="line">                <span class="keyword">await</span> session.initialize()</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 获取工具列表</span></span><br><span class="line">                tools_result = <span class="keyword">await</span> session.list_tools()</span><br><span class="line">                tools = tools_result.tools</span><br><span class="line"></span><br><span class="line">                console.<span class="built_in">print</span>(<span class="string">f&quot;[green]✓ <span class="subst">&#123;name&#125;</span>: <span class="subst">&#123;<span class="built_in">len</span>(tools)&#125;</span> 个工具[/green]&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> tools</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        console.<span class="built_in">print</span>(<span class="string">f&quot;[red]✗ 连接服务器 <span class="subst">&#123;name&#125;</span> 失败: <span class="subst">&#123;e&#125;</span>[/red]&quot;</span>)</span><br><span class="line">        console.<span class="built_in">print</span>(<span class="string">f&quot;[red]  错误类型: <span class="subst">&#123;<span class="built_in">type</span>(e).__name__&#125;</span>[/red]&quot;</span>)</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        console.<span class="built_in">print</span>(<span class="string">f&quot;[red]  详细错误: <span class="subst">&#123;traceback.format_exc()&#125;</span>[/red]&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br></pre></td></tr></table></figure>

<p>这里核心就是直接使用 MCP Python SDK 提供的客户端接口去调用 MCP 服务器获取工具列表。</p>
<p>接下来就是处理用户的输入了，这里首先我们要做的是将获取到的 MCP 工具列表转换成 OpenAI 能够识别的 function tools 格式，然后将用户的输入和工具一起发给 OpenAI 进行处理，然后根据返回结果判断是否应该调用某个工具，如果需要同样直接调用 MCP 的工具即可，最后将获得的结果一起组装发给 OpenAI 获得一个更加完整的回答结果。这整个流程不复杂，当然还有很多细节可以优化，更多的还是根据我们自己的需求进行集成。</p>
<p>现在我们可以直接测试下结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">$ python simple_client.py</span><br><span class="line">✓ 已加载 1 个 MCP 服务器配置</span><br><span class="line"></span><br><span class="line">→ 正在获取可用工具列表...</span><br><span class="line">→ 正在连接服务器: weather</span><br><span class="line">[05/25/25 11:42:51] INFO     Processing request of <span class="built_in">type</span> ListToolsRequest  server.py:551</span><br><span class="line">✓ weather: 2 个工具</span><br><span class="line">                              可用 MCP 工具</span><br><span class="line">┏━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓</span><br><span class="line">┃ 服务器  ┃ 工具名称             ┃ 描述                                 ┃</span><br><span class="line">┡━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩</span><br><span class="line">│ weather │ get_current_weather  │                                      │</span><br><span class="line">│         │                      │ 获取指定城市的当前天气信息           │</span><br><span class="line">│         │                      │                                      │</span><br><span class="line">│         │                      │ Args:                                │</span><br><span class="line">│         │                      │     city: 城市名称（英文）           │</span><br><span class="line">│         │                      │                                      │</span><br><span class="line">│         │                      │ Returns:                             │</span><br><span class="line">│         │                      │     格式化的当前天气信息             │</span><br><span class="line">│         │                      │                                      │</span><br><span class="line">│         │ get_weather_forecast │                                      │</span><br><span class="line">│         │                      │ 获取指定城市的天气预报               │</span><br><span class="line">│         │                      │                                      │</span><br><span class="line">│         │                      │ Args:                                │</span><br><span class="line">│         │                      │     city: 城市名称（英文）           │</span><br><span class="line">│         │                      │     days: 预报天数（1-5天，默认5天） │</span><br><span class="line">│         │                      │                                      │</span><br><span class="line">│         │                      │ Returns:                             │</span><br><span class="line">│         │                      │     格式化的天气预报信息             │</span><br><span class="line">│         │                      │                                      │</span><br><span class="line">└─────────┴──────────────────────┴──────────────────────────────────────┘</span><br><span class="line">╭────────────── 欢迎使用 MCP 客户端 ──────────────╮</span><br><span class="line">│ MyMCP 客户端已启动                              │</span><br><span class="line">│ 输入您的问题，我会使用可用的 MCP 工具来帮助您。 │</span><br><span class="line">│ 输入 <span class="string">&#x27;tools&#x27;</span> 查看可用工具                       │</span><br><span class="line">│ 输入 <span class="string">&#x27;exit&#x27;</span> 或 <span class="string">&#x27;quit&#x27;</span> 退出。                    │</span><br><span class="line">╰─────────────────────────────────────────────────╯</span><br><span class="line"></span><br><span class="line">您: 你好,你是谁?</span><br><span class="line">⠹ 正在思考...</span><br><span class="line"></span><br><span class="line">助手:</span><br><span class="line">╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮</span><br><span class="line">│ 你好！我是一个智能助手，可以帮助你完成各种任务，比如回答问题、查询天气、提供建议等等。如果你有任何需要，随时告诉我！ 😊                  │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line"></span><br><span class="line">您: 成都今天的天气咋样?明天适合穿裙子吗?</span><br><span class="line">⠧ 正在思考...</span><br><span class="line">⠴ 正在调用 weather.get_current_weather...[05/25/25 11:44:03] INFO     Processing request of <span class="built_in">type</span> CallToolRequest                                                        server.py:551</span><br><span class="line">⠴ 正在调用 weather.get_current_weather...</span><br><span class="line">✓ weather.get_current_weather 调用成功</span><br><span class="line">⠸ 正在调用 weather.get_weather_forecast...[05/25/25 11:44:04] INFO     Processing request of <span class="built_in">type</span> CallToolRequest                                                        server.py:551</span><br><span class="line">⠋ 正在调用 weather.get_weather_forecast...</span><br><span class="line">✓ weather.get_weather_forecast 调用成功</span><br><span class="line">⠧ 正在生成最终响应...</span><br><span class="line"></span><br><span class="line">助手:</span><br><span class="line">╭──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮</span><br><span class="line">│ 成都今天天气晴朗，当前温度26.9°C，湿度44%，风力较小，非常适合外出活动。                                                                  │</span><br><span class="line">│                                                                                                                                          │</span><br><span class="line">│ 明天(5月25日)天气预报：                                                                                                                  │</span><br><span class="line">│                                                                                                                                          │</span><br><span class="line">│  • 天气：多云                                                                                                                            │</span><br><span class="line">│  • 温度：26.4°C~29.3°C                                                                                                                   │</span><br><span class="line">│  • 风力：3.1 m/s                                                                                                                         │</span><br><span class="line">│  • 湿度：41%                                                                                                                             │</span><br><span class="line">│                                                                                                                                          │</span><br><span class="line">│ 建议：明天温度适中，风力不大，穿裙子完全没问题。不过建议搭配一件薄外套或防晒衣，因为多云天气紫外线可能较强。如果计划长时间在户外，可以带 │</span><br><span class="line">│ 把晴雨伞备用。                                                                                                                           │</span><br><span class="line">╰──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span><br><span class="line"></span><br><span class="line">您:</span><br></pre></td></tr></table></figure>

<p>从输出可以看到能够正常调用我们配置的 MCP 服务器提供的工具。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Waylon Yan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/posts/18525.html">http://example.com/posts/18525.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AI/">AI</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/5677.html"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">AI-08-A2A</div></div></a></div><div class="next-post pull-right"><a href="/posts/65143.html"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">AI-06-dify</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/posts/62587.html" title="AI-00-初识AI"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-22</div><div class="title">AI-00-初识AI</div></div></a></div><div><a href="/posts/24369.html" title="AI-01-Langchain构建RAG应用"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-23</div><div class="title">AI-01-Langchain构建RAG应用</div></div></a></div><div><a href="/posts/52660.html" title="AI-01-LLM概述"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-17</div><div class="title">AI-01-LLM概述</div></div></a></div><div><a href="/posts/23894.html" title="AI-02-通俗解释LLM"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-17</div><div class="title">AI-02-通俗解释LLM</div></div></a></div><div><a href="/posts/34613.html" title="AI-04-提示词工程"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-17</div><div class="title">AI-04-提示词工程</div></div></a></div><div><a href="/posts/7755.html" title="AI-02-Agent"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-11</div><div class="title">AI-02-Agent</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Waylon Yan</div><div class="author-info__description">tech life sharing</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">271</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">42</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">26</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Waylonwhynot" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:ywl1006@outlook.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">无止境</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Agent%EF%BC%8CFunction-Calling%EF%BC%8CMCP%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">1.</span> <span class="toc-text">Agent，Function Calling，MCP之间的关系</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">1.0.1.</span> <span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Agent"><span class="toc-number">1.1.</span> <span class="toc-text">Agent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.1.</span> <span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Function-Calling"><span class="toc-number">1.2.</span> <span class="toc-text">Function Calling</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AI-Agent%E4%B8%8E%E6%A8%A1%E5%9E%8B%E7%9A%84%E9%80%9A%E4%BF%A1"><span class="toc-number">1.3.</span> <span class="toc-text">AI Agent与模型的通信</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AI-Agent-%E5%A6%82%E4%BD%95%E4%B8%8ETools%E8%BF%9B%E8%A1%8C%E9%80%9A%E4%BF%A1"><span class="toc-number">1.4.</span> <span class="toc-text">AI Agent 如何与Tools进行通信</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MCP"><span class="toc-number">1.5.</span> <span class="toc-text">MCP</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%A4%E4%BA%92%E8%BF%87%E7%A8%8B"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">交互过程</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MCP%E5%9F%BA%E7%A1%80"><span class="toc-number"></span> <span class="toc-text">MCP基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E6%98%AF%E5%90%A6%E5%85%B7%E6%9C%89Function-Calling%E8%83%BD%E5%8A%9B"><span class="toc-number">0.1.</span> <span class="toc-text">模型是否具有Function Calling能力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cline%E7%9A%84XML%E5%8D%8F%E8%AE%AE%E4%B8%8EReAct%EF%BC%88Thought-Action-Observation%EF%BC%89%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">0.2.</span> <span class="toc-text">Cline的XML协议与ReAct（Thought Action Observation）之间的关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-MCP"><span class="toc-number">2.</span> <span class="toc-text">为什么需要 MCP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MCP-%E6%9E%B6%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">MCP 架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MCP-%E5%8D%8F%E8%AE%AE"><span class="toc-number">4.</span> <span class="toc-text">MCP 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.1.</span> <span class="toc-text">消息类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E5%A4%A7%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">4.2.</span> <span class="toc-text">四大核心功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">4.3.</span> <span class="toc-text">生命周期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E8%BE%93%E6%9C%BA%E5%88%B6"><span class="toc-number">4.4.</span> <span class="toc-text">传输机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">快速使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">5.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-SQLite-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.2.</span> <span class="toc-text">创建 SQLite 数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">5.3.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90"><span class="toc-number">5.4.</span> <span class="toc-text">解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91-MCP-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.</span> <span class="toc-text">开发 MCP 服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">6.1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-MCP-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.2.</span> <span class="toc-text">实现 MCP 服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95-MCP-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.3.</span> <span class="toc-text">调试 MCP 服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-Cursor-%E4%B8%AD%E6%B5%8B%E8%AF%95"><span class="toc-number">6.4.</span> <span class="toc-text">在 Cursor 中测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91-MCP-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">7.</span> <span class="toc-text">开发 MCP 客户端</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/3616160428.html" title="GO-37-常用标准库"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GO-37-常用标准库"/></a><div class="content"><a class="title" href="/posts/3616160428.html" title="GO-37-常用标准库">GO-37-常用标准库</a><time datetime="2025-08-25T18:47:50.000Z" title="Created 2025-08-26 02:47:50">2025-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/164398045.html" title="GO-36-包与工程化"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GO-36-包与工程化"/></a><div class="content"><a class="title" href="/posts/164398045.html" title="GO-36-包与工程化">GO-36-包与工程化</a><time datetime="2025-08-24T10:01:30.000Z" title="Created 2025-08-24 18:01:30">2025-08-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2170744928.html" title="AI-09-Context-Engineering"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI-09-Context-Engineering"/></a><div class="content"><a class="title" href="/posts/2170744928.html" title="AI-09-Context-Engineering">AI-09-Context-Engineering</a><time datetime="2025-08-12T17:34:58.000Z" title="Created 2025-08-13 01:34:58">2025-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5677.html" title="AI-08-A2A"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI-08-A2A"/></a><div class="content"><a class="title" href="/posts/5677.html" title="AI-08-A2A">AI-08-A2A</a><time datetime="2025-06-21T07:22:33.000Z" title="Created 2025-06-21 15:22:33">2025-06-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/18525.html" title="AI-07-MCP"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI-07-MCP"/></a><div class="content"><a class="title" href="/posts/18525.html" title="AI-07-MCP">AI-07-MCP</a><time datetime="2025-06-08T06:19:30.000Z" title="Created 2025-06-08 14:19:30">2025-06-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Waylon Yan</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>