<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>mysql-01 | YouNeed</title><meta name="keywords" content="note"><meta name="author" content="Waylon Yan"><meta name="copyright" content="Waylon Yan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="sql 库表操作">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql-01">
<meta property="og:url" content="https://waylon.whatyouneed.site/2021/01/10/mysql-01/index.html">
<meta property="og:site_name" content="YouNeed">
<meta property="og:description" content="sql 库表操作">
<meta property="og:locale">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png">
<meta property="article:published_time" content="2021-01-10T06:10:53.000Z">
<meta property="article:modified_time" content="2022-03-26T11:23:41.313Z">
<meta property="article:author" content="Waylon Yan">
<meta property="article:tag" content="note">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://waylon.whatyouneed.site/2021/01/10/mysql-01/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'mysql-01',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-26 19:23:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">245</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">37</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">22</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">YouNeed</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">mysql-01</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-01-10T06:10:53.000Z" title="Created 2021-01-10 14:10:53">2021-01-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-03-26T11:23:41.313Z" title="Updated 2022-03-26 19:23:41">2022-03-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/mysql/">mysql</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="mysql-01"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>sql 库表操作</p>
<a id="more"></a>

<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SQL语言主要用于存取数据、查询数据、更新数据和管理关系数据库系统,SQL语言由IBM开发。SQL语言分为3种类型：</span><br><span class="line"><span class="meta">#</span><span class="bash">1、DDL语句    数据库定义语言： 数据库、表、视图、索引、存储过程，例如CREATE DROP ALTER</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2、DML语句    数据库操纵语言： 插入数据INSERT、删除数据DELETE、更新数据UPDATE、查询数据SELECT</span></span><br><span class="line"><span class="meta">#</span><span class="bash">3、DCL语句    数据库控制语言： 例如控制用户的访问权限GRANT、REVOKE</span></span><br></pre></td></tr></table></figure>



<h2 id="基本库表语句"><a href="#基本库表语句" class="headerlink" title="基本库表语句"></a>基本库表语句</h2><p>1、mysql是什么？<br>    mysql本质就是一个c/s架构的套接字软件</p>
<p>2、数据库基本概念<br>    数据库服务器： 运行有数据库管理软件的计算机<br>    数据库管理软件：mysql<br>    库：文件夹<br>    表：文件<br>    记录：文件中的一行的内容</p>
<p>3、针对库、表、记录的操作</p>
<blockquote>
<p>库</p>
</blockquote>
<p>数据库命名规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">可以由字母、数字、下划线、＠、＃、＄</span><br><span class="line">区分大小写</span><br><span class="line">唯一性</span><br><span class="line">不能使用关键字如 create select</span><br><span class="line">不能单独使用数字</span><br><span class="line">最长128位</span><br></pre></td></tr></table></figure>

<p>数据库相关操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">增</span><br><span class="line">    create database db12 charset utf8;</span><br><span class="line">改</span><br><span class="line">    alter database db12 charset gbk;</span><br><span class="line">查</span><br><span class="line">    show databases;</span><br><span class="line">    show create database db12;</span><br><span class="line">    select database();</span><br><span class="line">删</span><br><span class="line">    drop database db12;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>表</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">文件：</span><br><span class="line">    use db1; # 切换文件夹</span><br><span class="line"></span><br><span class="line">    增</span><br><span class="line">        create table t1(id int,name char(16));</span><br><span class="line">    改</span><br><span class="line">        alter table db1.t1 modify name char(15);</span><br><span class="line">        alter table db1.t1 change name NAME char(10);</span><br><span class="line">        alter table db1.t1 rename db1.t2;</span><br><span class="line">    查</span><br><span class="line">        show tables;</span><br><span class="line">        show create table t1; # 查看创表语句</span><br><span class="line">        desc t1;</span><br><span class="line">        desc db1.t1;</span><br><span class="line"></span><br><span class="line">    删</span><br><span class="line">        drop table db1.t1;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>记录</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">文件中一行行内容</span><br><span class="line">    增</span><br><span class="line">        insert into db1.t1(id,name) values</span><br><span class="line">        (1,&#39;egon&#39;),</span><br><span class="line">        (2,&#39;alexdsb&#39;),</span><br><span class="line">        (3,&#39;wxxsb&#39;);</span><br><span class="line"></span><br><span class="line">        insert into db1.t1(name) values</span><br><span class="line">        (&#39;egon&#39;),</span><br><span class="line">        (&#39;alexdsb&#39;),</span><br><span class="line">        (&#39;wxxsb&#39;);</span><br><span class="line">    改</span><br><span class="line">        update db1.t1 set name&#x3D;&#39;SB&#39; where id&#x3D;3;</span><br><span class="line">    查</span><br><span class="line">        select id,name from db1.t1;</span><br><span class="line"></span><br><span class="line">    删</span><br><span class="line">        delete from db1.t1 where id &gt;&#x3D; 2;</span><br><span class="line"></span><br><span class="line">        # delete 只能用于删除符合条件的某几条记录，不能用于清空表</span><br><span class="line">        delete from t1;</span><br><span class="line"></span><br><span class="line">        # 清空表应该使用truncate,不仅删除所有记录，而且将自增字段的值归0</span><br><span class="line">        truncate t1;</span><br></pre></td></tr></table></figure>



<h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><p>存储引擎就是表的类型(例如文件类型txt pdf)<br> 不同的类型会对应不同处理机制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 查看存储引擎</span><br><span class="line">show engines;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* myisam</span><br><span class="line"># 5.5之前默认</span><br><span class="line">      create table t4(id int)engine&#x3D;&#39;myisam&#39;;</span><br><span class="line">      特点: 速度比innodb快, 但是我们更加注重数据的安全</span><br><span class="line">      文件特点: t4.frm 表结构 </span><br><span class="line">               t4.MYD 表数据</span><br><span class="line">               t4.MYI 索引</span><br><span class="line">      存数据特点: insert into t4 values(1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* innodb</span><br><span class="line"># 5.5之后默认</span><br><span class="line">      create table t3(id int)engine&#x3D;&#39;innodb&#39;;</span><br><span class="line">      特点: 存储数据更加安全; 支持事务(数据安全),行级锁(数据安全), 外键(数据与数据之间的联系)</span><br><span class="line">      文件特点: t3.frm 表结构 </span><br><span class="line">               t3.MYD 表数据</span><br><span class="line">      存数据特点: insert into t3 values(1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* blackhole</span><br><span class="line"># 黑洞  无论存什么，都立刻消失</span><br><span class="line">      create table t5(id int)engine&#x3D;&#39;blackhole&#39;;</span><br><span class="line">      文件特点: t5.frm  只有表结构 </span><br><span class="line">      存数据特点: insert into t5 values(1); 数据没有</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* memory</span><br><span class="line"># 内存引擎(全部存在内存中) 断电数据丢失</span><br><span class="line">      create table t6(id int)engine&#x3D;&#39;memory&#39;;</span><br><span class="line">      文件特点: t6.frm 只有表结构 </span><br><span class="line">      存数据特点: insert into t6 values(1); 重启数据丢失</span><br></pre></td></tr></table></figure>

<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>建表的完整语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table 表名(</span><br><span class="line"> 字段名1 类型[(宽度) 约束条件],</span><br><span class="line"> 字段名2 类型[(宽度) 约束条件],</span><br><span class="line"> 字段名3 类型[(宽度) 约束条件]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：</p>
<ul>
<li><p>同一张表字段名不能重复</p>
</li>
<li><p>宽度和约束条件是可选的；字段名必须的；</p>
<ul>
<li>约束条件支持多个<ul>
<li>字段名1 类型[(宽度) 约束条件1 约束条件2….</li>
</ul>
</li>
</ul>
</li>
<li><p>建表时最后一个字段后一定不要加逗号</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">补充：</span><br><span class="line">    宽度一般是对存储数据的限制，</span><br><span class="line">    create table t7(name char); 默认宽度<span class="number">1</span></span><br><span class="line">    insert into t7 values(<span class="string">&#x27;jason&#x27;</span>);</span><br><span class="line">    5.6 --&gt; 默认没有开启严格模式 规定只能存一个字符 你给了多个字符，那么自动截取</span><br><span class="line">    5.7 --&gt; 默认开启了严格模式，那么规定只能存几个，就不能超，否则报错 Data too long for column &#x27;name&#x27; at row 1</span><br><span class="line">    </span><br><span class="line"><span class="string">&quot;&quot;&quot;严格模式到底开否？&quot;&quot;&quot;</span></span><br><span class="line">MySQL <span class="number">5.7</span>以后默认开启；要开，少让DB干活。</span><br><span class="line"></span><br><span class="line"><span class="comment"># 约束条件 null not null</span></span><br><span class="line">create table t8（id int, name char <span class="keyword">not</span> null）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">宽度：限制数据存储</span></span><br><span class="line"><span class="string">约束条件：在宽度的基础之上增加额外的约束</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">设置sql模式为严格模式</span><br><span class="line">show variables like <span class="string">&quot;%mode&quot;</span>;</span><br><span class="line"><span class="comment"># 全局设置</span></span><br><span class="line">set <span class="keyword">global</span> sql_mode=<span class="string">&quot;strict_trans_tables&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者修改配置文件</span></span><br><span class="line">sql_mode=STRICT_TRANS_TABLES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">需要重启客户端，会重新加载sql_mode</span><br></pre></td></tr></table></figure>



<h3 id="数字类型"><a href="#数字类型" class="headerlink" title="数字类型"></a>数字类型</h3><ul>
<li>整型（默认有符号）  int占用4字节<ul>
<li>TINYINT SMALLINT MEDUIMINT INT BIGINT</li>
<li>年龄，等级，id，号码</li>
</ul>
</li>
<li>浮点型                        float占用4字节<ul>
<li>FLOAT DOUBLE DECIMAL</li>
<li>身高，体重，薪资</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">1.1 整型</span><br><span class="line">    强调：对于整型类型来说，无需指定宽度，默认宽度足够显示。</span><br><span class="line">         数据类型的宽度限制的是显示宽度而非存储宽度；</span><br><span class="line">         </span><br><span class="line">         </span><br><span class="line">         id int(8)</span><br><span class="line">            如果数字没有超出8位，那么默认用空格填充至8位</span><br><span class="line">            超出，有几位存几位（遵守最大范围）</span><br><span class="line">         </span><br><span class="line">    </span><br><span class="line"># tinyint</span><br><span class="line">    create table t7(id tinyint);</span><br><span class="line">    insert into t7 values(-129),(256);</span><br><span class="line">    结论：默认有符号，超出限制只存最大值</span><br><span class="line">    </span><br><span class="line"># tinyint 无符号</span><br><span class="line">    create table t8(id tinyint unsigned);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"># int</span><br><span class="line">    create table t1(id int);</span><br><span class="line">    insert into t1 values(-1),(256);</span><br><span class="line">    结论：默认有符号，可以存负数</span><br><span class="line"></span><br><span class="line"># int 无符号</span><br><span class="line">    create table t2(id int unsigned);</span><br><span class="line">    insert into t2 values(4294967295);</span><br><span class="line">    # 用0 填充</span><br><span class="line">    create table t10(id int(3) unsigned zerofill);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">1.2 浮点型（数的宽度-包含小数，小数位)</span><br><span class="line"></span><br><span class="line">    create table t14(x float(255,30));   # 总共255位，小数30位，整数位就是225</span><br><span class="line">    create table t15(x double(255,30));  # 总共255位，小数30位，整数位就是225</span><br><span class="line">    create table t16(x decimal(65,30));  # 总共65位，小数30位，整数位就是35</span><br><span class="line"></span><br><span class="line">    insert into t14 values(1.111111111111111111111111111111);</span><br><span class="line">    insert into t15 values(1.111111111111111111111111111111);</span><br><span class="line">    insert into t16 values(1.111111111111111111111111111111);</span><br><span class="line">    </span><br><span class="line">    float &lt; double &lt; decimal </span><br><span class="line">    # 要结合实际场景  三者都能用</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210423085136177.png" alt="image-20210423085136177"></p>
<h3 id="字符类型：char-定长-，varchar-变长"><a href="#字符类型：char-定长-，varchar-变长" class="headerlink" title="字符类型：char(定长)，varchar(变长)"></a>字符类型：char(定长)，varchar(变长)</h3><p><strong>ps</strong>: 现在用vachar比较多，<strong>针对不精确问题有时候直接存字符串解决</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">varchar不一定更省内存，当存储额数据刚好到达限制的时候,varchar刚好大一个头部信息1-2bytes    varchar(4) char(4) 存储&#39;abcd&#39;</span><br><span class="line"></span><br><span class="line">char(5)</span><br><span class="line">    优点： 存取都很简单，直接按照固定的字符存取数据即可</span><br><span class="line">    缺点： 浪费空间</span><br><span class="line">    相同点：最大能存放5个字符</span><br><span class="line">    不同点：char 定长</span><br><span class="line">        传入3个字符，那么用空格补全两个空格</span><br><span class="line">        </span><br><span class="line">varchar(5)</span><br><span class="line">    优点: 节省空间</span><br><span class="line">    缺点: 存取较为麻烦（存的时候需要制作报头，取的时候也需要先读取报头，之后才能读取真实数据）</span><br><span class="line">    相同点:最大能存放5个字符</span><br><span class="line">    不同点：</span><br><span class="line">        varchar变长</span><br><span class="line">        传入3个字符，就存3个字符</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create table t22(x char(5));</span><br><span class="line">create table t23(x varchar(5));</span><br><span class="line"></span><br><span class="line">insert into t22 values(&#39;a&#39;);</span><br><span class="line">insert into t23 values(&#39;a&#39;);</span><br><span class="line"></span><br><span class="line"># 统计字段长度</span><br><span class="line">select char_length(x) from t22;</span><br><span class="line">select char_length(x) from t23;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">注意:</span><br><span class="line">1.</span><br><span class="line">    针对char类型，在存放时会将字符补全为5个，然后在查询时又会将末尾补全的空格去掉，如果不想让mysql</span><br><span class="line">    去掉末尾的空格，应该修改sql模式</span><br><span class="line">    set global sql_mode&#x3D;&quot;strict_trans_tables,PAD_CHAR_TO_FULL_LENGTH&quot;</span><br><span class="line"></span><br><span class="line">2.</span><br><span class="line">    查询语句中where  字段&#x3D;“值    ”，会将值右面的空格去掉后再做比较</span><br><span class="line">egon</span><br><span class="line">alex</span><br><span class="line">lxx</span><br><span class="line"></span><br><span class="line">char(5)</span><br><span class="line">egon |alex |lxx  |</span><br><span class="line"></span><br><span class="line">varchar(5)</span><br><span class="line">1bytes+egon|1bytes+alex|1bytes+lxx|</span><br><span class="line"> </span><br></pre></td></tr></table></figure>



<h3 id="日期类型：time，date，datetime，timestamp，year"><a href="#日期类型：time，date，datetime，timestamp，year" class="headerlink" title="日期类型：time，date，datetime，timestamp，year"></a>日期类型：time，date，datetime，timestamp，year</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">date:     年月日      2020-5-4</span><br><span class="line">datetime: 年月日时分秒 2020-5-4 11:12:32</span><br><span class="line">time:     时分秒      11:12:32</span><br><span class="line">timestamp:</span><br><span class="line">year:     2020</span><br><span class="line"></span><br><span class="line">create table student(</span><br><span class="line">    id int primary key auto_increment,</span><br><span class="line">    name char(16),</span><br><span class="line">    born_year year,</span><br><span class="line">    class_time time,</span><br><span class="line">    birth date,</span><br><span class="line">    reg_time datetime</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table stu(</span><br><span class="line">    id int primary key auto_increment,</span><br><span class="line">    name char(16),</span><br><span class="line">    born_year year,</span><br><span class="line">    class_time time,</span><br><span class="line">    birth date,</span><br><span class="line">    reg_time datetime</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into student(name,born_year,class_time,birth,reg_time) values</span><br><span class="line">(&#39;egon1&#39;,now(),now(),now(),now());</span><br><span class="line"></span><br><span class="line">create table t17(x datetime);</span><br><span class="line">create table t18(x timestamp);</span><br><span class="line">create table t19(x datetime not null default now());</span><br></pre></td></tr></table></figure>



<h3 id="枚举类型enum与集合类型set"><a href="#枚举类型enum与集合类型set" class="headerlink" title="枚举类型enum与集合类型set"></a>枚举类型enum与集合类型set</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">enum:多选一</span><br><span class="line">set：多选多</span><br><span class="line"></span><br><span class="line">create table emp(</span><br><span class="line">    id int primary key auto_increment,</span><br><span class="line">    name char(16),</span><br><span class="line">    sex enum(&#39;male&#39;,&#39;female&#39;,&#39;unknow&#39;),</span><br><span class="line">    hobbies set(&#39;play&#39;,&#39;read&#39;,&#39;sleep&#39;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into emp(name,sex,hobbies) values</span><br><span class="line">(&#39;egon&#39;,&#39;male&#39;,&#39;play,read&#39;);</span><br></pre></td></tr></table></figure>




<h2 id="表操作之约束条件"><a href="#表操作之约束条件" class="headerlink" title="表操作之约束条件"></a>表操作之约束条件</h2><p><strong>约束条件：约束条件是在类型之外为字段附加的限制</strong></p>
<h3 id><a href="#" class="headerlink" title></a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create table t2(</span><br><span class="line">    id int,</span><br><span class="line">    name char(16),</span><br><span class="line">    gender enum(&#39;male&#39;, &#39;female&#39;, &#39;others&#39;) default &#39;male&#39;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into t2(id, name) values(1, &#39;alex&#39;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="not-null"><a href="#not-null" class="headerlink" title="not null"></a>not null</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">非空</span><br></pre></td></tr></table></figure>

<h3 id="zerofill"><a href="#zerofill" class="headerlink" title="zerofill"></a>zerofill</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 用0 填充</span><br><span class="line">create table t10(id int(3) unsigned zerofill);</span><br></pre></td></tr></table></figure>

<h3 id="unsigned"><a href="#unsigned" class="headerlink" title="unsigned"></a>unsigned</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># int 无符号</span><br><span class="line">    create table t2(id int unsigned);</span><br><span class="line">    insert into t2 values(4294967295);</span><br></pre></td></tr></table></figure>



<p>###unique key（单列唯一，联合唯一）</p>
<h4 id="单列唯一"><a href="#单列唯一" class="headerlink" title="单列唯一"></a>单列唯一</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;设置唯一约束 UNIQUE&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">方法一：</span><br><span class="line">create table department1(</span><br><span class="line">id int,</span><br><span class="line">name varchar(20) unique,</span><br><span class="line">comment varchar(100)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">方法二：</span><br><span class="line">create table department2(</span><br><span class="line">id int,</span><br><span class="line">name varchar(20),</span><br><span class="line">comment varchar(100),</span><br><span class="line">constraint uk_name unique(name)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; insert into department1 values(1,&#39;IT&#39;,&#39;技术&#39;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">mysql&gt; insert into department1 values(1,&#39;IT&#39;,&#39;技术&#39;);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &#39;IT&#39; for key &#39;name&#39;</span><br><span class="line"></span><br><span class="line">create table t25(x char(5) unique);</span><br><span class="line">create table t26(</span><br><span class="line">    x int,</span><br><span class="line">    y char(5),</span><br><span class="line">    constraint uni_x unique key(x)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="联合唯一"><a href="#联合唯一" class="headerlink" title="联合唯一"></a>联合唯一</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create table services(</span><br><span class="line">    id int,</span><br><span class="line">    name char(16),</span><br><span class="line">    ip char(15),</span><br><span class="line">    port int,</span><br><span class="line">    unique key(ip,port)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="not-null-unqiue-化学反应"><a href="#not-null-unqiue-化学反应" class="headerlink" title="not null +  unqiue 化学反应"></a>not null +  unqiue 化学反应</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table t1(id int not null unique);</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; desc t1;</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| Field | Type    | Null | Key | Default | Extra |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11) | NO   | PRI | NULL    |       |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">not null+unique的化学反应</span><br><span class="line">create table service(</span><br><span class="line">id int primary key auto_increment,</span><br><span class="line">name varchar(20),</span><br><span class="line">host varchar(15) not null,</span><br><span class="line">port int not null,</span><br><span class="line">unique(host,port) #联合唯一</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into service values</span><br><span class="line">    -&gt; (1,&#39;nginx&#39;,&#39;192.168.0.10&#39;,80),</span><br><span class="line">    -&gt; (2,&#39;haproxy&#39;,&#39;192.168.0.20&#39;,80),</span><br><span class="line">    -&gt; (3,&#39;mysql&#39;,&#39;192.168.0.30&#39;,3306)</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 3 rows affected (0.01 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into service(name,host,port) values(&#39;nginx&#39;,&#39;192.168.0.10&#39;,80);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &#39;192.168.0.10-80&#39; for key &#39;host&#39;</span><br></pre></td></tr></table></figure>

<h3 id="primary-key"><a href="#primary-key" class="headerlink" title="primary key"></a>primary key</h3><blockquote>
<p>常用写法 id int primary key auto_increment</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">create table t5(id int primary key);</span><br><span class="line">insert into t5 values(null);</span><br><span class="line">insert into t5 values(1),(2);</span><br><span class="line"></span><br><span class="line">强调：</span><br><span class="line">1. 约束效果上看  primary key =  not null + unique</span><br><span class="line"></span><br><span class="line">2. primary key是innodb存储引擎组织数据的一句</span><br><span class="line">   (1).那么在创建表时，必须定义一个主键且只有一个主键</span><br><span class="line">   (2).没有设置主键时</span><br><span class="line">       1.innodb存储引擎会自上而下寻找一个 不为空且唯一的字段 自动当做主键</span><br><span class="line">       2. 如果不指定并且也没有not null+unique的字段，那么innodb存储引擎会生成一个隐藏的字段当做主键。原因是innodb存储引擎会以主键为准创建聚集索引</span><br><span class="line">       3. 一张表中通常应该有一个id字段并且该字段应该是主键</span><br><span class="line"></span><br><span class="line">3. auto_increment 自增</span><br><span class="line">   注意 auto_increment 通常是加在设置成key键的字段上,不能给普通字段加. 并且一般跟主键一起使用。</span><br><span class="line">     eg: id int primary_key auto_increment;</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 不能设置两个自增字段</span></span></span><br><span class="line">mysql中只能设置一列为自增长，这一列可以是主键，也可以不是主键，如果不是主键，则必须将其设置为一种键(key,即索引)。自增的开始值为表属性，不是字段属性，所以需要在表属性中设置，如要设置自增开始值为10000</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">age 会自动成为主键</span><br><span class="line">create table t3 (</span><br><span class="line">   id int,</span><br><span class="line">   name char(16),</span><br><span class="line">   age int not null unique,</span><br><span class="line">   addr char(32) not null unique</span><br><span class="line">);</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 联合主键(多个字段联合起来作为表的主键，本质还是一个主键)（用的不多）</span></span><br><span class="line">create table t4(</span><br><span class="line">   ip char(16),</span><br><span class="line">   port int,</span><br><span class="line">   primary key(ip,port)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 必须由主键的原因</span></span><br><span class="line">原因:</span><br><span class="line">    为什么一定要有主键,因为MySQL考虑到,你以后要查询的时候会用到。总需要有一个字段作为依据，这个字段就是主键,以这个字段为基础，建立B+tree索引结构，意义是按照主键字段查询的时候可以加速查询。Innodb存储引擎建表的时候一定要有主键，Mysql就会以ID字段为基准造索引，以ID字段查的时候就会用到。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>补充</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete from 在删除表中数据的时候，主键的自增并不会停止</span><br><span class="line">truncate t1 清空表数据并且重置主键</span><br></pre></td></tr></table></figure>

<p>###foreign key(帮助建立表与表关系的字段)</p>
<p>背景：</p>
<p>假设我们要描述所有公司的员工，需要描述的属性有这些 ： 工号 姓名 部门</p>
<p>公司有3个部门，但是有1个亿的员工，那意味着部门这个字段需要重复存储，部门名字越长，越浪费</p>
<p>问题: </p>
<ol>
<li><p>一张表组织结构不是很清晰</p>
</li>
<li><p>浪费硬盘空间</p>
</li>
<li><p>数据的扩展性极差(无法忽视)</p>
</li>
</ol>
<p>解决方法： 我们完全可以定义一个部门表 然后让员工信息表关联该表，如何关联，即foreign key</p>
<blockquote>
<p>表与表关系</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">一对多（**外键建在多的一方**）</span><br><span class="line">多对多（**单独一张表存储关系**）</span><br><span class="line">一对一（**外键建在任意一方，通常航建立在查询较多的表中**）</span><br><span class="line">没有</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如何找出两张表的关系</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">分析步骤：必须双向对比</span><br><span class="line">#1、先站在左表的角度去找</span><br><span class="line">是否左表的多条记录可以对应右表的一条记录，如果是，则证明左表的一个字段foreign key 右表一个字段（通常是id）</span><br><span class="line"></span><br><span class="line">#2、再站在右表的角度去找</span><br><span class="line">是否右表的多条记录可以对应左表的一条记录，如果是，则证明右表的一个字段foreign key 左表一个字段（通常是id）</span><br><span class="line"></span><br><span class="line">#3、总结：</span><br><span class="line">#多对一：</span><br><span class="line">如果只有步骤1成立，则是左表多对一右表</span><br><span class="line">如果只有步骤2成立，则是右表多对一左表</span><br><span class="line"></span><br><span class="line">#多对多</span><br><span class="line">如果步骤1和2同时成立，则证明这两张表时一个双向的多对一，即多对多,需要定义一个这两张表的关系表来专门存放二者的关系</span><br><span class="line"></span><br><span class="line">#一对一:</span><br><span class="line">如果1和2都不成立，而是左表的一条记录唯一对应右表的一条记录，反之亦然。这种情况很简单，就是在左表foreign key右表的基础上，将左表的外键字段设置成unique即可</span><br></pre></td></tr></table></figure>

<h4 id="一对多（-外键建在多的一方-）-级联"><a href="#一对多（-外键建在多的一方-）-级联" class="headerlink" title="一对多（**外键建在多的一方**）  级联"></a>一对多（**<font color="red">外键建在多的一方</font>**）  级联</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">create table dep(</span><br><span class="line">   id int primary key auto_increment,</span><br><span class="line">   dep_name char(16),</span><br><span class="line">   dep_desc char(32)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table emp(</span><br><span class="line">   id int primary key auto_increment,</span><br><span class="line">   name char(16),</span><br><span class="line">   gender enum(&#39;male&#39;,&#39;female&#39;,&#39;others&#39;) default &#39;male&#39;,</span><br><span class="line">   dep_id int,</span><br><span class="line">   foreign key(dep_id) references dep(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into dep values</span><br><span class="line">(1,&#39;欧德博爱技术有限事业部&#39;,&#39;教书育人&#39;),</span><br><span class="line">(2,&#39;艾利克斯人力资源部&#39;, &#39;不做人&#39;),</span><br><span class="line">(3,&#39;销售部&#39;, &#39;忽悠人&#39;);</span><br><span class="line"></span><br><span class="line">insert into emp (id,name,dep_id) values</span><br><span class="line">(1,&#39;egon&#39;,1),</span><br><span class="line">(2,&#39;alex1&#39;,2),</span><br><span class="line">(3,&#39;alex2&#39;,2),</span><br><span class="line">(4,&#39;alex3&#39;,2),</span><br><span class="line">(5,&#39;李坦克&#39;,3),</span><br><span class="line">(6,&#39;刘飞机&#39;,3),</span><br><span class="line">(7,&#39;张火箭&#39;,3),</span><br><span class="line">(8,&#39;林子弹&#39;,3),</span><br><span class="line">(9,&#39;加特林&#39;,3)</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"># 修改dep表里面的id字段</span><br><span class="line">update dep set id&#x3D;200 where id&#x3D;2; 不行</span><br><span class="line"># 删除dep表里面的数据</span><br><span class="line">delete from dep;  不行</span><br><span class="line"># 1. 先删除销售部对应的员工数据 之后删除部门</span><br><span class="line">  操作太过繁琐</span><br><span class="line"># 2. 真正做到数据之间有关系</span><br><span class="line">  更新就同步更新-级联更新</span><br><span class="line">  删除就同步删除-级联删除</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create table dep(</span><br><span class="line">   id int primary key auto_increment,</span><br><span class="line">   dep_name char(16),</span><br><span class="line">   dep_desc char(32)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table emp(</span><br><span class="line">   id int primary key auto_increment,</span><br><span class="line">   name char(16),</span><br><span class="line">   gender enum(&#39;male&#39;,&#39;female&#39;,&#39;others&#39;) default &#39;male&#39;,</span><br><span class="line">   dep_id int,</span><br><span class="line">   foreign key(dep_id) references dep(id)</span><br><span class="line">   on update cascade  # 级联更新</span><br><span class="line">   on delete cascade  # 级联删除</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">create table book(</span><br><span class="line">    id int primary key auto_increment,</span><br><span class="line">    title varchar(32),</span><br><span class="line">    price int</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table author(</span><br><span class="line">    id int primary key auto_increment,</span><br><span class="line">    name varchar(32),</span><br><span class="line">    age int</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table book2author(</span><br><span class="line">    id int primary key auto_increment,</span><br><span class="line">    author_id int,</span><br><span class="line">    book_id int,</span><br><span class="line">    foreign key(author_id) references author(id)</span><br><span class="line">    on update cascade  # 级联更新</span><br><span class="line">    on delete cascade,  # 级联删除</span><br><span class="line">    foreign key(book_id) references book(id)</span><br><span class="line">    on update cascade  # 级联更新</span><br><span class="line">    on delete cascade</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 插入数据</span><br><span class="line">insert into author(name,age) values(&#39;jason&#39;,18),(&#39;egon&#39;,73);</span><br><span class="line">insert into book(title,price) values(&#39;jpm&#39;, 555),(&#39;xxx&#39;,123),(&#39;qwe&#39;,456);</span><br><span class="line">insert into book2author(author_id, book_id) values(1,1),(1,2),(1,3),(2,1),(2,3);</span><br></pre></td></tr></table></figure>

<h4 id="一对一-外键字段在任何一方都可以，建议建在查询频率比较高的表中"><a href="#一对一-外键字段在任何一方都可以，建议建在查询频率比较高的表中" class="headerlink" title="一对一: 外键字段在任何一方都可以，建议建在查询频率比较高的表中"></a>一对一: <strong>外键字段在任何一方都可以，建议建在查询频率比较高的表中</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">如果一个表的字段特别多 每次查询又不是所有的字段都能用的到</span><br><span class="line">将表一分为二</span><br><span class="line"># 示例1</span><br><span class="line">用户表</span><br><span class="line">     用户表</span><br><span class="line">     id name age</span><br><span class="line">     用户详情表</span><br><span class="line">     id addr phone hobby email.....</span><br><span class="line">关联方式：foreign key+unique</span><br><span class="line"></span><br><span class="line">create table authordetail(</span><br><span class="line">    id int primary key auto_increment,</span><br><span class="line">    phone int,</span><br><span class="line">    addr varchar(64)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table authors(</span><br><span class="line">    id int primary key auto_increment,</span><br><span class="line">    name varchar(32),</span><br><span class="line">    age int,</span><br><span class="line">    authordetail_id int unique,</span><br><span class="line">    foreign key(authordetail_id) references authordetail(id)</span><br><span class="line">    on update cascade  # 级联更新</span><br><span class="line">    on delete cascade</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;&quot;</span><br><span class="line">表与表如果有关系的话，可以有两种建立联系的方式</span><br><span class="line">    1.通过外键强制性的建立关系</span><br><span class="line">    2.通过sql语句逻辑层面上建立联系，必须多写几条sql语句，动一条数据，相关联数据也通过sql删除</span><br><span class="line">      delete from emp where id&#x3D;1;</span><br><span class="line">      delete from dep where id&#x3D;1;</span><br><span class="line"></span><br><span class="line">创建外键需要消耗一定的资源 并且增加了表与表之间的耦合度</span><br><span class="line">在实际项目中，如果表特别多  其实可以不做任何外键处理，直接通过sql语句来建立逻辑层面上的关系</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>



<p><strong>主键、外键和索引的区别</strong></p>
<ol>
<li>定义</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">主键：唯一标识一条记录，不能有重复，不允许为空。</span><br><span class="line">外键：表的外键是另一表的主键，外键是可以有重复的，可以是空值。</span><br><span class="line">索引：该字段没有重复值，但可以有一个空值。</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>作用</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">主键：用来保证数据完整性</span><br><span class="line">外键：用来和其他表建立联系用</span><br><span class="line">索引：用来提高查询排序的速度</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>个数</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">主键：主键只能有一个。</span><br><span class="line">外键：一个表可以有多个外键。</span><br><span class="line">索引：一个表可以有多个唯一索引。</span><br></pre></td></tr></table></figure>















<blockquote>
<p>引用其他博客</p>
</blockquote>
<h4 id="创造外键的条件"><a href="#创造外键的条件" class="headerlink" title="创造外键的条件"></a>创造外键的条件</h4><pre><code>mysql&gt; create table departments (dep_id int(4),dep_name varchar(11));
Query OK, 0 rows affected (0.02 sec)

mysql&gt; desc departments;
+----------+-------------+------+-----+---------+-------+
| Field    | Type        | Null | Key | Default | Extra |
+----------+-------------+------+-----+---------+-------+
| dep_id   | int(4)      | YES  |     | NULL    |       |
| dep_name | varchar(11) | YES  |     | NULL    |       |
+----------+-------------+------+-----+---------+-------+
rows in set (0.00 sec)

# 创建外键不成功
mysql&gt; create table staff_info (s_id int,name varchar(20),dep_id int,foreign key(dep_id) references departments(dep_id));
ERROR 1215 (HY000): Cannot add foreign key 

# 设置dep_id非空，仍然不能成功创建外键
mysql&gt; alter table departments modify dep_id int(4) not null;
Query OK, 0 rows affected (0.02 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; desc departments;
+----------+-------------+------+-----+---------+-------+
| Field    | Type        | Null | Key | Default | Extra |
+----------+-------------+------+-----+---------+-------+
| dep_id   | int(4)      | NO   |     | NULL    |       |
| dep_name | varchar(11) | YES  |     | NULL    |       |
+----------+-------------+------+-----+---------+-------+
rows in set (0.00 sec)

mysql&gt; create table staff_info (s_id int,name varchar(20),dep_id int,foreign key(dep_id) references departments(dep_id));
ERROR 1215 (HY000): Cannot add foreign key constraint

# 当设置字段为unique唯一字段时，设置该字段为外键成功
mysql&gt; alter table departments modify dep_id int(4) unique;
Query OK, 0 rows affected (0.01 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; desc departments;                                                                                                       +----------+-------------+------+-----+---------+-------+
| Field    | Type        | Null | Key | Default | Extra |
+----------+-------------+------+-----+---------+-------+
| dep_id   | int(4)      | YES  | UNI | NULL    |       |
| dep_name | varchar(11) | YES  |     | NULL    |       |
+----------+-------------+------+-----+---------+-------+
rows in set (0.01 sec)

mysql&gt; create table staff_info (s_id int,name varchar(20),dep_id int,foreign key(dep_id) references departments(dep_id));
Query OK, 0 rows affected (0.02 sec)
多对一：单向的多对一
多对多：双向的多对一
一对一：</code></pre>
<h4 id="外键操作示例"><a href="#外键操作示例" class="headerlink" title="外键操作示例"></a>外键操作示例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">#表类型必须是innodb存储引擎，且被关联的字段，即references指定的另外一个表的字段，必须保证唯一</span><br><span class="line">create table department(</span><br><span class="line">id int primary key,</span><br><span class="line">name varchar(20) not null</span><br><span class="line">)engine&#x3D;innodb;</span><br><span class="line"></span><br><span class="line">#dpt_id外键，关联父表（department主键id），同步更新，同步删除</span><br><span class="line">create table employee(</span><br><span class="line">id int primary key,</span><br><span class="line">name varchar(20) not null,</span><br><span class="line">dpt_id int,</span><br><span class="line">foreign key(dpt_id)</span><br><span class="line">references department(id)</span><br><span class="line">on delete cascade  # 级连删除</span><br><span class="line">on update cascade # 级连更新</span><br><span class="line">)engine&#x3D;innodb;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#先往父表department中插入记录</span><br><span class="line">insert into department values</span><br><span class="line">(1,&#39;教质部&#39;),</span><br><span class="line">(2,&#39;技术部&#39;),</span><br><span class="line">(3,&#39;人力资源部&#39;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#再往子表employee中插入记录</span><br><span class="line">insert into employee values</span><br><span class="line">(1,&#39;jason&#39;,1),</span><br><span class="line">(2,&#39;oscar&#39;,2),</span><br><span class="line">(3,&#39;lqz&#39;,2),</span><br><span class="line">(4,&#39;tank&#39;,2),</span><br><span class="line">(5,&#39;mac&#39;,3),</span><br><span class="line">(6,&#39;李沁洋&#39;,3),</span><br><span class="line">(7,&#39;皮卡丘&#39;,3),</span><br><span class="line">(8,&#39;程咬金&#39;,3),</span><br><span class="line">(9,&#39;程咬银&#39;,3)</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删父表department，子表employee中对应的记录跟着删</span><br><span class="line">mysql&gt; delete from department where id&#x3D;2;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from employee;</span><br><span class="line">+----+-----------+--------+</span><br><span class="line">| id | name      | dpt_id |</span><br><span class="line">+----+-----------+--------+</span><br><span class="line">|  1 | jason      |      1 |</span><br><span class="line">|  5 | mac     |      3 |</span><br><span class="line">|  6 | 李沁洋    |      3 |</span><br><span class="line">|  7 | 皮卡丘    |      3 |</span><br><span class="line">|  8 | 程咬金    |      3 |</span><br><span class="line">|  9 | 程咬银    |      3 |</span><br><span class="line">+----+-----------+--------+</span><br><span class="line">rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#更新父表department，子表employee中对应的记录跟着改</span><br><span class="line">mysql&gt; update department set id&#x3D;2 where id&#x3D;3;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from employee;</span><br><span class="line">+----+-----------+--------+</span><br><span class="line">| id | name      | dpt_id |</span><br><span class="line">+----+-----------+--------+</span><br><span class="line">|  1 | jason      |      1 |</span><br><span class="line">|  5 | mac     |      2 |</span><br><span class="line">|  6 | 李沁洋    |      2 |</span><br><span class="line">|  7 | 皮卡丘    |      2 |</span><br><span class="line">|  8 | 程咬金    |      2 |</span><br><span class="line">|  9 | 程咬银    |      2 |</span><br><span class="line">+----+-----------+--------+</span><br><span class="line">rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="on-delete"><a href="#on-delete" class="headerlink" title="on delete"></a>on delete</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#  cascade方式</span><br><span class="line">在父表上update&#x2F;delete记录时，同步update&#x2F;delete掉子表的匹配记录 </span><br><span class="line"></span><br><span class="line">#  set null方式</span><br><span class="line">在父表上update&#x2F;delete记录时，将子表上匹配记录的列设为null</span><br><span class="line">要注意子表的外键列不能为not null  </span><br><span class="line"></span><br><span class="line">#  No action方式</span><br><span class="line">如果子表中有匹配的记录,则不允许对父表对应候选键进行update&#x2F;delete操作  </span><br><span class="line"></span><br><span class="line">#  Restrict方式</span><br><span class="line">同no action, 都是立即检查外键约束</span><br><span class="line"></span><br><span class="line">#  Set default方式</span><br><span class="line">父表有变更时,子表将外键列设置成一个默认的值 但Innodb不能识别</span><br></pre></td></tr></table></figure>

<h3 id="修改表"><a href="#修改表" class="headerlink" title="修改表"></a>修改表</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MySQL对大小写不敏感</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1. 修改表名</span></span><br><span class="line"><span class="string">    alter table 表名 rename 新表名</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 增加字段</span></span><br><span class="line"><span class="string">    alter table 表名 add 字段名 字段类型(宽度)  约束条件; # 默认在最后</span></span><br><span class="line"><span class="string">    alter table 表名 add 字段名 字段类型(宽度)  约束条件 first;</span></span><br><span class="line"><span class="string">    alter table 表名 add 字段名 字段类型(宽度)  约束条件 after 字段名;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. 删除字段</span></span><br><span class="line"><span class="string">        alter table 表名 drop 字段名</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">4. 修改字段</span></span><br><span class="line"><span class="string">    alter table 表名 modify 字段名 字段类型(宽度) 约束条件;</span></span><br><span class="line"><span class="string">    alter table 表名 change 旧字段名 新字段名 字段类型(宽度) 约束条件;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="复制表"><a href="#复制表" class="headerlink" title="复制表"></a>复制表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;&quot;</span><br><span class="line">sql查询结果就是一张虚拟表</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">create table 表名 select * from 旧表;   不能复制表结构，主键 外键。。。</span><br></pre></td></tr></table></figure>



<h2 id="记录相关操作"><a href="#记录相关操作" class="headerlink" title="记录相关操作"></a>记录相关操作</h2><h3 id="插入数据INSERT"><a href="#插入数据INSERT" class="headerlink" title="插入数据INSERT"></a>插入数据INSERT</h3><h3 id="更新数据UPDATE"><a href="#更新数据UPDATE" class="headerlink" title="更新数据UPDATE"></a>更新数据UPDATE</h3><h3 id="删除数据DELETE"><a href="#删除数据DELETE" class="headerlink" title="删除数据DELETE"></a>删除数据DELETE</h3><h3 id="查询数据SELECT"><a href="#查询数据SELECT" class="headerlink" title="查询数据SELECT"></a>查询数据SELECT</h3><h4 id="单表查询"><a href="#单表查询" class="headerlink" title="单表查询"></a>单表查询</h4><ul>
<li>单表查询语法:<ul>
<li>select distinct 字段1,字段2,字段3,… from 表名</li>
<li>where 条件</li>
<li>group by 分组的字段</li>
<li>having 条件</li>
<li>order by 排序字段</li>
<li>limit 限制显示的条数;</li>
</ul>
</li>
</ul>
<p>创建表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">company.employee</span><br><span class="line">    员工id      id                  int             </span><br><span class="line">    姓名        emp_name            varchar</span><br><span class="line">    性别        sex                 enum</span><br><span class="line">    年龄        age                 int</span><br><span class="line">    入职日期     hire_date           date</span><br><span class="line">    岗位        post                varchar</span><br><span class="line">    职位描述     post_comment        varchar</span><br><span class="line">    薪水        salary              double</span><br><span class="line">    办公室       office              int</span><br><span class="line">    部门编号     depart_id           int</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建表</span><br><span class="line">create table employee(</span><br><span class="line">id int not null unique auto_increment,</span><br><span class="line">name varchar(20) not null,</span><br><span class="line">sex enum(&#39;male&#39;,&#39;female&#39;) not null default &#39;male&#39;, #大部分是男的</span><br><span class="line">age int(3) unsigned not null default 28,</span><br><span class="line">hire_date date not null,</span><br><span class="line">post varchar(50),</span><br><span class="line">post_comment varchar(100),</span><br><span class="line">salary double(15,2),</span><br><span class="line">office int, #一个部门一个屋子</span><br><span class="line">depart_id int</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看表结构</span><br><span class="line">mysql&gt; desc employee;</span><br><span class="line">+--------------+-----------------------+------+-----+---------+----------------+</span><br><span class="line">| Field        | Type                  | Null | Key | Default | Extra          |</span><br><span class="line">+--------------+-----------------------+------+-----+---------+----------------+</span><br><span class="line">| id           | int(11)               | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name         | varchar(20)           | NO   |     | NULL    |                |</span><br><span class="line">| sex          | enum(&#39;male&#39;,&#39;female&#39;) | NO   |     | male    |                |</span><br><span class="line">| age          | int(3) unsigned       | NO   |     | 28      |                |</span><br><span class="line">| hire_date    | date                  | NO   |     | NULL    |                |</span><br><span class="line">| post         | varchar(50)           | YES  |     | NULL    |                |</span><br><span class="line">| post_comment | varchar(100)          | YES  |     | NULL    |                |</span><br><span class="line">| salary       | double(15,2)          | YES  |     | NULL    |                |</span><br><span class="line">| office       | int(11)               | YES  |     | NULL    |                |</span><br><span class="line">| depart_id    | int(11)               | YES  |     | NULL    |                |</span><br><span class="line">+--------------+-----------------------+------+-----+---------+----------------+</span><br><span class="line"></span><br><span class="line">#插入记录</span><br><span class="line">#三个部门：教学，销售，运营</span><br><span class="line">insert into employee(name,sex,age,hire_date,post,salary,office,depart_id) values</span><br><span class="line">(&#39;egon&#39;,&#39;male&#39;,18,&#39;20170301&#39;,&#39;老男孩驻沙河办事处外交大使&#39;,7300.33,401,1), #以下是教学部</span><br><span class="line">(&#39;alex&#39;,&#39;male&#39;,78,&#39;20150302&#39;,&#39;teacher&#39;,1000000.31,401,1),</span><br><span class="line">(&#39;wupeiqi&#39;,&#39;male&#39;,81,&#39;20130305&#39;,&#39;teacher&#39;,8300,401,1),</span><br><span class="line">(&#39;yuanhao&#39;,&#39;male&#39;,73,&#39;20140701&#39;,&#39;teacher&#39;,3500,401,1),</span><br><span class="line">(&#39;liwenzhou&#39;,&#39;male&#39;,28,&#39;20121101&#39;,&#39;teacher&#39;,2100,401,1),</span><br><span class="line">(&#39;jingliyang&#39;,&#39;female&#39;,18,&#39;20110211&#39;,&#39;teacher&#39;,9000,401,1),</span><br><span class="line">(&#39;jinxin&#39;,&#39;male&#39;,18,&#39;19000301&#39;,&#39;teacher&#39;,30000,401,1),</span><br><span class="line">(&#39;成龙&#39;,&#39;male&#39;,48,&#39;20101111&#39;,&#39;teacher&#39;,10000,401,1),</span><br><span class="line"></span><br><span class="line">(&#39;歪歪&#39;,&#39;female&#39;,48,&#39;20150311&#39;,&#39;sale&#39;,3000.13,402,2),#以下是销售部门</span><br><span class="line">(&#39;丫丫&#39;,&#39;female&#39;,38,&#39;20101101&#39;,&#39;sale&#39;,2000.35,402,2),</span><br><span class="line">(&#39;丁丁&#39;,&#39;female&#39;,18,&#39;20110312&#39;,&#39;sale&#39;,1000.37,402,2),</span><br><span class="line">(&#39;星星&#39;,&#39;female&#39;,18,&#39;20160513&#39;,&#39;sale&#39;,3000.29,402,2),</span><br><span class="line">(&#39;格格&#39;,&#39;female&#39;,28,&#39;20170127&#39;,&#39;sale&#39;,4000.33,402,2),</span><br><span class="line"></span><br><span class="line">(&#39;张野&#39;,&#39;male&#39;,28,&#39;20160311&#39;,&#39;operation&#39;,10000.13,403,3), #以下是运营部门</span><br><span class="line">(&#39;程咬金&#39;,&#39;male&#39;,18,&#39;19970312&#39;,&#39;operation&#39;,20000,403,3),</span><br><span class="line">(&#39;程咬银&#39;,&#39;female&#39;,18,&#39;20130311&#39;,&#39;operation&#39;,19000,403,3),</span><br><span class="line">(&#39;程咬铜&#39;,&#39;male&#39;,18,&#39;20150411&#39;,&#39;operation&#39;,18000,403,3),</span><br><span class="line">(&#39;程咬铁&#39;,&#39;female&#39;,18,&#39;20140512&#39;,&#39;operation&#39;,17000,403,3)</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">#ps：如果在windows系统中，插入中文字符，select的结果为空白，可以将所有字符编码统一设置成gbk</span><br><span class="line"></span><br><span class="line">准备表和记录</span><br></pre></td></tr></table></figure>

<h5 id="书写建议"><a href="#书写建议" class="headerlink" title="书写建议"></a>书写建议</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 书写</span><br><span class="line">select id,name from emp where id &gt; 3;</span><br><span class="line"># 执行顺序</span><br><span class="line">from</span><br><span class="line">where</span><br><span class="line">select</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">虽然执行顺序和书写顺序不一致 你在写sql语句的时候可能不知道怎么写</span><br><span class="line">你就按照书写顺序的方式写sql</span><br><span class="line">    select * 占位</span><br><span class="line">    补全sql语句</span><br><span class="line">    * 替换成想要的具体字段</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<h5 id="几个重要关键字的执行顺序"><a href="#几个重要关键字的执行顺序" class="headerlink" title="几个重要关键字的执行顺序"></a>几个重要关键字的执行顺序</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">执行优先级</span><br><span class="line"><span class="number">1.</span>找到表:<span class="keyword">from</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>拿着where指定的约束条件，去文件/表中取出一条条记录</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>将取出的一条条记录进行分组group by，如果没有group by，则整体作为一组</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>将分组的结果进行having过滤</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>执行select</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>去重</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>将结果按条件排序：order by</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span>限制结果的显示条数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">from</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">where</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">group</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">having</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">distinct</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">limit</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select</span>():</span></span><br><span class="line">    f=<span class="keyword">from</span>()</span><br><span class="line">    vt1=where(f,条件)</span><br><span class="line">    vt2=group(v1,分组字段)</span><br><span class="line">    vt3=having(vt2,条件)</span><br><span class="line">    vt4=distinct(vt3)</span><br><span class="line">    vt5=order(vt4,排序的字段)</span><br><span class="line">    vt6=limit(vt5,限制显示的条数)</span><br><span class="line">    print(vt6)</span><br></pre></td></tr></table></figure>

<h5 id="where约束条件"><a href="#where约束条件" class="headerlink" title="where约束条件"></a>where约束条件</h5><p>where字句中可以使用：</p>
<ol>
<li>比较运算符：&gt; &lt; &gt;= &lt;= &lt;&gt; !=</li>
<li>between 80 and 100 值在10到20之间</li>
<li>in(80,90,100) 值是10或20或30</li>
<li>like ‘egon%’<br>  pattern可以是%或_，<br>  %表示任意多字符<br>  _表示一个字符</li>
<li>逻辑运算符：在多个条件直接可以使用逻辑运算符 and or not</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#1:单条件查询</span><br><span class="line">    SELECT name FROM employee</span><br><span class="line">        WHERE post&#x3D;&#39;sale&#39;;</span><br><span class="line">        </span><br><span class="line">#2:多条件查询</span><br><span class="line">    SELECT name,salary FROM employee</span><br><span class="line">        WHERE post&#x3D;&#39;teacher&#39; AND salary&gt;10000;</span><br><span class="line"></span><br><span class="line">#3:关键字BETWEEN AND</span><br><span class="line">    SELECT name,salary FROM employee </span><br><span class="line">        WHERE salary BETWEEN 10000 AND 20000;</span><br><span class="line"></span><br><span class="line">    SELECT name,salary FROM employee </span><br><span class="line">        WHERE salary NOT BETWEEN 10000 AND 20000;</span><br><span class="line">    </span><br><span class="line">#4:关键字IS NULL(判断某个字段是否为NULL不能用等号，需要用IS)</span><br><span class="line">    SELECT name,post_comment FROM employee </span><br><span class="line">        WHERE post_comment IS NULL;</span><br><span class="line"></span><br><span class="line">    SELECT name,post_comment FROM employee </span><br><span class="line">        WHERE post_comment IS NOT NULL;</span><br><span class="line">        </span><br><span class="line">    SELECT name,post_comment FROM employee </span><br><span class="line">        WHERE post_comment&#x3D;&#39;&#39;; 注意&#39;&#39;是空字符串，不是null</span><br><span class="line">    ps：</span><br><span class="line">        执行</span><br><span class="line">        update employee set post_comment&#x3D;&#39;&#39; where id&#x3D;2;</span><br><span class="line">        再用上条查看，就会有结果了</span><br><span class="line"></span><br><span class="line">#5:关键字IN集合查询</span><br><span class="line">    SELECT name,salary FROM employee </span><br><span class="line">        WHERE salary&#x3D;3000 OR salary&#x3D;3500 OR salary&#x3D;4000 OR salary&#x3D;9000 ;</span><br><span class="line">    </span><br><span class="line">    SELECT name,salary FROM employee </span><br><span class="line">        WHERE salary IN (3000,3500,4000,9000) ;</span><br><span class="line"></span><br><span class="line">    SELECT name,salary FROM employee </span><br><span class="line">        WHERE salary NOT IN (3000,3500,4000,9000) ;</span><br><span class="line"></span><br><span class="line">#6:关键字LIKE模糊查询</span><br><span class="line">    通配符’%’</span><br><span class="line">    SELECT * FROM employee </span><br><span class="line">            WHERE name LIKE &#39;eg%&#39;;</span><br><span class="line"></span><br><span class="line">    通配符’_’</span><br><span class="line">    SELECT * FROM employee </span><br><span class="line">            WHERE name LIKE &#39;al__&#39;;</span><br></pre></td></tr></table></figure>

<h5 id="分组查询-GROUP-BY"><a href="#分组查询-GROUP-BY" class="headerlink" title="分组查询:GROUP BY"></a>分组查询:GROUP BY</h5><p><strong>什么是分组？为什么要分组？</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#1、首先明确一点：分组发生在where之后，即分组是基于where之后得到的记录而进行的</span><br><span class="line"></span><br><span class="line">#2、分组指的是：将所有记录按照某个相同字段进行归类，比如针对员工信息表的职位分组，或者按照性别进行分组等</span><br><span class="line"></span><br><span class="line">#3、为何要分组呢？</span><br><span class="line">    取每个部门的最高工资</span><br><span class="line">    取每个部门的员工数</span><br><span class="line">    取男人数和女人数</span><br><span class="line"></span><br><span class="line">小窍门：‘每’这个字后面的字段，就是我们分组的依据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#4、大前提：</span><br><span class="line">    可以按照任意字段分组，但是分组完毕后，比如group by post，只能查看post字段，如果想查看组内信息，需要借助于聚合函数</span><br></pre></td></tr></table></figure>

<p><strong>ONLY_FULL_GROUP_BY</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#查看MySQL 5.7默认的sql_mode如下：</span><br><span class="line">mysql&gt; select @@global.sql_mode;</span><br><span class="line">ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br><span class="line"></span><br><span class="line">#！！！注意</span><br><span class="line">ONLY_FULL_GROUP_BY的语义就是确定select target list中的所有列的值都是明确语义，简单的说来，在ONLY_FULL_GROUP_BY模式下，target list中的值要么是来自于聚集函数的结果，要么是来自于group by list中的表达式的值。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#设置sql_mole如下操作(我们可以去掉ONLY_FULL_GROUP_BY模式)：</span><br><span class="line">mysql&gt; set global sql_mode&#x3D;&#39;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#39;;</span><br><span class="line"></span><br><span class="line">！！！SQL_MODE设置！！！</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@global.sql_mode;</span><br><span class="line">+-------------------+</span><br><span class="line">| @@global.sql_mode |</span><br><span class="line">+-------------------+</span><br><span class="line">|                   |</span><br><span class="line">+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from emp group by post; </span><br><span class="line">+----+------+--------+-----+------------+----------------------------+--------------+------------+--------+-----------+</span><br><span class="line">| id | name | sex    | age | hire_date  | post                       | post_comment | salary     | office | depart_id |</span><br><span class="line">+----+------+--------+-----+------------+----------------------------+--------------+------------+--------+-----------+</span><br><span class="line">| 14 | 张野 | male   |  28 | 2016-03-11 | operation                  | NULL         |   10000.13 |    403 |         3 |</span><br><span class="line">|  9 | 歪歪 | female |  48 | 2015-03-11 | sale                       | NULL         |    3000.13 |    402 |         2 |</span><br><span class="line">|  2 | alex | male   |  78 | 2015-03-02 | teacher                    | NULL         | 1000000.31 |    401 |         1 |</span><br><span class="line">|  1 | egon | male   |  18 | 2017-03-01 | 老男孩驻沙河办事处外交大使 | NULL         |    7300.33 |    401 |         1 |</span><br><span class="line">+----+------+--------+-----+------------+----------------------------+--------------+------------+--------+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#由于没有设置ONLY_FULL_GROUP_BY,于是也可以有结果，默认都是组内的第一条记录，但其实这是没有意义的</span><br><span class="line"></span><br><span class="line">mysql&gt; set global sql_mode&#x3D;&#39;ONLY_FULL_GROUP_BY&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit #设置成功后，一定要退出，然后重新登录方可生效</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line">mysql&gt; use db1;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; select * from emp group by post; #报错</span><br><span class="line">ERROR 1055 (42000): &#39;db1.emp.id&#39; isn&#39;t in GROUP BY</span><br><span class="line">mysql&gt; select post,count(id) from emp group by post; #只能查看分组依据和使用聚合函数</span><br><span class="line">+----------------------------+-----------+</span><br><span class="line">| post                       | count(id) |</span><br><span class="line">+----------------------------+-----------+</span><br><span class="line">| operation                  |         5 |</span><br><span class="line">| sale                       |         5 |</span><br><span class="line">| teacher                    |         7 |</span><br><span class="line">| 老男孩驻沙河办事处外交大使 |         1 |</span><br><span class="line">+----------------------------+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>GROUP BY</strong>（GROUP_CONCAT，CONCAT）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 碰到的关键字一般使用group by</span><br><span class="line">每个 最高 最低 平均</span><br><span class="line"></span><br><span class="line">单独使用GROUP BY关键字分组</span><br><span class="line">    SELECT post FROM employee GROUP BY post;</span><br><span class="line">    注意：我们按照post字段分组，那么select查询的字段只能是post，想要获取组内的其他相关信息，需要借助函数</span><br><span class="line"></span><br><span class="line"># GROUP_CONCAT 获取分组之后的其他字段的值，还可以拼接操作</span><br><span class="line">GROUP BY关键字和GROUP_CONCAT()函数一起使用 (分组之后帮助获取组内单个元素某一个字段对应数据帮助拼接起来)</span><br><span class="line">    SELECT post,GROUP_CONCAT(name) FROM employee GROUP BY post;#按照岗位分组，并查看组内成员名</span><br><span class="line">    SELECT post,GROUP_CONCAT(name) as emp_members FROM employee GROUP BY post;</span><br><span class="line">    # 还可以拼接</span><br><span class="line">    SELECT post,GROUP_CONCAT(name,&#39;_DSB&#39;) as emp_members FROM employee GROUP BY post;</span><br><span class="line">    SELECT post,GROUP_CONCAT(name,&#39;,&#39;,salary) as emp_members FROM employee GROUP BY post;</span><br><span class="line"></span><br><span class="line"># CONCAT 不分组的时候 拼接操作用</span><br><span class="line">    select concat(&#39;NAME:&#39;, name),concat(&#39;SAL:&#39;,salary) from emp;</span><br><span class="line"># CONCAT_WS 如果多个字段之间的连接符号是相同的情况下，可以直接使用concat_ws来完成</span><br><span class="line">    select concat_ws(&#39;:&#39;,name,age,sex) from emp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GROUP BY与聚合函数一起使用</span><br><span class="line">    select post,count(id) as count from employee group by post;#按照岗位分组，并查看每个组有多少人</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"># 补充: as 不单单可以给字段起别名，还可以临时给表起别名</span><br><span class="line">select emp.id,emp.name from employee;</span><br><span class="line">select emp.id,emp.name from employee as t1; 报错</span><br><span class="line">select t1.id,t1.name from employee as t1;</span><br><span class="line"></span><br><span class="line"># 查询每个人的年薪</span><br><span class="line">select name,salary*12 from employee group by name;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>强调</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果我们用unique的字段作为分组的依据，则每一条记录自成一组，这种分组没有意义</span><br><span class="line">多条记录之间的某个字段值相同，该字段通常用来作为分组的依据</span><br></pre></td></tr></table></figure>

<p><strong>聚合函数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#强调：聚合函数聚合的是组的内容，若是没有分组，则默认一组</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">    SELECT COUNT(*) FROM employee; # 计数，id最常用</span><br><span class="line">    SELECT COUNT(*) FROM employee WHERE depart_id&#x3D;1;</span><br><span class="line">    SELECT MAX(salary) FROM employee;</span><br><span class="line">    SELECT MIN(salary) FROM employee;</span><br><span class="line">    SELECT AVG(salary) FROM employee;</span><br><span class="line">    SELECT SUM(salary) FROM employee;</span><br><span class="line">    SELECT SUM(salary) FROM employee WHERE depart_id&#x3D;3;</span><br></pre></td></tr></table></figure>

<p><strong>注意事项</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 关键字where 和 group by同时出现的时候group by必须在where 后面</span><br><span class="line">where 先对整体数据进行过滤之后再分组操作</span><br><span class="line">where 筛选条件不能使用聚合函数</span><br><span class="line">select id,name,age from employee where max(salary) &gt; 3000;</span><br><span class="line"></span><br><span class="line">select max(salary) from emp;</span><br><span class="line"></span><br><span class="line"># 统计各部门年龄在30岁以上的员工平均薪资</span><br><span class="line">select post, AVG(salary),group_concat(name) from employee where age &gt; 30 group by post;</span><br></pre></td></tr></table></figure>

<h5 id="HAVING过滤-分组之后的筛选条件"><a href="#HAVING过滤-分组之后的筛选条件" class="headerlink" title="HAVING过滤,分组之后的筛选条件"></a><strong>HAVING过滤</strong>,分组之后的筛选条件</h5><p>“””</p>
<p>Having 的语法和where 是一致的</p>
<p>只不过having是在分组之后进行的过滤操作</p>
<p>即having是可以直接使用聚合函数的</p>
<p>“””</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 统计各部门年龄在30以上的平均工资并且保留平均薪资大于10000的部门</span><br><span class="line">select post,avg(salary) from employee where age&gt;30 group by psot having avg(salary) &gt; 10000;</span><br></pre></td></tr></table></figure>

<h5 id="distinct-去重"><a href="#distinct-去重" class="headerlink" title="distinct 去重"></a>distinct 去重</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;&quot;</span><br><span class="line">一定要注意 必须是完全一样的数据才可以去重！！！</span><br><span class="line">一定不要将主键忽视，有主键的情况下，是不可能去重复的；</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;&#39;id&#39;:1,&#39;name&#39;:&#39;Jason&#39;,&#39;age&#39;:18&#125;,</span><br><span class="line">  &#123;&#39;id&#39;:2,&#39;name&#39;:&#39;Jason&#39;,&#39;age&#39;:18&#125;,</span><br><span class="line">  &#123;&#39;id&#39;:3,&#39;name&#39;:&#39;Egon&#39;,&#39;age&#39;:18&#125;,</span><br><span class="line">]</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">select distinct id,age from employee;</span><br><span class="line">select distinct age from employee;</span><br></pre></td></tr></table></figure>

<p><strong>查询排序:ORDER BY</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 按单列排序</span><br><span class="line">    SELECT * FROM employee ORDER BY salary;</span><br><span class="line">    SELECT * FROM employee ORDER BY salary ASC;</span><br><span class="line">    SELECT * FROM employee ORDER BY salary DESC;</span><br><span class="line"></span><br><span class="line"># 按多列排序:先按照age降序排序，如果年纪相同，则按照薪资排序(升序)</span><br><span class="line">    SELECT * from employee</span><br><span class="line">        ORDER BY age,</span><br><span class="line">        salary DESC;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 统计各部门年龄唉10岁以上的员工平均工资并且保留平均薪资大于1000的部门，然后对平均工资进行降序。</span><br><span class="line">select post,avg(salary) from employee where age&gt;10 group by post Having avg(salary)&gt;10000 order by avg(salary) Desc;</span><br></pre></td></tr></table></figure>

<p><strong>限制查询的记录数:LIMIT</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">    SELECT * FROM employee ORDER BY salary DESC </span><br><span class="line">        LIMIT 3;                    #默认初始位置为0 </span><br><span class="line">    </span><br><span class="line">    SELECT * FROM employee ORDER BY salary DESC</span><br><span class="line">        LIMIT 0,5; #从第0开始，即先查询出第一条，然后包含这一条在内往后查5条</span><br><span class="line"></span><br><span class="line">    SELECT * FROM employee ORDER BY salary DESC</span><br><span class="line">        LIMIT 5,5; #从第5开始，即先查询出第6条，然后包含这一条在内往后查5条</span><br></pre></td></tr></table></figure>

<p><strong>正则</strong>（REGEXP）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM employee WHERE name REGEXP &#39;^ale&#39;;</span><br><span class="line"></span><br><span class="line">SELECT * FROM employee WHERE name REGEXP &#39;on$&#39;;</span><br><span class="line"></span><br><span class="line">SELECT * FROM employee WHERE name REGEXP &#39;m&#123;2&#125;&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">小结：对字符串匹配的方式</span><br><span class="line">WHERE name &#x3D; &#39;egon&#39;;</span><br><span class="line">WHERE name LIKE &#39;yua%&#39;;</span><br><span class="line">WHERE name REGEXP &#39;on$&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">正则表达式：</span><br><span class="line">      用一些特殊符号的组合去字符串中筛选出符合条件的数据。</span><br><span class="line"></span><br><span class="line">1. re模块常用方法</span><br><span class="line">          match: 从头开始匹配</span><br><span class="line">          search: 从整体匹配</span><br><span class="line">          findall: 分组优先展示</span><br><span class="line">                   ^j.*(n|y)$</span><br><span class="line">                   不会展示所有正则表达式匹配到的内容</span><br><span class="line">                   而仅仅展示括号内的正则表达式匹配到的内容</span><br><span class="line">2. 贪婪非贪婪</span><br><span class="line">   正则表达式都是贪婪匹配的，</span><br><span class="line">   将贪婪变成非贪婪职业需要在正则表达式后面加？</span><br><span class="line">   .*  贪婪</span><br><span class="line">   .*? 非贪婪</span><br></pre></td></tr></table></figure>



<h4 id="-1"><a href="#-1" class="headerlink" title></a></h4><h4 id="连表操作-连表查询-子查询"><a href="#连表操作-连表查询-子查询" class="headerlink" title="连表操作(连表查询+子查询)"></a>连表操作(连表查询+子查询)</h4><p>连表查询</p>
<pre><code>#重点：外链接语法

SELECT 字段列表
    FROM 表1 INNER|LEFT|RIGHT JOIN 表2
    ON 表1.字段 = 表2.字段;


1、inner join：只取两张表有对应关系的部分(共有的数据部分)
select * from emp inner join dep
    on emp.dep_id = dep.id
    ;
2、left join:在inner join的基础上保留左表中的记录(没有则NULL顶着)
select * from emp left join dep
    on emp.dep_id = dep.id
    ;

3、right join:在inner join的基础上保留右表中的记录(没有则NULL顶着)
select * from emp right join dep
    on emp.dep_id = dep.id
    ;

4、full join：在内连接的基础上左右两边的记录都保留
select * from emp left join dep on emp.dep_id = dep.id
union
select * from emp right join dep on emp.dep_id = dep.id
    ;</code></pre>
<h4 id="知识点补充"><a href="#知识点补充" class="headerlink" title="知识点补充"></a>知识点补充</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#查询平均年龄在25岁以上的部门名</span><br><span class="line"></span><br><span class="line">只要是多表查询，就有两种思路； 连表  和  子查询</span><br><span class="line"># 连表操作</span><br><span class="line">  1 先拿到部门和员工表 拼接之后结果</span><br><span class="line">  2 需要分组</span><br><span class="line">select department.name from employee inner join department </span><br><span class="line">    on employee.dep_id&#x3D;department.id </span><br><span class="line">    group by department.name </span><br><span class="line">    having avg(age)&gt;25 ;</span><br><span class="line"># 子查询</span><br><span class="line">select name from department where id in (select dep_id from employee group by dep_id having avg(age)&gt;25);</span><br></pre></td></tr></table></figure>





<h4 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#1：子查询是将一个查询语句嵌套在另一个查询语句中。</span><br><span class="line">#2：内层查询语句的查询结果，可以为外层查询语句提供查询条件。</span><br><span class="line">#3：子查询中可以包含：IN、NOT IN、ANY、ALL、EXISTS 和 NOT EXISTS等关键字</span><br><span class="line">#4：还可以包含比较运算符：&#x3D; 、 !&#x3D;、&gt; 、&lt;等</span><br></pre></td></tr></table></figure>

<p><strong>1 带IN关键字的子查询</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#查询平均年龄在25岁以上的部门名</span><br><span class="line">select id,name from department</span><br><span class="line">    where id in </span><br><span class="line">        (select dep_id from employee group by dep_id having avg(age) &gt; 25);</span><br><span class="line"></span><br><span class="line">#查看技术部员工姓名</span><br><span class="line">select name from employee</span><br><span class="line">    where dep_id in </span><br><span class="line">        (select id from department where name&#x3D;&#39;技术&#39;);</span><br><span class="line"></span><br><span class="line">#查看不足1人的部门名(子查询得到的是有人的部门id)</span><br><span class="line">select name from department where id not in (select distinct dep_id from employee);</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 注意not in </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">not in 无法处理null的值，即子查询中如果存在null的值，not in将无法处理，如下</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from emp;</span><br><span class="line">+----+------------+--------+------+--------+</span><br><span class="line">| id | name | sex | age | dep_id |</span><br><span class="line">+----+------------+--------+------+--------+</span><br><span class="line">| 1 | egon | male | 18 | 200 |</span><br><span class="line">| 2 | alex | female | 48 | 201 |</span><br><span class="line">| 3 | wupeiqi | male | 38 | 201 |</span><br><span class="line">| 4 | yuanhao | female | 28 | 202 |</span><br><span class="line">| 5 | liwenzhou | male | 18 | 200 |</span><br><span class="line">| 6 | jingliyang | female | 18 | 204 |</span><br><span class="line">| 7 | xxx | male | 19 | NULL |</span><br><span class="line">+----+------------+--------+------+--------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from dep;</span><br><span class="line">+------+--------------+</span><br><span class="line">| id | name |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 200 | 技术 |</span><br><span class="line">| 201 | 人力资源 |</span><br><span class="line">| 202 | 销售 |</span><br><span class="line">| 203 | 运营 |</span><br><span class="line">+------+--------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"># 子查询中存在null</span><br><span class="line">mysql&gt; select * from dep where id not in (select distinct dep_id from emp);</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line"># 解决方案如下</span><br><span class="line">mysql&gt; select * from dep where id not in (select distinct dep_id from emp where dep_id is not null);</span><br><span class="line">+------+--------+</span><br><span class="line">| id | name |</span><br><span class="line">+------+--------+</span><br><span class="line">| 203 | 运营 |</span><br><span class="line">+------+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line"></span><br><span class="line">！！！注意not in</span><br></pre></td></tr></table></figure>

<p><strong>2 带ANY关键字的子查询</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#在 SQL 中 ANY 和 SOME 是同义词，SOME 的用法和功能和 ANY 一模一样。</span><br><span class="line"></span><br><span class="line"># ANY 和 IN 运算符不同之处1</span><br><span class="line">ANY 必须和其他的比较运算符共同使用，而且ANY必须将比较运算符放在 ANY 关键字之前，所比较的值需要匹配子查询中的任意一个值，这也就是 ANY 在英文中所表示的意义</span><br><span class="line"></span><br><span class="line">例如：使用 IN 和使用 ANY运算符得到的结果是一致的</span><br><span class="line">select * from employee where salary &#x3D; any (</span><br><span class="line">select max(salary) from employee group by depart_id);</span><br><span class="line"></span><br><span class="line">select * from employee where salary in (</span><br><span class="line">select max(salary) from employee group by depart_id);</span><br><span class="line"></span><br><span class="line">结论：也就是说“&#x3D;ANY”等价于 IN 运算符，而“&lt;&gt;ANY”则等价于 NOT IN 运算符</span><br><span class="line"></span><br><span class="line"># ANY和 IN 运算符不同之处2</span><br><span class="line">ANY 运算符不能与固定的集合相匹配，比如下面的 SQL 语句是错误的</span><br><span class="line"></span><br><span class="line">SELECT</span><br><span class="line">*</span><br><span class="line">FROM</span><br><span class="line">T_Book</span><br><span class="line">WHERE</span><br><span class="line">FYearPublished &lt; ANY (2001, 2003, 2005)</span><br></pre></td></tr></table></figure>

<p><strong>3 带ALL关键字的子查询</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># all同any类似，只不过all表示的是所有，any表示任一</span><br><span class="line">查询出那些薪资比所有部门的平均薪资都高的员工&#x3D;》薪资在所有部门平均线以上的狗币资本家</span><br><span class="line">select * from employee where salary &gt; all (</span><br><span class="line">select avg(salary) from employee group by depart_id);</span><br><span class="line">查询出那些薪资比所有部门的平均薪资都低的员工&#x3D;》薪资在所有部门平均线以下的无产阶级劳苦大众</span><br><span class="line">select * from employee where salary &lt; all (</span><br><span class="line">select avg(salary) from employee group by depart_id);</span><br><span class="line"></span><br><span class="line">查询出那些薪资比任意一个部门的平均薪资低的员工&#x3D;》薪资在任一部门平均线以下的员工select * from employee where salary &lt; any ( select avg(salary) from employee group by depart_id); </span><br><span class="line">查询出那些薪资比任意一个部门的平均薪资高的员工&#x3D;》薪资在任一部门平均线以上的员工</span><br><span class="line">select * from employee where salary &gt; any (</span><br><span class="line">select avg(salary) from employee group by depart_id);</span><br></pre></td></tr></table></figure>

<p><strong>4 带比较运算符的子查询</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#比较运算符：&#x3D;、!&#x3D;、&gt;、&gt;&#x3D;、&lt;、&lt;&#x3D;、&lt;&gt;</span><br><span class="line">#查询大于所有人平均年龄的员工名与年龄</span><br><span class="line">mysql&gt; select name,age from emp where age &gt; (select avg(age) from emp);</span><br><span class="line">+---------+------+</span><br><span class="line">| name | age |</span><br><span class="line">+---------+------+</span><br><span class="line">| alex | 48 |</span><br><span class="line">| wupeiqi | 38 |</span><br><span class="line">+---------+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查询大于部门内平均年龄的员工名、年龄</span><br><span class="line">select t1.name,t1.age from emp t1</span><br><span class="line">inner join </span><br><span class="line">(select dep_id,avg(age) avg_age from emp group by dep_id) t2</span><br><span class="line">on t1.dep_id &#x3D; t2.dep_id</span><br><span class="line">where t1.age &gt; t2.avg_age;</span><br></pre></td></tr></table></figure>

<p><strong>5 带EXISTS关键字的子查询</strong></p>
<p>EXISTS关字键字表示存在。在使用EXISTS关键字时，内层查询语句不返回查询的记录。<br>而是返回一个真假值。True或False<br>当返回<strong>True</strong>时，<strong>外层查询语句将进行查询</strong>；当返回值为<strong>False</strong>时，<strong>外层查询语句不进行查询</strong>;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#department表中存在dept_id&#x3D;203，Ture</span><br><span class="line">mysql&gt; select * from employee</span><br><span class="line">    -&gt;     where exists</span><br><span class="line">    -&gt;         (select id from department where id&#x3D;200);</span><br><span class="line">+----+------------+--------+------+--------+</span><br><span class="line">| id | name       | sex    | age  | dep_id |</span><br><span class="line">+----+------------+--------+------+--------+</span><br><span class="line">|  1 | egon       | male   |   18 |    200 |</span><br><span class="line">|  2 | alex       | female |   48 |    201 |</span><br><span class="line">|  3 | wupeiqi    | male   |   38 |    201 |</span><br><span class="line">|  4 | yuanhao    | female |   28 |    202 |</span><br><span class="line">|  5 | liwenzhou  | male   |   18 |    200 |</span><br><span class="line">|  6 | jingliyang | female |   18 |    204 |</span><br><span class="line">+----+------------+--------+------+--------+</span><br><span class="line"></span><br><span class="line">#department表中存在dept_id&#x3D;205，False</span><br><span class="line">mysql&gt; select * from employee</span><br><span class="line">    -&gt;     where exists</span><br><span class="line">    -&gt;         (select id from department where id&#x3D;204);</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>5.1 in与exists</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">！！！！！！当in和exists在查询效率上比较时，in查询的效率快于exists的查询效率！！！！！！</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;exists&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># exists</span><br><span class="line">exists后面一般都是子查询，后面的子查询被称做相关子查询（即与主语句相关），当子查询返回行数时，exists条件返回true，</span><br><span class="line">否则返回false，exists是不返回列表的值的，exists只在乎括号里的数据能不能查找出来，是否存在这样的记录。</span><br><span class="line"></span><br><span class="line"># 例</span><br><span class="line">查询出那些班级里有学生的班级</span><br><span class="line">select * from class where exists (select * from stu where stu.cid&#x3D;class.id)</span><br><span class="line"></span><br><span class="line"># exists的执行原理为：</span><br><span class="line">1、依次执行外部查询：即select * from class </span><br><span class="line">2、然后为外部查询返回的每一行分别执行一次子查询：即(select * from stu where stu.cid&#x3D;class.cid)</span><br><span class="line">3、子查询如果返回行，则exists条件成立，条件成立则输出外部查询取出的那条记录</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;in&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># in</span><br><span class="line">in后跟的都是子查询，in()后面的子查询 是返回结果集的</span><br><span class="line"></span><br><span class="line"># 例</span><br><span class="line">查询和所有女生年龄相同的男生</span><br><span class="line">select * from stu where sex&#x3D;&#39;男&#39; and age in(select age from stu where sex&#x3D;&#39;女&#39;)</span><br><span class="line"></span><br><span class="line"># in的执行原理为：</span><br><span class="line">in()的执行次序和exists()不一样,in()的子查询会先产生结果集,</span><br><span class="line">然后主查询再去结果集里去找符合要求的字段列表去.符合要求的输出,反之则不输出.</span><br></pre></td></tr></table></figure>

<p><strong>5.2 not in与 not exists</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">!!!!!!not exists查询的效率远远高与not in查询的效率。!!!!!!</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;not in&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">not in()子查询的执行顺序是：</span><br><span class="line">为了证明not in成立，即找不到，需要一条一条地查询表，符合要求才返回子查询的结果集，不符合的就继续查询下一条记录，直到把表中的记录查询完，只能查询全部记录才能证明，并没有用到索引。</span><br><span class="line">                </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;not exists&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">not exists：</span><br><span class="line">如果主查询表中记录少，子查询表中记录多，并有索引。</span><br><span class="line">例如:查询那些班级中没有学生的班级</span><br><span class="line">select * from class</span><br><span class="line"></span><br><span class="line">where not exists</span><br><span class="line"></span><br><span class="line">(select * from student where student.cid &#x3D; class.cid)</span><br><span class="line"></span><br><span class="line">not exists的执行顺序是：</span><br><span class="line">在表中查询，是根据索引查询的，如果存在就返回true，如果不存在就返回false，不会每条记录都去查询。</span><br></pre></td></tr></table></figure>











<p>示例1：找出年龄大于25岁的员工以及员工所在的部门</p>
<pre><code>select emp.name,dep.name from emp inner join dep
    on emp.dep_id = dep.id
    where age &gt; 25
    ;</code></pre>
<p>示例1：找出平均年龄&gt;=20的部门名</p>
<pre><code>select dep.name,avg(age) from emp inner join dep
    on emp.dep_id = dep.id
    group by dep.name
    having avg(age) &gt;= 20;


    select name from dep where id in
    (select  dep_id from emp group by dep_id having avg(age) &gt;= 20);



    select * from emp inner join dep
    on emp.dep_id = dep.id
    where dep.name = &#39;销售&#39;;


    select * from emp where dep_id =
    (select id from dep where name =&#39;销售&#39;);



    select * from t2 inner join

    (select * from emp inner join dep
    on emp.dep_id = dep.id) as t1

    on t2.xx = t1.yy


    练习：查询每个部门最新入职的那位员工</code></pre>
<p>select t1.name,t1.hire_date,t1.post,t2.post,t2.max_date from emp as t1<br>inner join<br>(select post,max(hire_date) as max_date from emp group by post) as t2<br>on t1.post = t2.post<br>where t1.hire_date = t2.max_date<br>;</p>
<h2 id="pymysql模块"><a href="#pymysql模块" class="headerlink" title="pymysql模块"></a>pymysql模块</h2><h3 id="一-链接、执行sql、关闭（游标）"><a href="#一-链接、执行sql、关闭（游标）" class="headerlink" title="一 链接、执行sql、关闭（游标）"></a><strong>一 链接、执行sql、关闭（游标）</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">user=input(<span class="string">&#x27;用户名: &#x27;</span>).strip()</span><br><span class="line">pwd=input(<span class="string">&#x27;密码: &#x27;</span>).strip()</span><br><span class="line"></span><br><span class="line"><span class="comment">#链接</span></span><br><span class="line">conn=pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;123&#x27;</span>,database=<span class="string">&#x27;egon&#x27;</span>,charset=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"><span class="comment">#游标</span></span><br><span class="line">cursor=conn.cursor() <span class="comment">#执行完毕返回的结果集默认以元组显示</span></span><br><span class="line"><span class="comment">#fetchall数据格式：((12, &#x27;kubernetes权威指南&#x27;, datetime.date(2021, 5, 18)), (13, &#x27;Prometheus深入浅出&#x27;, datetime.date(2021, 5, 18)))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cursor=conn.cursor(cursor=pymysql.cursors.DictCursor) 以字典的方式返回</span><br><span class="line"><span class="comment"># 数据格式</span></span><br><span class="line">[&#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">12</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;kubernetes权威指南&#x27;</span>, <span class="string">&#x27;publish_date&#x27;</span>: datetime.date(<span class="number">2021</span>, <span class="number">5</span>, <span class="number">18</span>)&#125;, &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">13</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;Prometheus深入浅出&#x27;</span>, <span class="string">&#x27;publish_date&#x27;</span>: datetime.date(<span class="number">2021</span>, <span class="number">5</span>, <span class="number">18</span>)&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行sql语句</span></span><br><span class="line">sql=<span class="string">&#x27;select * from userinfo where name=&quot;%s&quot; and password=&quot;%s&quot;&#x27;</span> %(user,pwd) <span class="comment">#注意%s需要加引号</span></span><br><span class="line">print(sql)</span><br><span class="line">res=cursor.execute(sql) <span class="comment">#执行sql语句，返回sql查询成功的记录数目</span></span><br><span class="line">print(res)</span><br><span class="line"></span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> res:</span><br><span class="line">    print(<span class="string">&#x27;登录成功&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">&#x27;登录失败&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="二-execute-之sql注入"><a href="#二-execute-之sql注入" class="headerlink" title="二 execute()之sql注入"></a><strong>二 execute()之sql注入</strong></h3><p>注意：符号–会注释掉它之后的sql，正确的语法：–后至少有一个任意字符</p>
<p>根本原理：就根据程序的字符串拼接name=’%s’，我们输入一个<strong>xxx’ – haha</strong>,用我们输入的xxx加’在程序中拼接成一个判断条件name=<strong>‘xxx’ – haha’</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">最后那一个空格，在一条sql语句中如果遇到select * from t1 where id &gt; 3 -- and name&#x3D;&#39;egon&#39;;则--之后的条件被注释掉了</span><br><span class="line"></span><br><span class="line">#1、sql注入之：用户存在，绕过密码</span><br><span class="line">egon&#39; -- 任意字符</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">select * from user where name&#x3D;&#39;jason&#39; -- asdsad&#39; and password&#x3D;&#39;&#39;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">#2、sql注入之：用户不存在，绕过用户与密码</span><br><span class="line">xxx&#39; or 1&#x3D;1 -- 任意字符</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">select * from user where name&#x3D;&#39;xxx&#39; or 1&#x3D;1 -- asdsadsad&#39; and password&#x3D;&#39;&#39;</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>![image-20210426172311389](/Users/waylonyan/Library/Application Support/typora-user-images/image-20210426172311389.png)</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210426172326630.png" alt="image-20210426172326630"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210426172403230.png" alt="image-20210426172403230"></p>
<p>解决方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">如何解决上述问题？</span><br><span class="line">  日常软件在获取用户输入内容之后，都会限制一些特殊符号的输入；</span><br><span class="line">  所有敏感信息不要靠自己去做拼接操作，交互固定的模块帮你去过滤数据防止SQL注入。</span><br><span class="line">  在pymysql中 excute就能够帮你过滤</span><br><span class="line"></span><br><span class="line"># 原来是我们对sql进行字符串拼接</span><br><span class="line"># sql&#x3D;&quot;select * from userinfo where name&#x3D;&#39;%s&#39; and password&#x3D;&#39;%s&#39;&quot; %(user,pwd)</span><br><span class="line"># print(sql)</span><br><span class="line"># res&#x3D;cursor.execute(sql)</span><br><span class="line"></span><br><span class="line">#改写为（execute帮我们做字符串拼接，我们无需且一定不能再为%s加引号了,pymysql自动识别%s后面元祖里面数据进行替换）</span><br><span class="line">sql&#x3D;&quot;select * from userinfo where name&#x3D;%s and password&#x3D;%s&quot; #！！！注意%s需要去掉引号，因为pymysql会自动为我们加上</span><br><span class="line">res&#x3D;cursor.execute(sql,[user,pwd]) #pymysql模块自动帮我们解决sql注入的问题，只要我们按照pymysql的规矩来。</span><br></pre></td></tr></table></figure>

<h3 id="三-增、删、改：conn-commit"><a href="#三-增、删、改：conn-commit" class="headerlink" title="三 增、删、改：conn.commit()"></a><strong>三 增、删、改：conn.commit()</strong></h3><blockquote>
<p>重点是多行数据提交</p>
</blockquote>
<blockquote>
<p>可以直接设置autocommit =True</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="comment">#链接</span></span><br><span class="line">conn=pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;123&#x27;</span>,database=<span class="string">&#x27;egon&#x27;</span>)</span><br><span class="line"><span class="comment">#游标</span></span><br><span class="line">cursor=conn.cursor(pymysql.cursors.DictCursor)</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行sql语句</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#part1</span></span><br><span class="line">sql=<span class="string">&#x27;insert into userinfo(name,password) values(%s,%s);&#x27;</span></span><br><span class="line">res=cursor.execute(sql,(<span class="string">&quot;root&quot;</span>,<span class="string">&quot;123456&quot;</span>)) <span class="comment">#执行sql语句，返回sql影响成功的行数</span></span><br><span class="line">print(res)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part2 增加多条数据 （列表套元祖的形式）</span></span><br><span class="line">sql=<span class="string">&#x27;insert into userinfo(name,password) values(%s,%s);&#x27;</span></span><br><span class="line">res=cursor.executemany(sql,[(<span class="string">&quot;root&quot;</span>,<span class="string">&quot;123456&quot;</span>),(<span class="string">&quot;lhf&quot;</span>,<span class="string">&quot;12356&quot;</span>),(<span class="string">&quot;eee&quot;</span>,<span class="string">&quot;156&quot;</span>)]) <span class="comment">#执行sql语句，返回sql影响成功的行数</span></span><br><span class="line">print(res)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part3   更新数据</span></span><br><span class="line">sql=<span class="string">&#x27;update user set name=&quot;jason111&quot; where id=1&#x27;</span></span><br><span class="line">rows = cursor.execute(sql)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part4   删除数据</span></span><br><span class="line">sql = <span class="string">&#x27;delete from user where id=1&#x27;</span></span><br><span class="line">rows = cursor.execute(sql)</span><br><span class="line"></span><br><span class="line">sql = <span class="string">&#x27;delete from app01_books where title=%s&#x27;</span></span><br><span class="line">rows = cursor.execute(sql,[<span class="string">&#x27;水浒传&#x27;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conn.commit() <span class="comment">#提交后才发现表中插入记录成功</span></span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>



<h3 id="四-查：fetchone，fetchmany，fetchall"><a href="#四-查：fetchone，fetchmany，fetchall" class="headerlink" title="四 查：fetchone，fetchmany，fetchall"></a><strong>四 查：fetchone，fetchmany，fetchall</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="comment">#链接</span></span><br><span class="line">conn=pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;123&#x27;</span>,database=<span class="string">&#x27;egon&#x27;</span>)</span><br><span class="line"><span class="comment">#游标</span></span><br><span class="line">cursor=conn.cursor()</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行sql语句</span></span><br><span class="line">sql=<span class="string">&#x27;select * from userinfo;&#x27;</span></span><br><span class="line">rows=cursor.execute(sql) <span class="comment">#执行sql语句，返回sql影响成功的行数rows,将结果放入一个集合，等待被查询</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cursor.scroll(3,mode=&#x27;absolute&#x27;) # 相对开头位置移动，</span></span><br><span class="line"><span class="comment"># cursor.scroll(3,mode=&#x27;relative&#x27;) # 相对当前位置移动</span></span><br><span class="line">res1=cursor.fetchone() <span class="comment"># 返回字典</span></span><br><span class="line">res2=cursor.fetchone()</span><br><span class="line">res3=cursor.fetchone()</span><br><span class="line">res4=cursor.fetchmany(<span class="number">2</span>)</span><br><span class="line">res5=cursor.fetchall() <span class="comment"># 列表套字典</span></span><br><span class="line">print(res1)</span><br><span class="line">print(res2)</span><br><span class="line">print(res3)</span><br><span class="line">print(res4)</span><br><span class="line">print(res5)</span><br><span class="line">print(<span class="string">&#x27;%s rows in set (0.00 sec)&#x27;</span> %rows)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conn.commit() <span class="comment">#提交后才发现表中插入记录成功</span></span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">(1, &#x27;root&#x27;, &#x27;123456&#x27;)</span></span><br><span class="line"><span class="string">(2, &#x27;root&#x27;, &#x27;123456&#x27;)</span></span><br><span class="line"><span class="string">(3, &#x27;root&#x27;, &#x27;123456&#x27;)</span></span><br><span class="line"><span class="string">((4, &#x27;root&#x27;, &#x27;123456&#x27;), (5, &#x27;root&#x27;, &#x27;123456&#x27;))</span></span><br><span class="line"><span class="string">((6, &#x27;root&#x27;, &#x27;123456&#x27;), (7, &#x27;lhf&#x27;, &#x27;12356&#x27;), (8, &#x27;eee&#x27;, &#x27;156&#x27;))</span></span><br><span class="line"><span class="string">rows in set (0.00 sec)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="五-获取插入的最后一条数据的自增ID"><a href="#五-获取插入的最后一条数据的自增ID" class="headerlink" title="五 获取插入的最后一条数据的自增ID"></a><strong>五 获取插入的最后一条数据的自增ID</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">conn=pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;123&#x27;</span>,database=<span class="string">&#x27;egon&#x27;</span>)</span><br><span class="line">cursor=conn.cursor()</span><br><span class="line"></span><br><span class="line">sql=<span class="string">&#x27;insert into userinfo(name,password) values(&quot;xxx&quot;,&quot;123&quot;);&#x27;</span></span><br><span class="line">rows=cursor.execute(sql)</span><br><span class="line">print(cursor.lastrowid) <span class="comment">#在插入语句后查看</span></span><br><span class="line"></span><br><span class="line">conn.commit()</span><br><span class="line"></span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>



<h2 id="视图-触发器-事务-存储过程-内置函数-流程控制-索引理论"><a href="#视图-触发器-事务-存储过程-内置函数-流程控制-索引理论" class="headerlink" title="视图 触发器 事务 存储过程 内置函数 流程控制 索引理论"></a>视图 触发器 事务 存储过程 内置函数 流程控制 索引理论</h2><h3 id="一-视图"><a href="#一-视图" class="headerlink" title="一. 视图"></a>一. 视图</h3><p>视图是一个虚拟表（非真实存在），其本质是【根据SQL语句获取动态的数据集，并为其命名】，用户使用时只需使用【名称】即可获取结果集，可以将该结果集当做表来使用。</p>
<p>使用视图我们可以把查询过程中的临时表摘出来，用视图去实现，这样以后再想操作该临时表的数据时就无需重写复杂的sql了，直接去视图中查找即可，但视图有明显地效率问题，并且视图是存放在数据库中的，如果我们程序中使用的sql过分依赖数据库中的视图，即强耦合，那就意味着扩展sql极为不便，因此并不推荐使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#两张有关系的表</span><br><span class="line">mysql&gt; select * from course;</span><br><span class="line">+-----+--------+------------+</span><br><span class="line">| cid | cname  | teacher_id |</span><br><span class="line">+-----+--------+------------+</span><br><span class="line">|   1 | 生物   |          1 |</span><br><span class="line">|   2 | 物理   |          2 |</span><br><span class="line">|   3 | 体育   |          3 |</span><br><span class="line">|   4 | 美术   |          2 |</span><br><span class="line">+-----+--------+------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from teacher;</span><br><span class="line">+-----+-----------------+</span><br><span class="line">| tid | tname           |</span><br><span class="line">+-----+-----------------+</span><br><span class="line">|   1 | 张磊老师        |</span><br><span class="line">|   2 | 李平老师        |</span><br><span class="line">|   3 | 刘海燕老师      |</span><br><span class="line">|   4 | 朱云海老师      |</span><br><span class="line">|   5 | 李杰老师        |</span><br><span class="line">+-----+-----------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#查询李平老师教授的课程名</span><br><span class="line">mysql&gt; select cname from course where teacher_id &#x3D; (select tid from teacher where tname&#x3D;&#39;李平老师&#39;);</span><br><span class="line">+--------+</span><br><span class="line">| cname  |</span><br><span class="line">+--------+</span><br><span class="line">| 物理   |</span><br><span class="line">| 美术   |</span><br><span class="line">+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#子查询出临时表，作为teacher_id等判断依据</span><br><span class="line">select tid from teacher where tname&#x3D;&#39;李平老师&#39;</span><br></pre></td></tr></table></figure>

<h4 id="一-创建视图"><a href="#一-创建视图" class="headerlink" title="一 创建视图"></a><strong>一 创建视图</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#语法：CREATE VIEW 视图名称 AS  SQL语句</span><br><span class="line">create view teacher_view as select tid from teacher where tname&#x3D;&#39;李平老师&#39;;</span><br><span class="line"></span><br><span class="line">#于是查询李平老师教授的课程名的sql可以改写为</span><br><span class="line">mysql&gt; select cname from course where teacher_id &#x3D; (select tid from teacher_view);</span><br><span class="line">+--------+</span><br><span class="line">| cname  |</span><br><span class="line">+--------+</span><br><span class="line">| 物理   |</span><br><span class="line">| 美术   |</span><br><span class="line">+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#！！！注意注意注意：</span><br><span class="line">#1. 使用视图以后就无需每次都重写子查询的sql，但是这么效率并不高，还不如我们写子查询的效率高</span><br><span class="line"></span><br><span class="line">#2. 而且有一个致命的问题：视图是存放到数据库里的，如果我们程序中的sql过分依赖于数据库中存放的视图，那么意味着，一旦sql需要修改且涉及到视图的部分，则必须去数据库中进行修改，而通常在公司中数据库有专门的DBA负责，你要想完成修改，必须付出大量的沟通成本DBA可能才会帮你完成修改，极其地不方便</span><br></pre></td></tr></table></figure>

<h4 id="二-使用视图"><a href="#二-使用视图" class="headerlink" title="二 使用视图"></a><strong>二 使用视图</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#修改视图，原始表也跟着改</span><br><span class="line">mysql&gt; select * from course;</span><br><span class="line">+-----+--------+------------+</span><br><span class="line">| cid | cname  | teacher_id |</span><br><span class="line">+-----+--------+------------+</span><br><span class="line">|   1 | 生物   |          1 |</span><br><span class="line">|   2 | 物理   |          2 |</span><br><span class="line">|   3 | 体育   |          3 |</span><br><span class="line">|   4 | 美术   |          2 |</span><br><span class="line">+-----+--------+------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create view course_view as select * from course; #创建表course的视图</span><br><span class="line">Query OK, 0 rows affected (0.52 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from course_view;</span><br><span class="line">+-----+--------+------------+</span><br><span class="line">| cid | cname  | teacher_id |</span><br><span class="line">+-----+--------+------------+</span><br><span class="line">|   1 | 生物   |          1 |</span><br><span class="line">|   2 | 物理   |          2 |</span><br><span class="line">|   3 | 体育   |          3 |</span><br><span class="line">|   4 | 美术   |          2 |</span><br><span class="line">+-----+--------+------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; update course_view set cname&#x3D;&#39;xxx&#39;; #更新视图中的数据</span><br><span class="line">Query OK, 4 rows affected (0.04 sec)</span><br><span class="line">Rows matched: 4  Changed: 4  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into course_view values(5,&#39;yyy&#39;,2); #往视图中插入数据</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from course; #发现原始表的记录也跟着修改了</span><br><span class="line">+-----+-------+------------+</span><br><span class="line">| cid | cname | teacher_id |</span><br><span class="line">+-----+-------+------------+</span><br><span class="line">|   1 | xxx   |          1 |</span><br><span class="line">|   2 | xxx   |          2 |</span><br><span class="line">|   3 | xxx   |          3 |</span><br><span class="line">|   4 | xxx   |          2 |</span><br><span class="line">|   5 | yyy   |          2 |</span><br><span class="line">+-----+-------+------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>我们不应该修改视图中的记录，而且在涉及多个表的情况下是根本无法修改视图中的记录的，如下图</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210426204949545.png" alt="image-20210426204949545"></p>
<h4 id="三-修改视图"><a href="#三-修改视图" class="headerlink" title="三 修改视图"></a><strong>三 修改视图</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">语法：ALTER VIEW 视图名称 AS SQL语句</span><br><span class="line">mysql&gt; alter view teacher_view as select * from course where cid&gt;3;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from teacher_view;</span><br><span class="line">+-----+-------+------------+</span><br><span class="line">| cid | cname | teacher_id |</span><br><span class="line">+-----+-------+------------+</span><br><span class="line">|   4 | xxx   |          2 |</span><br><span class="line">|   5 | yyy   |          2 |</span><br><span class="line">+-----+-------+------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="四-删除视图"><a href="#四-删除视图" class="headerlink" title="四 删除视图"></a><strong>四 删除视图</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">语法：DROP VIEW 视图名称</span><br><span class="line"></span><br><span class="line">DROP VIEW teacher_view</span><br></pre></td></tr></table></figure>



<h3 id="二-触发器"><a href="#二-触发器" class="headerlink" title="二. 触发器"></a>二. 触发器</h3><p>使用触发器可以定制用户对表进行【增、删、改】操作时前后的行为，自动触发的功能。注意：没有查询</p>
<blockquote>
<p><strong>使用触发器可以 协助实现监控，日志.</strong>…..</p>
</blockquote>
<blockquote>
<p>触发器可以在六种情况下自动触发  <strong>增前/后 删前/后 改前/后</strong></p>
</blockquote>
<h4 id="0-基本语法结构"><a href="#0-基本语法结构" class="headerlink" title="0. 基本语法结构"></a>0. 基本语法结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create trigger 触发器的名字 before&#x2F;after insert&#x2F;update&#x2F;delete on 表名 for each row </span><br><span class="line">begin</span><br><span class="line">     sql语句</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 具体使用，针对触发器的名字  见名知意</span><br></pre></td></tr></table></figure>

<p>ps : 修改MySQL默认的语句结束符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 只作用于当前窗口</span><br><span class="line">delimiter $$ 将默认的分号； 改为$$</span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<h4 id="一-创建触发器"><a href="#一-创建触发器" class="headerlink" title="一 创建触发器"></a><strong>一 创建触发器</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># 插入前</span><br><span class="line">CREATE TRIGGER tri_before_insert_tb1 BEFORE INSERT ON tb1 FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    ...</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"># 插入后</span><br><span class="line">CREATE TRIGGER tri_after_insert_tb1 AFTER INSERT ON tb1 FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    ...</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"># 删除前</span><br><span class="line">CREATE TRIGGER tri_before_delete_tb1 BEFORE DELETE ON tb1 FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    ...</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"># 删除后</span><br><span class="line">CREATE TRIGGER tri_after_delete_tb1 AFTER DELETE ON tb1 FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    ...</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"># 更新前</span><br><span class="line">CREATE TRIGGER tri_before_update_tb1 BEFORE UPDATE ON tb1 FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    ...</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"># 更新后</span><br><span class="line">CREATE TRIGGER tri_after_update_tb1 AFTER UPDATE ON tb1 FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    ...</span><br><span class="line">END</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>插入触发器后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#准备表</span><br><span class="line">CREATE TABLE cmd (</span><br><span class="line">    id INT PRIMARY KEY auto_increment,</span><br><span class="line">    USER CHAR (32),</span><br><span class="line">    priv CHAR (10),</span><br><span class="line">    cmd CHAR (64),</span><br><span class="line">    sub_time datetime, #提交时间</span><br><span class="line">    success enum (&#39;yes&#39;, &#39;no&#39;) #0代表执行失败</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE errlog (</span><br><span class="line">    id INT PRIMARY KEY auto_increment,</span><br><span class="line">    err_cmd CHAR (64),</span><br><span class="line">    err_time datetime</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">当cmd表中的记录success字段是no；那么就触发trigger的执行去errlog表中插入数据。</span><br><span class="line">NEW指代的就是一条条的数据对象</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建触发器</span><br><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">CREATE TRIGGER tri_after_insert_cmd AFTER INSERT ON cmd FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    IF NEW.success &#x3D; &#39;no&#39; THEN #等值判断只有一个等号</span><br><span class="line">            INSERT INTO errlog(err_cmd, err_time) VALUES(NEW.cmd, NEW.sub_time) ; #必须加分号</span><br><span class="line">      END IF ; #必须加分号</span><br><span class="line">END&#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#往表cmd中插入记录，触发触发器，根据IF的条件决定是否插入错误日志</span><br><span class="line">INSERT INTO cmd (</span><br><span class="line">    USER,</span><br><span class="line">    priv,</span><br><span class="line">    cmd,</span><br><span class="line">    sub_time,</span><br><span class="line">    success</span><br><span class="line">)</span><br><span class="line">VALUES</span><br><span class="line">    (&#39;egon&#39;,&#39;0755&#39;,&#39;ls -l &#x2F;etc&#39;,NOW(),&#39;yes&#39;),</span><br><span class="line">    (&#39;egon&#39;,&#39;0755&#39;,&#39;cat &#x2F;etc&#x2F;passwd&#39;,NOW(),&#39;no&#39;),</span><br><span class="line">    (&#39;egon&#39;,&#39;0755&#39;,&#39;useradd xxx&#39;,NOW(),&#39;no&#39;),</span><br><span class="line">    (&#39;egon&#39;,&#39;0755&#39;,&#39;ps aux&#39;,NOW(),&#39;yes&#39;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查询错误日志，发现有两条</span><br><span class="line">mysql&gt; select * from errlog;</span><br><span class="line">+----+-----------------+---------------------+</span><br><span class="line">| id | err_cmd         | err_time            |</span><br><span class="line">+----+-----------------+---------------------+</span><br><span class="line">|  1 | cat &#x2F;etc&#x2F;passwd | 2017-09-14 22:18:48 |</span><br><span class="line">|  2 | useradd xxx     | 2017-09-14 22:18:48 |</span><br><span class="line">+----+-----------------+---------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>特别的：<font color="red">NEW</font>表示即将插入的数据行对象（new.success 就能拿到对象里面的值），<font color="red">OLD</font>表示即将删除的数据行。</strong></p>
<h4 id="二-使用触发器"><a href="#二-使用触发器" class="headerlink" title="二 使用触发器"></a><strong>二 使用触发器</strong></h4><p>触发器无法由用户直接调用，而知由于对表的【增/删/改】操作被动引发的。</p>
<h4 id="三-删除触发器"><a href="#三-删除触发器" class="headerlink" title="三 删除触发器"></a><strong>三 删除触发器</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop trigger tri_after_insert_cmd;</span><br></pre></td></tr></table></figure>

<h3 id="三-事务"><a href="#三-事务" class="headerlink" title="三 事务"></a>三 事务</h3><p>事务用于将某些操作的多个SQL作为原子性操作，一旦有某一个出现错误，即可回滚到原来的状态。</p>
<p>开启一个事务可以包含多条sql语句，包含诸多操作，要么都成功，要么同时失败。</p>
<blockquote>
<p> 这个特点称之为<strong>事务的原子性</strong></p>
</blockquote>
<p><strong>事务作用</strong>：<font color="red">从而保证数据库数据完整性和操作的安全性。</font></p>
<p><strong>事务的四大特性</strong>：**<font color="red">ACID</font>**</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">A: 原子性</span><br><span class="line">   一个事务是一个不可分割的单位，事务中包含了诸多操作，要么同时成功，要么同时失败。</span><br><span class="line">   </span><br><span class="line">C: 一致性</span><br><span class="line">   事务必须是使数据库从一个一致性的状态变到另外一个一致性的状态。一致性和原子性是密切相关的。</span><br><span class="line">   </span><br><span class="line">I: 隔离性</span><br><span class="line">   一个事务的执行不能被其他事务干扰，其一个事务内部的操作及其使用到的数据对并发的其他事务是隔离的，并发执行的事务之间也是互不干扰的。</span><br><span class="line">   </span><br><span class="line">D: 持久性</span><br><span class="line">    也叫”永久性“。</span><br><span class="line">    一个事务一旦提交成功执行成功，那么它对数据库中数据的修改应该是永久的。</span><br><span class="line">    接下来的其他操作或者故障不应该改对其他有任何的影响。</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>开启事务</strong>：<strong>start transaction;</strong></p>
</li>
<li><p><strong>回滚(回到事务执行之前的状态): rollback</strong> </p>
</li>
<li><p><strong>确认(确认后无法回滚了)**：</strong>commit**</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">create table user(</span><br><span class="line">id int primary key auto_increment,</span><br><span class="line">name char(32),</span><br><span class="line">balance int</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into user(name,balance)</span><br><span class="line">values</span><br><span class="line">(&#39;wsb&#39;,1000),</span><br><span class="line">(&#39;egon&#39;,1000),</span><br><span class="line">(&#39;ysb&#39;,1000);</span><br><span class="line"></span><br><span class="line">#原子操作，开启事务</span><br><span class="line">start transaction;</span><br><span class="line"></span><br><span class="line"># 修改操作</span><br><span class="line">update user set balance&#x3D;900 where name&#x3D;&#39;wsb&#39;; #买支付100元</span><br><span class="line">update user set balance&#x3D;1010 where name&#x3D;&#39;egon&#39;; #中介拿走10元</span><br><span class="line">update user set balance&#x3D;1090 where name&#x3D;&#39;ysb&#39;; #卖家拿到90元</span><br><span class="line"># 确认</span><br><span class="line">commit;</span><br><span class="line"></span><br><span class="line">#出现异常，回滚到初始状态</span><br><span class="line">start transaction;</span><br><span class="line">update user set balance&#x3D;900 where name&#x3D;&#39;wsb&#39;; #买支付100元</span><br><span class="line">update user set balance&#x3D;1010 where name&#x3D;&#39;egon&#39;; #中介拿走10元</span><br><span class="line">update user set balance&#x3D;1090 where name&#x3D;&#39;ysb&#39;; #卖家拿到90元,出现异常没有拿到</span><br><span class="line">rollback;</span><br><span class="line">commit;</span><br><span class="line">mysql&gt; select * from user;</span><br><span class="line">+----+------+---------+</span><br><span class="line">| id | name | balance |</span><br><span class="line">+----+------+---------+</span><br><span class="line">|  1 | wsb  |    1000 |</span><br><span class="line">|  2 | egon |    1000 |</span><br><span class="line">|  3 | ysb  |    1000 |</span><br><span class="line">+----+------+---------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="四-存储过程"><a href="#四-存储过程" class="headerlink" title="四 存储过程"></a>四 存储过程</h3><h4 id="一-介绍"><a href="#一-介绍" class="headerlink" title="一 介绍"></a><strong>一 介绍</strong></h4><p>类似于python中的函数。</p>
<p>存储过程包含了一系列可执行的sql语句，存储过程存放于MySQL中，通过调用它的名字可以执行其内部的一堆sql</p>
<p>使用存储过程的优点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#1. 用于替代程序写的SQL语句，实现程序与sql解耦</span><br><span class="line"></span><br><span class="line">#2. 基于网络传输，传别名的数据量小，而直接传sql数据量大</span><br></pre></td></tr></table></figure>

<p>使用存储过程的缺点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#1. 程序员扩展功能不方便</span><br></pre></td></tr></table></figure>

<p>补充：<strong>程序与数据库结合使用的三种方式</strong></p>
<blockquote>
<p>第一种基本不用。一般都是第三种，出现效率问题再动手写SQL</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#方式一：</span><br><span class="line">    MySQL：存储过程</span><br><span class="line">    程序：调用存储过程</span><br><span class="line"></span><br><span class="line">#方式二：</span><br><span class="line">    MySQL：</span><br><span class="line">    程序：纯SQL语句</span><br><span class="line"></span><br><span class="line">#方式三：</span><br><span class="line">    MySQL:</span><br><span class="line">    程序：类和对象，即ORM（本质还是纯SQL语句）</span><br></pre></td></tr></table></figure>

<h4 id="二-创建简单存储过程（无参）"><a href="#二-创建简单存储过程（无参）" class="headerlink" title="二 创建简单存储过程（无参）"></a><strong>二 创建简单存储过程（无参）</strong></h4><p><code>create procedure 存储过程名字()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">create procedure p1()</span><br><span class="line">BEGIN</span><br><span class="line">    select * from blog;</span><br><span class="line">    INSERT into blog(name,sub_time) values(&quot;xxx&quot;,now());</span><br><span class="line">END &#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">#在mysql中调用</span><br><span class="line">call p1() </span><br><span class="line"></span><br><span class="line">#在python中基于pymysql调用</span><br><span class="line">cursor.callproc(&#39;p1&#39;) </span><br><span class="line">print(cursor.fetchall())</span><br></pre></td></tr></table></figure>

<h4 id="三-创建存储过程（有参）"><a href="#三-创建存储过程（有参）" class="headerlink" title="三 创建存储过程（有参）"></a><strong>三 创建存储过程（有参）</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">对于存储过程，可以接收参数，其参数有三类：</span><br><span class="line"></span><br><span class="line">#in          仅用于传入参数用</span><br><span class="line">#out        仅用于返回值用</span><br><span class="line">#inout     既可以传入又可以当作返回值</span><br></pre></td></tr></table></figure>

<p>in:传入参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">create procedure p2(</span><br><span class="line">    in n1 int,</span><br><span class="line">    in n2 int</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">    </span><br><span class="line">    select * from blog where id &gt; n1;</span><br><span class="line">END &#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">#在mysql中调用</span><br><span class="line">call p2(3,2)</span><br><span class="line"></span><br><span class="line">#在python中基于pymysql调用</span><br><span class="line">cursor.callproc(&#39;p2&#39;,(3,2))</span><br><span class="line">print(cursor.fetchall())</span><br></pre></td></tr></table></figure>

<p>out：返回值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">create procedure p3(</span><br><span class="line">    in n1 int,</span><br><span class="line">    out res int</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">    select * from blog where id &gt; n1;</span><br><span class="line">    set res &#x3D; 1;</span><br><span class="line">END &#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">#在mysql中调用</span><br><span class="line">set @res&#x3D;0; #0代表假（执行失败），1代表真（执行成功）</span><br><span class="line">call p3(3,@res);</span><br><span class="line">select @res;</span><br><span class="line"></span><br><span class="line">#在python中基于pymysql调用</span><br><span class="line">cursor.callproc(&#39;p3&#39;,(3,0)) #0相当于set @res&#x3D;0</span><br><span class="line">print(cursor.fetchall()) #查询select的查询结果</span><br><span class="line"></span><br><span class="line">cursor.execute(&#39;select @_p3_0,@_p3_1;&#39;) #@p3_0代表第一个参数，@p3_1代表第二个参数，即返回值</span><br><span class="line">print(cursor.fetchall())</span><br></pre></td></tr></table></figure>

<p>inout:既可以传入又可以返回</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">create procedure p4(</span><br><span class="line">    inout n1 int</span><br><span class="line">)</span><br><span class="line">BEGIN</span><br><span class="line">    select * from blog where id &gt; n1;</span><br><span class="line">    set n1 &#x3D; 1;</span><br><span class="line">END &#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">#在mysql中调用</span><br><span class="line">set @x&#x3D;3;</span><br><span class="line">call p4(@x);</span><br><span class="line">select @x;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#在python中基于pymysql调用</span><br><span class="line">cursor.callproc(&#39;p4&#39;,(3,))</span><br><span class="line">print(cursor.fetchall()) #查询select的查询结果</span><br><span class="line"></span><br><span class="line">cursor.execute(&#39;select @_p4_0;&#39;) </span><br><span class="line">print(cursor.fetchall())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>事务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#介绍</span><br><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">            create procedure p4(</span><br><span class="line">                out status int</span><br><span class="line">            )</span><br><span class="line">            BEGIN</span><br><span class="line">                1. 声明如果出现异常则执行&#123;</span><br><span class="line">                    set status &#x3D; 1;</span><br><span class="line">                    rollback;</span><br><span class="line">                &#125;</span><br><span class="line">                   </span><br><span class="line">                开始事务</span><br><span class="line">                    -- 由秦兵账户减去100</span><br><span class="line">                    -- 方少伟账户加90</span><br><span class="line">                    -- 张根账户加10</span><br><span class="line">                    commit;</span><br><span class="line">                结束</span><br><span class="line">                </span><br><span class="line">                set status &#x3D; 2;</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">            END &#x2F;&#x2F;</span><br><span class="line">            delimiter ;</span><br><span class="line"></span><br><span class="line">#实现</span><br><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">create PROCEDURE p5(</span><br><span class="line">    OUT p_return_code tinyint</span><br><span class="line">)</span><br><span class="line">BEGIN </span><br><span class="line">    DECLARE exit handler for sqlexception </span><br><span class="line">    BEGIN </span><br><span class="line">        -- ERROR </span><br><span class="line">        set p_return_code &#x3D; 1; </span><br><span class="line">        rollback; </span><br><span class="line">    END; </span><br><span class="line"></span><br><span class="line">    DECLARE exit handler for sqlwarning </span><br><span class="line">    BEGIN </span><br><span class="line">        -- WARNING </span><br><span class="line">        set p_return_code &#x3D; 2; </span><br><span class="line">        rollback; </span><br><span class="line">    END; </span><br><span class="line"></span><br><span class="line">    START TRANSACTION; </span><br><span class="line">        DELETE from tb1; #执行失败</span><br><span class="line">        insert into blog(name,sub_time) values(&#39;yyy&#39;,now());</span><br><span class="line">    COMMIT; </span><br><span class="line"></span><br><span class="line">    -- SUCCESS </span><br><span class="line">    set p_return_code &#x3D; 0; #0代表执行成功</span><br><span class="line"></span><br><span class="line">END &#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line">#在mysql中调用存储过程</span><br><span class="line">set @res&#x3D;123;</span><br><span class="line">call p5(@res);</span><br><span class="line">select @res;</span><br><span class="line"></span><br><span class="line">#在python中基于pymysql调用存储过程</span><br><span class="line">cursor.callproc(&#39;p5&#39;,(123,))</span><br><span class="line">print(cursor.fetchall()) #查询select的查询结果</span><br><span class="line"></span><br><span class="line">cursor.execute(&#39;select @_p5_0;&#39;)</span><br><span class="line">print(cursor.fetchall())</span><br></pre></td></tr></table></figure>

<h4 id="四-执行存储过程"><a href="#四-执行存储过程" class="headerlink" title="四 执行存储过程"></a><strong>四 执行存储过程</strong></h4><p>在MySQL<strong>中执行存储过程</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-- 无参数</span><br><span class="line">call proc_name()</span><br><span class="line"></span><br><span class="line">-- 有参数，全in</span><br><span class="line">call proc_name(1,2)</span><br><span class="line"></span><br><span class="line">-- 有参数，有in，out，inout</span><br><span class="line">set @t1&#x3D;0;</span><br><span class="line">set @t2&#x3D;3;</span><br><span class="line">call proc_name(1,2,@t1,@t2)</span><br><span class="line"></span><br><span class="line">执行存储过程</span><br></pre></td></tr></table></figure>

<p>在python中基于pymysql执行存储过程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line">conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">3306</span>, user=<span class="string">&#x27;root&#x27;</span>, passwd=<span class="string">&#x27;123&#x27;</span>, db=<span class="string">&#x27;t1&#x27;</span>)</span><br><span class="line">cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)</span><br><span class="line"><span class="comment"># 执行存储过程</span></span><br><span class="line">cursor.callproc(<span class="string">&#x27;p1&#x27;</span>, args=(<span class="number">1</span>, <span class="number">22</span>, <span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line"><span class="comment"># 获取执行完存储的参数</span></span><br><span class="line">cursor.execute(<span class="string">&quot;select @_p1_0,@_p1_1,@_p1_2,@_p1_3&quot;</span>)</span><br><span class="line">result = cursor.fetchall()</span><br><span class="line"></span><br><span class="line">conn.commit()</span><br><span class="line">cursor.close()</span><br><span class="line">conn.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<h4 id="五-删除存储过程"><a href="#五-删除存储过程" class="headerlink" title="五 删除存储过程"></a><strong>五 删除存储过程</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop procedure proc_name;</span><br></pre></td></tr></table></figure>



<h3 id="五-函数"><a href="#五-函数" class="headerlink" title="五 函数"></a>五 函数</h3><p>MySQL中提供了许多内置函数，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line">一、数学函数</span><br><span class="line">    ROUND(x,y)</span><br><span class="line">        返回参数x的四舍五入的有y位小数的值</span><br><span class="line">        </span><br><span class="line">    RAND()</span><br><span class="line">        返回０到１内的随机值,可以通过提供一个参数(种子)使RAND()随机数生成器生成一个指定的值。</span><br><span class="line"></span><br><span class="line">二、聚合函数(常用于GROUP BY从句的SELECT查询中)</span><br><span class="line">    AVG(col)返回指定列的平均值</span><br><span class="line">    COUNT(col)返回指定列中非NULL值的个数</span><br><span class="line">    MIN(col)返回指定列的最小值</span><br><span class="line">    MAX(col)返回指定列的最大值</span><br><span class="line">    SUM(col)返回指定列的所有值之和</span><br><span class="line">    GROUP_CONCAT(col) 返回由属于一组的列值连接组合而成的结果    </span><br><span class="line">    </span><br><span class="line">三、字符串函数</span><br><span class="line"></span><br><span class="line">    CHAR_LENGTH(str)</span><br><span class="line">        返回值为字符串str 的长度，长度的单位为字符。一个多字节字符算作一个单字符。</span><br><span class="line">    CONCAT(str1,str2,...)</span><br><span class="line">        字符串拼接</span><br><span class="line">        如有任何一个参数为NULL ，则返回值为 NULL。</span><br><span class="line">    CONCAT_WS(separator,str1,str2,...)</span><br><span class="line">        字符串拼接（自定义连接符）</span><br><span class="line">        CONCAT_WS()不会忽略任何空字符串。 (然而会忽略所有的 NULL）。</span><br><span class="line"></span><br><span class="line">    CONV(N,from_base,to_base)</span><br><span class="line">        进制转换</span><br><span class="line">        例如：</span><br><span class="line">            SELECT CONV(&#39;a&#39;,16,2); 表示将 a 由16进制转换为2进制字符串表示</span><br><span class="line"></span><br><span class="line">    FORMAT(X,D)</span><br><span class="line">        将数字X 的格式写为&#39;#,###,###.##&#39;,以四舍五入的方式保留小数点后 D 位， 并将结果以字符串的形式返回。若  D 为 0, 则返回结果不带有小数点，或不含小数部分。</span><br><span class="line">        例如：</span><br><span class="line">            SELECT FORMAT(12332.1,4); 结果为： &#39;12,332.1000&#39;</span><br><span class="line">    INSERT(str,pos,len,newstr)</span><br><span class="line">        在str的指定位置插入字符串</span><br><span class="line">            pos：要替换位置其实位置</span><br><span class="line">            len：替换的长度</span><br><span class="line">            newstr：新字符串</span><br><span class="line">        特别的：</span><br><span class="line">            如果pos超过原字符串长度，则返回原字符串</span><br><span class="line">            如果len超过原字符串长度，则由新字符串完全替换</span><br><span class="line">    INSTR(str,substr)</span><br><span class="line">        返回字符串 str 中子字符串的第一个出现位置。</span><br><span class="line"></span><br><span class="line">    LEFT(str,len)</span><br><span class="line">        返回字符串str 从开始的len位置的子序列字符。</span><br><span class="line"></span><br><span class="line">    LOWER(str)</span><br><span class="line">        变小写</span><br><span class="line"></span><br><span class="line">    UPPER(str)</span><br><span class="line">        变大写</span><br><span class="line">   </span><br><span class="line">    REVERSE(str)</span><br><span class="line">        返回字符串 str ，顺序和字符顺序相反。</span><br><span class="line">        </span><br><span class="line">    SUBSTRING(str,pos) , SUBSTRING(str FROM pos) SUBSTRING(str,pos,len) , SUBSTRING(str FROM pos FOR len)</span><br><span class="line">        不带有len 参数的格式从字符串str返回一个子字符串，起始于位置 pos。带有len参数的格式从字符串str返回一个长度同len字符相同的子字符串，起始于位置 pos。 使用 FROM的格式为标准 SQL 语法。也可能对pos使用一个负值。假若这样，则子字符串的位置起始于字符串结尾的pos 字符，而不是字符串的开头位置。在以下格式的函数中可以对pos 使用一个负值。</span><br><span class="line"></span><br><span class="line">        mysql&gt; SELECT SUBSTRING(&#39;Quadratically&#39;,5);</span><br><span class="line">            -&gt; &#39;ratically&#39;</span><br><span class="line"></span><br><span class="line">        mysql&gt; SELECT SUBSTRING(&#39;foobarbar&#39; FROM 4);</span><br><span class="line">            -&gt; &#39;barbar&#39;</span><br><span class="line"></span><br><span class="line">        mysql&gt; SELECT SUBSTRING(&#39;Quadratically&#39;,5,6);</span><br><span class="line">            -&gt; &#39;ratica&#39;</span><br><span class="line"></span><br><span class="line">        mysql&gt; SELECT SUBSTRING(&#39;Sakila&#39;, -3);</span><br><span class="line">            -&gt; &#39;ila&#39;</span><br><span class="line"></span><br><span class="line">        mysql&gt; SELECT SUBSTRING(&#39;Sakila&#39;, -5, 3);</span><br><span class="line">            -&gt; &#39;aki&#39;</span><br><span class="line"></span><br><span class="line">        mysql&gt; SELECT SUBSTRING(&#39;Sakila&#39; FROM -4 FOR 2);</span><br><span class="line">            -&gt; &#39;ki&#39;</span><br><span class="line">            </span><br><span class="line">四、日期和时间函数</span><br><span class="line">    CURDATE()或CURRENT_DATE() 返回当前的日期</span><br><span class="line">    CURTIME()或CURRENT_TIME() 返回当前的时间</span><br><span class="line">    DAYOFWEEK(date)   返回date所代表的一星期中的第几天(1~7)</span><br><span class="line">    DAYOFMONTH(date)  返回date是一个月的第几天(1~31)</span><br><span class="line">    DAYOFYEAR(date)   返回date是一年的第几天(1~366)</span><br><span class="line">    DAYNAME(date)   返回date的星期名，如：SELECT DAYNAME(CURRENT_DATE);</span><br><span class="line">    FROM_UNIXTIME(ts,fmt)  根据指定的fmt格式，格式化UNIX时间戳ts</span><br><span class="line">    HOUR(time)   返回time的小时值(0~23)</span><br><span class="line">    MINUTE(time)   返回time的分钟值(0~59)</span><br><span class="line">    MONTH(date)   返回date的月份值(1~12)</span><br><span class="line">    MONTHNAME(date)   返回date的月份名，如：SELECT MONTHNAME(CURRENT_DATE);</span><br><span class="line">    NOW()    返回当前的日期和时间</span><br><span class="line">    QUARTER(date)   返回date在一年中的季度(1~4)，如SELECT QUARTER(CURRENT_DATE);</span><br><span class="line">    WEEK(date)   返回日期date为一年中第几周(0~53)</span><br><span class="line">    YEAR(date)   返回日期date的年份(1000~9999)</span><br><span class="line">    </span><br><span class="line">    重点:</span><br><span class="line">    DATE_FORMAT(date,format) 根据format字符串格式化date值</span><br><span class="line"></span><br><span class="line">       mysql&gt; SELECT DATE_FORMAT(&#39;2009-10-04 22:23:00&#39;, &#39;%W %M %Y&#39;);</span><br><span class="line">        -&gt; &#39;Sunday October 2009&#39;</span><br><span class="line">       mysql&gt; SELECT DATE_FORMAT(&#39;2007-10-04 22:23:00&#39;, &#39;%H:%i:%s&#39;);</span><br><span class="line">        -&gt; &#39;22:23:00&#39;</span><br><span class="line">       mysql&gt; SELECT DATE_FORMAT(&#39;1900-10-04 22:23:00&#39;,</span><br><span class="line">        -&gt;                 &#39;%D %y %a %d %m %b %j&#39;);</span><br><span class="line">        -&gt; &#39;4th 00 Thu 04 10 Oct 277&#39;</span><br><span class="line">       mysql&gt; SELECT DATE_FORMAT(&#39;1997-10-04 22:23:00&#39;,</span><br><span class="line">        -&gt;                 &#39;%H %k %I %r %T %S %w&#39;);</span><br><span class="line">        -&gt; &#39;22 22 10 10:23:00 PM 22:23:00 00 6&#39;</span><br><span class="line">       mysql&gt; SELECT DATE_FORMAT(&#39;1999-01-01&#39;, &#39;%X %V&#39;);</span><br><span class="line">        -&gt; &#39;1998 52&#39;</span><br><span class="line">       mysql&gt; SELECT DATE_FORMAT(&#39;2006-06-00&#39;, &#39;%d&#39;);</span><br><span class="line">        -&gt; &#39;00&#39;</span><br><span class="line">        </span><br><span class="line">五、加密函数</span><br><span class="line">    MD5()    </span><br><span class="line">        计算字符串str的MD5校验和</span><br><span class="line">    PASSWORD(str)   </span><br><span class="line">        返回字符串str的加密版本，这个加密过程是不可逆转的，和UNIX密码加密过程使用不同的算法。</span><br><span class="line">        </span><br><span class="line">六、控制流函数            </span><br><span class="line">    CASE WHEN[test1] THEN [result1]...ELSE [default] END</span><br><span class="line">        如果testN是真，则返回resultN，否则返回default</span><br><span class="line">    CASE [test] WHEN[val1] THEN [result]...ELSE [default]END  </span><br><span class="line">        如果test和valN相等，则返回resultN，否则返回default</span><br><span class="line"></span><br><span class="line">    IF(test,t,f)   </span><br><span class="line">        如果test是真，返回t；否则返回f</span><br><span class="line"></span><br><span class="line">    IFNULL(arg1,arg2) </span><br><span class="line">        如果arg1不是空，返回arg1，否则返回arg2</span><br><span class="line"></span><br><span class="line">    NULLIF(arg1,arg2) </span><br><span class="line">        如果arg1&#x3D;arg2返回NULL；否则返回arg1        </span><br><span class="line">        </span><br><span class="line">七、控制流函数小练习</span><br><span class="line">#7.1、准备表</span><br><span class="line">&#x2F;*</span><br><span class="line">Navicat MySQL Data Transfer</span><br><span class="line"></span><br><span class="line">Source Server         : localhost_3306</span><br><span class="line">Source Server Version : 50720</span><br><span class="line">Source Host           : localhost:3306</span><br><span class="line">Source Database       : student</span><br><span class="line"></span><br><span class="line">Target Server Type    : MYSQL</span><br><span class="line">Target Server Version : 50720</span><br><span class="line">File Encoding         : 65001</span><br><span class="line"></span><br><span class="line">Date: 2018-01-02 12:05:30</span><br><span class="line">*&#x2F;</span><br><span class="line"></span><br><span class="line">SET FOREIGN_KEY_CHECKS&#x3D;0;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for course</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS &#96;course&#96;;</span><br><span class="line">CREATE TABLE &#96;course&#96; (</span><br><span class="line">  &#96;c_id&#96; int(11) NOT NULL,</span><br><span class="line">  &#96;c_name&#96; varchar(255) DEFAULT NULL,</span><br><span class="line">  &#96;t_id&#96; int(11) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;c_id&#96;),</span><br><span class="line">  KEY &#96;t_id&#96; (&#96;t_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Records of course</span><br><span class="line">-- ----------------------------</span><br><span class="line">INSERT INTO &#96;course&#96; VALUES (&#39;1&#39;, &#39;python&#39;, &#39;1&#39;);</span><br><span class="line">INSERT INTO &#96;course&#96; VALUES (&#39;2&#39;, &#39;java&#39;, &#39;2&#39;);</span><br><span class="line">INSERT INTO &#96;course&#96; VALUES (&#39;3&#39;, &#39;linux&#39;, &#39;3&#39;);</span><br><span class="line">INSERT INTO &#96;course&#96; VALUES (&#39;4&#39;, &#39;web&#39;, &#39;2&#39;);</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for score</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS &#96;score&#96;;</span><br><span class="line">CREATE TABLE &#96;score&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;s_id&#96; int(10) DEFAULT NULL,</span><br><span class="line">  &#96;c_id&#96; int(11) DEFAULT NULL,</span><br><span class="line">  &#96;num&#96; double DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;12 DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Records of score</span><br><span class="line">-- ----------------------------</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;1&#39;, &#39;1&#39;, &#39;1&#39;, &#39;79&#39;);</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;2&#39;, &#39;1&#39;, &#39;2&#39;, &#39;78&#39;);</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;3&#39;, &#39;1&#39;, &#39;3&#39;, &#39;35&#39;);</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;4&#39;, &#39;2&#39;, &#39;2&#39;, &#39;32&#39;);</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;5&#39;, &#39;3&#39;, &#39;1&#39;, &#39;66&#39;);</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;6&#39;, &#39;4&#39;, &#39;2&#39;, &#39;77&#39;);</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;7&#39;, &#39;4&#39;, &#39;1&#39;, &#39;68&#39;);</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;8&#39;, &#39;5&#39;, &#39;1&#39;, &#39;66&#39;);</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;9&#39;, &#39;2&#39;, &#39;1&#39;, &#39;69&#39;);</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;10&#39;, &#39;4&#39;, &#39;4&#39;, &#39;75&#39;);</span><br><span class="line">INSERT INTO &#96;score&#96; VALUES (&#39;11&#39;, &#39;5&#39;, &#39;4&#39;, &#39;66.7&#39;);</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for student</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS &#96;student&#96;;</span><br><span class="line">CREATE TABLE &#96;student&#96; (</span><br><span class="line">  &#96;s_id&#96; varchar(20) NOT NULL,</span><br><span class="line">  &#96;s_name&#96; varchar(255) DEFAULT NULL,</span><br><span class="line">  &#96;s_age&#96; int(10) DEFAULT NULL,</span><br><span class="line">  &#96;s_sex&#96; char(1) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;s_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Records of student</span><br><span class="line">-- ----------------------------</span><br><span class="line">INSERT INTO &#96;student&#96; VALUES (&#39;1&#39;, &#39;鲁班&#39;, &#39;12&#39;, &#39;男&#39;);</span><br><span class="line">INSERT INTO &#96;student&#96; VALUES (&#39;2&#39;, &#39;貂蝉&#39;, &#39;20&#39;, &#39;女&#39;);</span><br><span class="line">INSERT INTO &#96;student&#96; VALUES (&#39;3&#39;, &#39;刘备&#39;, &#39;35&#39;, &#39;男&#39;);</span><br><span class="line">INSERT INTO &#96;student&#96; VALUES (&#39;4&#39;, &#39;关羽&#39;, &#39;34&#39;, &#39;男&#39;);</span><br><span class="line">INSERT INTO &#96;student&#96; VALUES (&#39;5&#39;, &#39;张飞&#39;, &#39;33&#39;, &#39;女&#39;);</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for teacher</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS &#96;teacher&#96;;</span><br><span class="line">CREATE TABLE &#96;teacher&#96; (</span><br><span class="line">  &#96;t_id&#96; int(10) NOT NULL,</span><br><span class="line">  &#96;t_name&#96; varchar(50) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;t_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Records of teacher</span><br><span class="line">-- ----------------------------</span><br><span class="line">INSERT INTO &#96;teacher&#96; VALUES (&#39;1&#39;, &#39;大王&#39;);</span><br><span class="line">INSERT INTO &#96;teacher&#96; VALUES (&#39;2&#39;, &#39;alex&#39;);</span><br><span class="line">INSERT INTO &#96;teacher&#96; VALUES (&#39;3&#39;, &#39;egon&#39;);</span><br><span class="line">INSERT INTO &#96;teacher&#96; VALUES (&#39;4&#39;, &#39;peiqi&#39;);</span><br><span class="line"></span><br><span class="line">#7.2、统计各科各分数段人数.显示格式:课程ID,课程名称,[100-85],[85-70],[70-60],[ &lt;60]</span><br><span class="line"></span><br><span class="line">select  score.c_id,</span><br><span class="line">          course.c_name, </span><br><span class="line">      sum(CASE WHEN num BETWEEN 85 and 100 THEN 1 ELSE 0 END) as &#39;[100-85]&#39;,</span><br><span class="line">      sum(CASE WHEN num BETWEEN 70 and 85 THEN 1 ELSE 0 END) as &#39;[85-70]&#39;,</span><br><span class="line">      sum(CASE WHEN num BETWEEN 60 and 70 THEN 1 ELSE 0 END) as &#39;[70-60]&#39;,</span><br><span class="line">      sum(CASE WHEN num &lt; 60 THEN 1 ELSE 0 END) as &#39;[ &lt;60]&#39;</span><br><span class="line">from score,course where score.c_id&#x3D;course.c_id GROUP BY score.c_id; </span><br></pre></td></tr></table></figure>

<p>需要掌握函数：date_format</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#1 基本使用</span><br><span class="line">mysql&gt; SELECT DATE_FORMAT(&#39;2009-10-04 22:23:00&#39;, &#39;%W %M %Y&#39;);</span><br><span class="line">        -&gt; &#39;Sunday October 2009&#39;</span><br><span class="line">mysql&gt; SELECT DATE_FORMAT(&#39;2007-10-04 22:23:00&#39;, &#39;%H:%i:%s&#39;);</span><br><span class="line">        -&gt; &#39;22:23:00&#39;</span><br><span class="line">mysql&gt; SELECT DATE_FORMAT(&#39;1900-10-04 22:23:00&#39;,</span><br><span class="line">    -&gt;                 &#39;%D %y %a %d %m %b %j&#39;);</span><br><span class="line">        -&gt; &#39;4th 00 Thu 04 10 Oct 277&#39;</span><br><span class="line">mysql&gt; SELECT DATE_FORMAT(&#39;1997-10-04 22:23:00&#39;,</span><br><span class="line">    -&gt;                 &#39;%H %k %I %r %T %S %w&#39;);</span><br><span class="line">        -&gt; &#39;22 22 10 10:23:00 PM 22:23:00 00 6&#39;</span><br><span class="line">mysql&gt; SELECT DATE_FORMAT(&#39;1999-01-01&#39;, &#39;%X %V&#39;);</span><br><span class="line">        -&gt; &#39;1998 52&#39;</span><br><span class="line">mysql&gt; SELECT DATE_FORMAT(&#39;2006-06-00&#39;, &#39;%d&#39;);</span><br><span class="line">        -&gt; &#39;00&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#2 准备表和记录</span><br><span class="line">CREATE TABLE blog (</span><br><span class="line">    id INT PRIMARY KEY auto_increment,</span><br><span class="line">    NAME CHAR (32),</span><br><span class="line">    sub_time datetime</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO blog (NAME, sub_time)</span><br><span class="line">VALUES</span><br><span class="line">    (&#39;第1篇&#39;,&#39;2015-03-01 11:31:21&#39;),</span><br><span class="line">    (&#39;第2篇&#39;,&#39;2015-03-11 16:31:21&#39;),</span><br><span class="line">    (&#39;第3篇&#39;,&#39;2016-07-01 10:21:31&#39;),</span><br><span class="line">    (&#39;第4篇&#39;,&#39;2016-07-22 09:23:21&#39;),</span><br><span class="line">    (&#39;第5篇&#39;,&#39;2016-07-23 10:11:11&#39;),</span><br><span class="line">    (&#39;第6篇&#39;,&#39;2016-07-25 11:21:31&#39;),</span><br><span class="line">    (&#39;第7篇&#39;,&#39;2017-03-01 15:33:21&#39;),</span><br><span class="line">    (&#39;第8篇&#39;,&#39;2017-03-01 17:32:21&#39;),</span><br><span class="line">    (&#39;第9篇&#39;,&#39;2017-03-01 18:31:21&#39;);</span><br><span class="line"></span><br><span class="line">#3. 提取sub_time字段的值，按照格式后的结果即&quot;年月&quot;来分组</span><br><span class="line">SELECT DATE_FORMAT(sub_time,&#39;%Y-%m&#39;),COUNT(id) FROM blog GROUP BY DATE_FORMAT(sub_time,&#39;%Y-%m&#39;);</span><br><span class="line"></span><br><span class="line">#结果</span><br><span class="line">+-------------------------------+----------+</span><br><span class="line">| DATE_FORMAT(sub_time,&#39;%Y-%m&#39;) | COUNT(1) |</span><br><span class="line">+-------------------------------+----------+</span><br><span class="line">| 2015-03                       |        2 |</span><br><span class="line">| 2016-07                       |        4 |</span><br><span class="line">| 2017-03                       |        3 |</span><br><span class="line">+-------------------------------+----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>更多函数：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://doc.mysql.cn/mysql5/refman-5.1-zh.html-chapter/functions.html#encryption-functions">中文猛击这里</a> OR <a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/refman/5.7/en/functions.html">官方猛击这里</a></p>
<h4 id="一-自定义函数"><a href="#一-自定义函数" class="headerlink" title="一 自定义函数"></a><strong>一 自定义函数</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#！！！注意！！！</span><br><span class="line">#函数中不要写sql语句（否则会报错），函数仅仅只是一个功能，是一个在sql中被应用的功能</span><br><span class="line">#若要想在begin...end...中写sql，请用存储过程</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">create function f1(</span><br><span class="line">    i1 int,</span><br><span class="line">    i2 int)</span><br><span class="line">returns int</span><br><span class="line">BEGIN</span><br><span class="line">    declare num int;</span><br><span class="line">    set num &#x3D; i1 + i2;</span><br><span class="line">    return(num);</span><br><span class="line">END &#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">create function f5(</span><br><span class="line">    i int</span><br><span class="line">)</span><br><span class="line">returns int</span><br><span class="line">begin</span><br><span class="line">    declare res int default 0;</span><br><span class="line">    if i &#x3D; 10 then</span><br><span class="line">        set res&#x3D;100;</span><br><span class="line">    elseif i &#x3D; 20 then</span><br><span class="line">        set res&#x3D;200;</span><br><span class="line">    elseif i &#x3D; 30 then</span><br><span class="line">        set res&#x3D;300;</span><br><span class="line">    else</span><br><span class="line">        set res&#x3D;400;</span><br><span class="line">    end if;</span><br><span class="line">    return res;</span><br><span class="line">end &#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<h4 id="二-删除函数"><a href="#二-删除函数" class="headerlink" title="二 删除函数"></a><strong>二 删除函数</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop function func_name;</span><br></pre></td></tr></table></figure>

<h4 id="三-执行函数"><a href="#三-执行函数" class="headerlink" title="三 执行函数"></a><strong>三 执行函数</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 获取返回值</span><br><span class="line">select UPPER(&#39;egon&#39;) into @res;</span><br><span class="line">SELECT @res;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在查询中使用</span><br><span class="line">select f1(11,nid) ,name from tb2;</span><br></pre></td></tr></table></figure>



<h3 id="六-流程控制"><a href="#六-流程控制" class="headerlink" title="六 流程控制"></a>六 流程控制</h3><h4 id="一-条件语句"><a href="#一-条件语句" class="headerlink" title="一 条件语句"></a><strong>一 条件语句</strong></h4><p>If 条件语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">CREATE PROCEDURE proc_if ()</span><br><span class="line">BEGIN</span><br><span class="line">    </span><br><span class="line">    declare i int default 0;</span><br><span class="line">    if i &#x3D; 1 THEN</span><br><span class="line">        SELECT 1;</span><br><span class="line">    ELSEIF i &#x3D; 2 THEN</span><br><span class="line">        SELECT 2;</span><br><span class="line">    ELSE</span><br><span class="line">        SELECT 7;</span><br><span class="line">    END IF;</span><br><span class="line"></span><br><span class="line">END &#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<h4 id="二-循环语句"><a href="#二-循环语句" class="headerlink" title="二 循环语句"></a><strong>二 循环语句</strong></h4><p>while循环</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">CREATE PROCEDURE proc_while ()</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">    DECLARE num INT ;</span><br><span class="line">    SET num &#x3D; 0 ;</span><br><span class="line">    WHILE num &lt; 10 DO</span><br><span class="line">        SELECT</span><br><span class="line">            num ;</span><br><span class="line">        SET num &#x3D; num + 1 ;</span><br><span class="line">    END WHILE ;</span><br><span class="line"></span><br><span class="line">END &#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<p>repeat循环</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">delimiter &#x2F;&#x2F;</span><br><span class="line">CREATE PROCEDURE proc_repeat ()</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">    DECLARE i INT ;</span><br><span class="line">    SET i &#x3D; 0 ;</span><br><span class="line">    repeat</span><br><span class="line">        select i;</span><br><span class="line">        set i &#x3D; i + 1;</span><br><span class="line">        until i &gt;&#x3D; 5</span><br><span class="line">    end repeat;</span><br><span class="line"></span><br><span class="line">END &#x2F;&#x2F;</span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>

<p>loop循环</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">BEGIN</span><br><span class="line">    </span><br><span class="line">    declare i int default 0;</span><br><span class="line">    loop_label: loop</span><br><span class="line">        </span><br><span class="line">        set i&#x3D;i+1;</span><br><span class="line">        if i&lt;8 then</span><br><span class="line">            iterate loop_label;</span><br><span class="line">        end if;</span><br><span class="line">        if i&gt;&#x3D;10 then</span><br><span class="line">            leave loop_label;</span><br><span class="line">        end if;</span><br><span class="line">        select i;</span><br><span class="line">    end loop loop_label;</span><br><span class="line"></span><br><span class="line">END</span><br></pre></td></tr></table></figure>



<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="一-介绍-1"><a href="#一-介绍-1" class="headerlink" title="一 介绍"></a>一 介绍</h3><p><strong>为何要有索引?</strong></p>
<p><em>一般的应用系统，读写比例在10:1左右，而且插入操作和一般的更新操作很少出现性能问题，在生产环境中，我们遇到最多的，也是最容易出问题的，还是一些复杂的查询操作，因此对查询语句的优化显然是重中之重。说起加速查询，就不得不提到索引了。</em></p>
<p><strong>什么是索引？</strong></p>
<p><em>索引在MySQL中也叫做“键”，是存储引擎用于快速找到记录的一种数据结构。索引对于良好的性能</em><br><em>非常关键，尤其是当表中的数据量越来越大时，索引对于性能的影响愈发重要。</em></p>
<p><em>索引优化应该是对查询性能优化最有效的手段了。索引能够轻易将查询性能提高好几个数量级。</em><br><em>索引相当于字典的音序表，如果要查某个字，如果不使用音序表，则需要从几百页中逐页去查。</em></p>
<p><strong>你是否对索引存在误解？</strong></p>
<p>索引是应用程序设计和开发的一个重要方面。若索引太多，应用程序的性能可能会受到影响。而索引太少，对查询性能又会产生影响，要找到一个平衡点，这对应用程序的性能至关重要。</p>
<h3 id="二-索引的原理"><a href="#二-索引的原理" class="headerlink" title="二 索引的原理"></a><strong>二 索引的原理</strong></h3><p><strong>一 索引原理</strong></p>
<p>索引的目的在于提高查询效率，与我们查阅图书所用的目录是一个道理：先定位到章，然后定位到该章下的一个小节，然后找到页数。相似的例子还有：查字典，查火车车次，飞机航班等</p>
<p><font color="red"><strong>本质都是：通过不断地缩小想要获取数据的范围来筛选出最终想要的结果，同时把随机的事件变成顺序的事件，也就是说，有了这种索引机制，我们可以总是用同一种查找方式来锁定数据。</strong></font></p>
<p>数据库也是一样，但显然要复杂的多，因为不仅面临着等值查询，还有范围查询(&gt;、&lt;、between、in)、模糊查询(like)、并集查询(or)等等。数据库应该选择怎么样的方式来应对所有的问题呢？我们回想字典的例子，能不能把数据分成段，然后分段查询呢？最简单的如果1000条数据，1到100分成第一段，101到200分成第二段，201到300分成第三段……这样查第250条数据，只要找第三段就可以了，一下子去除了90%的无效数据。但如果是1千万的记录呢，分成几段比较好？稍有算法基础的同学会想到搜索树，其平均复杂度是lgN，具有不错的查询性能。但这里我们忽略了一个关键的问题，复杂度模型是基于每次相同的操作成本来考虑的。而数据库实现比较复杂，一方面数据是保存在磁盘上的，另外一方面为了提高性能，每次又可以把部分数据读入内存来计算，因为我们知道访问磁盘的成本大概是访问内存的十万倍左右，所以简单的搜索树难以满足复杂的应用场景。</p>
<p><strong>二 磁盘IO与预读</strong></p>
<p>前面提到了访问磁盘，那么这里先简单介绍一下磁盘IO和预读，磁盘读取数据靠的是机械运动，每次读取数据花费的时间可以分为寻道时间、旋转延迟、传输时间三个部分，寻道时间指的是磁臂移动到指定磁道所需要的时间，主流磁盘一般在5ms以下；旋转延迟就是我们经常听说的磁盘转速，比如一个磁盘7200转，表示每分钟能转7200次，也就是说1秒钟能转120次，旋转延迟就是1/120/2 = 4.17ms；传输时间指的是从磁盘读出或将数据写入磁盘的时间，一般在零点几毫秒，相对于前两个时间可以忽略不计。那么访问一次磁盘的时间，即一次磁盘IO的时间约等于5+4.17 = 9ms左右，听起来还挺不错的，但要知道一台500 -MIPS（Million Instructions Per Second）的机器每秒可以执行5亿条指令，因为指令依靠的是电的性质，换句话说执行一次IO的时间可以执行约450万条指令，数据库动辄十万百万乃至千万级数据，每次9毫秒的时间，显然是个灾难。下图是计算机硬件延迟的对比图，供大家参考：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427141010739.png" alt="image-20210427141010739"></p>
<p>考虑到磁盘IO是非常高昂的操作，计算机操作系统做了一些优化，<font color="red"><strong>当一次IO时，不光把当前磁盘地址的数据，而是把相邻的数据也都读取到内存缓冲区内</strong></font>，因为局部预读性原理告诉我们，当计算机访问一个地址的数据的时候，与其相邻的数据也会很快被访问到。每一次IO读取的数据我们称之为一页(page)。具体一页有多大数据跟操作系统有关，一般为4k或8k，也就是我们读取一页内的数据时候，实际上才发生了一次IO，这个理论对于索引的数据结构设计非常有帮助。</p>
<h3 id="三-索引的数据结构"><a href="#三-索引的数据结构" class="headerlink" title="三 索引的数据结构"></a>三 索引的数据结构</h3><p>前面讲了索引的基本原理，数据库的复杂性，又讲了操作系统的相关知识，目的就是让大家了解，任何一种数据结构都不是凭空产生的，一定会有它的背景和使用场景，我们现在总结一下，我们需要这种数据结构能够做些什么，其实很简单，那就是：每次查找数据时把磁盘IO次数控制在一个很小的数量级，最好是常数数量级。那么我们就想到如果一个高度可控的多路搜索树是否能满足需求呢？就这样，b+树应运而生（B+树是通过二叉查找树，再由平衡二叉树，B树演化而来）。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427141424527.png" alt="image-20210427141424527"></p>
<p>如上图，是一颗b+树，关于b+树的定义可以参见<a target="_blank" rel="noopener external nofollow noreferrer" href="http://zh.wikipedia.org/wiki/B%2B%E6%A0%91">B+树</a>，这里只说一些重点，浅蓝色的块我们称之为一个磁盘块，可以看到每个磁盘块包含几个数据项（深蓝色所示）和指针（黄色所示），如磁盘块1包含数据项17和35，包含指针P1、P2、P3，P1表示小于17的磁盘块，P2表示在17和35之间的磁盘块，P3表示大于35的磁盘块。真实的数据存在于叶子节点即3、5、9、10、13、15、28、29、36、60、75、79、90、99。非叶子节点只不存储真实的数据，只存储指引搜索方向的数据项，如17、35并不真实存在于数据表中。</p>
<h4 id="b-树的查找过程"><a href="#b-树的查找过程" class="headerlink" title="b+树的查找过程"></a>b+树的查找过程</h4><p>如图所示，如果要查找数据项29，那么首先会把磁盘块1由磁盘加载到内存，此时发生一次IO，在内存中用二分查找确定29在17和35之间，锁定磁盘块1的P2指针，内存时间因为非常短（相比磁盘的IO）可以忽略不计，通过磁盘块1的P2指针的磁盘地址把磁盘块3由磁盘加载到内存，发生第二次IO，29在26和30之间，锁定磁盘块3的P2指针，通过指针加载磁盘块8到内存，发生第三次IO，同时内存中做二分查找找到29，结束查询，总计三次IO。真实的情况是，3层的b+树可以表示上百万的数据，如果上百万的数据查找只需要三次IO，性能提高将是巨大的，如果没有索引，每个数据项都要发生一次IO，那么总共需要百万次的IO，显然成本非常非常高</p>
<h4 id="b-树性质"><a href="#b-树性质" class="headerlink" title="b+树性质"></a>b+树性质</h4><p>1.<strong><font color="red">索引字段要尽量的小</font>&gt;**：通过上面的分析，我们知道IO次数取决于b+数的高度h，假设当前数据表的数据为N，每个磁盘块的数据项的数量是m，则有h=㏒(m+1)N，当数据量N一定的情况下，m越大，h越小；而m = 磁盘块的大小 / 数据项的大小，磁盘块的大小也就是一个数据页的大小，是固定的，如果数据项占的空间越小，数据项的数量越多，树的高度越低。这就是为什么每个数据项，即索引字段要尽量的小，比如int占4字节，要比bigint8字节少一半。这也是为什么b+树要求把真实的数据放到叶子节点而不是内层节点，一旦放到内层节点，磁盘块的数据项会大幅度下降，导致树增高。当数据项等于1时将会退化成线性表。<br>2.<font color="red">**索引的最左匹配特性</font></strong>：当b+树的数据项是复合的数据结构，比如(name,age,sex)的时候，b+数是按照从左到右的顺序来建立搜索树的，比如当(张三,20,F)这样的数据来检索的时候，b+树会优先比较name来确定下一步的所搜方向，如果name相同再依次比较age和sex，最后得到检索的数据；但当(20,F)这样的没有name的数据来的时候，b+树就不知道下一步该查哪个节点，因为建立搜索树的时候name就是第一个比较因子，必须要先根据name来搜索才能知道下一步去哪里查询。比如当(张三,F)这样的数据来检索时，b+树可以用name来指定搜索方向，但下一个字段age的缺失，所以只能把名字等于张三的数据都找到，然后再匹配性别是F的数据了， 这个是非常重要的性质，即索引的最左匹配特性。</p>
<ol start="3">
<li>为什么主键愿意用id int </li>
</ol>
<p>对于同一个磁盘块 int 比 varchar能存取的更多，这样B+tree 树层越少</p>
<h3 id="四-聚集索引与辅助索引"><a href="#四-聚集索引与辅助索引" class="headerlink" title="四 聚集索引与辅助索引"></a><strong>四 聚集索引与辅助索引</strong></h3><p><strong>在数据库中，B+树的高度一般都在2<del>4层，这也就是说查找某一个键值的行记录时最多只需要2到4次IO，这倒不错。因为当前一般的机械硬盘每秒至少可以做100次IO，2</del>4次的IO意味着查询时间只需要0.02~0.04秒。</strong></p>
<p><strong>数据库中的B+树索引可以分为聚集索引（clustered index）和辅助索引（secondary index），</strong></p>
<p><strong>聚集索引与辅助索引相同的是：不管是聚集索引还是辅助索引，其内部都是B+树的形式，即高度是平衡的，叶子结点存放着所有的数据。</strong></p>
<p><strong>聚集索引与辅助索引不同的是：叶子结点存放的是否是一整行的信息</strong></p>
<p><font color="red"><strong>小总结</strong></font>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">聚集索引</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">聚集索引指的就是主键</span><br><span class="line">Innodb 只有两个文件 直接将主键存放在了ibd表中</span><br><span class="line">MyIsam 三个文件，单独将索引存一个文件</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">辅助索引</span><br><span class="line"># 主键之外的都叫辅助索引</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">查询数据的时候不可能一直使用到主键，也有可能会用到name,password 等其他字段。</span><br><span class="line">那么这个时候你是没有办法利用聚集索引，这个时候你就可以根据情况给其他字段设置辅助索引。</span><br><span class="line"></span><br><span class="line">辅助索引也是（B+树）</span><br><span class="line">&quot;&quot;</span><br><span class="line"></span><br><span class="line">覆盖索引</span><br><span class="line">在辅助索引的叶子节点就已经拿到了需要的数据</span><br><span class="line"># 给name设置辅助索引</span><br><span class="line">&#96;select name from user where name&#x3D;&#39;jason&#39;&#96;</span><br><span class="line">答: 想要用户名，用户名已经是辅助索引了，不需要去主键去找了。直接就能够拿到数据。这种现象就叫覆盖索引。</span><br><span class="line">&#96;select age from user where name&#x3D;&#39;jason&#39;&#96;  </span><br><span class="line">答：要的数据并不在辅助索引上，这种现象叫非附加索引。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>叶子节点存放的是数据对应的主键值<ul>
<li>先按照辅助索引拿到数据的主键值</li>
<li>之后还是需要去主键的聚集索引里面查询数据</li>
</ul>
</li>
</ul>
<p><strong>1、聚集索引</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#InnoDB存储引擎表示索引组织表，即表中数据按照主键顺序存放。而聚集索引（clustered index）就是按照每张表的主键构造一棵B+树，同时叶子结点存放的即为整张表的行记录数据，也将聚集索引的叶子结点称为数据页。聚集索引的这个特性决定了索引组织表中数据也是索引的一部分。同B+树数据结构一样，每个数据页都通过一个双向链表来进行链接。</span><br><span class="line">    </span><br><span class="line">#如果未定义主键，MySQL取第一个唯一索引（unique）而且只含非空列（NOT NULL）作为主键，InnoDB使用它作为聚簇索引。</span><br><span class="line">    </span><br><span class="line">#如果没有这样的列，InnoDB就自己产生一个这样的ID值，它有六个字节，而且是隐藏的，使其作为聚簇索引。</span><br><span class="line"></span><br><span class="line">#由于实际的数据页只能按照一棵B+树进行排序，因此每张表只能拥有一个聚集索引。在多少情况下，查询优化器倾向于采用聚集索引。因为聚集索引能够在B+树索引的叶子节点上直接找到数据。此外由于定义了数据的逻辑顺序，聚集索引能够特别快地访问针对范围值得查询。</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427142509739.png" alt="image-20210427142509739"></p>
<p><strong><font color="red">聚集索引的好处之一：它对主键的排序查找和范围查找速度非常快，叶子节点的数据就是用户所要查询的数据。如用户需要查找一张表，查询最后的10位用户信息，由于B+树索引是双向链表，所以用户可以快速找到最后一个数据页，并取出10条记录</font></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#参照第六小结测试索引的准备阶段来创建出表s1</span><br><span class="line">mysql&gt; desc s1; #最开始没有主键</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field  | Type        | Null | Key | Default | Extra |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| id     | int(11)     | NO   |     | NULL    |       |</span><br><span class="line">| name   | varchar(20) | YES  |     | NULL    |       |</span><br><span class="line">| gender | char(6)     | YES  |     | NULL    |       |</span><br><span class="line">| email  | varchar(50) | YES  |     | NULL    |       |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select * from s1 order by id desc limit 10; #Using filesort，需要二次排序</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+----------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra          |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+----------------+</span><br><span class="line">|  1 | SIMPLE      | s1    | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 2633472 |   100.00 | Using filesort |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+----------------+</span><br><span class="line">1 row in set, 1 warning (0.11 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table s1 add primary key(id); #添加主键</span><br><span class="line">Query OK, 0 rows affected (13.37 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select * from s1 order by id desc limit 10; #基于主键的聚集索引在创建完毕后就已经完成了排序，无需二次排序</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------+</span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------+</span><br><span class="line">|  1 | SIMPLE      | s1    | NULL       | index | NULL          | PRIMARY | 4       | NULL |   10 |   100.00 | NULL  |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------+</span><br><span class="line">1 row in set, 1 warning (0.04 sec)</span><br></pre></td></tr></table></figure>



<p><font color="red"><strong>聚集索引的好处之二：范围查询（range query），即如果要查找主键某一范围内的数据，通过叶子节点的上层中间节点就可以得到页的范围，之后直接读取数据页即可</strong></font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table s1 drop primary key;</span><br><span class="line">Query OK, 2699998 rows affected (24.23 sec)</span><br><span class="line">Records: 2699998  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; desc s1;</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field  | Type        | Null | Key | Default | Extra |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| id     | int(11)     | NO   |     | NULL    |       |</span><br><span class="line">| name   | varchar(20) | YES  |     | NULL    |       |</span><br><span class="line">| gender | char(6)     | YES  |     | NULL    |       |</span><br><span class="line">| email  | varchar(50) | YES  |     | NULL    |       |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">4 rows in set (0.12 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select * from s1 where id &gt; 1 and id &lt; 1000000; #没有聚集索引，预估需要检索的rows数如下</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | s1    | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 2690100 |    11.11 | Using where |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table s1 add primary key(id);</span><br><span class="line">Query OK, 0 rows affected (16.25 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select * from s1 where id &gt; 1 and id &lt; 1000000; #有聚集索引，预估需要检索的rows数如下</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows    | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | s1    | NULL       | range | PRIMARY       | PRIMARY | 4       | NULL | 1343355 |   100.00 | Using where |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+---------+---------+------+---------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.09 sec)</span><br></pre></td></tr></table></figure>

<p><strong>2、辅助索引</strong></p>
<p>表中除了聚集索引外其他索引都是辅助索引（Secondary Index，也称为非聚集索引），与聚集索引的区别是：辅助索引的叶子节点不包含行记录的全部数据。</p>
<p>叶子节点除了包含键值以外，每个叶子节点中的索引行中还包含一个书签（bookmark）。该书签用来告诉InnoDB存储引擎去哪里可以找到与索引相对应的行数据。</p>
<p>由于InnoDB存储引擎是索引组织表，因此InnoDB存储引擎的辅助索引的书签就是相应行数据的聚集索引键。如下图</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427151345317.png" alt="image-20210427151345317"></p>
<p>辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引，但只能有一个聚集索引。当通过辅助索引来寻找数据时，InnoDB存储引擎会遍历辅助索引并通过叶子级别的指针获得只想主键索引的主键，然后再通过主键索引来找到一个完整的行记录。</p>
<p>举例来说，如果在一棵高度为3的辅助索引树种查找数据，那需要对这个辅助索引树遍历3次找到指定主键，如果聚集索引树的高度同样为3，那么还需要对聚集索引树进行3次查找，最终找到一个完整的行数据所在的页，因此一共需要6次逻辑IO访问才能得到最终的一个数据页。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427151423480.png" alt="image-20210427151423480"></p>
<h3 id="五-MySQL索引管理"><a href="#五-MySQL索引管理" class="headerlink" title="五 MySQL索引管理"></a><strong>五 MySQL索引管理</strong></h3><p><strong>一 功能</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#1. 索引的功能就是加速查找</span><br><span class="line">#2. mysql中的primary key，unique，联合唯一也都是索引，这些索引除了加速查找以外，还有约束的功能</span><br></pre></td></tr></table></figure>

<p><strong>二 MySQL常用的索引</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">普通索引INDEX：加速查找</span><br><span class="line"></span><br><span class="line">唯一索引：</span><br><span class="line">    -主键索引PRIMARY KEY：加速查找+约束（不为空、不能重复）</span><br><span class="line">    -唯一索引UNIQUE:加速查找+约束（不能重复）</span><br><span class="line"></span><br><span class="line">联合索引：</span><br><span class="line">    -PRIMARY KEY(id,name):联合主键索引</span><br><span class="line">    -UNIQUE(id,name):联合唯一索引</span><br><span class="line">    -INDEX(id,name):联合普通索引</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">举个例子来说，比如你在为某商场做一个会员卡的系统。</span><br><span class="line"></span><br><span class="line">这个系统有一个会员表</span><br><span class="line">有下列字段：</span><br><span class="line">会员编号 INT</span><br><span class="line">会员姓名 VARCHAR(10)</span><br><span class="line">会员身份证号码 VARCHAR(18)</span><br><span class="line">会员电话 VARCHAR(10)</span><br><span class="line">会员住址 VARCHAR(50)</span><br><span class="line">会员备注信息 TEXT</span><br><span class="line"></span><br><span class="line">那么这个 会员编号，作为主键，使用 PRIMARY</span><br><span class="line">会员姓名 如果要建索引的话，那么就是普通的 INDEX</span><br><span class="line">会员身份证号码 如果要建索引的话，那么可以选择 UNIQUE （唯一的，不允许重复）</span><br><span class="line"></span><br><span class="line">#除此之外还有全文索引，即FULLTEXT</span><br><span class="line">会员备注信息 ， 如果需要建索引的话，可以选择全文搜索。</span><br><span class="line">用于搜索很长一篇文章的时候，效果最好。</span><br><span class="line">用在比较短的文本，如果就一两行字的，普通的 INDEX 也可以。</span><br><span class="line">但其实对于全文搜索，我们并不会使用MySQL自带的该索引，而是会选择第三方软件如Sphinx，专门来做全文搜索。</span><br><span class="line"></span><br><span class="line">#其他的如空间索引SPATIAL，了解即可，几乎不用</span><br></pre></td></tr></table></figure>

<p><strong>三 索引的两大类型hash与btree</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#我们可以在创建上述索引的时候，为其指定索引类型，分两类</span><br><span class="line">hash类型的索引：查询单条快，范围查询慢</span><br><span class="line">btree类型的索引：b+树，层数越多，数据量指数级增长（我们就用它，因为innodb默认支持它）</span><br><span class="line"></span><br><span class="line">#不同的存储引擎支持的索引类型也不一样</span><br><span class="line">InnoDB 支持事务，支持行级别锁定，支持 B-tree、Full-text 等索引，不支持 Hash 索引；</span><br><span class="line">MyISAM 不支持事务，支持表级别锁定，支持 B-tree、Full-text 等索引，不支持 Hash 索引；</span><br><span class="line">Memory 不支持事务，支持表级别锁定，支持 B-tree、Hash 等索引，不支持 Full-text 索引；</span><br><span class="line">NDB 支持事务，支持行级别锁定，支持 Hash 索引，不支持 B-tree、Full-text 等索引；</span><br><span class="line">Archive 不支持事务，支持表级别锁定，不支持 B-tree、Hash、Full-text 等索引；</span><br></pre></td></tr></table></figure>

<p><strong>四 创建/删除索引的语法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#方法一：创建表时</span><br><span class="line">    　　CREATE TABLE 表名 (</span><br><span class="line">                字段名1  数据类型 [完整性约束条件…],</span><br><span class="line">                字段名2  数据类型 [完整性约束条件…],</span><br><span class="line">                [UNIQUE | FULLTEXT | SPATIAL ]   INDEX | KEY</span><br><span class="line">                [索引名]  (字段名[(长度)]  [ASC |DESC]) </span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#方法二：CREATE在已存在的表上创建索引</span><br><span class="line">        CREATE  [UNIQUE | FULLTEXT | SPATIAL ]  INDEX  索引名 </span><br><span class="line">                     ON 表名 (字段名[(长度)]  [ASC |DESC]) ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#方法三：ALTER TABLE在已存在的表上创建索引</span><br><span class="line">        ALTER TABLE 表名 ADD  [UNIQUE | FULLTEXT | SPATIAL ] INDEX</span><br><span class="line">                             索引名 (字段名[(长度)]  [ASC |DESC]) ;</span><br><span class="line">                             </span><br><span class="line">#删除索引：DROP INDEX 索引名 ON 表名字;</span><br></pre></td></tr></table></figure>

<p>示范</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#方式一</span><br><span class="line">create table t1(</span><br><span class="line">    id int,</span><br><span class="line">    name char,</span><br><span class="line">    age int,</span><br><span class="line">    sex enum(&#39;male&#39;,&#39;female&#39;),</span><br><span class="line">    unique key uni_id(id),</span><br><span class="line">    index ix_name(name) #index没有key</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#方式二</span><br><span class="line">create index ix_age on t1(age);</span><br><span class="line"></span><br><span class="line">#方式三</span><br><span class="line">alter table t1 add index ix_sex(sex);</span><br><span class="line"></span><br><span class="line">#查看</span><br><span class="line">mysql&gt; show create table t1;</span><br><span class="line">| t1    | CREATE TABLE &#96;t1&#96; (</span><br><span class="line">  &#96;id&#96; int(11) DEFAULT NULL,</span><br><span class="line">  &#96;name&#96; char(1) DEFAULT NULL,</span><br><span class="line">  &#96;age&#96; int(11) DEFAULT NULL,</span><br><span class="line">  &#96;sex&#96; enum(&#39;male&#39;,&#39;female&#39;) DEFAULT NULL,</span><br><span class="line">  UNIQUE KEY &#96;uni_id&#96; (&#96;id&#96;),</span><br><span class="line">  KEY &#96;ix_name&#96; (&#96;name&#96;),</span><br><span class="line">  KEY &#96;ix_age&#96; (&#96;age&#96;),</span><br><span class="line">  KEY &#96;ix_sex&#96; (&#96;sex&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;latin1</span><br></pre></td></tr></table></figure>

<h3 id="六-测试索引"><a href="#六-测试索引" class="headerlink" title="六 测试索引"></a><strong>六 测试索引</strong></h3><p><strong>一 准备</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#1. 准备表</span><br><span class="line">create table s1(</span><br><span class="line">id int,</span><br><span class="line">name varchar(20),</span><br><span class="line">gender char(6),</span><br><span class="line">email varchar(50)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#2. 创建存储过程，实现批量插入记录</span><br><span class="line">delimiter $$ #声明存储过程的结束符号为$$</span><br><span class="line">create procedure auto_insert1()</span><br><span class="line">BEGIN</span><br><span class="line">    declare i int default 1;</span><br><span class="line">    while(i&lt;3000000)do</span><br><span class="line">        insert into s1 values(i,&#39;egon&#39;,&#39;male&#39;,concat(&#39;egon&#39;,i,&#39;@oldboy&#39;));</span><br><span class="line">        set i&#x3D;i+1;</span><br><span class="line">    end while;</span><br><span class="line">END$$ #$$结束</span><br><span class="line">delimiter ; #重新声明分号为结束符号</span><br><span class="line"></span><br><span class="line">#3. 查看存储过程</span><br><span class="line">show create procedure auto_insert1\G </span><br><span class="line"></span><br><span class="line">#4. 调用存储过程</span><br><span class="line">call auto_insert1();</span><br></pre></td></tr></table></figure>

<p><strong>二 在没有索引的前提下测试查询速度</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#无索引：mysql根本就不知道到底是否存在id等于333333333的记录，只能把数据表从头到尾扫描一遍，此时有多少个磁盘块就需要进行多少IO操作，所以查询速度很慢</span><br><span class="line">mysql&gt; select * from s1 where id&#x3D;333333333;</span><br><span class="line">Empty set (0.33 sec)</span><br></pre></td></tr></table></figure>

<p><strong>三 在表中已经存在大量数据的前提下，为某个字段段建立索引，建立速度会很慢</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427153849792.png" alt="image-20210427153849792"></p>
<p><strong>四 在索引建立完毕后，以该字段为查询条件时，查询速度提升明显</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427153904565.png" alt="image-20210427153904565"></p>
<p><strong>PS：</strong></p>
<p><strong>1. mysql先去索引表里根据b+树的搜索原理很快搜索到id等于333333333的记录不存在，IO大大降低，因而速度明显提升</strong></p>
<p><strong>2. 我们可以去mysql的data目录下找到该表，可以看到占用的硬盘空间多了</strong></p>
<p><strong>3. 需要注意，如下图</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427153925816.png" alt="image-20210427153925816"></p>
<p><strong>五 总结</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#1. 一定是为搜索条件的字段创建索引，比如select * from s1 where id &#x3D; 333;就需要为id加上索引</span><br><span class="line"></span><br><span class="line">#2. 在表中已经有大量数据的情况下，建索引会很慢，且占用硬盘空间，建完后查询速度加快</span><br><span class="line">比如create index idx on s1(id);会扫描表中所有的数据，然后以id为数据项，创建索引结构，存放于硬盘的表中。</span><br><span class="line">建完以后，再查询就会很快了。</span><br><span class="line"></span><br><span class="line">#3. 需要注意的是：innodb表的索引会存放于s1.ibd文件中，而myisam表的索引则会有单独的索引文件table1.MYI</span><br><span class="line"></span><br><span class="line">MySAM索引文件和数据文件是分离的，索引文件仅保存数据记录的地址。而在innodb中，表数据文件本身就是按照B+Tree（BTree即Balance True）组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录。这个索引的key是数据表的主键，因此innodb表数据文件本身就是主索引。</span><br><span class="line">因为inndob的数据文件要按照主键聚集，所以innodb要求表必须要有主键（Myisam可以没有），如果没有显式定义，则mysql系统会自动选择一个可以唯一标识数据记录的列作为主键，如果不存在这种列，则mysql会自动为innodb表生成一个隐含字段作为主键，这字段的长度为6个字节，类型为长整型.</span><br></pre></td></tr></table></figure>

<h3 id="七-正确使用索引"><a href="#七-正确使用索引" class="headerlink" title="七 正确使用索引"></a>七 正确使用索引</h3><p><strong>一 索引未命中</strong></p>
<p><strong><em>\</em>并不是说我们创建了索引就一定会加快查询速度，*****</strong>*若想利用索引达到预想的提高查询速度的效果，我们在添加索引时，必须遵循以下问题****</p>
<p><font color="green"><strong>1 范围问题，或者说条件不明确，条件中出现这些符号或关键字：</strong>&gt;、&gt;=、&lt;、&lt;=、!= 、between…and…、like、大于号、小于号**</font></p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427155426561.png" alt="image-20210427155426561"></p>
<p>不等于！=</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427155455897.png" alt="image-20210427155455897"></p>
<p>between …and…</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427155530459.png" alt="image-20210427155530459"></p>
<p>like</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427155615794.png" alt="image-20210427155615794"></p>
<p><font color="green"><strong>2 尽量选择区分度高的列作为索引,区分度的公式是count(distinct col)/count(*)，表示字段不重复的比例，比例越大我们扫描的记录数越少，唯一键的区分度是1，而一些状态、性别字段可能在大数据面前区分度就是0，那可能有人会问，这个比例有什么经验值吗？使用场景不同，这个值也很难确定，一般需要join的字段我们都要求是0.1以上，即平均1条扫描10条记录</strong></font>&gt;</p>
<p>#先把表中的索引都删除，让我们专心研究区分度的问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#先把表中的索引都删除，让我们专心研究区分度的问题</span><br><span class="line">mysql&gt; desc s1;</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field  | Type        | Null | Key | Default | Extra |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| id     | int(11)     | YES  | MUL | NULL    |       |</span><br><span class="line">| name   | varchar(20) | YES  |     | NULL    |       |</span><br><span class="line">| gender | char(5)     | YES  |     | NULL    |       |</span><br><span class="line">| email  | varchar(50) | YES  | MUL | NULL    |       |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; drop index a on s1;</span><br><span class="line">Query OK, 0 rows affected (0.20 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; drop index d on s1;</span><br><span class="line">Query OK, 0 rows affected (0.18 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; desc s1;</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field  | Type        | Null | Key | Default | Extra |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| id     | int(11)     | YES  |     | NULL    |       |</span><br><span class="line">| name   | varchar(20) | YES  |     | NULL    |       |</span><br><span class="line">| gender | char(5)     | YES  |     | NULL    |       |</span><br><span class="line">| email  | varchar(50) | YES  |     | NULL    |       |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427155933728.png" alt="image-20210427155933728"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">我们编写存储过程为表s1批量添加记录，name字段的值均为egon，也就是说name这个字段的区分度很低（gender字段也是一样的，我们稍后再搭理它）</span><br><span class="line"></span><br><span class="line">回忆b+树的结构，查询的速度与树的高度成反比，要想将树的高低控制的很低，需要保证：在某一层内数据项均是按照从左到右，从小到大的顺序依次排开，即左1&lt;左2&lt;左3&lt;...</span><br><span class="line"></span><br><span class="line">而对于区分度低的字段，无法找到大小关系，因为值都是相等的，毫无疑问，还想要用b+树存放这些等值的数据，只能增加树的高度，字段的区分度越低，则树的高度越高。极端的情况，索引字段的值都一样，那么b+树几乎成了一根棍。本例中就是这种极端的情况，name字段所有的值均为&#39;egon&#39;</span><br><span class="line"></span><br><span class="line">#现在我们得出一个结论：为区分度低的字段建立索引，索引树的高度会很高，然而这具体会带来什么影响呢？？？</span><br><span class="line"></span><br><span class="line">#1：如果条件是name&#x3D;&#39;xxxx&#39;,那么肯定是可以第一时间判断出&#39;xxxx&#39;是不在索引树中的（因为树中所有的值均为&#39;egon’），所以查询速度很快</span><br><span class="line"></span><br><span class="line">#2：如果条件正好是name&#x3D;&#39;egon&#39;,查询时，我们永远无法从树的某个位置得到一个明确的范围，只能往下找，往下找，往下找。。。这与全表扫描的IO次数没有多大区别，所以速度很慢</span><br></pre></td></tr></table></figure>

<p><font color="green"><strong>3 =和in可以乱序，比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮你优化成索引可以识别的形式</strong></font>&gt;</p>
<p><font color="green"><strong>4 索引列不能参与计算，保持列“干净”，比如from_unixtime(create_time) = ’2014-05-29’就不能使用到索引，原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都应用函数才能比较，显然成本太大。所以语句应该写成create_time = unix_timestamp(’2014-05-29’)</strong></font></p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427160127287.png" alt="image-20210427160127287"></p>
<p><strong>5 and/or</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#1、and与or的逻辑</span><br><span class="line">    条件1 and 条件2:所有条件都成立才算成立，但凡要有一个条件不成立则最终结果不成立</span><br><span class="line">    条件1 or 条件2:只要有一个条件成立则最终结果就成立</span><br><span class="line"></span><br><span class="line">#2、and的工作原理</span><br><span class="line">    条件：</span><br><span class="line">        a &#x3D; 10 and b &#x3D; &#39;xxx&#39; and c &gt; 3 and d &#x3D;4</span><br><span class="line">    索引：</span><br><span class="line">        制作联合索引(d,a,b,c)</span><br><span class="line">    工作原理:</span><br><span class="line">        对于连续多个and：mysql会按照联合索引，从左到右的顺序找一个区分度高的索引字段(这样便可以快速锁定很小的范围)，加速查询，即按照d—&gt;a-&gt;b-&gt;c的顺序</span><br><span class="line"></span><br><span class="line">#3、or的工作原理</span><br><span class="line">    条件：</span><br><span class="line">        a &#x3D; 10 or b &#x3D; &#39;xxx&#39; or c &gt; 3 or d &#x3D;4</span><br><span class="line">    索引：</span><br><span class="line">        制作联合索引(d,a,b,c)</span><br><span class="line">        </span><br><span class="line">    工作原理:</span><br><span class="line">        对于连续多个or：mysql会按照条件的顺序，从左到右依次判断，即a-&gt;b-&gt;c-&gt;d</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427160152591.png" alt="image-20210427160152591"></p>
<p>在左边条件成立但是索引字段的区分度低的情况下（name与gender均属于这种情况），会依次往右找到一个区分度高的索引字段，加速查询</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427160219952.png" alt="image-20210427160219952"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427160235665.png" alt="image-20210427160235665"></p>
<p>经过分析，在条件为name=’egon’ and gender=’male’ and id&gt;333 and email=’xxx’的情况下，我们完全没必要为前三个条件的字段加索引，因为只能用上email字段的索引，前三个字段的索引反而会降低我们的查询效率</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427160306004.png" alt="image-20210427160306004"></p>
<p><font color="green"><strong>6 最左前缀匹配原则（详见第八小节），非常重要的原则，对于组合索引mysql会一直向右匹配直到遇到范围查询(&gt;、&lt;、between、like)就停止匹配(指的是范围大了，有索引速度也慢)，比如a = 1 and b = 2 and c &gt; 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。</strong></font>&gt;</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427160338243.png" alt="image-20210427160338243"></p>
<p><strong>7 其他情况</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- 使用函数</span><br><span class="line">    select * from tb1 where reverse(email) &#x3D; &#39;egon&#39;;</span><br><span class="line">            </span><br><span class="line">- 类型不一致</span><br><span class="line">    如果列是字符串类型，传入条件是必须用引号引起来，不然...</span><br><span class="line">    select * from tb1 where email &#x3D; 999;</span><br><span class="line">    </span><br><span class="line">#排序条件为索引，则select字段必须也是索引字段，否则无法命中</span><br><span class="line">- order by</span><br><span class="line">    select name from s1 order by email desc;</span><br><span class="line">    当根据索引排序时候，select查询的字段如果不是索引，则速度仍然很慢</span><br><span class="line">    select email from s1 order by email desc;</span><br><span class="line">    特别的：如果对主键排序，则还是速度很快：</span><br><span class="line">        select * from tb1 order by nid desc;</span><br><span class="line"> </span><br><span class="line">- 组合索引最左前缀</span><br><span class="line">    如果组合索引为：(name,email)</span><br><span class="line">    name and email       -- 命中索引</span><br><span class="line">    name                 -- 命中索引</span><br><span class="line">    email                -- 未命中索引</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- count(1)或count(列)代替count(*)在mysql中没有差别了</span><br><span class="line"></span><br><span class="line">- create index xxxx  on tb(title(19)) #text类型，必须制定长度</span><br></pre></td></tr></table></figure>

<p><strong>二 其他注意事项</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- 避免使用select *</span><br><span class="line">- count(1)或count(列) 代替 count(*)</span><br><span class="line">- 创建表时尽量时 char 代替 varchar</span><br><span class="line">- 表的字段顺序固定长度的字段优先</span><br><span class="line">- 组合索引代替多个单列索引（经常使用多个条件查询时）</span><br><span class="line">- 尽量使用短索引</span><br><span class="line">- 使用连接（JOIN）来代替子查询(Sub-Queries)</span><br><span class="line">- 连表时注意条件类型需一致</span><br><span class="line">- 索引散列值（重复少）不适合建索引，例：性别不适合</span><br></pre></td></tr></table></figure>

<h3 id="八-联合索引与覆盖索引"><a href="#八-联合索引与覆盖索引" class="headerlink" title="八 联合索引与覆盖索引"></a>八 联合索引与覆盖索引</h3><p><strong>一 联合索引</strong></p>
<p>联合索引时指对表上的多个列合起来做一个索引。联合索引的创建方法与单个索引的创建方法一样，不同之处在仅在于有多个索引列，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table t(</span><br><span class="line">    -&gt; a int,</span><br><span class="line">    -&gt; b int,</span><br><span class="line">    -&gt; primary key(a),</span><br><span class="line">    -&gt; key idx_a_b(a,b)</span><br><span class="line">    -&gt; );</span><br><span class="line">Query OK, 0 rows affected (0.11 sec)</span><br></pre></td></tr></table></figure>

<p>那么何时需要使用联合索引呢？在讨论这个问题之前，先来看一下联合索引内部的结果。从本质上来说，联合索引就是一棵B+树，不同的是联合索引的键值得数量不是1，而是&gt;=2。接着来讨论两个整型列组成的联合索引，假定两个键值得名称分别为a、b如图</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20210427160449998.png" alt="image-20210427160449998"></p>
<p>可以看到这与我们之前看到的单个键的B+树并没有什么不同，键值都是排序的，通过叶子结点可以逻辑上顺序地读出所有数据，就上面的例子来说，即（1,1），（1,2），（2,1），（2,4），（3,1），（3,2），数据按（a,b）的顺序进行了存放。</p>
<p>因此，对于查询select * from table where a=xxx and b=xxx, 显然是可以使用(a,b) 这个联合索引的，对于单个列a的查询select * from table where a=xxx,也是可以使用（a,b）这个索引的。</p>
<p>但对于b列的查询select * from table where b=xxx,则不可以使用（a,b） 索引，其实你不难发现原因，叶子节点上b的值为1、2、1、4、1、2显然不是排序的，因此对于b列的查询使用不到(a,b) 索引</p>
<p><strong>联合索引的第二个好处是在第一个键相同的情况下，已经对第二个键进行了排序处理</strong>，例如在很多情况下应用程序都需要查询某个用户的购物情况，并按照时间进行排序，最后取出最近三次的购买记录，这时使用联合索引可以帮我们避免多一次的排序操作，因为索引本身在叶子节点已经排序了，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;准备表&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">create table buy_log(</span><br><span class="line">    userid int unsigned not null,</span><br><span class="line">    buy_date date</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into buy_log values</span><br><span class="line">(1,&#39;2009-01-01&#39;),</span><br><span class="line">(2,&#39;2009-01-01&#39;),</span><br><span class="line">(3,&#39;2009-01-01&#39;),</span><br><span class="line">(1,&#39;2009-02-01&#39;),</span><br><span class="line">(3,&#39;2009-02-01&#39;),</span><br><span class="line">(1,&#39;2009-03-01&#39;),</span><br><span class="line">(1,&#39;2009-04-01&#39;);</span><br><span class="line"></span><br><span class="line">alter table buy_log add key(userid);</span><br><span class="line">alter table buy_log add key(userid,buy_date);</span><br><span class="line"></span><br><span class="line">#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;验证&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">mysql&gt; show create table buy_log;</span><br><span class="line">| buy_log | CREATE TABLE &#96;buy_log&#96; (</span><br><span class="line">  &#96;userid&#96; int(10) unsigned NOT NULL,</span><br><span class="line">  &#96;buy_date&#96; date DEFAULT NULL,</span><br><span class="line">  KEY &#96;userid&#96; (&#96;userid&#96;),</span><br><span class="line">  KEY &#96;userid_2&#96; (&#96;userid&#96;,&#96;buy_date&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 |</span><br><span class="line"></span><br><span class="line">#可以看到possible_keys在这里有两个索引可以用，分别是单个索引userid与联合索引userid_2,但是优化器最终选择了使用的key是userid因为该索引的叶子节点包含单个键值，所以理论上一个页能存放的记录应该更多</span><br><span class="line">mysql&gt; explain select * from buy_log where userid&#x3D;2;</span><br><span class="line">+----+-------------+---------+------+-----------------+--------+---------+-------+------+-------+</span><br><span class="line">| id | select_type | table   | type | possible_keys   | key    | key_len | ref   | rows | Extra |</span><br><span class="line">+----+-------------+---------+------+-----------------+--------+---------+-------+------+-------+</span><br><span class="line">|  1 | SIMPLE      | buy_log | ref  | userid,userid_2 | userid | 4       | const |    1 |       |</span><br><span class="line">+----+-------------+---------+------+-----------------+--------+---------+-------+------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#接着假定要取出userid为1的最近3次的购买记录，用的就是联合索引userid_2了，因为在这个索引中，在userid&#x3D;1的情况下，buy_date都已经排序好了</span><br><span class="line">mysql&gt; explain select * from buy_log where userid&#x3D;1 order by buy_date desc limit 3;</span><br><span class="line">+----+-------------+---------+------+-----------------+----------+---------+-------+------+--------------------------+</span><br><span class="line">| id | select_type | table   | type | possible_keys   | key      | key_len | ref   | rows | Extra                    |</span><br><span class="line">+----+-------------+---------+------+-----------------+----------+---------+-------+------+--------------------------+</span><br><span class="line">|  1 | SIMPLE      | buy_log | ref  | userid,userid_2 | userid_2 | 4       | const |    4 | Using where; Using index |</span><br><span class="line">+----+-------------+---------+------+-----------------+----------+---------+-------+------+--------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#ps：如果extra的排序显示是Using filesort，则意味着在查出数据后需要二次排序(如下查询语句，没有先用where userid&#x3D;3先定位范围，于是即便命中索引也没用，需要二次排序)</span><br><span class="line">mysql&gt; explain select * from buy_log order by buy_date desc limit 3;</span><br><span class="line">+----+-------------+---------+-------+---------------+----------+---------+------+------+-----------------------------+</span><br><span class="line">| id | select_type | table   | type  | possible_keys | key      | key_len | ref  | rows | Extra                       |</span><br><span class="line">+----+-------------+---------+-------+---------------+----------+---------+------+------+-----------------------------+</span><br><span class="line">|  1 | SIMPLE      | buy_log | index | NULL          | userid_2 | 8       | NULL |    7 | Using index; Using filesort |</span><br><span class="line">+----+-------------+---------+-------+---------------+----------+---------+------+------+-----------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#对于联合索引（a,b）,下述语句可以直接使用该索引，无需二次排序</span><br><span class="line">select ... from table where a&#x3D;xxx order by b;</span><br><span class="line"></span><br><span class="line">#然后对于联合索引(a,b,c)来首，下列语句同样可以直接通过索引得到结果</span><br><span class="line">select ... from table where a&#x3D;xxx order by b;</span><br><span class="line">select ... from table where a&#x3D;xxx and b&#x3D;xxx order by c;</span><br><span class="line"></span><br><span class="line">#但是对于联合索引(a,b,c)，下列语句不能通过索引直接得到结果，还需要自己执行一次filesort操作，因为索引（a，c)并未排序</span><br><span class="line">select ... from table where a&#x3D;xxx order by c;</span><br></pre></td></tr></table></figure>

<p><strong>二 覆盖索引</strong></p>
<p><font color="red"><strong>InnoDB存储引擎支持覆盖索引（covering index，或称索引覆盖），即从辅助索引中就可以得到查询记录，而不需要查询聚集索引中的记录。</strong></font></p>
<p>使用覆盖索引的一个好处是：辅助索引不包含整行记录的所有信息，故其大小要远小于聚集索引，因此可以减少大量的IO操作</p>
<hr>
<p> 注意：覆盖索引技术最早是在InnoDB Plugin中完成并实现，这意味着对于InnoDB版本小于1.0的，或者MySQL数据库版本为5.0以下的，InnoDB存储引擎不支持覆盖索引特性</p>
<hr>
<p>对于InnoDB存储引擎的辅助索引而言，由于其包含了主键信息，因此其叶子节点存放的数据为（primary key1，priamey key2，…,key1，key2，…）。例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">select age from s1 where id&#x3D;123 and name &#x3D; &#39;egon&#39;; #id字段有索引，但是name字段没有索引,该sql命中了索引，但未覆盖，需要去聚集索引中再查找详细信息。</span><br><span class="line">最牛逼的情况是，索引字段覆盖了所有，那全程通过索引来加速查询以及获取结果就ok了</span><br><span class="line">mysql&gt; desc s1;</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type | Null | Key | Default | Extra |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">| id | int(11) | NO | | NULL | |</span><br><span class="line">| name | varchar(20) | YES | | NULL | |</span><br><span class="line">| gender | char(6) | YES | | NULL | |</span><br><span class="line">| email | varchar(50) | YES | | NULL | |</span><br><span class="line">+--------+-------------+------+-----+---------+-------+</span><br><span class="line">4 rows in set (0.21 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select name from s1 where id&#x3D;1000; #没有任何索引</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">| 1 | SIMPLE | s1 | NULL | ALL | NULL | NULL | NULL | NULL | 2688336 | 10.00 | Using where |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create index idx_id on s1(id); #创建索引</span><br><span class="line">Query OK, 0 rows affected (4.16 sec)</span><br><span class="line">Records: 0 Duplicates: 0 Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select name from s1 where id&#x3D;1000; #命中辅助索引，但是未覆盖索引，还需要从聚集索引中查找name</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------+</span><br><span class="line">| 1 | SIMPLE | s1 | NULL | ref | idx_id | idx_id | 4 | const | 1 | 100.00 | NULL |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------+</span><br><span class="line">1 row in set, 1 warning (0.08 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select id from s1 where id&#x3D;1000; #在辅助索引中就找到了全部信息，Using index代表覆盖索引</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------------+</span><br><span class="line">| 1 | SIMPLE | s1 | NULL | ref | idx_id | idx_id | 4 | const | 1 | 100.00 | Using index |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.03 sec)</span><br></pre></td></tr></table></figure>

<p><font color="red"><strong>覆盖索引的另外一个好处是对某些统计问题而言的。基于上一小结创建的表buy_log,查询计划如下</strong></font>&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select count(*) from buy_log;</span><br><span class="line">+----+-------------+---------+-------+---------------+--------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table   | type  | possible_keys | key    | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+---------+-------+---------------+--------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | buy_log | index | NULL          | userid | 4       | NULL |    7 | Using index |</span><br><span class="line">+----+-------------+---------+-------+---------------+--------+---------+------+------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>innodb存储引擎并不会选择通过查询聚集索引来进行统计。由于buy_log表有辅助索引，而辅助索引远小于聚集索引，选择辅助索引可以减少IO操作，故优化器的选择如上key为userid辅助索引</p>
<p><font color="red"><strong>对于（a,b）形式的联合索引，一般是不可以选择b中所谓的查询条件。但如果是统计操作，并且是覆盖索引，则优化器还是会选择使用该索引，如下</strong></font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#联合索引userid_2（userid,buy_date）,一般情况，我们按照buy_date是无法使用该索引的，但特殊情况下：查询语句是统计操作，且是覆盖索引，则按照buy_date当做查询条件时，也可以使用该联合索引</span><br><span class="line">mysql&gt; explain select count(*) from buy_log where buy_date &gt;&#x3D; &#39;2011-01-01&#39; and buy_date &lt; &#39;2011-02-01&#39;;</span><br><span class="line">+----+-------------+---------+-------+---------------+----------+---------+------+------+--------------------------+</span><br><span class="line">| id | select_type | table   | type  | possible_keys | key      | key_len | ref  | rows | Extra                    |</span><br><span class="line">+----+-------------+---------+-------+---------------+----------+---------+------+------+--------------------------+</span><br><span class="line">|  1 | SIMPLE      | buy_log | index | NULL          | userid_2 | 8       | NULL |    7 | Using where; Using index |</span><br><span class="line">+----+-------------+---------+-------+---------------+----------+---------+------+------+--------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="九-查询优化神器-explain"><a href="#九-查询优化神器-explain" class="headerlink" title="九 查询优化神器-explain"></a><strong>九 查询优化神器-explain</strong></h3><p><strong>关于explain命令相信大家并不陌生，具体用法和字段含义可以参考官网<a target="_blank" rel="noopener external nofollow noreferrer" href="http://dev.mysql.com/doc/refman/5.5/en/explain-output.html">explain-output</a>，这里需要强调rows是核心指标，绝大部分rows小的语句执行一定很快（有例外，下面会讲到）。所以优化语句基本上都是在优化rows。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">执行计划：让mysql预估执行操作(一般正确)</span><br><span class="line">    all &lt; index &lt; range &lt; index_merge &lt; ref_or_null &lt; ref &lt; eq_ref &lt; system&#x2F;const</span><br><span class="line">    id,email</span><br><span class="line">    </span><br><span class="line">    慢：</span><br><span class="line">        select * from userinfo3 where name&#x3D;&#39;alex&#39;</span><br><span class="line">        </span><br><span class="line">        explain select * from userinfo3 where name&#x3D;&#39;alex&#39;</span><br><span class="line">        type: ALL(全表扫描)</span><br><span class="line">            select * from userinfo3 limit 1;</span><br><span class="line">    快：</span><br><span class="line">        select * from userinfo3 where email&#x3D;&#39;alex&#39;</span><br><span class="line">        type: const(走索引)</span><br></pre></td></tr></table></figure>

<p><strong><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blog.itpub.net/29773961/viewspace-1767044/">http://blog.itpub.net/29773961/viewspace-1767044/</a></strong></p>
<h3 id="十-慢查询优化的基本步骤"><a href="#十-慢查询优化的基本步骤" class="headerlink" title="十 慢查询优化的基本步骤"></a><strong>十 慢查询优化的基本步骤</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0.先运行看看是否真的很慢，注意设置SQL_NO_CACHE</span><br><span class="line">1.where条件单表查，锁定最小返回记录表。这句话的意思是把查询语句的where都应用到表中返回的记录数最小的表开始查起，单表每个字段分别查询，看哪个字段的区分度最高</span><br><span class="line">2.explain查看执行计划，是否与1预期一致（从锁定记录较少的表开始查询）</span><br><span class="line">3.order by limit 形式的sql语句让排序的表优先查</span><br><span class="line">4.了解业务方使用场景</span><br><span class="line">5.加索引时参照建索引的几大原则</span><br><span class="line">6.观察结果，不符合预期继续从0分析</span><br></pre></td></tr></table></figure>

<h3 id="十一-慢日志管理"><a href="#十一-慢日志管理" class="headerlink" title="十一 慢日志管理"></a>十一 慢日志管理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">慢日志</span><br><span class="line">    - 执行时间 &gt; 10</span><br><span class="line">    - 未命中索引</span><br><span class="line">    - 日志文件路径</span><br><span class="line">    </span><br><span class="line">配置：</span><br><span class="line">    - 内存</span><br><span class="line">        show variables like &#39;%query%&#39;;</span><br><span class="line">        show variables like &#39;%queries%&#39;;</span><br><span class="line">        set global 变量名 &#x3D; 值</span><br><span class="line">    - 配置文件</span><br><span class="line">        mysqld --defaults-file&#x3D;&#39;E:\wupeiqi\mysql-5.7.16-winx64\mysql-5.7.16-winx64\my-default.ini&#39;</span><br><span class="line">        </span><br><span class="line">        my.conf内容：</span><br><span class="line">            slow_query_log &#x3D; ON</span><br><span class="line">            slow_query_log_file &#x3D; D:&#x2F;....</span><br><span class="line">            </span><br><span class="line">        注意：修改配置文件之后，需要重启服务</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>日志管理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">MySQL日志管理</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">错误日志: 记录 MySQL 服务器启动、关闭及运行错误等信息</span><br><span class="line">二进制日志: 又称binlog日志，以二进制文件的方式记录数据库中除 SELECT 以外的操作</span><br><span class="line">查询日志: 记录查询的信息</span><br><span class="line">慢查询日志: 记录执行时间超过指定时间的操作</span><br><span class="line">中继日志： 备库将主库的二进制日志复制到自己的中继日志中，从而在本地进行重放</span><br><span class="line">通用日志： 审计哪个账号、在哪个时段、做了哪些事件</span><br><span class="line">事务日志或称redo日志： 记录Innodb事务相关的如事务执行时间、检查点等</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">一、bin-log</span><br><span class="line">1. 启用</span><br><span class="line"># vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log-bin[&#x3D;dir\[filename]]</span><br><span class="line"># service mysqld restart</span><br><span class="line">2. 暂停</span><br><span class="line">&#x2F;&#x2F;仅当前会话</span><br><span class="line">SET SQL_LOG_BIN&#x3D;0;</span><br><span class="line">SET SQL_LOG_BIN&#x3D;1;</span><br><span class="line">3. 查看</span><br><span class="line">查看全部：</span><br><span class="line"># mysqlbinlog mysql.000002</span><br><span class="line">按时间：</span><br><span class="line"># mysqlbinlog mysql.000002 --start-datetime&#x3D;&quot;2012-12-05 10:02:56&quot;</span><br><span class="line"># mysqlbinlog mysql.000002 --stop-datetime&#x3D;&quot;2012-12-05 11:02:54&quot;</span><br><span class="line"># mysqlbinlog mysql.000002 --start-datetime&#x3D;&quot;2012-12-05 10:02:56&quot; --stop-datetime&#x3D;&quot;2012-12-05 11:02:54&quot; </span><br><span class="line"></span><br><span class="line">按字节数：</span><br><span class="line"># mysqlbinlog mysql.000002 --start-position&#x3D;260</span><br><span class="line"># mysqlbinlog mysql.000002 --stop-position&#x3D;260</span><br><span class="line"># mysqlbinlog mysql.000002 --start-position&#x3D;260 --stop-position&#x3D;930</span><br><span class="line">4. 截断bin-log（产生新的bin-log文件）</span><br><span class="line">a. 重启mysql服务器</span><br><span class="line">b. # mysql -uroot -p123 -e &#39;flush logs&#39;</span><br><span class="line">5. 删除bin-log文件</span><br><span class="line"># mysql -uroot -p123 -e &#39;reset master&#39; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">二、查询日志</span><br><span class="line">启用通用查询日志</span><br><span class="line"># vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log[&#x3D;dir\[filename]]</span><br><span class="line"># service mysqld restart</span><br><span class="line"></span><br><span class="line">三、慢查询日志</span><br><span class="line">启用慢查询日志</span><br><span class="line"># vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log-slow-queries[&#x3D;dir\[filename]]</span><br><span class="line">long_query_time&#x3D;n</span><br><span class="line"># service mysqld restart</span><br><span class="line">MySQL 5.6:</span><br><span class="line">slow-query-log&#x3D;1</span><br><span class="line">slow-query-log-file&#x3D;slow.log</span><br><span class="line">long_query_time&#x3D;3</span><br><span class="line">查看慢查询日志</span><br><span class="line">测试:BENCHMARK(count,expr)</span><br><span class="line">SELECT BENCHMARK(50000000,2*3);</span><br></pre></td></tr></table></figure>



<h3 id="十三-索引类型"><a href="#十三-索引类型" class="headerlink" title="十三 索引类型"></a>十三 索引类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">索引</span><br><span class="line"></span><br><span class="line">主键索引</span><br><span class="line">   其值唯一标识表中的每一行。该列称为表的主键,和业务无关，是唯一键索引的特定类型</span><br><span class="line">普通索引</span><br><span class="line">   create index index_name on test(name);</span><br><span class="line">   alter table test add index index_name(name);</span><br><span class="line">   在where条添加字后面的列建立索引才会加快查询速度</span><br><span class="line">   select id,name from test where state&#x3D;1 order by id group by name;</span><br><span class="line">唯一索引</span><br><span class="line">   如果在employee表中职员的姓(lname)上创建了唯一索引，则任何两个员工都不能同姓。</span><br><span class="line">前缀索引</span><br><span class="line">   根据字段的前N个字符建立索引;create index index_name on test(name(8));</span><br><span class="line">联合索引</span><br><span class="line">   多个字段建立一个索引</span><br></pre></td></tr></table></figure>

<h3 id="十四-不走索引的情况"><a href="#十四-不走索引的情况" class="headerlink" title="十四. 不走索引的情况"></a>十四. 不走索引的情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">索引</span><br><span class="line"></span><br><span class="line">主键索引</span><br><span class="line">   其值唯一标识表中的每一行。该列称为表的主键,和业务无关，是唯一键索引的特定类型</span><br><span class="line">普通索引</span><br><span class="line">   create index index_name on test(name);</span><br><span class="line">   alter table test add index index_name(name);</span><br><span class="line">   在where条添加字后面的列建立索引才会加快查询速度</span><br><span class="line">   select id,name from test where state&#x3D;1 order by id group by name;</span><br><span class="line">唯一索引</span><br><span class="line">   如果在employee表中职员的姓(lname)上创建了唯一索引，则任何两个员工都不能同姓。</span><br><span class="line">前缀索引</span><br><span class="line">   根据字段的前N个字符建立索引;create index index_name on test(name(8));</span><br><span class="line">联合索引</span><br><span class="line">   多个字段建立一个索引</span><br><span class="line">1、select没有用where 没有查询条件，或者查询条件没有建立索引   没有where的</span><br><span class="line">2、将来结果集的条目占总数据量的30%的时候。优化器觉得走全表扫描更好，</span><br><span class="line">3、索引本身失效，统计数据不真实   (比如表里面内容频繁发生改变，索引更新没跟上，索引就失效了)索引有自我维护的能力。   删除重建索引</span><br><span class="line">4、隐式转换导致索引失效.这一点应当引起重视.也是开发中经常会犯的错误.</span><br><span class="line">5、查询条件使用函数在索引列上，或者对索引列进行运算，运算包括(+，-，*，&#x2F;，! 等) </span><br><span class="line">6、&lt;&gt; 不等于 ，not in 不走索引</span><br><span class="line">7、like &quot;%_&quot; 百分号在最前面不走</span><br></pre></td></tr></table></figure>

<h3 id="十五-索引性能排序"><a href="#十五-索引性能排序" class="headerlink" title="十五. 索引性能排序"></a>十五. 索引性能排序</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">索引性能排序</span><br><span class="line">1、index：Full Index Scan，index与ALL区别为index类型只遍历索引树</span><br><span class="line">2、range:索引范围扫描，对索引的扫描开始于某一点，返回匹配值域的行。 where条件后  &gt; &lt; &gt;&#x3D; &lt;&#x3D; in or between and</span><br><span class="line">3、ref：使用非唯一索引扫描或者唯一索引的前缀扫描，返回匹配某个单独值的记录行</span><br><span class="line">4、eq_ref：类似ref，区别就在使用的索引是唯一索引，对于每个索引键值，表中只有一条记录匹配，简单来说，就是多表连接中使用primary key或者 unique key作为关联条件</span><br><span class="line">5、const、system：当MySQL对查询某部分进行优化，并转换为一个常量时，使用这些类型访问。</span><br><span class="line">如将主键置于where列表中，MySQL就能将该查询转换为一个常量</span><br><span class="line">6、NULL：找一个不存在的值</span><br><span class="line">7、Extra: </span><br></pre></td></tr></table></figure>



<h3 id="十六-生产案例"><a href="#十六-生产案例" class="headerlink" title="十六. 生产案例"></a>十六. 生产案例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">一、发现sql语句慢</span><br><span class="line">   select name from country where name like &quot;C%&quot; limit 10;</span><br><span class="line">二、desc country ----&gt; 看表结构发现没有创建索引</span><br><span class="line">三、看执行计划    possible_keys key Extra 都是null 没有索引或者没走索引</span><br><span class="line">   explain select name from country where name like &quot;C%&quot; limit 10;</span><br><span class="line">四、发现没走索引 创建索引 适不适合？     看唯一值多不多，多就可以（也可以建立联合索引-让唯一值更多）</span><br><span class="line">   select count(*) from country;  ---239</span><br><span class="line">   select count(distinct name) from country; ---239</span><br><span class="line">五、建立索引</span><br><span class="line">   alter table country add index name_idx(name);</span><br><span class="line">六、验证</span><br><span class="line">   explain select name from country where name like &quot;C%&quot; limit 10;</span><br></pre></td></tr></table></figure>



<h3 id="十七-建立索引规范"><a href="#十七-建立索引规范" class="headerlink" title="十七. 建立索引规范"></a>十七. 建立索引规范</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.选择唯一性索引 注意：如果重复值较多，可以考虑采用联合索引</span><br><span class="line">2.为经常需要排序、分组和联合操作的字段建立索引</span><br><span class="line">3.为常作为查询条件的字段建立索引    经常where的</span><br><span class="line">4.尽量使用前缀来索引</span><br><span class="line">5.限制索引的数目</span><br><span class="line">6.删除不再使用或者很少使用的索引</span><br></pre></td></tr></table></figure>

<h3 id="十八-备份相关"><a href="#十八-备份相关" class="headerlink" title="十八. 备份相关"></a>十八. 备份相关</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">热备</span><br><span class="line">在数据库正常业务是，备份数据，并且能够一致性恢复 </span><br><span class="line">冷备 </span><br><span class="line">关闭数据库业务，数据库没有任何变更的情况下，进行备份数据. </span><br><span class="line">温备 </span><br><span class="line">锁表备份，只能查询不能修改</span><br><span class="line"></span><br><span class="line">逻辑备份: </span><br><span class="line">基于SQL语句进行备份: mysqldump mysqlbinlog</span><br><span class="line">物理备份: </span><br><span class="line">基于磁盘文件备份: cp xtrabackup(XBK)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1）-A 全备参数</span><br><span class="line">mysqldump -uroot -p -A &gt;&#x2F;backup&#x2F;full.sql</span><br><span class="line">2）-B db1 db2 db3 备份多个单库</span><br><span class="line">mysqldump -uroot -p -B oldboy world &gt;&#x2F;backup&#x2F;bak.sql</span><br><span class="line">3）备份单个或多个表</span><br><span class="line">mysqldump -uroot -p world city country &gt;&#x2F;backup&#x2F;bak1.sql</span><br><span class="line">）-F 在备份开始时，刷新一个新binlog日志</span><br><span class="line"></span><br><span class="line">4）--master-data&#x3D;2 以注释的形式，保存备份开始时间点的binlog的状态信息 </span><br><span class="line">5）加上--single-transaction ，对innodb可以不锁表热备，对非innodb表可以实现自动锁表功能</span><br><span class="line"></span><br><span class="line">mysqldump -uroot -p -A -R --triggers --master-data&#x3D;2 --single-transaction &gt;&#x2F;backup&#x2F;full$(date +%F).sql</span><br><span class="line">(1)以注释的形式，保存备份开始时间点的binlog的状态信息  --master-data&#x3D;2 </span><br><span class="line">(2)对innodb可以不锁表热备  --single-transaction</span><br><span class="line">(3)对非innodb表可以实现自动锁表功能 --single-transaction</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Waylon Yan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://waylon.whatyouneed.site/2021/01/10/mysql-01/">https://waylon.whatyouneed.site/2021/01/10/mysql-01/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/note/">note</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/02/26/%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%9501/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">常见算法01</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/20/py-xadmin/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">py-xadmin</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/04/21/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-03/" title="并发编程-03"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-21</div><div class="title">并发编程-03</div></div></a></div><div><a href="/2022/01/01/MySQL-SQL%E5%AE%A1%E6%A0%B8%E5%B7%A5%E5%85%B7inception/" title="MySQL-SQL审核工具inception"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-01</div><div class="title">MySQL-SQL审核工具inception</div></div></a></div><div><a href="/2022/06/19/mysql-03/" title="mysql-03"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-19</div><div class="title">mysql-03</div></div></a></div><div><a href="/2021/04/18/prometheus%E7%9B%B8%E5%85%B3/" title="prometheus相关"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-18</div><div class="title">prometheus相关</div></div></a></div><div><a href="/2020/11/20/py-xadmin/" title="py-xadmin"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-20</div><div class="title">py-xadmin</div></div></a></div><div><a href="/2019/08/09/py-%E5%9F%BA%E7%A1%8001/" title="py_基础01"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-08-09</div><div class="title">py_基础01</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Waylon Yan</div><div class="author-info__description">tech life sharing</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">245</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">37</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">22</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Waylonwhynot" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:ywl1006@outlook.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">无止境</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%BA%93%E8%A1%A8%E8%AF%AD%E5%8F%A5"><span class="toc-number">2.</span> <span class="toc-text">基本库表语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-number">3.</span> <span class="toc-text">存储引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.</span> <span class="toc-text">数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.1.</span> <span class="toc-text">数字类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E7%B1%BB%E5%9E%8B%EF%BC%9Achar-%E5%AE%9A%E9%95%BF-%EF%BC%8Cvarchar-%E5%8F%98%E9%95%BF"><span class="toc-number">4.2.</span> <span class="toc-text">字符类型：char(定长)，varchar(变长)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B%EF%BC%9Atime%EF%BC%8Cdate%EF%BC%8Cdatetime%EF%BC%8Ctimestamp%EF%BC%8Cyear"><span class="toc-number">4.3.</span> <span class="toc-text">日期类型：time，date，datetime，timestamp，year</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8Benum%E4%B8%8E%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8Bset"><span class="toc-number">4.4.</span> <span class="toc-text">枚举类型enum与集合类型set</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E6%93%8D%E4%BD%9C%E4%B9%8B%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">表操作之约束条件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">5.1.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#not-null"><span class="toc-number">5.2.</span> <span class="toc-text">not null</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zerofill"><span class="toc-number">5.3.</span> <span class="toc-text">zerofill</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unsigned"><span class="toc-number">5.4.</span> <span class="toc-text">unsigned</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%88%97%E5%94%AF%E4%B8%80"><span class="toc-number">5.4.1.</span> <span class="toc-text">单列唯一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%81%94%E5%90%88%E5%94%AF%E4%B8%80"><span class="toc-number">5.4.2.</span> <span class="toc-text">联合唯一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#not-null-unqiue-%E5%8C%96%E5%AD%A6%E5%8F%8D%E5%BA%94"><span class="toc-number">5.4.3.</span> <span class="toc-text">not null +  unqiue 化学反应</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#primary-key"><span class="toc-number">5.5.</span> <span class="toc-text">primary key</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%EF%BC%88-%E5%A4%96%E9%94%AE%E5%BB%BA%E5%9C%A8%E5%A4%9A%E7%9A%84%E4%B8%80%E6%96%B9-%EF%BC%89-%E7%BA%A7%E8%81%94"><span class="toc-number">5.5.1.</span> <span class="toc-text">一对多（**外键建在多的一方**）  级联</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="toc-number">5.5.2.</span> <span class="toc-text">多对多</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80-%E5%A4%96%E9%94%AE%E5%AD%97%E6%AE%B5%E5%9C%A8%E4%BB%BB%E4%BD%95%E4%B8%80%E6%96%B9%E9%83%BD%E5%8F%AF%E4%BB%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E5%BB%BA%E5%9C%A8%E6%9F%A5%E8%AF%A2%E9%A2%91%E7%8E%87%E6%AF%94%E8%BE%83%E9%AB%98%E7%9A%84%E8%A1%A8%E4%B8%AD"><span class="toc-number">5.5.3.</span> <span class="toc-text">一对一: 外键字段在任何一方都可以，建议建在查询频率比较高的表中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-number">5.5.4.</span> <span class="toc-text">补充</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E9%80%A0%E5%A4%96%E9%94%AE%E7%9A%84%E6%9D%A1%E4%BB%B6"><span class="toc-number">5.5.5.</span> <span class="toc-text">创造外键的条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%96%E9%94%AE%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.5.6.</span> <span class="toc-text">外键操作示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#on-delete"><span class="toc-number">5.5.7.</span> <span class="toc-text">on delete</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%A1%A8"><span class="toc-number">5.6.</span> <span class="toc-text">修改表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E8%A1%A8"><span class="toc-number">5.7.</span> <span class="toc-text">复制表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="toc-number">6.</span> <span class="toc-text">记录相关操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AEINSERT"><span class="toc-number">6.1.</span> <span class="toc-text">插入数据INSERT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AEUPDATE"><span class="toc-number">6.2.</span> <span class="toc-text">更新数据UPDATE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AEDELETE"><span class="toc-number">6.3.</span> <span class="toc-text">删除数据DELETE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AESELECT"><span class="toc-number">6.4.</span> <span class="toc-text">查询数据SELECT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.4.1.</span> <span class="toc-text">单表查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B9%A6%E5%86%99%E5%BB%BA%E8%AE%AE"><span class="toc-number">6.4.1.1.</span> <span class="toc-text">书写建议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E5%85%B3%E9%94%AE%E5%AD%97%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">6.4.1.2.</span> <span class="toc-text">几个重要关键字的执行顺序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#where%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6"><span class="toc-number">6.4.1.3.</span> <span class="toc-text">where约束条件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2-GROUP-BY"><span class="toc-number">6.4.1.4.</span> <span class="toc-text">分组查询:GROUP BY</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HAVING%E8%BF%87%E6%BB%A4-%E5%88%86%E7%BB%84%E4%B9%8B%E5%90%8E%E7%9A%84%E7%AD%9B%E9%80%89%E6%9D%A1%E4%BB%B6"><span class="toc-number">6.4.1.5.</span> <span class="toc-text">HAVING过滤,分组之后的筛选条件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#distinct-%E5%8E%BB%E9%87%8D"><span class="toc-number">6.4.1.6.</span> <span class="toc-text">distinct 去重</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#-1"><span class="toc-number">6.4.2.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E8%A1%A8%E6%93%8D%E4%BD%9C-%E8%BF%9E%E8%A1%A8%E6%9F%A5%E8%AF%A2-%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.4.3.</span> <span class="toc-text">连表操作(连表查询+子查询)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%E8%A1%A5%E5%85%85"><span class="toc-number">6.4.4.</span> <span class="toc-text">知识点补充</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.4.5.</span> <span class="toc-text">子查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pymysql%E6%A8%A1%E5%9D%97"><span class="toc-number">7.</span> <span class="toc-text">pymysql模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E9%93%BE%E6%8E%A5%E3%80%81%E6%89%A7%E8%A1%8Csql%E3%80%81%E5%85%B3%E9%97%AD%EF%BC%88%E6%B8%B8%E6%A0%87%EF%BC%89"><span class="toc-number">7.1.</span> <span class="toc-text">一 链接、执行sql、关闭（游标）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-execute-%E4%B9%8Bsql%E6%B3%A8%E5%85%A5"><span class="toc-number">7.2.</span> <span class="toc-text">二 execute()之sql注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-%E5%A2%9E%E3%80%81%E5%88%A0%E3%80%81%E6%94%B9%EF%BC%9Aconn-commit"><span class="toc-number">7.3.</span> <span class="toc-text">三 增、删、改：conn.commit()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-%E6%9F%A5%EF%BC%9Afetchone%EF%BC%8Cfetchmany%EF%BC%8Cfetchall"><span class="toc-number">7.4.</span> <span class="toc-text">四 查：fetchone，fetchmany，fetchall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E8%8E%B7%E5%8F%96%E6%8F%92%E5%85%A5%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E6%9D%A1%E6%95%B0%E6%8D%AE%E7%9A%84%E8%87%AA%E5%A2%9EID"><span class="toc-number">7.5.</span> <span class="toc-text">五 获取插入的最后一条数据的自增ID</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE-%E8%A7%A6%E5%8F%91%E5%99%A8-%E4%BA%8B%E5%8A%A1-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B-%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6-%E7%B4%A2%E5%BC%95%E7%90%86%E8%AE%BA"><span class="toc-number">8.</span> <span class="toc-text">视图 触发器 事务 存储过程 内置函数 流程控制 索引理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E8%A7%86%E5%9B%BE"><span class="toc-number">8.1.</span> <span class="toc-text">一. 视图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE"><span class="toc-number">8.1.1.</span> <span class="toc-text">一 创建视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-%E4%BD%BF%E7%94%A8%E8%A7%86%E5%9B%BE"><span class="toc-number">8.1.2.</span> <span class="toc-text">二 使用视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-%E4%BF%AE%E6%94%B9%E8%A7%86%E5%9B%BE"><span class="toc-number">8.1.3.</span> <span class="toc-text">三 修改视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B-%E5%88%A0%E9%99%A4%E8%A7%86%E5%9B%BE"><span class="toc-number">8.1.4.</span> <span class="toc-text">四 删除视图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">8.2.</span> <span class="toc-text">二. 触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95%E7%BB%93%E6%9E%84"><span class="toc-number">8.2.1.</span> <span class="toc-text">0. 基本语法结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-%E5%88%9B%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">8.2.2.</span> <span class="toc-text">一 创建触发器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-%E4%BD%BF%E7%94%A8%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">8.2.3.</span> <span class="toc-text">二 使用触发器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">8.2.4.</span> <span class="toc-text">三 删除触发器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-%E4%BA%8B%E5%8A%A1"><span class="toc-number">8.3.</span> <span class="toc-text">三 事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">8.4.</span> <span class="toc-text">四 存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.4.1.</span> <span class="toc-text">一 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-%E5%88%9B%E5%BB%BA%E7%AE%80%E5%8D%95%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%EF%BC%88%E6%97%A0%E5%8F%82%EF%BC%89"><span class="toc-number">8.4.2.</span> <span class="toc-text">二 创建简单存储过程（无参）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%EF%BC%88%E6%9C%89%E5%8F%82%EF%BC%89"><span class="toc-number">8.4.3.</span> <span class="toc-text">三 创建存储过程（有参）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B-%E6%89%A7%E8%A1%8C%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">8.4.4.</span> <span class="toc-text">四 执行存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94-%E5%88%A0%E9%99%A4%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">8.4.5.</span> <span class="toc-text">五 删除存储过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E5%87%BD%E6%95%B0"><span class="toc-number">8.5.</span> <span class="toc-text">五 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="toc-number">8.5.1.</span> <span class="toc-text">一 自定义函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-%E5%88%A0%E9%99%A4%E5%87%BD%E6%95%B0"><span class="toc-number">8.5.2.</span> <span class="toc-text">二 删除函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0"><span class="toc-number">8.5.3.</span> <span class="toc-text">三 执行函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="toc-number">8.6.</span> <span class="toc-text">六 流程控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5"><span class="toc-number">8.6.1.</span> <span class="toc-text">一 条件语句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5"><span class="toc-number">8.6.2.</span> <span class="toc-text">二 循环语句</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-number">9.</span> <span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">9.1.</span> <span class="toc-text">一 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">9.2.</span> <span class="toc-text">二 索引的原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-%E7%B4%A2%E5%BC%95%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">9.3.</span> <span class="toc-text">三 索引的数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#b-%E6%A0%91%E7%9A%84%E6%9F%A5%E6%89%BE%E8%BF%87%E7%A8%8B"><span class="toc-number">9.3.1.</span> <span class="toc-text">b+树的查找过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-%E6%A0%91%E6%80%A7%E8%B4%A8"><span class="toc-number">9.3.2.</span> <span class="toc-text">b+树性质</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95%E4%B8%8E%E8%BE%85%E5%8A%A9%E7%B4%A2%E5%BC%95"><span class="toc-number">9.4.</span> <span class="toc-text">四 聚集索引与辅助索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-MySQL%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-number">9.5.</span> <span class="toc-text">五 MySQL索引管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD-%E6%B5%8B%E8%AF%95%E7%B4%A2%E5%BC%95"><span class="toc-number">9.6.</span> <span class="toc-text">六 测试索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83-%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="toc-number">9.7.</span> <span class="toc-text">七 正确使用索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB-%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%E4%B8%8E%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"><span class="toc-number">9.8.</span> <span class="toc-text">八 联合索引与覆盖索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%9D-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E7%A5%9E%E5%99%A8-explain"><span class="toc-number">9.9.</span> <span class="toc-text">九 查询优化神器-explain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81-%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4"><span class="toc-number">9.10.</span> <span class="toc-text">十 慢查询优化的基本步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%80-%E6%85%A2%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86"><span class="toc-number">9.11.</span> <span class="toc-text">十一 慢日志管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%89-%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">9.12.</span> <span class="toc-text">十三 索引类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B-%E4%B8%8D%E8%B5%B0%E7%B4%A2%E5%BC%95%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-number">9.13.</span> <span class="toc-text">十四. 不走索引的情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%BA%94-%E7%B4%A2%E5%BC%95%E6%80%A7%E8%83%BD%E6%8E%92%E5%BA%8F"><span class="toc-number">9.14.</span> <span class="toc-text">十五. 索引性能排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E5%85%AD-%E7%94%9F%E4%BA%A7%E6%A1%88%E4%BE%8B"><span class="toc-number">9.15.</span> <span class="toc-text">十六. 生产案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%83-%E5%BB%BA%E7%AB%8B%E7%B4%A2%E5%BC%95%E8%A7%84%E8%8C%83"><span class="toc-number">9.16.</span> <span class="toc-text">十七. 建立索引规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E5%85%AB-%E5%A4%87%E4%BB%BD%E7%9B%B8%E5%85%B3"><span class="toc-number">9.17.</span> <span class="toc-text">十八. 备份相关</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/08/26/Linux-Puppet-02/" title="Linux-Puppet-02"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux-Puppet-02"/></a><div class="content"><a class="title" href="/2022/08/26/Linux-Puppet-02/" title="Linux-Puppet-02">Linux-Puppet-02</a><time datetime="2022-08-25T16:00:37.000Z" title="Created 2022-08-26 00:00:37">2022-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/25/Linux-Puppet/" title="Linux-Puppet"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux-Puppet"/></a><div class="content"><a class="title" href="/2022/08/25/Linux-Puppet/" title="Linux-Puppet">Linux-Puppet</a><time datetime="2022-08-25T07:42:51.000Z" title="Created 2022-08-25 15:42:51">2022-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/19/mysql-03/" title="mysql-03"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql-03"/></a><div class="content"><a class="title" href="/2022/06/19/mysql-03/" title="mysql-03">mysql-03</a><time datetime="2022-06-19T14:43:39.000Z" title="Created 2022-06-19 22:43:39">2022-06-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/07/%E4%B8%80.%20%E7%89%88%E6%9C%AC%E9%80%89%E5%9E%8B/" title="No title"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2022/06/07/%E4%B8%80.%20%E7%89%88%E6%9C%AC%E9%80%89%E5%9E%8B/" title="No title">No title</a><time datetime="2022-06-07T01:46:37.000Z" title="Created 2022-06-07 09:46:37">2022-06-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/01/Promethues03/" title="Promethues03"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Promethues03"/></a><div class="content"><a class="title" href="/2022/05/01/Promethues03/" title="Promethues03">Promethues03</a><time datetime="2022-05-01T12:09:29.000Z" title="Created 2022-05-01 20:09:29">2022-05-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Waylon Yan</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>