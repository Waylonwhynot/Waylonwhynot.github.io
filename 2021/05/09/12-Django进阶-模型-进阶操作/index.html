<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>12-Django进阶-模型-进阶操作 | YouNeed</title><meta name="keywords" content="ORM"><meta name="author" content="Waylon Yan"><meta name="copyright" content="Waylon Yan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="查询优化&#x2F; 中介模型">
<meta property="og:type" content="article">
<meta property="og:title" content="12-Django进阶-模型-进阶操作">
<meta property="og:url" content="https://waylon.whatyouneed.site/2021/05/09/12-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-%E8%BF%9B%E9%98%B6%E6%93%8D%E4%BD%9C/index.html">
<meta property="og:site_name" content="YouNeed">
<meta property="og:description" content="查询优化&#x2F; 中介模型">
<meta property="og:locale">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png">
<meta property="article:published_time" content="2021-05-09T15:27:14.000Z">
<meta property="article:modified_time" content="2022-03-26T11:23:41.481Z">
<meta property="article:author" content="Waylon Yan">
<meta property="article:tag" content="ORM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://waylon.whatyouneed.site/2021/05/09/12-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-%E8%BF%9B%E9%98%B6%E6%93%8D%E4%BD%9C/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '12-Django进阶-模型-进阶操作',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-26 19:23:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">246</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">37</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">22</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">YouNeed</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">12-Django进阶-模型-进阶操作</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-05-09T15:27:14.000Z" title="Created 2021-05-09 23:27:14">2021-05-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-03-26T11:23:41.481Z" title="Updated 2022-03-26 19:23:41">2022-03-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Django/">Django</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="12-Django进阶-模型-进阶操作"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>查询优化/ 中介模型</p>
<a id="more"></a>

<h2 id="一-QuerySet对象"><a href="#一-QuerySet对象" class="headerlink" title="一 QuerySet对象"></a>一 QuerySet对象</h2><h3 id="1-1可切片"><a href="#1-1可切片" class="headerlink" title="1.1可切片"></a><strong>1.1可切片</strong></h3><p>使用Python 的切片语法来限制<code>查询集</code>记录的数目 。它等同于SQL 的<code>LIMIT</code> 和<code>OFFSET</code> 子句。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Entry.objects.all()[:5]      # (LIMIT 5)</span><br><span class="line">Entry.objects.all()[5:10]    # (OFFSET 5 LIMIT 5)</span><br></pre></td></tr></table></figure>

<p>不支持负的索引（例如<code>Entry.objects.all()[-1]</code>）。通常，<code>查询集</code> 的切片返回一个新的<code>查询集</code> —— 它不会执行查询。</p>
<h3 id="1-2可迭代"><a href="#1-2可迭代" class="headerlink" title="1.2可迭代"></a><strong>1.2可迭代</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">articleList&#x3D;models.Article.objects.all()</span><br><span class="line"></span><br><span class="line">for article in articleList:</span><br><span class="line">    print(article.title)</span><br></pre></td></tr></table></figure>

<h3 id="1-3惰性查询"><a href="#1-3惰性查询" class="headerlink" title="1.3惰性查询"></a><strong>1.3惰性查询</strong></h3><p><code>查询集</code> 是惰性执行的 —— 创建<code>查询集</code>不会带来任何数据库的访问。你可以将过滤器保持一整天，直到<code>查询集</code> 需要求值时，Django 才会真正运行这个查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">queryResult&#x3D;models.Article.objects.all() # not hits database</span><br><span class="line"> </span><br><span class="line">print(queryResult) # hits database</span><br><span class="line"> </span><br><span class="line">for article in queryResult:</span><br><span class="line">    print(article.title)    # hits database</span><br></pre></td></tr></table></figure>

<p>一般来说，只有在“请求”<code>查询集</code> 的结果时才会到数据库中去获取它们。当你确实需要结果时，<code>查询集</code> 通过访问数据库来<em>求值</em></p>
<h3 id="1-4缓存机制"><a href="#1-4缓存机制" class="headerlink" title="1.4缓存机制"></a><strong>1.4缓存机制</strong></h3><p>每个<code>查询集</code>都包含一个缓存来最小化对数据库的访问。理解它是如何工作的将让你编写最高效的代码。</p>
<p>在一个新创建的<code>查询集</code>中，缓存为空。首次对<code>查询集</code>进行求值 —— 同时发生数据库查询 ——Django 将保存查询的结果到<code>查询集</code>的缓存中并返回明确请求的结果（例如，如果正在迭代<code>查询集</code>，则返回下一个结果）。接下来对该<code>查询集</code> 的求值将重用缓存的结果。</p>
<p>请牢记这个缓存行为，因为对<code>查询集</code>使用不当的话，它会坑你的。例如，下面的语句创建两个<code>查询集</code>，对它们求值，然后扔掉它们：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print([a.title for a in models.Article.objects.all()])</span><br><span class="line">print([a.create_time for a in models.Article.objects.all()])</span><br></pre></td></tr></table></figure>

<p>这意味着相同的数据库查询将执行两次，显然倍增了你的数据库负载。同时，还有可能两个结果列表并不包含相同的数据库记录，因为在两次请求期间有可能有Article被添加进来或删除掉。为了避免这个问题，只需保存<code>查询集</code>并重新使用它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queryResult&#x3D;models.Article.objects.all()</span><br><span class="line">print([a.title for a in queryResult])</span><br><span class="line">print([a.create_time for a in queryResult])</span><br></pre></td></tr></table></figure>

<h4 id="何时查询集不会被缓存"><a href="#何时查询集不会被缓存" class="headerlink" title="何时查询集不会被缓存?"></a>何时查询集不会被缓存?</h4><p>查询集不会永远缓存它们的结果。当只对查询集的部分进行求值时会检查缓存， 如果这个部分不在缓存中，那么接下来查询返回的记录都将不会被缓存。所以，这意味着使用切片或索引来限制查询集将不会填充缓存。</p>
<p>例如，重复获取查询集对象中一个特定的索引将每次都查询数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queryset &#x3D; Entry.objects.all()</span><br><span class="line">print queryset[5] # Queries the database</span><br><span class="line">print queryset[5] # Queries the database again</span><br></pre></td></tr></table></figure>

<p>然而，如果已经对全部查询集求值过，则将检查缓存：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">queryset &#x3D; Entry.objects.all()</span><br><span class="line">[entry for entry in queryset] # Queries the database</span><br><span class="line">print queryset[5] # Uses cache</span><br><span class="line">print queryset[5] # Uses cache</span><br></pre></td></tr></table></figure>

<p>下面是一些其它例子，它们会使得全部的查询集被求值并填充到缓存中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[entry for entry in queryset]</span><br><span class="line">bool(queryset)</span><br><span class="line">entry in queryset</span><br><span class="line">list(queryset)</span><br></pre></td></tr></table></figure>

<p>注：简单地打印查询集不会填充缓存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queryResult&#x3D;models.Article.objects.all()</span><br><span class="line">print(queryResult) #  hits database</span><br><span class="line">print(queryResult) #  hits database</span><br></pre></td></tr></table></figure>

<h3 id="1-5-exists-与iterator-方法"><a href="#1-5-exists-与iterator-方法" class="headerlink" title="1.5 exists()与iterator()方法"></a><strong>1.5 exists()与iterator()方法</strong></h3><h4 id="exists："><a href="#exists：" class="headerlink" title="exists："></a>exists：</h4><p>简单的使用if语句进行判断也会完全执行整个queryset并且把数据放入cache，虽然你并不需要这些 数据！为了避免这个，可以用exists()方法来检查是否有数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if queryResult.exists():</span><br><span class="line">    #SELECT (1) AS &quot;a&quot; FROM &quot;blog_article&quot; LIMIT 1; args&#x3D;()</span><br><span class="line">        print(&quot;exists...&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="iterator"><a href="#iterator" class="headerlink" title="iterator:"></a>iterator:</h4><p>当queryset非常巨大时，cache会成为问题。</p>
<p>处理成千上万的记录时，将它们一次装入内存是很浪费的。更糟糕的是，巨大的queryset可能会锁住系统 进程，让你的程序濒临崩溃。要避免在遍历数据的同时产生queryset cache，可以使用iterator()方法 来获取数据，处理完数据就将其丢弃。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">objs &#x3D; Book.objects.all().iterator()</span><br><span class="line"># iterator()可以一次只从数据库获取少量数据，这样可以节省内存</span><br><span class="line">for obj in objs:</span><br><span class="line">    print(obj.title)</span><br><span class="line">#BUT,再次遍历没有打印,因为迭代器已经在上一次遍历(next)到最后一次了,没得遍历了</span><br><span class="line">for obj in objs:</span><br><span class="line">    print(obj.title)</span><br></pre></td></tr></table></figure>

<p>当然，使用iterator()方法来防止生成cache，意味着遍历同一个queryset时会重复执行查询。所以使 #用iterator()的时候要当心，确保你的代码在操作一个大的queryset时没有重复执行查询。</p>
<p><strong>总结:</strong></p>
<p>queryset的cache是用于减少程序对数据库的查询，在通常的使用下会保证只有在需要的时候才会查询数据库。 使用exists()和iterator()方法可以优化程序对内存的使用。不过，由于它们并不会生成queryset cache，可能 会造成额外的数据库查询。</p>
<h2 id="二-中介模型"><a href="#二-中介模型" class="headerlink" title="二 中介模型"></a>二 中介模型</h2><p>处理类似搭配 pizza 和 topping 这样简单的多对多关系时，使用标准的<code>ManyToManyField</code> 就可以了。但是，有时你可能需要关联数据到两个模型之间的关系上。</p>
<p>例如，有这样一个应用，它记录音乐家所属的音乐小组。我们可以用一个<code>ManyToManyField</code> 表示小组和成员之间的多对多关系。但是，有时你可能想知道更多成员关系的细节，比如成员是何时加入小组的。</p>
<p>对于这些情况，Django 允许你指定一个中介模型来定义多对多关系。 你可以将其他字段放在中介模型里面。源模型的<code>ManyToManyField</code> 字段将使用<code>through</code> 参数指向中介模型。对于上面的音乐小组的例子，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line"> </span><br><span class="line">class Person(models.Model):</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;128)</span><br><span class="line"> </span><br><span class="line">    def __str__(self):              # __unicode__ on Python 2</span><br><span class="line">        return self.name</span><br><span class="line"> </span><br><span class="line">class Group(models.Model):</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;128)</span><br><span class="line">    members &#x3D; models.ManyToManyField(Person, through&#x3D;&#39;Membership&#39;)</span><br><span class="line"> </span><br><span class="line">    def __str__(self):              # __unicode__ on Python 2</span><br><span class="line">        return self.name</span><br><span class="line"> </span><br><span class="line">class Membership(models.Model):</span><br><span class="line">    person &#x3D; models.ForeignKey(Person)</span><br><span class="line">    group &#x3D; models.ForeignKey(Group)</span><br><span class="line">    date_joined &#x3D; models.DateField()</span><br><span class="line">    invite_reason &#x3D; models.CharField(max_length&#x3D;64)</span><br></pre></td></tr></table></figure>

<p>既然你已经设置好<code>ManyToManyField</code> 来使用中介模型（在这个例子中就是<code>Membership</code>），接下来你要开始创建多对多关系。你要做的就是创建中介模型的实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ringo &#x3D; Person.objects.create(name&#x3D;&quot;Ringo Starr&quot;)</span><br><span class="line">&gt;&gt;&gt; paul &#x3D; Person.objects.create(name&#x3D;&quot;Paul McCartney&quot;)</span><br><span class="line">&gt;&gt;&gt; beatles &#x3D; Group.objects.create(name&#x3D;&quot;The Beatles&quot;)</span><br><span class="line">&gt;&gt;&gt; m1 &#x3D; Membership(person&#x3D;ringo, group&#x3D;beatles,</span><br><span class="line">...     date_joined&#x3D;date(1962, 8, 16),</span><br><span class="line">...     invite_reason&#x3D;&quot;Needed a new drummer.&quot;)</span><br><span class="line">&gt;&gt;&gt; m1.save()</span><br><span class="line">&gt;&gt;&gt; beatles.members.all()</span><br><span class="line">[&lt;Person: Ringo Starr&gt;]</span><br><span class="line">&gt;&gt;&gt; ringo.group_set.all()</span><br><span class="line">[&lt;Group: The Beatles&gt;]</span><br><span class="line">&gt;&gt;&gt; m2 &#x3D; Membership.objects.create(person&#x3D;paul, group&#x3D;beatles,</span><br><span class="line">...     date_joined&#x3D;date(1960, 8, 1),</span><br><span class="line">...     invite_reason&#x3D;&quot;Wanted to form a band.&quot;)</span><br><span class="line">&gt;&gt;&gt; beatles.members.all()</span><br><span class="line">[&lt;Person: Ringo Starr&gt;, &lt;Person: Paul McCartney&gt;]</span><br></pre></td></tr></table></figure>

<p>与普通的多对多字段不同，你不能使用<code>add</code>、 <code>create</code>和赋值语句（比如，<code>beatles.members = [...]</code>）来创建关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># THIS WILL NOT WORK</span><br><span class="line">&gt;&gt;&gt; beatles.members.add(john)</span><br><span class="line"># NEITHER WILL THIS</span><br><span class="line">&gt;&gt;&gt; beatles.members.create(name&#x3D;&quot;George Harrison&quot;)</span><br><span class="line"># AND NEITHER WILL THIS</span><br><span class="line">&gt;&gt;&gt; beatles.members &#x3D; [john, paul, ringo, george]</span><br></pre></td></tr></table></figure>

<p>为什么不能这样做？ 这是因为你不能只创建 <code>Person</code>和 <code>Group</code>之间的关联关系，你还要指定 <code>Membership</code>模型中所需要的所有信息；而简单的<code>add</code>、<code>create</code> 和赋值语句是做不到这一点的。所以它们不能在使用中介模型的多对多关系中使用。此时，唯一的办法就是创建中介模型的实例。</p>
<p><code>remove()</code>方法被禁用也是出于同样的原因。但是<code>clear()</code> 方法却是可用的。它可以清空某个实例所有的多对多关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; # Beatles have broken up</span><br><span class="line">&gt;&gt;&gt; beatles.members.clear()</span><br><span class="line">&gt;&gt;&gt; # Note that this deletes the intermediate model instances</span><br><span class="line">&gt;&gt;&gt; Membership.objects.all()</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<h2 id="三-查询优化"><a href="#三-查询优化" class="headerlink" title="三 查询优化"></a>三 查询优化</h2><h3 id="3-1表数据"><a href="#3-1表数据" class="headerlink" title="3.1表数据"></a>3.1表数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">class UserInfo(AbstractUser):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用户信息</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    nid &#x3D; models.BigAutoField(primary_key&#x3D;True)</span><br><span class="line">    nickname &#x3D; models.CharField(verbose_name&#x3D;&#39;昵称&#39;, max_length&#x3D;32)</span><br><span class="line">    telephone &#x3D; models.CharField(max_length&#x3D;11, blank&#x3D;True, null&#x3D;True, unique&#x3D;True, verbose_name&#x3D;&#39;手机号码&#39;)</span><br><span class="line">    avatar &#x3D; models.FileField(verbose_name&#x3D;&#39;头像&#39;,upload_to &#x3D; &#39;avatar&#x2F;&#39;,default&#x3D;&quot;&#x2F;avatar&#x2F;default.png&quot;)</span><br><span class="line">    create_time &#x3D; models.DateTimeField(verbose_name&#x3D;&#39;创建时间&#39;, auto_now_add&#x3D;True)</span><br><span class="line"> </span><br><span class="line">    fans &#x3D; models.ManyToManyField(verbose_name&#x3D;&#39;粉丝们&#39;,</span><br><span class="line">                                  to&#x3D;&#39;UserInfo&#39;,</span><br><span class="line">                                  through&#x3D;&#39;UserFans&#39;,</span><br><span class="line">                                  related_name&#x3D;&#39;f&#39;,</span><br><span class="line">                                  through_fields&#x3D;(&#39;user&#39;, &#39;follower&#39;))</span><br><span class="line"> </span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.username</span><br><span class="line"> </span><br><span class="line">class UserFans(models.Model):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    互粉关系表</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    nid &#x3D; models.AutoField(primary_key&#x3D;True)</span><br><span class="line">    user &#x3D; models.ForeignKey(verbose_name&#x3D;&#39;博主&#39;, to&#x3D;&#39;UserInfo&#39;, to_field&#x3D;&#39;nid&#39;, related_name&#x3D;&#39;users&#39;)</span><br><span class="line">    follower &#x3D; models.ForeignKey(verbose_name&#x3D;&#39;粉丝&#39;, to&#x3D;&#39;UserInfo&#39;, to_field&#x3D;&#39;nid&#39;, related_name&#x3D;&#39;followers&#39;)</span><br><span class="line"> </span><br><span class="line">class Blog(models.Model):</span><br><span class="line"> </span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    博客信息</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    nid &#x3D; models.BigAutoField(primary_key&#x3D;True)</span><br><span class="line">    title &#x3D; models.CharField(verbose_name&#x3D;&#39;个人博客标题&#39;, max_length&#x3D;64)</span><br><span class="line">    site &#x3D; models.CharField(verbose_name&#x3D;&#39;个人博客后缀&#39;, max_length&#x3D;32, unique&#x3D;True)</span><br><span class="line">    theme &#x3D; models.CharField(verbose_name&#x3D;&#39;博客主题&#39;, max_length&#x3D;32)</span><br><span class="line">    user &#x3D; models.OneToOneField(to&#x3D;&#39;UserInfo&#39;, to_field&#x3D;&#39;nid&#39;)</span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.title</span><br><span class="line"> </span><br><span class="line">class Category(models.Model):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    博主个人文章分类表</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    nid &#x3D; models.AutoField(primary_key&#x3D;True)</span><br><span class="line">    title &#x3D; models.CharField(verbose_name&#x3D;&#39;分类标题&#39;, max_length&#x3D;32)</span><br><span class="line"> </span><br><span class="line">    blog &#x3D; models.ForeignKey(verbose_name&#x3D;&#39;所属博客&#39;, to&#x3D;&#39;Blog&#39;, to_field&#x3D;&#39;nid&#39;)</span><br><span class="line"> </span><br><span class="line">class Article(models.Model):</span><br><span class="line"> </span><br><span class="line">    nid &#x3D; models.BigAutoField(primary_key&#x3D;True)</span><br><span class="line">    title &#x3D; models.CharField(max_length&#x3D;50, verbose_name&#x3D;&#39;文章标题&#39;)</span><br><span class="line">    desc &#x3D; models.CharField(max_length&#x3D;255, verbose_name&#x3D;&#39;文章描述&#39;)</span><br><span class="line">    read_count &#x3D; models.IntegerField(default&#x3D;0)</span><br><span class="line">    comment_count&#x3D; models.IntegerField(default&#x3D;0)</span><br><span class="line">    up_count &#x3D; models.IntegerField(default&#x3D;0)</span><br><span class="line">    down_count &#x3D; models.IntegerField(default&#x3D;0)</span><br><span class="line">    category &#x3D; models.ForeignKey(verbose_name&#x3D;&#39;文章类型&#39;, to&#x3D;&#39;Category&#39;, to_field&#x3D;&#39;nid&#39;, null&#x3D;True)</span><br><span class="line">    create_time &#x3D; models.DateField(verbose_name&#x3D;&#39;创建时间&#39;)</span><br><span class="line">    blog &#x3D; models.ForeignKey(verbose_name&#x3D;&#39;所属博客&#39;, to&#x3D;&#39;Blog&#39;, to_field&#x3D;&#39;nid&#39;)</span><br><span class="line">    tags &#x3D; models.ManyToManyField(</span><br><span class="line">        to&#x3D;&quot;Tag&quot;,</span><br><span class="line">        through&#x3D;&#39;Article2Tag&#39;,</span><br><span class="line">        through_fields&#x3D;(&#39;article&#39;, &#39;tag&#39;),</span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">class ArticleDetail(models.Model):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    文章详细表</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    nid &#x3D; models.AutoField(primary_key&#x3D;True)</span><br><span class="line">    content &#x3D; models.TextField(verbose_name&#x3D;&#39;文章内容&#39;, )</span><br><span class="line"> </span><br><span class="line">    article &#x3D; models.OneToOneField(verbose_name&#x3D;&#39;所属文章&#39;, to&#x3D;&#39;Article&#39;, to_field&#x3D;&#39;nid&#39;)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">class Comment(models.Model):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    评论表</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    nid &#x3D; models.BigAutoField(primary_key&#x3D;True)</span><br><span class="line">    article &#x3D; models.ForeignKey(verbose_name&#x3D;&#39;评论文章&#39;, to&#x3D;&#39;Article&#39;, to_field&#x3D;&#39;nid&#39;)</span><br><span class="line">    content &#x3D; models.CharField(verbose_name&#x3D;&#39;评论内容&#39;, max_length&#x3D;255)</span><br><span class="line">    create_time &#x3D; models.DateTimeField(verbose_name&#x3D;&#39;创建时间&#39;, auto_now_add&#x3D;True)</span><br><span class="line"> </span><br><span class="line">    parent_comment &#x3D; models.ForeignKey(&#39;self&#39;, blank&#x3D;True, null&#x3D;True, verbose_name&#x3D;&#39;父级评论&#39;)</span><br><span class="line">    user &#x3D; models.ForeignKey(verbose_name&#x3D;&#39;评论者&#39;, to&#x3D;&#39;UserInfo&#39;, to_field&#x3D;&#39;nid&#39;)</span><br><span class="line"> </span><br><span class="line">    up_count &#x3D; models.IntegerField(default&#x3D;0)</span><br><span class="line"> </span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.content</span><br><span class="line"> </span><br><span class="line">class ArticleUpDown(models.Model):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    点赞表</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    nid &#x3D; models.AutoField(primary_key&#x3D;True)</span><br><span class="line">    user &#x3D; models.ForeignKey(&#39;UserInfo&#39;, null&#x3D;True)</span><br><span class="line">    article &#x3D; models.ForeignKey(&quot;Article&quot;, null&#x3D;True)</span><br><span class="line">    models.BooleanField(verbose_name&#x3D;&#39;是否赞&#39;)</span><br><span class="line"> </span><br><span class="line">class CommentUp(models.Model):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    点赞表</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    nid &#x3D; models.AutoField(primary_key&#x3D;True)</span><br><span class="line">    user &#x3D; models.ForeignKey(&#39;UserInfo&#39;, null&#x3D;True)</span><br><span class="line">    comment &#x3D; models.ForeignKey(&quot;Comment&quot;, null&#x3D;True)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">class Tag(models.Model):</span><br><span class="line">    nid &#x3D; models.AutoField(primary_key&#x3D;True)</span><br><span class="line">    title &#x3D; models.CharField(verbose_name&#x3D;&#39;标签名称&#39;, max_length&#x3D;32)</span><br><span class="line">    blog &#x3D; models.ForeignKey(verbose_name&#x3D;&#39;所属博客&#39;, to&#x3D;&#39;Blog&#39;, to_field&#x3D;&#39;nid&#39;)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">class Article2Tag(models.Model):</span><br><span class="line">    nid &#x3D; models.AutoField(primary_key&#x3D;True)</span><br><span class="line">    article &#x3D; models.ForeignKey(verbose_name&#x3D;&#39;文章&#39;, to&#x3D;&quot;Article&quot;, to_field&#x3D;&#39;nid&#39;)</span><br><span class="line">    tag &#x3D; models.ForeignKey(verbose_name&#x3D;&#39;标签&#39;, to&#x3D;&quot;Tag&quot;, to_field&#x3D;&#39;nid&#39;)</span><br></pre></td></tr></table></figure>

<h3 id="3-2-select-related"><a href="#3-2-select-related" class="headerlink" title="3.2 select_related"></a>3.2 select_related</h3><h4 id="3-2-1简单使用"><a href="#3-2-1简单使用" class="headerlink" title="3.2.1简单使用"></a><strong>3.2.1简单使用</strong></h4><p>对于一对一字段（OneToOneField）和外键字段（ForeignKey），可以使用select_related 来对QuerySet进行优化。</p>
<p>select_related 返回一个<code>QuerySet</code>，当执行它的查询时它沿着外键关系查询关联的对象的数据。它会生成一个复杂的查询并引起性能的损耗，但是在以后使用外键关系时将不需要数据库查询。</p>
<p>简单说，在对QuerySet使用select_related()函数后，Django会获取相应外键对应的对象，从而在之后需要的时候不必再查询数据库了。</p>
<p>下面的例子解释了普通查询和<code>select_related()</code> 查询的区别。</p>
<p>查询id=2的文章的分类名称,下面是一个标准的查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># Hits the database.</span><br><span class="line">article&#x3D;models.Article.objects.get(nid&#x3D;2)</span><br><span class="line"> </span><br><span class="line"># Hits the database again to get the related Blog object.</span><br><span class="line">print(article.category.title)</span><br><span class="line">&#39;&#39;&#39;</span><br><span class="line"> </span><br><span class="line">SELECT</span><br><span class="line">    &quot;blog_article&quot;.&quot;nid&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;title&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;desc&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;read_count&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;comment_count&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;up_count&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;down_count&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;category_id&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;create_time&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;blog_id&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;article_type_id&quot;</span><br><span class="line">             FROM &quot;blog_article&quot;</span><br><span class="line">             WHERE &quot;blog_article&quot;.&quot;nid&quot; &#x3D; 2; args&#x3D;(2,)</span><br><span class="line"> </span><br><span class="line">SELECT</span><br><span class="line">     &quot;blog_category&quot;.&quot;nid&quot;,</span><br><span class="line">     &quot;blog_category&quot;.&quot;title&quot;,</span><br><span class="line">     &quot;blog_category&quot;.&quot;blog_id&quot;</span><br><span class="line">              FROM &quot;blog_category&quot;</span><br><span class="line">              WHERE &quot;blog_category&quot;.&quot;nid&quot; &#x3D; 4; args&#x3D;(4,)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">&#39;&#39;&#39;</span><br></pre></td></tr></table></figure>

<p>如果我们使用select_related()函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">articleList&#x3D;models.Article.objects.select_related(&quot;category&quot;).all()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    for article_obj in articleList:</span><br><span class="line">        #  Doesn&#39;t hit the database, because article_obj.category</span><br><span class="line">        #  has been prepopulated in the previous query.</span><br><span class="line">        #不再查询数据库，因为第一次查询，数据已经填充进去了</span><br><span class="line">        print(article_obj.category.title)</span><br><span class="line">SELECT</span><br><span class="line">     &quot;blog_article&quot;.&quot;nid&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;title&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;desc&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;read_count&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;comment_count&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;up_count&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;down_count&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;category_id&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;create_time&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;blog_id&quot;,</span><br><span class="line">     &quot;blog_article&quot;.&quot;article_type_id&quot;,</span><br><span class="line"> </span><br><span class="line">     &quot;blog_category&quot;.&quot;nid&quot;,</span><br><span class="line">     &quot;blog_category&quot;.&quot;title&quot;,</span><br><span class="line">     &quot;blog_category&quot;.&quot;blog_id&quot;</span><br><span class="line"> </span><br><span class="line">FROM &quot;blog_article&quot;</span><br><span class="line">LEFT OUTER JOIN &quot;blog_category&quot; ON (&quot;blog_article&quot;.&quot;category_id&quot; &#x3D; &quot;blog_category&quot;.&quot;nid&quot;);</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-多外键查询"><a href="#3-2-2-多外键查询" class="headerlink" title="**3.2.2 多外键查询 **"></a>**3.2.2 多外键查询 **</h4><p>这是针对category的外键查询，如果是另外一个外键呢？让我们一起看下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">article&#x3D;models.Article.objects.select_related(&quot;category&quot;).get(nid&#x3D;1)</span><br><span class="line">print(article.articledetail)</span><br></pre></td></tr></table></figure>

<p>观察logging结果，发现依然需要查询两次，所以需要改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">article&#x3D;models.Article.objects.select_related(&quot;category&quot;,&quot;articledetail&quot;).get(nid&#x3D;1)</span><br><span class="line">print(article.articledetail)</span><br></pre></td></tr></table></figure>

<p>或者：1.7以后支持链式操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">article&#x3D;models.Article.objects</span><br><span class="line">　　　　　　　　　　　　　.select_related(&quot;category&quot;)</span><br><span class="line">　　　　　　　　　　　　　.select_related(&quot;articledetail&quot;)</span><br><span class="line">　　　　　　　　　　　　　.get(nid&#x3D;1)  # django 1.7 支持链式操作</span><br><span class="line">print(article.articledetail)</span><br><span class="line">SELECT</span><br><span class="line"> </span><br><span class="line">    &quot;blog_article&quot;.&quot;nid&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;title&quot;,</span><br><span class="line">    ......</span><br><span class="line"> </span><br><span class="line">    &quot;blog_category&quot;.&quot;nid&quot;,</span><br><span class="line">    &quot;blog_category&quot;.&quot;title&quot;,</span><br><span class="line">    &quot;blog_category&quot;.&quot;blog_id&quot;,</span><br><span class="line"> </span><br><span class="line">    &quot;blog_articledetail&quot;.&quot;nid&quot;,</span><br><span class="line">    &quot;blog_articledetail&quot;.&quot;content&quot;,</span><br><span class="line">    &quot;blog_articledetail&quot;.&quot;article_id&quot;</span><br><span class="line"> </span><br><span class="line">   FROM &quot;blog_article&quot;</span><br><span class="line">   LEFT OUTER JOIN &quot;blog_category&quot; ON (&quot;blog_article&quot;.&quot;category_id&quot; &#x3D; &quot;blog_category&quot;.&quot;nid&quot;)</span><br><span class="line">   LEFT OUTER JOIN &quot;blog_articledetail&quot; ON (&quot;blog_article&quot;.&quot;nid&quot; &#x3D; &quot;blog_articledetail&quot;.&quot;article_id&quot;)</span><br><span class="line">   WHERE &quot;blog_article&quot;.&quot;nid&quot; &#x3D; 1; args&#x3D;(1,)</span><br></pre></td></tr></table></figure>

<h4 id="3-2-3-深层查询"><a href="#3-2-3-深层查询" class="headerlink" title="3.2.3 深层查询"></a><strong>3.2.3 深层查询</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查询id&#x3D;1的文章的用户姓名</span><br><span class="line"> </span><br><span class="line">    article&#x3D;models.Article.objects.select_related(&quot;blog&quot;).get(nid&#x3D;1)</span><br><span class="line">    print(article.blog.user.username)</span><br></pre></td></tr></table></figure>

<p>依然需要查询两次：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    &quot;blog_article&quot;.&quot;nid&quot;,</span><br><span class="line">    &quot;blog_article&quot;.&quot;title&quot;,</span><br><span class="line">    ......</span><br><span class="line"> </span><br><span class="line">     &quot;blog_blog&quot;.&quot;nid&quot;,</span><br><span class="line">     &quot;blog_blog&quot;.&quot;title&quot;,</span><br><span class="line"> </span><br><span class="line">   FROM &quot;blog_article&quot; INNER JOIN &quot;blog_blog&quot; ON (&quot;blog_article&quot;.&quot;blog_id&quot; &#x3D; &quot;blog_blog&quot;.&quot;nid&quot;)</span><br><span class="line">   WHERE &quot;blog_article&quot;.&quot;nid&quot; &#x3D; 1;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">SELECT</span><br><span class="line">    &quot;blog_userinfo&quot;.&quot;password&quot;,</span><br><span class="line">    &quot;blog_userinfo&quot;.&quot;last_login&quot;,</span><br><span class="line">    ......</span><br><span class="line"> </span><br><span class="line">FROM &quot;blog_userinfo&quot;</span><br><span class="line">WHERE &quot;blog_userinfo&quot;.&quot;nid&quot; &#x3D; 1;</span><br></pre></td></tr></table></figure>

<p>这是因为第一次查询没有query到userInfo表，所以，修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">article&#x3D;models.Article.objects.select_related(&quot;blog__user&quot;).get(nid&#x3D;1)</span><br><span class="line">print(article.blog.user.username)</span><br><span class="line">SELECT</span><br><span class="line"> </span><br><span class="line">&quot;blog_article&quot;.&quot;nid&quot;, &quot;blog_article&quot;.&quot;title&quot;,</span><br><span class="line">......</span><br><span class="line"> </span><br><span class="line"> &quot;blog_blog&quot;.&quot;nid&quot;, &quot;blog_blog&quot;.&quot;title&quot;,</span><br><span class="line">......</span><br><span class="line"> </span><br><span class="line"> &quot;blog_userinfo&quot;.&quot;password&quot;, &quot;blog_userinfo&quot;.&quot;last_login&quot;,</span><br><span class="line">......</span><br><span class="line"> </span><br><span class="line">FROM &quot;blog_article&quot;</span><br><span class="line"> </span><br><span class="line">INNER JOIN &quot;blog_blog&quot; ON (&quot;blog_article&quot;.&quot;blog_id&quot; &#x3D; &quot;blog_blog&quot;.&quot;nid&quot;)</span><br><span class="line"> </span><br><span class="line">INNER JOIN &quot;blog_userinfo&quot; ON (&quot;blog_blog&quot;.&quot;user_id&quot; &#x3D; &quot;blog_userinfo&quot;.&quot;nid&quot;)</span><br><span class="line">WHERE &quot;blog_article&quot;.&quot;nid&quot; &#x3D; 1;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-总结"><a href="#3-2-4-总结" class="headerlink" title="3.2.4 总结"></a><strong>3.2.4 总结</strong></h4><ol>
<li>select_related主要针一对一和多对一关系进行优化。</li>
<li>select_related使用SQL的JOIN语句进行优化，通过减少SQL查询的次数来进行优化、提高性能。</li>
<li>可以通过可变长参数指定需要select_related的字段名。也可以通过使用双下划线“__”连接字段名来实现指定的递归查询。</li>
<li>没有指定的字段不会缓存，没有指定的深度不会缓存，如果要访问的话Django会再次进行SQL查询。</li>
<li>也可以通过depth参数指定递归的深度，Django会自动缓存指定深度内所有的字段。如果要访问指定深度外的字段，Django会再次进行SQL查询。</li>
<li>也接受无参数的调用，Django会尽可能深的递归查询所有的字段。但注意有Django递归的限制和性能的浪费。</li>
<li>Django &gt;= 1.7，链式调用的select_related相当于使用可变长参数。Django &lt; 1.7，链式调用会导致前边的select_related失效，只保留最后一个。</li>
</ol>
<h3 id="3-3-prefetch-related"><a href="#3-3-prefetch-related" class="headerlink" title="3.3 prefetch_related()"></a>3.3 <strong>prefetch_related()</strong></h3><p>对于多对多字段（ManyToManyField）和一对多字段，可以使用prefetch_related()来进行优化。</p>
<p>prefetch_related()和select_related()的设计目的很相似，都是为了减少SQL查询的数量，但是实现的方式不一样。后者是通过JOIN语句，在SQL查询内解决问题。但是对于多对多关系，使用SQL语句解决就显得有些不太明智，因为JOIN得到的表将会很长，会导致SQL语句运行时间的增加和内存占用的增加。若有n个对象，每个对象的多对多字段对应Mi条，就会生成Σ(n)Mi 行的结果表。</p>
<p>prefetch_related()的解决方法是，分别查询每个表，然后用Python处理他们之间的关系。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查询所有文章关联的所有标签</span><br><span class="line">    article_obj&#x3D;models.Article.objects.all()</span><br><span class="line">    for i in article_obj:</span><br><span class="line"> </span><br><span class="line">        print(i.tags.all())  #4篇文章: hits database 5</span><br></pre></td></tr></table></figure>

<p>改为prefetch_related：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"># 查询所有文章关联的所有标签</span><br><span class="line">    article_obj&#x3D;models.Article.objects.prefetch_related(&quot;tags&quot;).all()</span><br><span class="line">    for i in article_obj:</span><br><span class="line"> </span><br><span class="line">        print(i.tags.all())  #4篇文章: hits database 2</span><br><span class="line">SELECT &quot;blog_article&quot;.&quot;nid&quot;,</span><br><span class="line">               &quot;blog_article&quot;.&quot;title&quot;,</span><br><span class="line">               ......</span><br><span class="line"> </span><br><span class="line">FROM &quot;blog_article&quot;;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">SELECT</span><br><span class="line">  (&quot;blog_article2tag&quot;.&quot;article_id&quot;) AS &quot;_prefetch_related_val_article_id&quot;,</span><br><span class="line">  &quot;blog_tag&quot;.&quot;nid&quot;,</span><br><span class="line">  &quot;blog_tag&quot;.&quot;title&quot;,</span><br><span class="line">  &quot;blog_tag&quot;.&quot;blog_id&quot;</span><br><span class="line">   FROM &quot;blog_tag&quot;</span><br><span class="line">  INNER JOIN &quot;blog_article2tag&quot; ON (&quot;blog_tag&quot;.&quot;nid&quot; &#x3D; &quot;blog_article2tag&quot;.&quot;tag_id&quot;)</span><br><span class="line">  WHERE &quot;blog_article2tag&quot;.&quot;article_id&quot; IN (1, 2, 3, 4);</span><br><span class="line">def select_related(self, *fields)</span><br><span class="line">     性能相关：表之间进行join连表操作，一次性获取关联的数据。</span><br><span class="line">     model.tb.objects.all().select_related()</span><br><span class="line">     model.tb.objects.all().select_related(&#39;外键字段&#39;)</span><br><span class="line">     model.tb.objects.all().select_related(&#39;外键字段__外键字段&#39;)</span><br><span class="line"></span><br><span class="line">def prefetch_related(self, *lookups)</span><br><span class="line">    性能相关：多表连表操作时速度会慢，使用其执行多次SQL查询在Python代码中实现连表操作。</span><br><span class="line">            # 获取所有用户表</span><br><span class="line">            # 获取用户类型表where id in (用户表中的查到的所有用户ID)</span><br><span class="line">            models.UserInfo.objects.prefetch_related(&#39;外键字段&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            from django.db.models import Count, Case, When, IntegerField</span><br><span class="line">            Article.objects.annotate(</span><br><span class="line">                numviews&#x3D;Count(Case(</span><br><span class="line">                    When(readership__what_time__lt&#x3D;treshold, then&#x3D;1),</span><br><span class="line">                    output_field&#x3D;CharField(),</span><br><span class="line">                ))</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            students &#x3D; Student.objects.all().annotate(num_excused_absences&#x3D;models.Sum(</span><br><span class="line">                models.Case(</span><br><span class="line">                    models.When(absence__type&#x3D;&#39;Excused&#39;, then&#x3D;1),</span><br><span class="line">                default&#x3D;0,</span><br><span class="line">                output_field&#x3D;models.IntegerField()</span><br><span class="line">            )))</span><br><span class="line">  # 加select_related 主动做链表，相当于直接链表把数据全取出来了，</span><br><span class="line">    # 不加：for循环几次，就再次查几次数据库</span><br><span class="line">    # select_related(&#39;author_detail&#39;)参数是fk的字段，可能有多个外键，所以可以写多个</span><br><span class="line">    ret&#x3D;models.Author.objects.all().select_related(&#39;author_detail&#39;)</span><br><span class="line">    for i in ret:</span><br><span class="line">        print(i.author_detail.addr)</span><br><span class="line">    ret &#x3D; models.Author.objects.all()</span><br><span class="line">    for i in ret:</span><br><span class="line">        print(i.author_detail.addr)</span><br><span class="line"></span><br><span class="line">#     用了fk,但是不做链表，做多次查询,把结果集都放到对象中</span><br><span class="line">#     两次查询，相当于select * from author_detail where nid in [1,2]</span><br><span class="line">    ret&#x3D;models.Author.objects.all().prefetch_related(&#39;author_detail&#39;)</span><br><span class="line">    for i in ret:</span><br><span class="line">        print(i.author_detail.addr)</span><br><span class="line"># 总结：数据量少，可以用select_related</span><br><span class="line">#     数据量比较多用prefetch_related</span><br></pre></td></tr></table></figure>

<h2 id="四-extra"><a href="#四-extra" class="headerlink" title="四 extra"></a>四 extra</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">extra(select&#x3D;None, where&#x3D;None, params&#x3D;None, </span><br><span class="line">      tables&#x3D;None, order_by&#x3D;None, select_params&#x3D;None)</span><br></pre></td></tr></table></figure>

<p>有些情况下，Django的查询语法难以简单的表达复杂的 <code>WHERE</code> 子句，对于这种情况, Django 提供了 <code>extra()</code> <code>QuerySet</code>修改机制 — 它能在 <code>QuerySet</code>生成的SQL从句中注入新子句</p>
<p>extra可以指定一个或多个 <code>参数</code>,例如 <code>select</code>, <code>where</code> or <code>tables</code>. 这些参数都不是必须的，但是你至少要使用一个!要注意这些额外的方式对不同的数据库引擎可能存在移植性问题.(因为你在显式的书写SQL语句),除非万不得已,尽量避免这样做</p>
<h3 id="4-1参数之select"><a href="#4-1参数之select" class="headerlink" title="4.1参数之select"></a>4.1参数之select</h3><p>The <code>select</code> 参数可以让你在 <code>SELECT</code> 从句中添加其他字段信息，它应该是一个字典，存放着属性名到 SQL 从句的映射。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">queryResult&#x3D;models.Article</span><br><span class="line">　　　　　　　　　　　.objects.extra(select&#x3D;&#123;&#39;is_recent&#39;: &quot;create_time &gt; &#39;2017-09-05&#39;&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>结果集中每个 Entry 对象都有一个额外的属性is_recent, 它是一个布尔值，表示 Article对象的create_time 是否晚于2017-09-05.</p>
<p>练习：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># in sqlite:</span><br><span class="line">    article_obj&#x3D;models.Article.objects</span><br><span class="line">　　　　　　　　　　　　　　.filter(nid&#x3D;1)</span><br><span class="line">　　　　　　　　　　　　　　.extra(select&#x3D;&#123;&quot;standard_time&quot;:&quot;strftime(&#39;%%Y-%%m-%%d&#39;,create_time)&quot;&#125;)</span><br><span class="line">　　　　　　　　　　　　　　.values(&quot;standard_time&quot;,&quot;nid&quot;,&quot;title&quot;)</span><br><span class="line">    print(article_obj)</span><br><span class="line">    # &lt;QuerySet [&#123;&#39;title&#39;: &#39;MongoDb 入门教程&#39;, &#39;standard_time&#39;: &#39;2017-09-03&#39;, &#39;nid&#39;: 1&#125;]&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-2参数之where-tables"><a href="#4-2参数之where-tables" class="headerlink" title="4.2参数之where / tables"></a>4.2参数之<code>where</code> / <code>tables</code></h3><p>您可以使用<code>where</code>定义显式SQL <code>WHERE</code>子句 - 也许执行非显式连接。您可以使用<code>tables</code>手动将表添加到SQL <code>FROM</code>子句。</p>
<p><code>where</code>和<code>tables</code>都接受字符串列表。所有<code>where</code>参数均为“与”任何其他搜索条件。</p>
<p>举例来讲：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">queryResult&#x3D;models.Article</span><br><span class="line">　　　　　　　　　　　.objects.extra(where&#x3D;[&#39;nid in (1,3) OR title like &quot;py%&quot; &#39;,&#39;nid&gt;2&#39;])</span><br><span class="line">extra, 额外查询条件以及相关表，排序</span><br><span class="line">            </span><br><span class="line">                models.UserInfo.objects.filter(id__gt&#x3D;1)</span><br><span class="line">                models.UserInfo.objects.all() </span><br><span class="line">                # id name age ut_id</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">                models.UserInfo.objects.extra(self, select&#x3D;None, where&#x3D;None, params&#x3D;None, tables&#x3D;None, order_by&#x3D;None, select_params&#x3D;None)</span><br><span class="line">                # a. 映射</span><br><span class="line">                    # select </span><br><span class="line">                    # select_params&#x3D;None</span><br><span class="line">                    # select 此处 from 表</span><br><span class="line">                </span><br><span class="line">                # b. 条件</span><br><span class="line">                    # where&#x3D;None</span><br><span class="line">                    # params&#x3D;None,</span><br><span class="line">                    # select * from 表 where 此处</span><br><span class="line">                </span><br><span class="line">                # c. 表</span><br><span class="line">                    # tables</span><br><span class="line">                    # select * from 表,此处</span><br><span class="line">                    </span><br><span class="line">                # c. 排序</span><br><span class="line">                    # order_by&#x3D;None</span><br><span class="line">                    # select * from 表 order by 此处</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                models.UserInfo.objects.extra(</span><br><span class="line">                    select&#x3D;&#123;&#39;newid&#39;:&#39;select count(1) from app01_usertype where id&gt;%s&#39;&#125;,</span><br><span class="line">                    select_params&#x3D;[1,],</span><br><span class="line">                    where &#x3D; [&#39;age&gt;%s&#39;],</span><br><span class="line">                    params&#x3D;[18,],</span><br><span class="line">                    order_by&#x3D;[&#39;-age&#39;],</span><br><span class="line">                    tables&#x3D;[&#39;app01_usertype&#39;]</span><br><span class="line">                )</span><br><span class="line">                &quot;&quot;&quot;</span><br><span class="line">                select </span><br><span class="line">                    app01_userinfo.id,</span><br><span class="line">                    (select count(1) from app01_usertype where id&gt;1) as newid</span><br><span class="line">                from app01_userinfo,app01_usertype</span><br><span class="line">                where </span><br><span class="line">                    app01_userinfo.age &gt; 18</span><br><span class="line">                order by </span><br><span class="line">                    app01_userinfo.age desc</span><br><span class="line">                &quot;&quot;&quot;</span><br><span class="line">                </span><br><span class="line">                result &#x3D; models.UserInfo.objects.filter(id__gt&#x3D;1).extra(</span><br><span class="line">                    where&#x3D;[&#39;app01_userinfo.id &lt; %s&#39;],</span><br><span class="line">                    params&#x3D;[100,],</span><br><span class="line">                    tables&#x3D;[&#39;app01_usertype&#39;],</span><br><span class="line">                    order_by&#x3D;[&#39;-app01_userinfo.id&#39;],</span><br><span class="line">                    select&#x3D;&#123;&#39;uid&#39;:1,&#39;sw&#39;:&quot;select count(1) from app01_userinfo&quot;&#125;</span><br><span class="line">                )</span><br><span class="line">                print(result.query)</span><br><span class="line">                # SELECT (1) AS &quot;uid&quot;, (select count(1) from app01_userinfo) AS &quot;sw&quot;, &quot;app01_userinfo&quot;.&quot;id&quot;, &quot;app01_userinfo&quot;.&quot;name&quot;, &quot;app01_userinfo&quot;.&quot;age&quot;, &quot;app01_userinfo&quot;.&quot;ut_id&quot; FROM &quot;app01_userinfo&quot; , &quot;app01_usertype&quot; WHERE (&quot;app01_userinfo&quot;.&quot;id&quot; &gt; 1 AND (app01_userinfo.id &lt; 100)) ORDER BY (&quot;app01_userinfo&quot;.id) DESC</span><br><span class="line"># 在对象中加入字段</span><br><span class="line">ret&#x3D;models.Author.objects.all().filter(nid__gt&#x3D;1).extra(select&#x3D;&#123;&#39;n&#39;:&#39;select count(*) from app01_book where nid&gt;%s&#39;&#125;,select_params&#x3D;[1])</span><br><span class="line">print(ret[0].n)</span><br><span class="line">print(ret.query)</span><br><span class="line"># 给字段重命名</span><br><span class="line">ret&#x3D;models.Author.objects.all().filter(author_detail__telephone&#x3D;132234556).extra(select&#x3D;&#123;&#39;bb&#39;:&quot;app01_authordatail.telephone&quot;&#125;).values(&#39;bb&#39;)</span><br><span class="line">print(ret)</span><br><span class="line">print(ret.query)</span><br></pre></td></tr></table></figure>

<h2 id="五-原生sql"><a href="#五-原生sql" class="headerlink" title="五 原生sql"></a>五 原生sql</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from django.db import connection, connections</span><br><span class="line"></span><br><span class="line">cursor &#x3D; connection.cursor() # connection&#x3D;default数据</span><br><span class="line">cursor &#x3D; connections[&#39;db2&#39;].cursor()</span><br><span class="line"></span><br><span class="line">cursor.execute(&quot;&quot;&quot;SELECT * from auth_user where id &#x3D; %s&quot;&quot;&quot;, [1])</span><br><span class="line"></span><br><span class="line">row &#x3D; cursor.fetchone()</span><br><span class="line">row &#x3D; cursor.fetchall()</span><br><span class="line">ret &#x3D; models.Author.objects.raw(&#39;select * from app01_author where nid&gt;1&#39;)</span><br><span class="line">print(ret)</span><br><span class="line">for i in ret:</span><br><span class="line">    print(i)</span><br><span class="line">print(ret.query)</span><br><span class="line"># 会把book的字段放到author对象中</span><br><span class="line">ret &#x3D; models.Author.objects.raw(&#39;select * from app01_book where nid&gt;1&#39;)</span><br><span class="line">print(ret)</span><br><span class="line">for i in ret:</span><br><span class="line">    print(i.price)</span><br><span class="line">    print(type(i))</span><br></pre></td></tr></table></figure>

<h2 id="六-整体插入"><a href="#六-整体插入" class="headerlink" title="六 整体插入"></a>六 整体插入</h2><p>创建对象时，尽可能使用bulk_create()来减少SQL查询的数量。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Entry.objects.bulk_create([</span><br><span class="line">    Entry(headline&#x3D;&quot;Python 3.0 Released&quot;),</span><br><span class="line">    Entry(headline&#x3D;&quot;Python 3.1 Planned&quot;)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>…更优于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Entry.objects.create(headline&#x3D;&quot;Python 3.0 Released&quot;)</span><br><span class="line">Entry.objects.create(headline&#x3D;&quot;Python 3.1 Planned&quot;)</span><br></pre></td></tr></table></figure>

<p>注意该方法有很多注意事项，所以确保它适用于你的情况。</p>
<p>这也可以用在ManyToManyFields中，所以：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my_band.members.add(me, my_friend)</span><br></pre></td></tr></table></figure>

<p>…更优于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">my_band.members.add(me)</span><br><span class="line">my_band.members.add(my_friend)</span><br></pre></td></tr></table></figure>

<p>…其中Bands和Artists具有多对多关联。</p>
<h2 id="七-事务操作"><a href="#七-事务操作" class="headerlink" title="七 事务操作"></a>七 事务操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 事务操作</span><br><span class="line">from django.db import transaction</span><br><span class="line">with transaction.atomic():</span><br></pre></td></tr></table></figure>

<h2 id="八-defer和only"><a href="#八-defer和only" class="headerlink" title="八 defer和only"></a>八 defer和only</h2><p>defer(‘id’,’name’):取出对象，字段除了id和name都有<br>only(‘id’,’name’):取的对象，只有id和name<br>如果点，依然能点出其它列，但是不要点了，因为取没有的列，会再次查询数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ret=models.Author.objects.only(<span class="string">&#x27;nid&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ret:</span><br><span class="line">    <span class="comment"># 查询不在的字段，会再次查询数据库，造成数据库压力大</span></span><br><span class="line">    print(i.name)</span><br></pre></td></tr></table></figure>





<h2 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### 验证一</span></span><br><span class="line">    <span class="comment"># models.Publish.objects.all()  # 不会查询</span></span><br><span class="line">    <span class="comment"># res = models.Publish.objects.all()  # 不会查询</span></span><br><span class="line">    <span class="comment"># print(res)  # 会查询</span></span><br><span class="line">    <span class="comment"># time.sleep(20)</span></span><br><span class="line">    <span class="comment"># print(res) # 还会重新查询</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证二：</span></span><br><span class="line">    <span class="comment"># res = models.Publish.objects.all()  # 不会查询</span></span><br><span class="line">    <span class="comment"># print([a.name for a in res])</span></span><br><span class="line">    <span class="comment"># time.sleep(20)</span></span><br><span class="line">    <span class="comment"># print([a.city for a in res]) # 不会再次查，数据是老数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 验证三：</span></span><br><span class="line">    print([a.name <span class="keyword">for</span> a <span class="keyword">in</span> models.Publish.objects.all()]) <span class="comment"># 会查询</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print([a.city <span class="keyword">for</span> a <span class="keyword">in</span> models.Publish.objects.all()]) <span class="comment"># 会重新查询</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这种操作叫“提交”查询结果集，是推荐的方式，最小化SQL访问</span><br><span class="line">res = models.Publish.objects.all()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">（<span class="number">1</span>）切片和索引不会命中缓存</span><br><span class="line">不会建立缓存：简单的打印QuerySetprint(res)，返回只是全部查询集的一个切片。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）键值</span><br><span class="line"> print([a.city <span class="keyword">for</span> a <span class="keyword">in</span> res])  这种情况不属于切片也不属于索引，所以在有查询结果集（res） 的情况下，不会再次查，数据是老数据</span><br><span class="line"></span><br><span class="line">（<span class="number">3</span>）不提交查询结果集 （res=xxx）</span><br><span class="line">每次都重新查询</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Waylon Yan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://waylon.whatyouneed.site/2021/05/09/12-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-%E8%BF%9B%E9%98%B6%E6%93%8D%E4%BD%9C/">https://waylon.whatyouneed.site/2021/05/09/12-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-%E8%BF%9B%E9%98%B6%E6%93%8D%E4%BD%9C/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ORM/">ORM</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/05/18/13-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-choices%E5%8F%82%E6%95%B0%E5%92%8C%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%88%9B%E5%BB%BA/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">13-Django进阶-模型-choices参数和多对多创建</div></div></a></div><div class="next-post pull-right"><a href="/2021/05/09/10-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-%E6%9B%B4%E5%A4%9A%E5%AD%97%E6%AE%B5%E4%B8%8E%E5%8F%82%E6%95%B0/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">10-Django进阶-模型-更多字段与参数</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/05/18/13-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-choices%E5%8F%82%E6%95%B0%E5%92%8C%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%88%9B%E5%BB%BA/" title="13-Django进阶-模型-choices参数和多对多创建"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-18</div><div class="title">13-Django进阶-模型-choices参数和多对多创建</div></div></a></div><div><a href="/2021/05/09/08-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-%E5%8D%95%E8%A1%A8/" title="08-Django进阶-模型-单表"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-09</div><div class="title">08-Django进阶-模型-单表</div></div></a></div><div><a href="/2021/06/02/09-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-%E5%A4%9A%E8%A1%A8/" title="09-Django进阶-模型-多表"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-02</div><div class="title">09-Django进阶-模型-多表</div></div></a></div><div><a href="/2021/05/09/10-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-%E6%9B%B4%E5%A4%9A%E5%AD%97%E6%AE%B5%E4%B8%8E%E5%8F%82%E6%95%B0/" title="10-Django进阶-模型-更多字段与参数"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-09</div><div class="title">10-Django进阶-模型-更多字段与参数</div></div></a></div><div><a href="/2021/05/09/11-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-%E4%BA%8B%E5%8A%A1%E5%92%8C%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/" title="11-Django进阶-模型-事务和查询优化"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-09</div><div class="title">11-Django进阶-模型-事务和查询优化</div></div></a></div><div><a href="/2021/05/09/09-Django%E8%BF%9B%E9%98%B6-%E6%A8%A1%E5%9E%8B-%E5%8D%95%E8%A1%A8%E5%A4%9A%E8%A1%A8/" title="09-Django进阶-模型-单表多表"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-09</div><div class="title">09-Django进阶-模型-单表多表</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Waylon Yan</div><div class="author-info__description">tech life sharing</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">246</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">37</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">22</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Waylonwhynot" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:ywl1006@outlook.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">无止境</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-QuerySet%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.</span> <span class="toc-text">一 QuerySet对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E5%8F%AF%E5%88%87%E7%89%87"><span class="toc-number">1.1.</span> <span class="toc-text">1.1可切片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E5%8F%AF%E8%BF%AD%E4%BB%A3"><span class="toc-number">1.2.</span> <span class="toc-text">1.2可迭代</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E6%83%B0%E6%80%A7%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.</span> <span class="toc-text">1.3惰性查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.</span> <span class="toc-text">1.4缓存机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%95%E6%97%B6%E6%9F%A5%E8%AF%A2%E9%9B%86%E4%B8%8D%E4%BC%9A%E8%A2%AB%E7%BC%93%E5%AD%98"><span class="toc-number">1.4.1.</span> <span class="toc-text">何时查询集不会被缓存?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-exists-%E4%B8%8Eiterator-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">1.5 exists()与iterator()方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exists%EF%BC%9A"><span class="toc-number">1.5.1.</span> <span class="toc-text">exists：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iterator"><span class="toc-number">1.5.2.</span> <span class="toc-text">iterator:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E4%B8%AD%E4%BB%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">二 中介模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">三 查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1%E8%A1%A8%E6%95%B0%E6%8D%AE"><span class="toc-number">3.1.</span> <span class="toc-text">3.1表数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-select-related"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 select_related</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1简单使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E5%A4%9A%E5%A4%96%E9%94%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.2.</span> <span class="toc-text">**3.2.2 多外键查询 **</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-%E6%B7%B1%E5%B1%82%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 深层查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4-%E6%80%BB%E7%BB%93"><span class="toc-number">3.2.4.</span> <span class="toc-text">3.2.4 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-prefetch-related"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 prefetch_related()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-extra"><span class="toc-number">4.</span> <span class="toc-text">四 extra</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E5%8F%82%E6%95%B0%E4%B9%8Bselect"><span class="toc-number">4.1.</span> <span class="toc-text">4.1参数之select</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E5%8F%82%E6%95%B0%E4%B9%8Bwhere-tables"><span class="toc-number">4.2.</span> <span class="toc-text">4.2参数之where &#x2F; tables</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E5%8E%9F%E7%94%9Fsql"><span class="toc-number">5.</span> <span class="toc-text">五 原生sql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E6%95%B4%E4%BD%93%E6%8F%92%E5%85%A5"><span class="toc-number">6.</span> <span class="toc-text">六 整体插入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C"><span class="toc-number">7.</span> <span class="toc-text">七 事务操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-defer%E5%92%8Conly"><span class="toc-number">8.</span> <span class="toc-text">八 defer和only</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">9.</span> <span class="toc-text">查询优化</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/08/27/Linux-Puppet-03/" title="Linux-Puppet-03"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux-Puppet-03"/></a><div class="content"><a class="title" href="/2022/08/27/Linux-Puppet-03/" title="Linux-Puppet-03">Linux-Puppet-03</a><time datetime="2022-08-27T15:39:57.000Z" title="Created 2022-08-27 23:39:57">2022-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/26/Linux-Puppet-02/" title="Linux-Puppet-02"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux-Puppet-02"/></a><div class="content"><a class="title" href="/2022/08/26/Linux-Puppet-02/" title="Linux-Puppet-02">Linux-Puppet-02</a><time datetime="2022-08-25T16:00:37.000Z" title="Created 2022-08-26 00:00:37">2022-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/25/Linux-Puppet/" title="Linux-Puppet"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux-Puppet"/></a><div class="content"><a class="title" href="/2022/08/25/Linux-Puppet/" title="Linux-Puppet">Linux-Puppet</a><time datetime="2022-08-25T07:42:51.000Z" title="Created 2022-08-25 15:42:51">2022-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/19/mysql-03/" title="mysql-03"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql-03"/></a><div class="content"><a class="title" href="/2022/06/19/mysql-03/" title="mysql-03">mysql-03</a><time datetime="2022-06-19T14:43:39.000Z" title="Created 2022-06-19 22:43:39">2022-06-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/07/%E4%B8%80.%20%E7%89%88%E6%9C%AC%E9%80%89%E5%9E%8B/" title="No title"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2022/06/07/%E4%B8%80.%20%E7%89%88%E6%9C%AC%E9%80%89%E5%9E%8B/" title="No title">No title</a><time datetime="2022-06-07T01:46:37.000Z" title="Created 2022-06-07 09:46:37">2022-06-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Waylon Yan</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>