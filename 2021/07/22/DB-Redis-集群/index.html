<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"waylon.whatyouneed.site","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Redis集群(主从复制&#x2F; sentinel&#x2F; 哨兵) +  缓存使用优化">
<meta property="og:type" content="article">
<meta property="og:title" content="DB-Redis-集群">
<meta property="og:url" content="https://waylon.whatyouneed.site/2021/07/22/DB-Redis-%E9%9B%86%E7%BE%A4/index.html">
<meta property="og:site_name" content="YouNeed">
<meta property="og:description" content="Redis集群(主从复制&#x2F; sentinel&#x2F; 哨兵) +  缓存使用优化">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200530220558236.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200531233524414.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200601170651307.png">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/006tNbRwgy1gadzuhodicj30oe0dc0y9.jpg">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603153429516.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603160407526.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603163500204.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603164854686.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603165131230.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603165912284.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603170155706.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603173148510.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603173408822.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603173831345.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603174710311.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/2020060317550042.png">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/007S8ZIlgy1gicfyki8z3j31z40s0e55.jpg">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/007S8ZIlgy1gicfz99dh4j30x80u0dy9.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicfzd2rulj31q80u04qp.jpg">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/007S8ZIlgy1gicfzhs7wtj31i40u04e7.jpg">
<meta property="og:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/007S8ZIlgy1gicfzlkae8j30u00vagwo.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicfzpidedj31sa0ss7v2.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicfzu8mifj318m0qqwni.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicfzygmc8j30na0qmdso.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg03n445j31460rugwv.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg07cegpj31i10u01kx.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg1469xqj31uc0tk7u6.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg19v43hj31pl0u01ea.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg1dtp92j31te0q27hv.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg1i8mu1j31r80u07nz.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gduwyfg8mgj30bm0dsjt6.jpg">
<meta property="article:published_time" content="2021-07-22T14:40:08.000Z">
<meta property="article:modified_time" content="2021-08-01T19:55:40.883Z">
<meta property="article:author" content="Waylon Yan">
<meta property="article:tag" content="DB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200530220558236.png">

<link rel="canonical" href="https://waylon.whatyouneed.site/2021/07/22/DB-Redis-%E9%9B%86%E7%BE%A4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>DB-Redis-集群 | YouNeed</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
    <a target="_blank" rel="noopener" href="https://github.com/Waylonwhynot" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#FD6C6C; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">YouNeed</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">what</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://waylon.whatyouneed.site/2021/07/22/DB-Redis-%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/timg.jpeg">
      <meta itemprop="name" content="Waylon Yan">
      <meta itemprop="description" content="tech life sharing">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YouNeed">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          DB-Redis-集群
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-22 22:40:08" itemprop="dateCreated datePublished" datetime="2021-07-22T22:40:08+08:00">2021-07-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-02 03:55:40" itemprop="dateModified" datetime="2021-08-02T03:55:40+08:00">2021-08-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>44 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Redis集群(主从复制/ sentinel/ 哨兵) +  缓存使用优化</p>
<a id="more"></a>

<h2 id="一-主从复制"><a href="#一-主从复制" class="headerlink" title="一. 主从复制"></a>一. 主从复制</h2><h3 id="一-场景"><a href="#一-场景" class="headerlink" title="一. 场景:"></a>一. 场景:</h3><p>一主一从，一主多从</p>
<p>1.做读写分离</p>
<p>2.做数据副本,持久化的另一种方式</p>
<p>3.机器故障；容量瓶颈；QPS瓶颈</p>
<p>3.负载均衡，配合读写分离，有主节点提供写服务，从节点提供读服务，分担服务器负载，尤其在写少读多的情况下，通过多个从节点分担读负载，可以大大提高redis服务器的并发量和负载。</p>
<p>4.高可用的基石，主从复制是哨兵和集群能够实施的基础，因此我们可以说主从复制是高可用的基石。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">一个maskter可以有多个slave</span><br><span class="line">一个slave只能有一个master</span><br><span class="line">数据流向是单向的，从master到slave</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200530220558236.png" alt="在这里插入图片描述"></p>
<h3 id="1-1-原理（主从复制不依赖主库是否开持久化，但是不开持久化会有问题）"><a href="#1-1-原理（主从复制不依赖主库是否开持久化，但是不开持久化会有问题）" class="headerlink" title="1.1 原理（主从复制不依赖主库是否开持久化，但是不开持久化会有问题）"></a>1.1 原理（主从复制不依赖主库是否开持久化，但是不开持久化会有问题）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. 副本库通过slaveof 127.0.0.1 6379命令,连接主库,并发送SYNC给主库 </span><br><span class="line">2. 主库收到SYNC,会立即触发BGSAVE,后台保存RDB,发送给副本库</span><br><span class="line">3. 副本库接收后会应用RDB快照</span><br><span class="line">4. 主库会陆续将中间产生的新的操作,保存并发送给副本库</span><br><span class="line">5. 到此,我们主复制集就正常工作了</span><br><span class="line">6. 再此以后,主库只要发生新的操作,都会以命令传播的形式自动发送给副本库.</span><br><span class="line">7. 所有复制相关信息,从info信息中都可以查到.即使重启任何节点,他的主从关系依然都在.</span><br><span class="line">8. 如果发生主从关系断开时,从库数据没有任何损坏,在下次重连之后,从库发送PSYNC给主库</span><br><span class="line">9. 主库只会将从库缺失部分的数据同步给从库应用,达到快速恢复主从的目的</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200531233524414.png" alt="img"></p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200601170651307.png" alt="img"></p>
<h3 id="1-2-主库是否要开启持久化"><a href="#1-2-主库是否要开启持久化" class="headerlink" title="1.2 主库是否要开启持久化"></a>1.2 主库是否要开启持久化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">如果不开有可能，主库重启操作，造成所有主从数据丢失！</span><br><span class="line"></span><br><span class="line">注意：当不开启持久化功能的时候，数据正常实时的复制到从库上，主库宕机，选择一个从库作为主库</span><br><span class="line"><span class="comment"># 主库未宕机，是重启，主从关系还有，所有从节点的数据全部丢失</span></span><br><span class="line"></span><br><span class="line">解决方案:  <span class="number">1.</span> 如果没开持久化: 一旦主库失去连接，踢出去，不复制主库 <span class="comment"># 从库切为主库</span></span><br><span class="line">                   slaveof no one</span><br><span class="line">          <span class="number">2.</span> 主库打开持久化功能, 恢复之后，所有的从节点进行全量复制</span><br><span class="line">https://blog.csdn.net/fangkang7/article/details/<span class="number">106429654</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-辅助配置（主从数据一致性配置）"><a href="#1-3-辅助配置（主从数据一致性配置）" class="headerlink" title="1.3 辅助配置（主从数据一致性配置）"></a>1.3 辅助配置（主从数据一致性配置）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">min-slaves-to-write 1</span><br><span class="line">min-slaves-max-lag 3</span><br><span class="line"><span class="comment">#那么在从服务器的数量少于1个，或者三个从服务器的延迟（lag）值都大于或等于3秒时，主服务器将拒绝执行写命令</span></span><br><span class="line"></span><br><span class="line">min-slaves-to-write &lt;number of slaves&gt;   最少有多少个从库完成写入，才认为主从复制完成了</span><br><span class="line">min-slaves-max-lag &lt;number of seconds&gt;   当前网络延时状况，至少要少于多少秒，否则认为主从复制没有完成</span><br></pre></td></tr></table></figure>

<h3 id="二-配置"><a href="#二-配置" class="headerlink" title="二 配置"></a>二 配置</h3><h3 id="2-1-slave-命令"><a href="#2-1-slave-命令" class="headerlink" title="2.1 slave 命令"></a>2.1 slave 命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">6380是从，6379是主</span><br><span class="line"></span><br><span class="line">在6380上执行（去从库配置，配置主库）</span><br><span class="line"></span><br><span class="line">slaveof 127.0.0.1 6379 #异步</span><br><span class="line">slaveof no one #取消复制，不会把之前的数据清除</span><br></pre></td></tr></table></figure>

<h3 id="2-2-配置文件"><a href="#2-2-配置文件" class="headerlink" title="2.2 配置文件"></a>2.2 配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">slaveof ip port <span class="comment">#配置从节点ip和端口</span></span><br><span class="line">slave-read-only yes <span class="comment">#从节点只读，因为可读可写，数据会乱</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">mkdir -p redis1/conf redis1/data redis2/conf redis2/data redis3/conf redis3/data</span></span><br><span class="line"><span class="string">vim redis.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">daemonize no</span></span><br><span class="line"><span class="string">pidfile redis.pid</span></span><br><span class="line"><span class="string">bind 0.0.0.0</span></span><br><span class="line"><span class="string">protected-mode no</span></span><br><span class="line"><span class="string">port 6379</span></span><br><span class="line"><span class="string">timeout 0</span></span><br><span class="line"><span class="string">logfile redis.log</span></span><br><span class="line"><span class="string">dbfilename dump.rdb</span></span><br><span class="line"><span class="string">dir /data</span></span><br><span class="line"><span class="string">slaveof 10.0.0.101 6379</span></span><br><span class="line"><span class="string">slave-read-only yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cp redis.conf /home/redis2/conf/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">docker run -p 6379:6379 --name redis_6379 -v /home/redis1/conf/redis.conf:/etc/redis/redis.conf -v /home/redis1/data:/data -d redis redis-server /etc/redis/redis.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">docker run -p 6378:6379 --name redis_6378 -v /home/redis2/conf/redis.conf:/etc/redis/redis.conf -v /home/redis2/data:/data -d redis redis-server /etc/redis/redis.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">docker run -p 6377:6379 --name redis_6377 -v /home/redis3/conf/redis.conf:/etc/redis/redis.conf -v /home/redis3/data:/data -d redis redis-server /etc/redis/redis.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">info replication</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="四-故障处理"><a href="#四-故障处理" class="headerlink" title="四 故障处理"></a>四 故障处理</h3><p>slave故障</p>
<p>master故障</p>
<h3 id="五-复制常见问题"><a href="#五-复制常见问题" class="headerlink" title="五 复制常见问题"></a>五 复制常见问题</h3><p>1 读写分离</p>
<p>读流量分摊到从节点</p>
<p>可能遇到问题：复制数据延迟，读到过期数据，从节点故障</p>
<p>2 主从配置不一致</p>
<p>maxmemory不一致：丢失数据</p>
<p>数据结构优化参数：主节点做了优化，从节点没有设置优化，会出现一些问题</p>
<p>3 规避全量复制</p>
<p>第一次全量复制，不可避免：小主节点，低峰(夜间)</p>
<p>节点运行id不匹配：主节点重启(运行id变化)</p>
<p>复制挤压缓冲区不足：增大复制缓冲区大小，rel_backlog_size</p>
<p>4 规避复制风暴</p>
<p>单主节点复制风暴，主节点重启，所有从节点复制</p>
<h2 id="二-redis-sentinel-哨兵"><a href="#二-redis-sentinel-哨兵" class="headerlink" title="二.redis-sentinel 哨兵"></a>二.redis-sentinel 哨兵</h2><h3 id="一-主从复制问题"><a href="#一-主从复制问题" class="headerlink" title="一 主从复制问题"></a>一 主从复制问题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#主从复制存在的问题：</span><br><span class="line">#1 主从复制，主节点发生故障，需要做故障转移，可以手动转移：让其中一个slave变成master</span><br><span class="line">#2 主从复制，只能主写数据，所以写能力和存储能力有限</span><br></pre></td></tr></table></figure>



<h3 id="二-哨兵作用-哨兵的三个作用监控、通知、自动转移故障"><a href="#二-哨兵作用-哨兵的三个作用监控、通知、自动转移故障" class="headerlink" title="二 哨兵作用(哨兵的三个作用监控、通知、自动转移故障)"></a>二 哨兵作用(哨兵的三个作用<code>监控、通知、自动转移故障</code>)</h3><p>可以做故障判断，故障转移，通知客户端（其实是一个进程），客户端直接连接sentinel的地址</p>
<ul>
<li>监控<br>监控谁？支持主从结构的工作一个是主节点一个是从节点，那肯定就是监控这俩个了。<br>监控主节点和从节点是否正常运行<br>检测主节点是否存活，主节点和从节点运行情况<br>通知</li>
<li>哨兵检测的服务器出现问题时，会向其他的哨兵发送通知，哨兵之间就相当于一个微信群，每个哨兵发现的问题都会发在这个群里。</li>
<li>自动故障转移<br>当检测到主节点宕机后，断开与宕机主节点连接的所有从节点，在从节点中选取一个作为主节点，然后将其他的从节点连接到这个最新主节点的上。并且告知客户端最新的服务器地址。</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1gadzuhodicj30oe0dc0y9.jpg" alt="image-20191229230823911"></p>
<p>1 多个sentinel发现并确认master有问题</p>
<p>2 选举触一个sentinel作为领导</p>
<p>3 选取一个slave作为新的master</p>
<p>4 通知其余slave成为新的master的slave</p>
<p>5 通知客户端主从变化</p>
<p>6 等待老的master复活成为新master的slave</p>
<h3 id="三-安装配置"><a href="#三-安装配置" class="headerlink" title="三 安装配置"></a>三 安装配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">1 配置开启主从节点</span><br><span class="line">2 配置开启sentinel监控主节点（sentinel是特殊的redis）</span><br><span class="line">3 应该是多台机器</span><br><span class="line"><span class="comment">#配置开启sentinel监控主节点</span></span><br><span class="line">mkdir -p redis4/conf redis4/data redis5/conf redis5/data redis6/data redis6/conf</span><br><span class="line"></span><br><span class="line">vi sentinel.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">dir data</span><br><span class="line">protected-mode no</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">logfile <span class="string">&quot;redis_sentinel.log&quot;</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -p 26379:26379 --name redis_26379 -v /home/redis4/conf/sentinel.conf:/etc/redis/sentinel.conf -v /home/redis4/data:/data -d redis redis-sentinel /etc/redis/sentinel.conf</span><br><span class="line"></span><br><span class="line">docker run -p 26378:26379 --name redis_26378 -v /home/redis5/conf/sentinel.conf:/etc/redis/sentinel.conf -v /home/redis5/data:/data -d redis redis-sentinel /etc/redis/sentinel.conf</span><br><span class="line"></span><br><span class="line">docker run -p 26377:26379 --name redis_26377 -v /home/redis6/conf/sentinel.conf:/etc/redis/sentinel.conf -v /home/redis6/data:/data -d redis redis-sentinel /etc/redis/sentinel.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis-sentinel sentinel.conf</span><br><span class="line"></span><br><span class="line">info</span><br><span class="line">配置会重写，自动发现slave</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span><br><span class="line">告诉sentinel去监听地址为ip:port的一个master，这里的master-name可以自定义，quorum是一个数字，指明当有多少个sentinel认为一个master失效时，master才算真正失效</span><br><span class="line"></span><br><span class="line">sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span><br><span class="line">设置连接master和slave时的密码，注意的是sentinel不能分别为master和slave设置不同的密码，因此master和slave的密码应该设置相同。</span><br><span class="line"></span><br><span class="line">sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt; </span><br><span class="line">这个配置项指定了需要多少失效时间，一个master才会被这个sentinel主观地认为是不可用的。 单位是毫秒，默认为30秒</span><br><span class="line"></span><br><span class="line">sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt; </span><br><span class="line">这个配置项指定了在发生failover主备切换时最多可以有多少个slave同时对新的master进行 同步，这个数字越小，完成failover所需的时间就越长，但是如果这个数字越大，就意味着越 多的slave因为replication而不可用。可以通过将这个值设为 1 来保证每次只有一个slave 处于不能处理命令请求的状态。</span><br><span class="line"></span><br><span class="line">sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span><br><span class="line">failover-timeout 可以用在以下这些方面：     </span><br><span class="line">1. 同一个sentinel对同一个master两次failover之间的间隔时间。   </span><br><span class="line">2. 当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。    </span><br><span class="line">3.当想要取消一个正在进行的failover所需要的时间。    </span><br><span class="line">4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了。</span><br><span class="line">1 搭一个一主两从</span><br><span class="line"><span class="comment">#创建三个配置文件：</span></span><br><span class="line"><span class="comment">#第一个是主配置文件</span></span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /var/run/redis.pid</span><br><span class="line">port 6379</span><br><span class="line">dir <span class="string">&quot;/opt/soft/redis/data&quot;</span></span><br><span class="line">logfile “6379.log”</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二个是从配置文件</span></span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /var/run/redis2.pid</span><br><span class="line">port 6378</span><br><span class="line">dir <span class="string">&quot;/opt/soft/redis/data2&quot;</span></span><br><span class="line">logfile “6378.log”</span><br><span class="line">slaveof 127.0.0.1 6379</span><br><span class="line">slave-read-only yes</span><br><span class="line"><span class="comment">#第三个是从配置文件</span></span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /var/run/redis3.pid</span><br><span class="line">port 6377</span><br><span class="line">dir <span class="string">&quot;/opt/soft/redis/data3&quot;</span></span><br><span class="line">logfile “6377.log”</span><br><span class="line">slaveof 127.0.0.1 6379</span><br><span class="line">slave-read-only yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#把三个redis服务都启动起来</span></span><br><span class="line">./src/redis-server redis_6379.conf</span><br><span class="line">./src/redis-server redis_6378.conf</span><br><span class="line">./src/redis-server redis_6377.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2 搭建哨兵</span><br><span class="line"><span class="comment"># sentinel.conf这个文件</span></span><br><span class="line"><span class="comment"># 把哨兵也当成一个redis服务器</span></span><br><span class="line">创建三个配置文件分别叫sentinel_26379.conf sentinel_26378.conf  sentinel_26377.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前路径下创建 data1 data2 data3 个文件夹</span></span><br><span class="line"><span class="comment">#内容如下(需要修改端口，文件地址日志文件名字)</span></span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">dir ./data3</span><br><span class="line">protected-mode no</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">logfile <span class="string">&quot;redis_sentinel3.log&quot;</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动三个哨兵</span></span><br><span class="line">./src/redis-sentinel sentinel_26379.conf</span><br><span class="line">./src/redis-sentinel sentinel_26378.conf</span><br><span class="line">./src/redis-sentinel sentinel_26377.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 登陆哨兵</span></span><br><span class="line">./src/redis-cli -p 26377</span><br><span class="line"><span class="comment"># 输入 info</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 查看哨兵的配置文件被修改了，自动生成的</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主动停掉主redis 6379，哨兵会自动选择一个从库作为主库</span></span><br><span class="line">redis-cli -p 6379</span><br><span class="line">shutdown</span><br><span class="line"><span class="comment">#等待原来的主库启动，该主库会变成从库</span></span><br></pre></td></tr></table></figure>

<h3 id="四-客户端连接"><a href="#四-客户端连接" class="headerlink" title="四 客户端连接"></a>四 客户端连接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">import redis</span><br><span class="line">from redis.sentinel import Sentinel</span><br><span class="line"></span><br><span class="line"># 连接哨兵服务器(主机名也可以用域名)</span><br><span class="line"># 10.0.0.101:26379</span><br><span class="line">sentinel &#x3D; Sentinel([(&#39;10.0.0.101&#39;, 26379),</span><br><span class="line">                     (&#39;10.0.0.101&#39;, 26378),</span><br><span class="line">                     (&#39;10.0.0.101&#39;, 26377)</span><br><span class="line">             ],</span><br><span class="line">                    socket_timeout&#x3D;5)</span><br><span class="line"></span><br><span class="line">print(sentinel)</span><br><span class="line"># 获取主服务器地址</span><br><span class="line">master &#x3D; sentinel.discover_master(&#39;mymaster&#39;)</span><br><span class="line">print(master)</span><br><span class="line"></span><br><span class="line"># 获取从服务器地址</span><br><span class="line">slave &#x3D; sentinel.discover_slaves(&#39;mymaster&#39;)</span><br><span class="line">print(slave)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##### 读写分离</span><br><span class="line"># 获取主服务器进行写入</span><br><span class="line"># master &#x3D; sentinel.master_for(&#39;mymaster&#39;, socket_timeout&#x3D;0.5)</span><br><span class="line"># w_ret &#x3D; master.set(&#39;foo&#39;, &#39;bar&#39;)</span><br><span class="line"></span><br><span class="line"># slave &#x3D; sentinel.slave_for(&#39;mymaster&#39;, socket_timeout&#x3D;0.5)</span><br><span class="line"># r_ret &#x3D; slave.get(&#39;foo&#39;)</span><br><span class="line"># print(r_ret)</span><br></pre></td></tr></table></figure>

<h3 id="五-实现原理"><a href="#五-实现原理" class="headerlink" title="五 实现原理"></a>五 实现原理</h3><h4 id="1-监控工作流程"><a href="#1-监控工作流程" class="headerlink" title="1. 监控工作流程"></a>1. 监控工作流程</h4><p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603153429516.png" alt="在这里插入图片描述"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>哨兵发送info指令，并且保存所有哨兵状态，主节点和从节点的信息</span><br><span class="line"><span class="number">2.</span>主节点会记录redis实例的信息，主节点记录的信息跟哨兵记录的信息看起来是一样的，实际上还是有点区别哈。</span><br><span class="line"><span class="number">3.</span>哨兵会根据在主节点拿到的从节点信息，给对应的从节点也发送info指令</span><br><span class="line"><span class="number">4.</span>接着哨兵<span class="number">2</span>来了，同样的也会改主节点发送info指令，并且建立cmd连接</span><br><span class="line"><span class="number">5.</span>这个时候哨兵<span class="number">2</span>也会保存跟哨兵<span class="number">1</span>一样的信息，只不过是保存的哨兵信息是<span class="number">2</span>个。</span><br><span class="line"><span class="number">6.</span>这个时候为了每个哨兵的信息都一致它们之间建立了一个发布订阅。为了哨兵之间的信息长期对称它们之间也会互发ping命令。</span><br><span class="line"><span class="number">7.</span>当再来一个哨兵<span class="number">3</span>时，也会做同样的事情，给主节点和从节点发送info。并且跟哨兵<span class="number">1</span>和哨兵<span class="number">2</span>建立连接。</span><br></pre></td></tr></table></figure>

<h4 id="2-通知工作流程"><a href="#2-通知工作流程" class="headerlink" title="2. 通知工作流程"></a>2. 通知工作流程</h4><p>Sentinel会给主从的所有节点发送命令获取其状态，并且会把信息发布到哨兵的订阅里。</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603160407526.png" alt="img"></p>
<h4 id="3-故障转移原理（本文重点）"><a href="#3-故障转移原理（本文重点）" class="headerlink" title="3. 故障转移原理（本文重点）"></a>3. 故障转移原理（本文重点）</h4><p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603163500204.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>哨兵会一直给主节点发送publish sentinel ：hello，直到哨兵报出sdown，这个词这会是有不是有点熟悉了。没错就是我们上文中把主节点断开后哨兵服务端报出的信息。哨兵报出主节点sdown后还没有完，哨兵还会往内网里发布消息说明这个主节点挂了。发送的指令是sentinel <span class="keyword">is</span>-master-down-by-address-port</span><br><span class="line"><span class="number">2.</span>其余的哨兵接收到指令后，主节点挂了吗？让我去看看到底挂没挂。发送的信息也是hello。其余的哨兵也会发送他们收到的信息并且发送指令sentinel <span class="keyword">is</span>-master-down-by-address-port到自己的内网，确认一下第一个发送sentinel <span class="keyword">is</span>-master-down-by-address-port的哨兵说你说的对，这个家伙确实挂了。当所有人都认为主节点挂了后就会修改其状态为odown。当一个哨兵认为主节点挂了标记的是sdown，当半数哨兵都认为挂了其标记的状态是odown。这也就是配置哨兵为什么配置单数的原因。</span><br><span class="line"><span class="number">3.</span>对于一个哨兵认为主节点挂了称之为主观下线，半数哨兵认为主节点挂了称之为客官下线。</span><br><span class="line"><span class="number">4.</span>一旦被认为主节点客官下线后，哨兵就会进行下一步操作</span><br></pre></td></tr></table></figure>

<p>这时哨兵已经检测到问题所在了，那么到底是那个哨兵去负责推选新的主节点呢！不能是张三也去，李四也去，王五也去，这样就乱套了、于是就需要在所有的哨兵里选出领头的，那么是如何选的呢！请看下图。</p>
<p>这个时候呢！五个sentinel就在一起开会了，所有的哨兵都在一个内网中，然后他们会做一件事情就是五个sentinel会同时发送指令sentinel is-master-down-by-address-port并且携带上自己竞选次数和runid。</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603164854686.png" alt="在这里插入图片描述"></p>
<p>每个sentinel既是参选者也是投票者，每个sentinel都有一票，信封就代表自己的投票权。</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603165131230.png" alt="在这里插入图片描述"></p>
<p>当sentinel1和sentinel4同时把指令发送到群里准备竞选时，sentinel2这个时候就说我先接到谁的指令就把票投给谁。假如sentinel1发的早，那么sentinel2的票就会投给sentinel1。</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603165912284.png" alt="在这里插入图片描述"></p>
<p>按照这样的规则一直发起投票直到有一个sentinel的票数为总sentinel数量的一半之多。假设说是sentinel1的票数满足总哨兵数量的一半之多后，sentinel1就会当选。这个时候就进行到了下一个阶段。</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603170155706.png" alt="在这里插入图片描述"></p>
<p>在上边哨兵已经选出了sentinel1为代表去所有的从节点找出一个作为主节点。这个挑选主节点不是随便拿一个是有一定的规则的。</p>
<p>先把不在线的干掉</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603173148510.png" alt="在这里插入图片描述"></p>
<p>响应慢的干掉，sentinel会给所有的redis发送信息，响应速度慢的就会被干掉</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603173408822.png" alt="在这里插入图片描述"></p>
<p>与原主节点断开时间最久的干掉，这里由于演示不够用了，所有新增了一个slave5，没有任何意义哈！</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603173831345.png" alt="在这里插入图片描述"></p>
<p>以上三个点都判断结束后还有salve4和slave5，就会根据优先原则来进行筛选。</p>
<p>首先会根据优先级，如果优先级一样在进行其他判断<br>判断offset偏移量，判断数据同步性，假如说slave4的offset为90 slave5偏移量为100 那么哨兵就会认为slave4的网络是不是有问题啊！于是就会选slave5为新的主节点。那如果说是slave4和slave5的offset相同呢！还有最后一个判断<br>最后一步就是判断runid了，也就是职场中的论资排辈了，也就说根据runid的创建时间来判断，时间早的上位。</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/20200603174710311.png" alt="在这里插入图片描述"></p>
<p>选出新的主节点后就要对所有的节点发送指令了。</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/2020060317550042.png" alt="在这里插入图片描述"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">首先进行监控，并且所有的哨兵同步信息</span><br><span class="line"></span><br><span class="line">哨兵向订阅里边发布信息</span><br><span class="line"></span><br><span class="line">故障转移</span><br><span class="line"></span><br><span class="line">哨兵发现主节点下线</span><br><span class="line">哨兵开启投票竞选负责人</span><br><span class="line">由负责人推选新的主节点</span><br><span class="line">新的主节点断开原主节点，并且其他的从节点连接新的主节点，原主节点上线后作为从节点连接。</span><br></pre></td></tr></table></figure>



<h3 id="六-常见问题"><a href="#六-常见问题" class="headerlink" title="六 常见问题"></a>六 常见问题</h3><h2 id="三-redis-cluster"><a href="#三-redis-cluster" class="headerlink" title="三.redis-cluster"></a>三.redis-cluster</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/fangkang7/article/details/<span class="number">106560672</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">一. 高性能： </span><br><span class="line">  <span class="number">1</span>、在多分片节点中，将<span class="number">16384</span>个槽位，均匀分布到多个分片节点中</span><br><span class="line">  <span class="number">2</span>、存数据时，将key做crc16(key),然后和<span class="number">16384</span>进行取模，得出槽位值（<span class="number">0</span><span class="number">-16383</span>之间）</span><br><span class="line">  <span class="number">3</span>、key ---hash运算-----落到后端槽位 根据计算得出的槽位值，找到相对应的分片节点的主节点，存储到相应槽位上</span><br><span class="line">  <span class="number">4</span>、如果客户端当时连接的节点不是将来要存储的分片节点，分片集群会将客户端连接切换至真正存储节点进行数据存储</span><br><span class="line">二.高可用：</span><br><span class="line">在搭建集群时，会为每一个分片的主节点，对应一个从节点，实现slaveof的功能，同时当主节点down，实现类似于sentinel的自动failover的功能。</span><br><span class="line">三. 规划、搭建过程：</span><br><span class="line">  <span class="number">6</span>个redis实例，一般会放到<span class="number">3</span>台硬件服务器</span><br><span class="line">  注：在企业规划中，一个分片的两个分到不同的物理机，防止硬件主机宕机造成的整个分片数据丢失。</span><br><span class="line">  端口号：<span class="number">7000</span><span class="number">-7005</span></span><br></pre></td></tr></table></figure>





<h3 id="一-Redis-Cluser介绍背景"><a href="#一-Redis-Cluser介绍背景" class="headerlink" title="一 Redis Cluser介绍背景"></a>一 Redis Cluser介绍背景</h3><h4 id="1-1问题"><a href="#1-1问题" class="headerlink" title="1.1问题"></a>1.1问题</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 存在问题 </span><br><span class="line">1 并发量：单机redis qps为10w&#x2F;s,但是我们可能需要百万级别的并发量</span><br><span class="line">2 数据量：机器内存16g--256g，如果存500g数据呢？</span><br></pre></td></tr></table></figure>

<h4 id="1-2-解决"><a href="#1-2-解决" class="headerlink" title="1.2 解决"></a>1.2 解决</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 解决：加机器，分布式</span><br><span class="line">redis cluster 在2015年的 3.0 版本加入了，满足分布式的需求</span><br></pre></td></tr></table></figure>

<h3 id="二-数据分布（分布式数据库）"><a href="#二-数据分布（分布式数据库）" class="headerlink" title="二 数据分布（分布式数据库）"></a>二 数据分布（分布式数据库）</h3><h4 id="2-1-存在问题"><a href="#2-1-存在问题" class="headerlink" title="2.1 存在问题"></a>2.1 存在问题</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">假设全量的数据非常大，500g，单机已经无法满足，我们需要进行分区，分到若干个子集中</span><br></pre></td></tr></table></figure>

<h4 id="2-2-分区方式"><a href="#2-2-分区方式" class="headerlink" title="2.2 分区方式"></a>2.2 分区方式</h4><table>
<thead>
<tr>
<th>分布方式</th>
<th>特点</th>
<th>产品</th>
</tr>
</thead>
<tbody><tr>
<td>哈希分布</td>
<td>数据分散度高，建值分布于业务无关，无法顺序访问，支持批量操作</td>
<td>一致性哈希memcache，redis cluster，其他缓存产品</td>
</tr>
<tr>
<td>顺序分布</td>
<td>数据分散度易倾斜，建值业务相关，可顺序访问，支持批量操作</td>
<td>BigTable，HBase</td>
</tr>
</tbody></table>
<h5 id="2-2-1-顺序分区"><a href="#2-2-1-顺序分区" class="headerlink" title="2.2.1 顺序分区"></a>2.2.1 顺序分区</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 原理：100个数据分到3个节点上 1--33第一个节点；34--66第二个节点；67--100第三个节点（很多关系型数据库使用此种方式）</span><br></pre></td></tr></table></figure>

<h5 id="2-2-2-哈希分区"><a href="#2-2-2-哈希分区" class="headerlink" title="2.2.2 哈希分区"></a>2.2.2 哈希分区</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 原理：hash分区： 节点取余 ，假设3台机器， hash(key)%3,落到不同节点上</span><br></pre></td></tr></table></figure>

<h5 id="2-2-2-1-节点取余分区"><a href="#2-2-2-1-节点取余分区" class="headerlink" title="2.2.2 .1 节点取余分区"></a>2.2.2 .1 节点取余分区</h5><p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/007S8ZIlgy1gicfyki8z3j31z40s0e55.jpg" alt="image-20200811120153068"></p>
<p>节点扩容，添加一个节点，存在问题，很多数据需要偏移，总偏移量要大于80%</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/007S8ZIlgy1gicfz99dh4j30x80u0dy9.jpg" alt="image-20200811120704296"></p>
<p>推荐翻倍扩容，由3变成6，数据量迁移为50%，比80%降低</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicfzd2rulj31q80u04qp.jpg" alt="image-20200811120815523"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 总结：</span><br><span class="line">客户端分片，通过hash+取余</span><br><span class="line">节点伸缩，数据节点关系发生变化，导致影响数据迁移过大</span><br><span class="line">迁移数量和添加节点数量有关：建议翻倍扩容</span><br></pre></td></tr></table></figure>

<h5 id="2-2-2-2-一致性哈希分区"><a href="#2-2-2-2-一致性哈希分区" class="headerlink" title="2.2.2 .2 一致性哈希分区"></a>2.2.2 .2 一致性哈希分区</h5><p>每个节点负责一部分数据，对key进行hash，得到结果在node1和node2之间，就放到node2中，顺时针查找</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/007S8ZIlgy1gicfzhs7wtj31i40u04e7.jpg" alt="image-20200811121233804"></p>
<p>假设添加一个新节点node5，现在只需要迁移一小部分数据，不会影响node3和node4的数据，只会迁移node1和node2的数据</p>
<p><img src="https://gitee.com/waylon1006/blog_pic/raw/master/pic/007S8ZIlgy1gicfzlkae8j30u00vagwo.jpg" alt="image-20200811121518855"></p>
<p>节点比较多的话合适，假设有1000个节点，加一个只要迁移千分之一的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#总结：</span><br><span class="line">客户端分片：哈希+顺时针（优化取余）</span><br><span class="line">节点伸缩：只影响临近节点，但是还有数据迁移的情况</span><br><span class="line">伸缩：保证最小迁移数据和无法保证负载均衡（这样总共5个节点，数据就不均匀了），翻倍扩容可以实现负载均衡</span><br></pre></td></tr></table></figure>

<h5 id="2-2-2-3-虚拟槽分区"><a href="#2-2-2-3-虚拟槽分区" class="headerlink" title="2.2.2 .3 虚拟槽分区"></a>2.2.2 .3 虚拟槽分区</h5><p>预设虚拟槽：每个槽映射一个数据子集，一般比节点数大</p>
<p>良好的哈希函数：如CRC16</p>
<p>服务端管理节点、槽、数据：如redis cluster（槽的范围0–16383）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">5个节点，把16384个槽平均分配到每个节点，客户端会把数据发送给任意一个节点，通过CRC16对key进行哈希对16383进行取余，算出当前key属于哪部分槽，属于哪个节点，每个节点都会记录是不是负责这部分槽，如果是负责的，进行保存，如果槽不在自己范围内，redis cluster是共享消息的模式，它知道哪个节点负责哪些槽，返回结果，让客户端找对应的节点去存</span><br><span class="line">服务端管理节点，槽，关系</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicfzpidedj31sa0ss7v2.jpg" alt="image-20200811190745066"></p>
<h3 id="三-集群搭建"><a href="#三-集群搭建" class="headerlink" title="三 集群搭建"></a>三 集群搭建</h3><h4 id="3-1-单机架构"><a href="#3-1-单机架构" class="headerlink" title="3. 1 单机架构"></a>3. 1 单机架构</h4><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicfzu8mifj318m0qqwni.jpg" alt="image-20200811191353220"></p>
<h4 id="3-2-分布式架构"><a href="#3-2-分布式架构" class="headerlink" title="3.2 分布式架构"></a>3.2 分布式架构</h4><p>每个节点之间相互通信，都负责读写，客户端去存，如果不是当前节点，会返回应该存到哪个节点</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicfzygmc8j30na0qmdso.jpg" alt="image-20200811191435244"></p>
<h4 id="3-3-Redis-Cluster架构"><a href="#3-3-Redis-Cluster架构" class="headerlink" title="3.3 Redis Cluster架构"></a>3.3 Redis Cluster架构</h4><p>节点，meet，指派槽，复制，高可用</p>
<h5 id="meet解释"><a href="#meet解释" class="headerlink" title="meet解释"></a>meet解释</h5><p>A meet一下C，C回复一下，A meet一下B ，B回复一下，这样B和C也能相互感知，A，B，C之间就可以相关交互数据，所有节点共享消息</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg03n445j31460rugwv.jpg" alt="image-20200811192029280"></p>
<h5 id="指派槽"><a href="#指派槽" class="headerlink" title="指派槽"></a>指派槽</h5><p>总共有16384个槽，平均分配到每个节点上</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg07cegpj31i10u01kx.jpg" alt="image-20200811192334455"></p>
<h4 id="3-4-原生安装"><a href="#3-4-原生安装" class="headerlink" title="3.4 原生安装"></a>3.4 原生安装</h4><p>1 配置开启节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 配置</span></span><br><span class="line">port <span class="variable">$&#123;port&#125;</span></span><br><span class="line">daemonize yes</span><br><span class="line">dir <span class="string">&quot;/opt/redis/redis/data/&quot;</span></span><br><span class="line">logfile <span class="string">&quot;<span class="variable">$&#123;port&#125;</span>.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#masterauth  集群搭建时，主的密码</span></span><br><span class="line">cluster-enabled yes  <span class="comment"># 开启cluster</span></span><br><span class="line">cluster-node-timeout 15000 <span class="comment"># 故障转移，超时时间 15s</span></span><br><span class="line">cluster-config-file nodes-<span class="variable">$&#123;port&#125;</span>.conf  <span class="comment"># 给cluster节点增加一个自己的配置文件</span></span><br><span class="line">cluster-require-full-coverage yes  <span class="comment">#只要集群中有一个故障了，整个就不对外提供服务了，这个实际不合理，假设有50个节点，一个节点故障了，所有不提供服务了；，需要设置成no</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 开启6个节点</span></span><br><span class="line">redis-server redis-7000.conf</span><br><span class="line">redis-server redis-7001.conf</span><br><span class="line">redis-server redis-7002.conf</span><br><span class="line">redis-server redis-7003.conf</span><br><span class="line">redis-server redis-7004.conf</span><br><span class="line">redis-server redis-7005.conf</span><br></pre></td></tr></table></figure>

<p>2 meet(相互通信)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster meet 127.0.0.1 7001</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster meet 127.0.0.1 7002</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster meet 127.0.0.1 7003</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster meet 127.0.0.1 7004</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster meet 127.0.0.1 7005</span><br></pre></td></tr></table></figure>

<p>3 指派槽</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster addslots &#123;0...5461&#125;</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster addslots &#123;5462...10922&#125;</span><br><span class="line">redis-cli -h 127.0.0.1 -p 7000 cluster addslots &#123;10923...16383&#125;</span><br></pre></td></tr></table></figure>

<p>4 主从</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cluster replicate node-id</span></span><br><span class="line"><span class="comment"># 让7003复制7000</span></span><br><span class="line">redis-cli -h 127.0.0.1 -p 7003 cluster replicate <span class="variable">$&#123;node-id-7000&#125;</span></span><br><span class="line">redis-cli -h 127.0.0.1 -p 7004 cluster replicate <span class="variable">$&#123;node-id-7001&#125;</span></span><br><span class="line">redis-cli -h 127.0.0.1 -p 7005 cluster replicate <span class="variable">$&#123;node-id-7002&#125;</span></span><br><span class="line"><span class="comment"># 实操</span></span><br><span class="line"><span class="built_in">cd</span> /opt/soft/redis/config</span><br><span class="line">vim redis-7000.conf</span><br><span class="line"><span class="comment"># 写入</span></span><br><span class="line">port 7000</span><br><span class="line">daemonize yes</span><br><span class="line">dir <span class="string">&quot;/opt/soft/redis/data/&quot;</span></span><br><span class="line">logfile <span class="string">&quot;7000.log&quot;</span></span><br><span class="line">dbfilename <span class="string">&quot;dump-7000.rdb&quot;</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-7000.conf</span><br><span class="line">cluster-require-full-coverage yes </span><br><span class="line"><span class="comment"># 快速生成其他配置</span></span><br><span class="line">sed <span class="string">&#x27;s/7000/7001/g&#x27;</span> redis-7000.conf &gt; redis-7001.conf</span><br><span class="line">sed <span class="string">&#x27;s/7000/7002/g&#x27;</span> redis-7000.conf &gt; redis-7002.conf</span><br><span class="line">sed <span class="string">&#x27;s/7000/7003/g&#x27;</span> redis-7000.conf &gt; redis-7003.conf</span><br><span class="line">sed <span class="string">&#x27;s/7000/7004/g&#x27;</span> redis-7000.conf &gt; redis-7004.conf</span><br><span class="line">sed <span class="string">&#x27;s/7000/7005/g&#x27;</span> redis-7000.conf &gt; redis-7005.conf</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">./src/redis-server ./config/redis-7000.conf</span><br><span class="line">ps -ef |grep redis</span><br><span class="line">./src/redis-server ./config/redis-7001.conf</span><br><span class="line">./src/redis-server ./config/redis-7002.conf</span><br><span class="line">./src/redis-server ./config/redis-7003.conf</span><br><span class="line">./src/redis-server ./config/redis-7004.conf</span><br><span class="line">./src/redis-server ./config/redis-7005.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接其中一个，set数据（失败，因为没有分配槽）</span></span><br><span class="line">redis-cli -p 7000</span><br><span class="line"><span class="built_in">set</span> hello world <span class="comment">#报错</span></span><br><span class="line"><span class="comment"># config文件夹下出现了：nodes-7000.conf，查看一下可以看到节点的id</span></span><br><span class="line"><span class="comment"># 也可以：</span></span><br><span class="line">redis-cli -p 7000 cluster nodes</span><br><span class="line"><span class="comment"># 也可以:查看更详细信息</span></span><br><span class="line">redis-cli -p 7000 cluster info</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 节点握手（meet操作）</span></span><br><span class="line"><span class="comment"># 7000和7001 握手</span></span><br><span class="line">redis-cli -p 7000 cluster meet 127.0.0.1 7001</span><br><span class="line"><span class="comment"># 查看握手情况</span></span><br><span class="line">redis-cli -p 7000 cluster nodes <span class="comment"># 可以看到已经达成了握手</span></span><br><span class="line">redis-cli -p 7002 cluster nodes <span class="comment"># 没有握手，还是孤立</span></span><br><span class="line"><span class="comment"># 继续握手</span></span><br><span class="line">redis-cli -p 7000 cluster meet 127.0.0.1 7002</span><br><span class="line">redis-cli -p 7000 cluster meet 127.0.0.1 7003</span><br><span class="line">redis-cli -p 7000 cluster meet 127.0.0.1 7004</span><br><span class="line">redis-cli -p 7000 cluster meet 127.0.0.1 7005</span><br><span class="line"><span class="comment"># 查看最后结果</span></span><br><span class="line">redis-cli -p 7000 cluster info  <span class="comment"># 可以看到6个节点握手成功了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 当前还是不可以读写，还没分配槽</span></span><br><span class="line">redis-cli -p 7000 cluster addslots 0 <span class="comment"># 给7000分配第0个槽</span></span><br><span class="line"><span class="comment"># 这样一个个设置太麻烦，咱们写个脚本执行</span></span><br><span class="line">mkdir script</span><br><span class="line"><span class="built_in">cd</span> script</span><br><span class="line">vim addslots.sh</span><br><span class="line"><span class="comment"># 写入</span></span><br><span class="line">start=<span class="variable">$1</span></span><br><span class="line">end=<span class="variable">$2</span></span><br><span class="line">port=<span class="variable">$3</span></span><br><span class="line"><span class="keyword">for</span> slot <span class="keyword">in</span> `seq <span class="variable">$&#123;start&#125;</span> <span class="variable">$&#123;end&#125;</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;slot:<span class="variable">$&#123;slot&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment"># 保存退出，测试</span></span><br><span class="line">sh addslots.sh 0 4096 7000</span><br><span class="line"><span class="comment"># 写具体命令</span></span><br><span class="line">start=<span class="variable">$1</span></span><br><span class="line">end=<span class="variable">$2</span></span><br><span class="line">port=<span class="variable">$3</span></span><br><span class="line"><span class="keyword">for</span> slot <span class="keyword">in</span> `seq <span class="variable">$&#123;start&#125;</span> <span class="variable">$&#123;end&#125;</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;slot:<span class="variable">$&#123;slot&#125;</span>&quot;</span></span><br><span class="line">  redis-cli -p <span class="variable">$&#123;port&#125;</span> cluster addslots <span class="variable">$&#123;slot&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入</span></span><br><span class="line">sh addslots.sh 0 5641 7000</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">redis-cli -p 7000</span><br><span class="line">cluster info</span><br><span class="line">cluster nodes</span><br><span class="line"><span class="comment"># 继续分槽</span></span><br><span class="line">sh addslots.sh 5641 10922 7001</span><br><span class="line">sh addslots.sh 10923  16383 7002</span><br><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line">redis-cli -p 7000 cluster info</span><br><span class="line"></span><br><span class="line"><span class="comment">##  配置主从</span></span><br><span class="line"><span class="comment"># 7003是7000的从</span></span><br><span class="line"><span class="comment"># 7004是7001的从</span></span><br><span class="line"><span class="comment"># 7005是7002的从</span></span><br><span class="line">redis-cli -p 7003 cluster replicate 7000id</span><br><span class="line">redis-cli -p 7004 cluster replicate 7001id</span><br><span class="line">redis-cli -p 7005 cluster replicate 7002id</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看</span></span><br><span class="line">redis-cli -p 7000 cluster info</span><br><span class="line">redis-cli -p 7000 cluster nodes</span><br><span class="line">redis-cli -p 7000 cluster slots <span class="comment"># 查看槽的信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 存放数据</span></span><br><span class="line">redis-cli -c -p 7000</span><br><span class="line"><span class="built_in">set</span> hello world <span class="comment"># 可以成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 生产环境建议 三台机器，主从不放在同一台机器上</span></span><br></pre></td></tr></table></figure>

<h4 id="3-5-官方工具安装（Ruby脚本）"><a href="#3-5-官方工具安装（Ruby脚本）" class="headerlink" title="]3.5 官方工具安装（Ruby脚本）"></a>]3.5 官方工具安装（Ruby脚本）</h4><h5 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载编译安装ruby</span></span><br><span class="line">wget https://cache.ruby-lang.org/pub/ruby/2.5/ruby-2.5.8.tar.gz</span><br><span class="line">tar -zxvf ruby-2.5.8.tar.gz</span><br><span class="line"><span class="built_in">cd</span> ruby</span><br><span class="line">./configure -prefix=/usr/<span class="built_in">local</span>/ruby</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/ruby</span><br><span class="line">cp bin/ruby /usr/<span class="built_in">local</span>/bin  <span class="comment"># ruby类似于python3</span></span><br><span class="line">cp bin/gem /usr/<span class="built_in">local</span>/bin   <span class="comment"># gem类似于pip</span></span><br><span class="line"></span><br><span class="line">ruby -v <span class="comment"># 检查版本</span></span><br><span class="line"><span class="comment"># 安装rubygem redis</span></span><br><span class="line"><span class="comment">### 更换gem源</span></span><br><span class="line">gem sources -l</span><br><span class="line"><span class="comment"># 移除https://rubygems.org源</span></span><br><span class="line">gem sources --remove https://rubygems.org/</span><br><span class="line"><span class="comment"># 增加https://gems.ruby-china.com/源</span></span><br><span class="line">gem sources -a https://gems.ruby-china.com/</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">gem sources -l</span><br><span class="line"><span class="comment">## 安装gem redis</span></span><br><span class="line">gem install redis -v 3.3.3</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">gem list check redis gem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装redis-trib.rb</span></span><br><span class="line"><span class="built_in">cd</span> /opt/soft/redis/src</span><br><span class="line">./redis-trib.rb 弃用了，需要使用</span><br><span class="line"><span class="comment"># 1 表示给每个主节点配置一个从节点</span></span><br><span class="line">redis-cli --cluster create --cluster-replicas 1 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005</span><br><span class="line">yes</span><br></pre></td></tr></table></figure>

<h3 id="四-集群伸缩"><a href="#四-集群伸缩" class="headerlink" title="四 集群伸缩"></a>四 集群伸缩</h3><h4 id="伸缩原理"><a href="#伸缩原理" class="headerlink" title="伸缩原理"></a>伸缩原理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 加入节点，删除节点：槽和数据在节点之间的移动</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg1469xqj31uc0tk7u6.jpg" alt="image-20200811235039641"></p>
<h4 id="集群扩容"><a href="#集群扩容" class="headerlink" title="集群扩容"></a>集群扩容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 作用：为它迁移槽和数据实现扩容  作为从节点负责故障转移</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1  准备新节点</span></span><br><span class="line">-集群模式</span><br><span class="line">-配置和其他节点统一</span><br><span class="line">-启动后是孤儿节点</span><br><span class="line">sed <span class="string">&#x27;s/7000/7006/g&#x27;</span> redis-7000.conf &gt; redis-7006.conf</span><br><span class="line">sed <span class="string">&#x27;s/7000/7007/g&#x27;</span> redis-7000.conf &gt; redis-7007.conf</span><br><span class="line">redis-server conf/redis-7006.conf</span><br><span class="line">redis-server conf/redis-7007.conf</span><br><span class="line"><span class="comment"># 孤立状态re</span></span><br><span class="line">redis-cli -p 7006 cluster nodes</span><br><span class="line"><span class="comment">#2  加入集群</span></span><br><span class="line"><span class="comment">### 方式一</span></span><br><span class="line">在7000上执行</span><br><span class="line">redis-cli -p 7000 cluster meet 127.0.0.1 7006</span><br><span class="line">redis-cli -p 7000 cluster meet 127.0.0.1 7007</span><br><span class="line"><span class="comment">### 方式二</span></span><br><span class="line">redis-cli --cluster add-node 127.0.0.1:7006 127.0.0.1:7000</span><br><span class="line">redis-cli --cluster add-node 127.0.0.1:7007 127.0.0.1:7000</span><br><span class="line"><span class="comment"># 查看配置</span></span><br><span class="line">cluster nodes</span><br><span class="line"><span class="comment"># 把7007做为7006的从</span></span><br><span class="line">redis-cli -p 7007 cluster replicate 7006的id</span><br><span class="line"><span class="comment">#3  迁移槽和数据</span></span><br><span class="line">  <span class="comment"># 槽迁移计划</span></span><br><span class="line">  <span class="comment"># 迁移数据</span></span><br><span class="line">  <span class="comment"># 添加从节点</span></span><br><span class="line">  </span><br><span class="line"> <span class="comment"># 我们不操作原生，直接使用redis-trip</span></span><br><span class="line">redis-cli --cluster reshard 127.0.0.1:7000 </span><br><span class="line"><span class="comment">#打印当前集群状态</span></span><br><span class="line"><span class="comment"># 希望迁移多少个槽：4096</span></span><br><span class="line"><span class="comment"># 希望那个id是接收的：7006的id</span></span><br><span class="line"><span class="comment"># 传入source id ：all</span></span><br><span class="line"><span class="comment"># yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">redis-cli -p 7000 cluster nodes</span><br><span class="line">redis-cli -p 7000 cluster slots</span><br><span class="line"><span class="comment">## 其他：</span></span><br><span class="line">-如果想给7000再加一个从节点怎么弄？</span><br><span class="line"><span class="comment"># 启动起7006，meet一下，让7006复制7000</span></span><br><span class="line">redis-cli -p 7000 cluster meet 127.0.0.1 7006</span><br><span class="line">redis-cli -p 7006 cluster replicate e03fb9a259cd314e9a23e17573d07c477d3242f7</span><br></pre></td></tr></table></figure>

<h4 id="集群缩容"><a href="#集群缩容" class="headerlink" title="集群缩容"></a>集群缩容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下线迁槽（把7006的1366个槽迁移到7000上）</span></span><br><span class="line">redis-cli --cluster reshard --cluster-from 7006的id --cluster-to 7000的id --cluster-slots 1366 127.0.0.1:7000</span><br><span class="line">yes</span><br><span class="line"></span><br><span class="line">redis-cli --cluster reshard --cluster-from 7006的id --cluster-to 7001的id --cluster-slots 1366 127.0.0.1:7001</span><br><span class="line">yes</span><br><span class="line">redis-cli --cluster reshard --cluster-from 7006的id --cluster-to 7002的id --cluster-slots 1365 127.0.0.1:7002</span><br><span class="line">yes</span><br><span class="line"><span class="comment"># 忘记节点，关闭节点</span></span><br><span class="line">redis-cli --cluster del-node 127.0.0.1:7000 要下线的7007id  <span class="comment"># 先下从，再下主，因为先下主会触发故障转移</span></span><br><span class="line">redis-cli --cluster del-node 127.0.0.1:7000 要下线的7006id </span><br><span class="line"><span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关掉其中一个主，另一个从立马变成主顶上， 重启停止的主，发现变成了从</span></span><br></pre></td></tr></table></figure>

<h3 id="五-客户端连接"><a href="#五-客户端连接" class="headerlink" title="五 客户端连接"></a>五 客户端连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -p 7000  <span class="comment"># -c表示集群模式</span></span><br><span class="line"><span class="built_in">set</span> hello world  <span class="comment"># ok</span></span><br><span class="line">cluster keyslot php</span><br><span class="line"><span class="comment"># 9244</span></span><br><span class="line"><span class="built_in">set</span> php sb <span class="comment"># 不命中，会返回7001，自动跳转到7001上  不加-c，只会返回错误，不会去执行7001上保存</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># rediscluster</span></span><br><span class="line"><span class="comment"># pip3 install redis-py-cluster</span></span><br><span class="line">from rediscluster import RedisCluster</span><br><span class="line">startup_nodes = [&#123;<span class="string">&quot;host&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;port&quot;</span>: <span class="string">&quot;7000&quot;</span>&#125;,&#123;<span class="string">&quot;host&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;port&quot;</span>: <span class="string">&quot;7001&quot;</span>&#125;,&#123;<span class="string">&quot;host&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;port&quot;</span>: <span class="string">&quot;7002&quot;</span>&#125;]</span><br><span class="line"><span class="comment"># rc = RedisCluster(startup_nodes=startup_nodes,decode_responses=True)</span></span><br><span class="line">rc = RedisCluster(startup_nodes=startup_nodes)</span><br><span class="line">rc.set(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(rc.get(<span class="string">&quot;foo&quot;</span>))</span><br></pre></td></tr></table></figure>

<h3 id="六-集群原理"><a href="#六-集群原理" class="headerlink" title="六 集群原理"></a>六 集群原理</h3><p>move重定向</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg19v43hj31pl0u01ea.jpg" alt="image-20200812003219180"></p>
<p>槽命中</p>
<p>cluster keyslot hello 可以计算出槽的值</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg1dtp92j31te0q27hv.jpg" alt="image-20200812003318203"></p>
<p>槽不命中：moved异常</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gicg1i8mu1j31r80u07nz.jpg" alt="image-20200812003446448"></p>
<h3 id="七-补充"><a href="#七-补充" class="headerlink" title="七 补充"></a>七 补充</h3><h4 id="7-1-5-0以后集群搭建"><a href="#7-1-5-0以后集群搭建" class="headerlink" title="7.1 5.0以后集群搭建"></a>7.1 5.0以后集群搭建</h4><p>Redis Cluster 在5.0之后取消了ruby脚本 <strong>redis-trib.rb</strong>的支持（手动命令行添加集群的方式不变），集合到redis-cli里，避免了再安装ruby的相关环境。直接使用redis-clit的参数–cluster 来取代</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster <span class="built_in">help</span></span><br><span class="line">Cluster Manager Commands:</span><br><span class="line">  create         host1:port1 ... hostN:portN   <span class="comment">#创建集群</span></span><br><span class="line">                 --cluster-replicas &lt;arg&gt;      <span class="comment">#从节点个数</span></span><br><span class="line">  check          host:port                     <span class="comment">#检查集群</span></span><br><span class="line">                 --cluster-search-multiple-owners <span class="comment">#检查是否有槽同时被分配给了多个节点</span></span><br><span class="line">  info           host:port                     <span class="comment">#查看集群状态</span></span><br><span class="line">  fix            host:port                     <span class="comment">#修复集群</span></span><br><span class="line">                 --cluster-search-multiple-owners <span class="comment">#修复槽的重复分配问题</span></span><br><span class="line">  reshard        host:port                     <span class="comment">#指定集群的任意一节点进行迁移slot，重新分slots</span></span><br><span class="line">                 --cluster-from &lt;arg&gt;          <span class="comment">#需要从哪些源节点上迁移slot，可从多个源节点完成迁移，以逗号隔开，传递的是节点的node id，还可以直接传递--from all，这样源节点就是集群的所有节点，不传递该参数的话，则会在迁移过程中提示用户输入</span></span><br><span class="line">                 --cluster-to &lt;arg&gt;            <span class="comment">#slot需要迁移的目的节点的node id，目的节点只能填写一个，不传递该参数的话，则会在迁移过程中提示用户输入</span></span><br><span class="line">                 --cluster-slots &lt;arg&gt;         <span class="comment">#需要迁移的slot数量，不传递该参数的话，则会在迁移过程中提示用户输入。</span></span><br><span class="line">                 --cluster-yes                 <span class="comment">#指定迁移时的确认输入</span></span><br><span class="line">                 --cluster-timeout &lt;arg&gt;       <span class="comment">#设置migrate命令的超时时间</span></span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;      <span class="comment">#定义cluster getkeysinslot命令一次取出的key数量，不传的话使用默认值为10</span></span><br><span class="line">                 --cluster-replace             <span class="comment">#是否直接replace到目标节点</span></span><br><span class="line">  rebalance      host:port                                      <span class="comment">#指定集群的任意一节点进行平衡集群节点slot数量 </span></span><br><span class="line">                 --cluster-weight &lt;node1=w1...nodeN=wN&gt;         <span class="comment">#指定集群节点的权重</span></span><br><span class="line">                 --cluster-use-empty-masters                    <span class="comment">#设置可以让没有分配slot的主节点参与，默认不允许</span></span><br><span class="line">                 --cluster-timeout &lt;arg&gt;                        <span class="comment">#设置migrate命令的超时时间</span></span><br><span class="line">                 --cluster-simulate                             <span class="comment">#模拟rebalance操作，不会真正执行迁移操作</span></span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;                       <span class="comment">#定义cluster getkeysinslot命令一次取出的key数量，默认值为10</span></span><br><span class="line">                 --cluster-threshold &lt;arg&gt;                      <span class="comment">#迁移的slot阈值超过threshold，执行rebalance操作</span></span><br><span class="line">                 --cluster-replace                              <span class="comment">#是否直接replace到目标节点</span></span><br><span class="line">  add-node       new_host:new_port existing_host:existing_port  <span class="comment">#添加节点，把新节点加入到指定的集群，默认添加主节点</span></span><br><span class="line">                 --cluster-slave                                <span class="comment">#新节点作为从节点，默认随机一个主节点</span></span><br><span class="line">                 --cluster-master-id &lt;arg&gt;                      <span class="comment">#给新节点指定主节点</span></span><br><span class="line">  del-node       host:port node_id                              <span class="comment">#删除给定的一个节点，成功后关闭该节点服务</span></span><br><span class="line">  call           host:port <span class="built_in">command</span> arg arg .. arg               <span class="comment">#在集群的所有节点执行相关命令</span></span><br><span class="line">  <span class="built_in">set</span>-timeout    host:port milliseconds                         <span class="comment">#设置cluster-node-timeout</span></span><br><span class="line">  import         host:port                                      <span class="comment">#将外部redis数据导入集群</span></span><br><span class="line">                 --cluster-from &lt;arg&gt;                           <span class="comment">#将指定实例的数据导入到集群</span></span><br><span class="line">                 --cluster-copy                                 <span class="comment">#migrate时指定copy</span></span><br><span class="line">                 --cluster-replace                              <span class="comment">#migrate时指定replace</span></span><br><span class="line">  <span class="built_in">help</span>           </span><br><span class="line"></span><br><span class="line">For check, fix, reshard, del-node, <span class="built_in">set</span>-timeout you can specify the host and port of any working node <span class="keyword">in</span> the cluster.</span><br></pre></td></tr></table></figure>

<p>① 创建集群主节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 192.168.163.132:6379 192.168.163.132:6380 192.168.163.132:6381</span><br></pre></td></tr></table></figure>

<p>② 创建集群主从节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/redis-cli --cluster create 192.168.163.132:6379 192.168.163.132:6380 192.168.163.132:6381 192.168.163.132:6382 192.168.163.132:6383 192.168.163.132:6384 --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<p>说明：–cluster-replicas 参数为数字，1表示每个主节点需要1个从节点。</p>
<p>通过该方式创建的带有从节点的机器不能够自己手动指定主节点，所以如果需要指定的话，需要自己手动指定，先使用①或③创建好主节点后，再通过④来处理。</p>
<p>③ 添加集群主节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster add-node 192.168.163.132:6382 192.168.163.132:6379</span><br></pre></td></tr></table></figure>

<p>说明：为一个指定集群添加节点，需要先连到该集群的任意一个节点IP（192.168.163.132:6379），再把新节点加入。该2个参数的顺序有要求：新加入的节点放前</p>
<p>④ 添加集群从节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster add-node 192.168.163.132:6382 192.168.163.132:6379 --cluster-slave --cluster-master-id 117457eab5071954faab5e81c3170600d5192270</span><br></pre></td></tr></table></figure>

<p>说明：把6382节点加入到6379节点的集群中，并且当做node_id为 117457eab5071954faab5e81c3170600d5192270 的从节点。如果不指定 <strong>–cluster-master-id</strong> 会随机分配到任意一个主节点。</p>
<p>⑤ 删除节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster del-node 192.168.163.132:6384 f6a6957421b80409106cb36be3c7ba41f3b603ff</span><br></pre></td></tr></table></figure>

<p>说明：指定IP、端口和node_id 来删除一个节点，从节点可以直接删除，主节点不能直接删除，删除之后，该节点会被shutdown。</p>
<p>注意：当被删除掉的节点重新起来之后不能自动加入集群，但其和主的复制还是正常的，也可以通过该节点看到集群信息（通过其他正常节点已经看不到该被del-node节点的信息）。</p>
<p>如果想要再次加入集群，则需要先在该节点执行cluster reset，再用add-node进行添加，进行增量同步复制。</p>
<p>到此，目前整个集群的状态如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.163.132:6379&gt; cluster nodes</span><br><span class="line">815da8448f5d5a304df0353ca10d8f9b77016b28 192.168.163.132:6380@16380 master - 0 1569748297177 2 connected 5461-10922</span><br><span class="line">0c21b6cee354594a23f4d5abf0d01b48bdc96d55 192.168.163.132:6383@16383 slave 56005b9413cbf225783906307a2631109e753f8f 0 1569748295000 4 connected</span><br><span class="line">3a1d04983ab6c4ae853f9602dd922d4ebadc4dbf 192.168.163.132:6382@16382 slave 815da8448f5d5a304df0353ca10d8f9b77016b28 0 1569748295000 5 connected</span><br><span class="line">117457eab5071954faab5e81c3170600d5192270 192.168.163.132:6379@16379 myself,master - 0 1569748297000 1 connected 0-5460</span><br><span class="line">56005b9413cbf225783906307a2631109e753f8f 192.168.163.132:6381@16381 master - 0 1569748295000 3 connected 10923-16383</span><br><span class="line">f6a6957421b80409106cb36be3c7ba41f3b603ff 192.168.163.132:6384@16384 slave 117457eab5071954faab5e81c3170600d5192270 0 1569748298185 6 connected</span><br></pre></td></tr></table></figure>

<p>⑥ 检查集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster check 192.168.163.132:6384 --cluster-search-multiple-owners</span><br></pre></td></tr></table></figure>

<p>说明：任意连接一个集群节点，进行集群状态检查</p>
<p>⑦ 集群信息查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster info 192.168.163.132:6384</span><br></pre></td></tr></table></figure>

<p>说明：检查key、slots、从节点个数的分配情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;redis-cli --cluster info 192.168.163.132:6384</span><br><span class="line">192.168.163.132:6380 (815da844...) -&gt; 0 keys | 5462 slots | 1 slaves.</span><br><span class="line">192.168.163.132:6381 (56005b94...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">192.168.163.132:6379 (117457ea...) -&gt; 2 keys | 5461 slots | 1 slaves.</span><br><span class="line">[OK] 2 keys in 3 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br></pre></td></tr></table></figure>

<p>⑧ 修复集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster fix 192.168.163.132:6384 --cluster-search-multiple-owners</span><br></pre></td></tr></table></figure>

<p>说明：修复集群和槽的重复分配问题</p>
<p>⑨ 设置集群的超时时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster set-timeout 192.168.163.132:6382 10000</span><br></pre></td></tr></table></figure>

<p>说明：连接到集群的任意一节点来设置集群的超时时间参数cluster-node-timeout</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster <span class="built_in">set</span>-timeout 192.168.163.132:6382 10000</span><br><span class="line">&gt;&gt;&gt; Reconfiguring node timeout <span class="keyword">in</span> every cluster node...</span><br><span class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 192.168.163.132:6382</span><br><span class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 192.168.163.132:6384</span><br><span class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 192.168.163.132:6383</span><br><span class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 192.168.163.132:6379</span><br><span class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 192.168.163.132:6381</span><br><span class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 192.168.163.132:6380</span><br><span class="line">&gt;&gt;&gt; New node timeout <span class="built_in">set</span>. 6 OK, 0 ERR.</span><br></pre></td></tr></table></figure>

<p>⑩ 集群中执行相关命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster call 192.168.163.132:6381 config set requirepass cc</span><br><span class="line">redis-cli -a cc --cluster call 192.168.163.132:6381 config set masterauth cc</span><br><span class="line">redis-cli -a cc --cluster call 192.168.163.132:6381 config rewrite</span><br></pre></td></tr></table></figure>

<p>说明：连接到集群的任意一节点来对整个集群的所有节点进行设置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster call 192.168.163.132:6381 config <span class="built_in">set</span> cluster-node-timeout 12000</span><br><span class="line">&gt;&gt;&gt; Calling config <span class="built_in">set</span> cluster-node-timeout 12000</span><br><span class="line">192.168.163.132:6381: OK</span><br><span class="line">192.168.163.132:6383: OK</span><br><span class="line">192.168.163.132:6379: OK</span><br><span class="line">192.168.163.132:6384: OK</span><br><span class="line">192.168.163.132:6382: OK</span><br><span class="line">192.168.163.132:6380: OK</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>到此，相关集群的基本操作已经介绍完，现在说明集群迁移的相关操作。</p>
<h4 id="迁移相关"><a href="#迁移相关" class="headerlink" title="迁移相关"></a>迁移相关</h4><p>① <strong>在线迁移slot</strong> ：在线把集群的一些slot从集群原来slot节点迁移到新的节点，即可以完成集群的在线横向扩容和缩容。有2种方式进行迁移</p>
<p>一是根据提示来进行操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">直接连接到集群的任意一节点</span><br><span class="line">redis-cli -a cc --cluster reshard 192.168.163.132:6379</span><br></pre></td></tr></table></figure>

<p>信息如下：</p>
<p>二是根据参数进行操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a cc --cluster reshard 192.168.163.132:6379 --cluster-from 117457eab5071954faab5e81c3170600d5192270 --cluster-to 815da8448f5d5a304df0353ca10d8f9b77016b28 --cluster-slots 10 --cluster-yes --cluster-timeout 5000 --cluster-pipeline 10 --cluster-replace</span><br></pre></td></tr></table></figure>

<p>说明：连接到集群的任意一节点来对指定节点指定数量的slot进行迁移到指定的节点。</p>
<p>② 平衡（rebalance）<strong>slot</strong> ：</p>
<p>1）平衡集群中各个节点的slot数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a cc --cluster rebalance 192.168.163.132:6379</span><br></pre></td></tr></table></figure>

<p>2）根据集群中各个节点设置的权重等平衡slot数量（不执行，只模拟）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a cc --cluster rebalance --cluster-weight 117457eab5071954faab5e81c3170600d5192270&#x3D;5 815da8448f5d5a304df0353ca10d8f9b77016b28&#x3D;4 56005b9413cbf225783906307a2631109e753f8f&#x3D;3 --cluster-simulate 192.168.163.132:6379</span><br></pre></td></tr></table></figure>

<p>③ 导入集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster import 192.168.163.132:6379 --cluster-from 192.168.163.132:9021 --cluster-replace</span><br></pre></td></tr></table></figure>

<p>说明：外部Redis实例（9021）导入到集群中的任意一节点。</p>
<p>注意：测试下来发现参数–cluster-replace没有用，如果集群中已经包含了某个key，在导入的时候会失败，不会覆盖，只有清空集群key才能导入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*** Importing 97847 keys from DB 0</span><br><span class="line">Migrating 9223372011174675807 to 192.168.163.132:6381: Source 192.168.163.132:9021 replied with error:</span><br><span class="line">ERR Target instance replied with error: BUSYKEY Target key name already exists</span><br></pre></td></tr></table></figure>

<p>并且发现如果集群设置了密码，也会导入失败，需要设置集群密码为空才能进行导入（call）。通过monitor（9021）的时候发现，在migrate的时候需要密码进行auth认证。</p>
<h2 id="一-缓存的收益与成本"><a href="#一-缓存的收益与成本" class="headerlink" title="一 缓存的收益与成本"></a>一 缓存的收益与成本</h2><h3 id="1-1-受益"><a href="#1-1-受益" class="headerlink" title="1.1 受益"></a>1.1 受益</h3><blockquote>
<p>1 加速读写</p>
<p>2 降低后端负载：后端服务器通过前端缓存降低负载，业务端使用redis降低后端mysql负载</p>
</blockquote>
<h3 id="1-2-成本"><a href="#1-2-成本" class="headerlink" title="1.2 成本"></a>1.2 成本</h3><blockquote>
<p>1 数据不一致：缓存层和数据层有时间窗口不一致，和更新策略有关</p>
<p>2 代码维护成本：多了一层缓存逻辑</p>
<p>3 运维成本：比如使用了Redis Cluster</p>
</blockquote>
<h3 id="1-3-使用场景"><a href="#1-3-使用场景" class="headerlink" title="1.3 使用场景"></a>1.3 使用场景</h3><blockquote>
<p>1 降低后端负载：对高消耗的sql，join结果集/分组统计的结果做缓存</p>
<p>2 加速请求响应：利用redis优化io响应时间</p>
<p>3 大量写合并为批量写：如计数器先redis累加再批量写入db</p>
</blockquote>
<h2 id="二-缓存更新策略"><a href="#二-缓存更新策略" class="headerlink" title="二 缓存更新策略"></a>二 缓存更新策略</h2><blockquote>
<p>1 LRU/LFU/FIFO算法剔除：例如maxmemory-policy(到了最大内存，对应的应对策略)</p>
<p> LRU -Least Recently Used,没有被使用时间最长的</p>
<p> LFU -Least Frequenty User,一定时间段内使用次数最少的</p>
<p> FIFO -First In First Out</p>
<p> LIRS (Low Inter-reference Recency Set)是一个页替换算法，相比于LRU(Least Recently Used)和很多其他的替换算法，LIRS具有较高的性能。这是通过使用两次访问同一页之间的距离（本距离指中间被访问了多少非重复块）作为一种尺度去动态地将访问页排序，从而去做一个替换的选择</p>
<p>配置文件中设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt;# LRU配置</span><br><span class="line">&gt;maxmemory-policy:volatile-lru</span><br><span class="line">&gt;（1）noeviction: 如果内存使用达到了maxmemory，client还要继续写入数据，那么就直接报错给客户端</span><br><span class="line">&gt;（2）allkeys-lru: 就是我们常说的LRU算法，移除掉最近最少使用的那些keys对应的数据，ps最长用的策略</span><br><span class="line">&gt;（3）volatile-lru: 也是采取LRU算法，但是仅仅针对那些设置了指定存活时间（TTL）的key才会清理掉</span><br><span class="line">&gt;（4）allkeys-random: 随机选择一些key来删除掉</span><br><span class="line">&gt;（5）volatile-random: 随机选择一些设置了TTL的key来删除掉</span><br><span class="line">&gt;（6）volatile-ttl: 移除掉部分keys，选择那些TTL时间比较短的keys</span><br><span class="line">&gt;# LFU配置 Redis4.0之后为maxmemory_policy淘汰策略添加了两个LFU模式：</span><br><span class="line">&gt;volatile-lfu：对有过期时间的key采用LFU淘汰算法</span><br><span class="line">&gt;allkeys-lfu：对全部key采用LFU淘汰算法</span><br><span class="line">&gt;# 还有2个配置可以调整LFU算法：</span><br><span class="line">&gt;lfu-log-factor 10</span><br><span class="line">&gt;lfu-decay-time 1</span><br><span class="line">&gt;# lfu-log-factor可以调整计数器counter的增长速度，lfu-log-factor越大，counter增长的越慢。</span><br><span class="line">&gt;# lfu-decay-time是一个以分钟为单位的数值，可以调整counter的减少速度</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>2 超时剔除：例如expire，设置过期时间</p>
<p>3 主动更新：开发控制生命周期</p>
</blockquote>
<table>
<thead>
<tr>
<th>策略</th>
<th>一致性</th>
<th>维护成本</th>
</tr>
</thead>
<tbody><tr>
<td>LRU/LIRS算法剔除</td>
<td>最差</td>
<td>低</td>
</tr>
<tr>
<td>超时剔除</td>
<td>较差</td>
<td>低</td>
</tr>
<tr>
<td>主动更新</td>
<td>强</td>
<td>高</td>
</tr>
</tbody></table>
<p>1 低一致性：最大内存和淘汰策略</p>
<p>2 高一致性：超时剔除和主动更新结合，最大内存和淘汰策略兜底</p>
<h2 id="三-缓存粒度控制"><a href="#三-缓存粒度控制" class="headerlink" title="三 缓存粒度控制"></a>三 缓存粒度控制</h2><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gduwyfg8mgj30bm0dsjt6.jpg" alt="image-20200416002406930"></p>
<blockquote>
<p>1 从mysql获取用户信息：select * from user where id=100</p>
<p>2 设置用户信息缓存：set user:100 <code>select * from user where id=100</code></p>
<p>3 缓存粒度：</p>
<p> 缓存全部属性</p>
<p> 缓存部分重要属性</p>
</blockquote>
<p>1 通用性：全量属性更好</p>
<p>2 占用空间：部分属性更好</p>
<p>3 代码维护：表面上全量属性更好</p>
<h2 id="四-缓存穿透，缓存击穿，缓存雪崩"><a href="#四-缓存穿透，缓存击穿，缓存雪崩" class="headerlink" title="四 缓存穿透，缓存击穿，缓存雪崩"></a>四 缓存穿透，缓存击穿，缓存雪崩</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">###  缓存穿透</span><br><span class="line">#描述：</span><br><span class="line">缓存穿透是指缓存和数据库中都没有的数据，而用户不断发起请求，如发起为id为“-1”的数据或id为特别大不存在的数据。这时的用户很可能是攻击者，攻击会导致数据库压力过大。</span><br><span class="line">#解决方案：</span><br><span class="line">1 接口层增加校验，如用户鉴权校验，id做基础校验，id&lt;&#x3D;0的直接拦截；</span><br><span class="line">2 从缓存取不到的数据，在数据库中也没有取到，这时也可以将key-value对写为key-null，缓存有效时间可以设置短点，如30秒（设置太长会导致正常情况也没法使用）。这样可以防止攻击用户反复用同一个id暴力攻击</span><br><span class="line">3 通过布隆过滤器实现</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 缓存击穿</span><br><span class="line">#描述：</span><br><span class="line">缓存击穿是指缓存中没有但数据库中有的数据（一般是缓存时间到期），这时由于并发用户特别多，同时读缓存没读到数据，又同时去数据库去取数据，引起数据库压力瞬间增大，造成过大压力</span><br><span class="line">#解决方案：</span><br><span class="line">设置热点数据永远不过期。</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">### 缓存雪崩</span><br><span class="line">#描述：</span><br><span class="line">缓存雪崩是指缓存中数据大批量到过期时间，而查询数据量巨大，引起数据库压力过大甚至down机。和缓存击穿不同的是，        缓存击穿指并发查同一条数据，缓存雪崩是不同数据都过期了，很多数据都查不到从而查数据库。</span><br><span class="line"># 解决方案：</span><br><span class="line">1 缓存数据的过期时间设置随机，防止同一时间大量数据过期现象发生。</span><br><span class="line">2 如果缓存数据库是分布式部署，将热点数据均匀分布在不同搞得缓存数据库中。</span><br><span class="line">3 设置热点数据永远不过期。</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/DB/" rel="tag"><i class="fas fa-cookie-bite"></i> DB</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/07/22/DB-Redis-%E5%9F%BA%E7%A1%80/" rel="prev" title="DB-Redis-基础">
      <i class="fa fa-chevron-left"></i> DB-Redis-基础
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/07/23/py-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8D%95%E4%BE%8B/" rel="next" title="py-设计模式-单例">
      py-设计模式-单例 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">1.</span> <span class="nav-text">一. 主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80-%E5%9C%BA%E6%99%AF"><span class="nav-number">1.1.</span> <span class="nav-text">一. 场景:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%8E%9F%E7%90%86%EF%BC%88%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E4%B8%8D%E4%BE%9D%E8%B5%96%E4%B8%BB%E5%BA%93%E6%98%AF%E5%90%A6%E5%BC%80%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%8C%E4%BD%86%E6%98%AF%E4%B8%8D%E5%BC%80%E6%8C%81%E4%B9%85%E5%8C%96%E4%BC%9A%E6%9C%89%E9%97%AE%E9%A2%98%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">1.1 原理（主从复制不依赖主库是否开持久化，但是不开持久化会有问题）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%B8%BB%E5%BA%93%E6%98%AF%E5%90%A6%E8%A6%81%E5%BC%80%E5%90%AF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">1.3.</span> <span class="nav-text">1.2 主库是否要开启持久化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E8%BE%85%E5%8A%A9%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%BB%E4%BB%8E%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%85%8D%E7%BD%AE%EF%BC%89"><span class="nav-number">1.4.</span> <span class="nav-text">1.3 辅助配置（主从数据一致性配置）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.5.</span> <span class="nav-text">二 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-slave-%E5%91%BD%E4%BB%A4"><span class="nav-number">1.6.</span> <span class="nav-text">2.1 slave 命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.7.</span> <span class="nav-text">2.2 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B-%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86"><span class="nav-number">1.8.</span> <span class="nav-text">四 故障处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94-%E5%A4%8D%E5%88%B6%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">1.9.</span> <span class="nav-text">五 复制常见问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-redis-sentinel-%E5%93%A8%E5%85%B5"><span class="nav-number">2.</span> <span class="nav-text">二.redis-sentinel 哨兵</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%97%AE%E9%A2%98"><span class="nav-number">2.1.</span> <span class="nav-text">一 主从复制问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C-%E5%93%A8%E5%85%B5%E4%BD%9C%E7%94%A8-%E5%93%A8%E5%85%B5%E7%9A%84%E4%B8%89%E4%B8%AA%E4%BD%9C%E7%94%A8%E7%9B%91%E6%8E%A7%E3%80%81%E9%80%9A%E7%9F%A5%E3%80%81%E8%87%AA%E5%8A%A8%E8%BD%AC%E7%A7%BB%E6%95%85%E9%9A%9C"><span class="nav-number">2.2.</span> <span class="nav-text">二 哨兵作用(哨兵的三个作用监控、通知、自动转移故障)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.</span> <span class="nav-text">三 安装配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5"><span class="nav-number">2.4.</span> <span class="nav-text">四 客户端连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-number">2.5.</span> <span class="nav-text">五 实现原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E7%9B%91%E6%8E%A7%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">2.5.1.</span> <span class="nav-text">1. 监控工作流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E9%80%9A%E7%9F%A5%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">2.5.2.</span> <span class="nav-text">2. 通知工作流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB%E5%8E%9F%E7%90%86%EF%BC%88%E6%9C%AC%E6%96%87%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-number">2.5.3.</span> <span class="nav-text">3. 故障转移原理（本文重点）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AD-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">2.6.</span> <span class="nav-text">六 常见问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-redis-cluster"><span class="nav-number">3.</span> <span class="nav-text">三.redis-cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80-Redis-Cluser%E4%BB%8B%E7%BB%8D%E8%83%8C%E6%99%AF"><span class="nav-number">3.1.</span> <span class="nav-text">一 Redis Cluser介绍背景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1%E9%97%AE%E9%A2%98"><span class="nav-number">3.1.1.</span> <span class="nav-text">1.1问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-%E8%A7%A3%E5%86%B3"><span class="nav-number">3.1.2.</span> <span class="nav-text">1.2 解决</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C-%E6%95%B0%E6%8D%AE%E5%88%86%E5%B8%83%EF%BC%88%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%89"><span class="nav-number">3.2.</span> <span class="nav-text">二 数据分布（分布式数据库）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98"><span class="nav-number">3.2.1.</span> <span class="nav-text">2.1 存在问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-%E5%88%86%E5%8C%BA%E6%96%B9%E5%BC%8F"><span class="nav-number">3.2.2.</span> <span class="nav-text">2.2 分区方式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-%E9%A1%BA%E5%BA%8F%E5%88%86%E5%8C%BA"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">2.2.1 顺序分区</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-%E5%93%88%E5%B8%8C%E5%88%86%E5%8C%BA"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">2.2.2 哈希分区</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-1-%E8%8A%82%E7%82%B9%E5%8F%96%E4%BD%99%E5%88%86%E5%8C%BA"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">2.2.2 .1 节点取余分区</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-2-%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E5%88%86%E5%8C%BA"><span class="nav-number">3.2.2.4.</span> <span class="nav-text">2.2.2 .2 一致性哈希分区</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-3-%E8%99%9A%E6%8B%9F%E6%A7%BD%E5%88%86%E5%8C%BA"><span class="nav-number">3.2.2.5.</span> <span class="nav-text">2.2.2 .3 虚拟槽分区</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-number">3.3.</span> <span class="nav-text">三 集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-%E5%8D%95%E6%9C%BA%E6%9E%B6%E6%9E%84"><span class="nav-number">3.3.1.</span> <span class="nav-text">3. 1 单机架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="nav-number">3.3.2.</span> <span class="nav-text">3.2 分布式架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-Redis-Cluster%E6%9E%B6%E6%9E%84"><span class="nav-number">3.3.3.</span> <span class="nav-text">3.3 Redis Cluster架构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#meet%E8%A7%A3%E9%87%8A"><span class="nav-number">3.3.3.1.</span> <span class="nav-text">meet解释</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8C%87%E6%B4%BE%E6%A7%BD"><span class="nav-number">3.3.3.2.</span> <span class="nav-text">指派槽</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-%E5%8E%9F%E7%94%9F%E5%AE%89%E8%A3%85"><span class="nav-number">3.3.4.</span> <span class="nav-text">3.4 原生安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-%E5%AE%98%E6%96%B9%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%EF%BC%88Ruby%E8%84%9A%E6%9C%AC%EF%BC%89"><span class="nav-number">3.3.5.</span> <span class="nav-text">]3.5 官方工具安装（Ruby脚本）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="nav-number">3.3.5.1.</span> <span class="nav-text">准备环境</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B-%E9%9B%86%E7%BE%A4%E4%BC%B8%E7%BC%A9"><span class="nav-number">3.4.</span> <span class="nav-text">四 集群伸缩</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%B8%E7%BC%A9%E5%8E%9F%E7%90%86"><span class="nav-number">3.4.1.</span> <span class="nav-text">伸缩原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%89%A9%E5%AE%B9"><span class="nav-number">3.4.2.</span> <span class="nav-text">集群扩容</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%BC%A9%E5%AE%B9"><span class="nav-number">3.4.3.</span> <span class="nav-text">集群缩容</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5"><span class="nav-number">3.5.</span> <span class="nav-text">五 客户端连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AD-%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86"><span class="nav-number">3.6.</span> <span class="nav-text">六 集群原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%83-%E8%A1%A5%E5%85%85"><span class="nav-number">3.7.</span> <span class="nav-text">七 补充</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-5-0%E4%BB%A5%E5%90%8E%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-number">3.7.1.</span> <span class="nav-text">7.1 5.0以后集群搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%81%E7%A7%BB%E7%9B%B8%E5%85%B3"><span class="nav-number">3.7.2.</span> <span class="nav-text">迁移相关</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80-%E7%BC%93%E5%AD%98%E7%9A%84%E6%94%B6%E7%9B%8A%E4%B8%8E%E6%88%90%E6%9C%AC"><span class="nav-number">4.</span> <span class="nav-text">一 缓存的收益与成本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%8F%97%E7%9B%8A"><span class="nav-number">4.1.</span> <span class="nav-text">1.1 受益</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%88%90%E6%9C%AC"><span class="nav-number">4.2.</span> <span class="nav-text">1.2 成本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">4.3.</span> <span class="nav-text">1.3 使用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C-%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="nav-number">5.</span> <span class="nav-text">二 缓存更新策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-%E7%BC%93%E5%AD%98%E7%B2%92%E5%BA%A6%E6%8E%A7%E5%88%B6"><span class="nav-number">6.</span> <span class="nav-text">三 缓存粒度控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%EF%BC%8C%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%EF%BC%8C%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="nav-number">7.</span> <span class="nav-text">四 缓存穿透，缓存击穿，缓存雪崩</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Waylon Yan"
      src="/images/timg.jpeg">
  <p class="site-author-name" itemprop="name">Waylon Yan</p>
  <div class="site-description" itemprop="description">tech life sharing</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">129</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Waylonwhynot" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Waylonwhynot" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:ywl1006@outlook.com" title="E-Mail → mailto:ywl1006@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Waylon Yan</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">45:04</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div> -->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
