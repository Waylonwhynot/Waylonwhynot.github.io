<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Service-Mesh02 | YouNeed</title><meta name="keywords" content="note"><meta name="author" content="Waylon Yan"><meta name="copyright" content="Waylon Yan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Envoy">
<meta property="og:type" content="article">
<meta property="og:title" content="Service-Mesh02">
<meta property="og:url" content="https://waylon.whatyouneed.site/2022/11/23/Service-Mesh02/index.html">
<meta property="og:site_name" content="YouNeed">
<meta property="og:description" content="Envoy">
<meta property="og:locale">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png">
<meta property="article:published_time" content="2022-11-23T15:55:24.000Z">
<meta property="article:modified_time" content="2022-12-04T10:49:14.658Z">
<meta property="article:author" content="Waylon Yan">
<meta property="article:tag" content="note">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://waylon.whatyouneed.site/2022/11/23/Service-Mesh02/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Service-Mesh02',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-04 18:49:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">251</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">38</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">24</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">YouNeed</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Service-Mesh02</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-11-23T15:55:24.000Z" title="Created 2022-11-23 23:55:24">2022-11-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-12-04T10:49:14.658Z" title="Updated 2022-12-04 18:49:14">2022-12-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/">服务网格</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Service-Mesh02"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Envoy</p>
<a id="more"></a>

<h1 id="What-is-Envoy"><a href="#What-is-Envoy" class="headerlink" title="What is Envoy?"></a>What is Envoy?</h1><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/envoyproxy/envoy">Envoy</a> 是一款由 Lyft 开源的，使用 C++ 编写的 L7 代理和通信总线，目前是 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://cncf.io/">CNCF</a> 旗下的开源项目且已经毕业，代码托管在 GitHub 上，它也是 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://jimmysong.io/kubernetes-handbook/usecases/istio.html">Istio</a> 服务网格中默认的数据平面。关于 Envoy 的详情请阅读 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloudnative.to/envoy/">Envoy 中文文档</a>。</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>Envoy 包括如下特性：</p>
<ul>
<li>进程外架构，不侵入应用进程</li>
<li>使用现代版 C++11 代码</li>
<li>L3/L4 filter 架构</li>
<li>HTTP L7 filter 架构</li>
<li>支持 HTTP/2</li>
<li>HTTP L7 routing</li>
<li>支持 gRPC</li>
<li>支持 MongoDB L7</li>
<li>动态配置</li>
<li>最佳可观测性</li>
<li>支持 front/edge proxy</li>
<li>高级负载均衡</li>
<li>健康检查</li>
<li>服务发现</li>
<li>支持 DynamoDB L7</li>
</ul>
<p>Envoy 本身无法构成一个完整的 Service Mesh，但是它可以作为 service mesh 中的应用间流量的代理，负责 service mesh 中的数据层。</p>
<h2 id="负载均衡与代理"><a href="#负载均衡与代理" class="headerlink" title="负载均衡与代理"></a>负载均衡与代理</h2><blockquote>
<p>siedcar</p>
</blockquote>
<ul>
<li><p>Listener(流量治理也主要配置在Listener之上)</p>
<ul>
<li><p>Ingress</p>
</li>
<li><p>Egress（发挥作用的正向代理）</p>
</li>
</ul>
</li>
</ul>
<p>​        Envoy 在启动的时候，会去请求管理服务器，以加载与自身有关的配置；网格在运行当中，如果更改路由，更改网格的管理配置的时候，我们期望能完成实时的推送；Envoy极大限度的支持配置的动态加载，所以Envoy启动的时候，会与管理服务器进行GRPC的连接（早起rest 轮询），更新配置。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/load-balancing-and-proxing.png" alt="负载均衡器的特性以及拓扑类型"></p>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>下图是 Envoy proxy 的架构图，显示了 host A 经过 Envoy 访问 host B 的过程。每个 host 上都可能运行多个 service，Envoy 中也可能有多个 Listener，每个 Listener 中可能会有多个 filter 组成了 chain。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://jimmysong.io/kubernetes-handbook/images/envoy-arch.png"><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/envoy-arch.png" alt="Envoy proxy 架构图"></a>图 7.4.1.1：Envoy proxy 架构图</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20221204165014809.png" alt="image-20221204165014809"></p>
<p>其中的基本术语将在下面解释。</p>
<h2 id="基本术语"><a href="#基本术语" class="headerlink" title="基本术语"></a>基本术语</h2><p><strong>Host</strong>：能够进行网络通信的实体（在手机或服务器等上的应用程序）。在 Envoy 中主机是指逻辑网络应用程序。只要每台主机都可以独立寻址，一块物理硬件上就运行多个主机。</p>
<p><strong>Downstream</strong>：下游（downstream）主机连接到 Envoy，发送请求并或获得响应。</p>
<p><strong>Upstream</strong>：上游（upstream）主机获取来自 Envoy 的链接请求和响应。</p>
<p><strong>Cluster</strong>: 集群（cluster）是 Envoy 连接到的一组逻辑上相似的上游主机。Envoy 通过服务发现发现集群中的成员。Envoy 可以通过主动运行状况检查来确定集群成员的健康状况。Envoy 如何将请求路由到集群成员由负载均衡策略确定。</p>
<p><strong>Mesh</strong>：一组互相协调以提供一致网络拓扑的主机。Envoy mesh 是指一组 Envoy 代理，它们构成了由多种不同服务和应用程序平台组成的分布式系统的消息传递基础。</p>
<p><strong>运行时配置</strong>：与 Envoy 一起部署的带外实时配置系统。可以在无需重启 Envoy 或 更改 Envoy 主配置的情况下，通过更改设置来影响操作。</p>
<p><strong>Listener</strong>: 侦听器（listener）是可以由下游客户端连接的命名网络位置（例如，端口、unix域套接字等）。Envoy 公开一个或多个下游主机连接的侦听器。一般是每台主机运行一个 Envoy，使用单进程运行，但是每个进程中可以启动任意数量的 Listener（监听器），目前只监听 TCP，每个监听器都独立配置一定数量的（L3/L4）网络过滤器。Listenter 也可以通过 Listener Discovery Service（<strong>LDS</strong>）动态获取。</p>
<p><strong>Listener filter</strong>：Listener 使用 listener filter（监听器过滤器）来操作链接的元数据。它的作用是在不更改 Envoy 的核心功能的情况下添加更多的集成功能。Listener filter 的 API 相对简单，因为这些过滤器最终是在新接受的套接字上运行。在链中可以互相衔接以支持更复杂的场景，例如调用速率限制。Envoy 已经包含了多个监听器过滤器。</p>
<p><strong>Http Route Table</strong>：HTTP 的路由规则，例如请求的域名，Path 符合什么规则，转发给哪个 Cluster。</p>
<p><strong>Health checking</strong>：健康检查会与SDS服务发现配合使用。但是，即使使用其他服务发现方式，也有相应需要进行主动健康检查的情况。</p>
<h2 id="xDS"><a href="#xDS" class="headerlink" title="xDS"></a>xDS</h2><p>xDS 是一个关键概念，它是一类发现服务的统称，其包括如下几类：</p>
<ul>
<li>CDS：Cluster Discovery Service</li>
<li>EDS：Endpoint Discovery Service</li>
<li>SDS：Service Discovery Service</li>
<li>RDS：Route Discovery Service</li>
<li>LDS：Listener Discovery Service</li>
</ul>
<p>正是通过对 xDS 的请求来动态更新 Envoy 配置。</p>
<h2 id="Envoy-Mesh"><a href="#Envoy-Mesh" class="headerlink" title="Envoy Mesh"></a>Envoy Mesh</h2><p>Envoy Mesh 指的是由 envoy 做负载均衡和代理的 mesh。该 Mesh 中会包含两类 envoy：</p>
<ul>
<li>Edge envoy：即流量进出 mesh 时候的 envoy，相当于 kubernetes 中的 ingress。</li>
<li>Service envoy：服务 envoy 是跟每个 serivce 实例一起运行的，应用程序无感知的进程外工具，在 kubernetes 中会与应用容器以 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://jimmysong.io/kubernetes-handbook/GLOSSARY.html#sidecar">sidecar</a> 形式运行在同一个 pod 中。</li>
</ul>
<p>Envoy 即可以单独作为 edge envoy，也可以仅做 service envoy 使用，也可以两者同时使用。Mesh 中的所有 envoy 会共享路由信息。</p>
<h2 id="Envoy-配置"><a href="#Envoy-配置" class="headerlink" title="Envoy 配置"></a>Envoy 配置</h2><p>Envoy 中的配置包括两大类：listenner 配置和 cluster 配置。</p>
<h3 id="Listener-配置"><a href="#Listener-配置" class="headerlink" title="Listener 配置"></a>Listener 配置</h3><p>我们知道 Envoy 中可以配置一组 listener 以实现复杂的处理逻辑。Listener 中设置监听的 TCP 端口，还有一组 filter 对这些端口上的数据流进行处理。如下所示，该示例来自<a target="_blank" rel="noopener external nofollow noreferrer" href="https://jimmysong.io/kubernetes-handbook/usecases/envoy-front-proxy.html">使用Envoy 作为前端代理</a>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">listeners:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">address:</span></span><br><span class="line">    <span class="attr">socket_address:</span></span><br><span class="line">      <span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">      <span class="attr">port_value:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">filter_chains:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.http_connection_manager</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">codec_type:</span> <span class="string">auto</span></span><br><span class="line">        <span class="attr">stat_prefix:</span> <span class="string">ingress_http</span></span><br><span class="line">        <span class="attr">route_config:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">local_route</span></span><br><span class="line">          <span class="attr">virtual_hosts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">            <span class="attr">domains:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">            <span class="attr">routes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">                <span class="attr">prefix:</span> <span class="string">&quot;/service/1&quot;</span></span><br><span class="line">              <span class="attr">route:</span></span><br><span class="line">                <span class="attr">cluster:</span> <span class="string">service1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">                <span class="attr">prefix:</span> <span class="string">&quot;/service/2&quot;</span></span><br><span class="line">              <span class="attr">route:</span></span><br><span class="line">                <span class="attr">cluster:</span> <span class="string">service2</span></span><br></pre></td></tr></table></figure>

<p>这是一个 <code>http_connection_manager</code> 例子，其中必须包含 <code>virtual_hosts</code> 配置，而 <code>virtual_hosts</code> 配置中必须包含以下几项配置：</p>
<ul>
<li><code>name</code>：服务名称</li>
<li><code>domains</code>：DNS 域名，必须能跟 <code>virtual_host</code> 的 URL 匹配</li>
<li><code>routes</code>：路由列表</li>
</ul>
<p>每个路由中还可以包含以下配置：</p>
<ul>
<li><code>prefix</code>：URL 路径前缀</li>
<li><code>cluster</code>：处理该请求的 envoy cluster</li>
<li><code>timeout_ms</code>：当出错时的超时时间</li>
</ul>
<p>如上面的例子中，我们还需要定义 <code>service1</code> cluster 和 <code>service2</code> cluster。</p>
<h3 id="Cluster-配置"><a href="#Cluster-配置" class="headerlink" title="Cluster 配置"></a>Cluster 配置</h3><p>Cluster 是一组逻辑相似的主机配置，定义哪些主机属于一个服务，cluster 的配置中包含了服务发现和负载均衡方式配置。依然是参考<a target="_blank" rel="noopener external nofollow noreferrer" href="https://jimmysong.io/kubernetes-handbook/usecases/envoy-front-proxy.html">使用Envoy 作为前端代理</a>中的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">clusters:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service1</span></span><br><span class="line">   <span class="attr">connect_timeout:</span> <span class="number">0.</span><span class="string">25s</span></span><br><span class="line">   <span class="attr">type:</span> <span class="string">strict_dns</span></span><br><span class="line">   <span class="attr">lb_policy:</span> <span class="string">round_robin</span></span><br><span class="line">   <span class="attr">http2_protocol_options:</span> &#123;&#125;</span><br><span class="line">   <span class="attr">hosts:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">socket_address:</span></span><br><span class="line">       <span class="attr">address:</span> <span class="string">service1</span></span><br><span class="line">       <span class="attr">port_value:</span> <span class="number">80</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service2</span></span><br><span class="line">   <span class="attr">connect_timeout:</span> <span class="number">0.</span><span class="string">25s</span></span><br><span class="line">   <span class="attr">type:</span> <span class="string">strict_dns</span></span><br><span class="line">   <span class="attr">lb_policy:</span> <span class="string">round_robin</span></span><br><span class="line">   <span class="attr">http2_protocol_options:</span> &#123;&#125;</span><br><span class="line">   <span class="attr">hosts:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">socket_address:</span></span><br><span class="line">       <span class="attr">address:</span> <span class="string">service2</span></span><br><span class="line">       <span class="attr">port_value:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>Cluster 的配置中至少包含以下信息：</p>
<ul>
<li><p><code>name</code>：cluster 名称，就是服务名称</p>
</li>
<li><pre><code>type
&lt;!--hexoPostRenderEscape:&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ：该 cluster 怎么知道主机是否启动？即服务发现类型，有以下方式：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - &amp;#96;static&amp;#96;：监听 cluster 中的所有主机&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - &amp;#96;strict_dns&amp;#96;：envoy 会监听 DNS，每个匹配的 A 记录都会认定为有效&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - &amp;#96;logical_dns&amp;#96;：envoy 将使用 DNS 来增加主机，如果 DNS 不再返回该主机也不会删除这些主机信息&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - &amp;#96;sds&amp;#96;：即 Serivce Discovery Serivce，envoy 访问外部的 REST 获取 cluster 成员信息&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- &amp;#96;&amp;#96;&amp;#96;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  lb_type&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;:hexoPostRenderEscape--&gt;

：cluster 的负载均衡类型，有以下方式：

- `round_robin`：轮询主机
- `weighted_least_request`：最近获得最少请求的主机
- `random`：随机</code></pre>
</li>
<li><p><code>hosts</code>：能够定义 cluster 中主机的 URL 地址，通常是<code>tcp://</code> URL</p>
</li>
</ul>
<h2 id="Envoy-Data-Path"><a href="#Envoy-Data-Path" class="headerlink" title="Envoy Data Path"></a>Envoy Data Path</h2><p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20221204164837931.png" alt="image-20221204164837931"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20221204165631753.png" alt="image-20221204165631753"></p>
<h2 id="Envoy几个显著特性"><a href="#Envoy几个显著特性" class="headerlink" title="Envoy几个显著特性"></a>Envoy几个显著特性</h2><ul>
<li><p>性能、可扩展性及动态可配置性</p>
<ul>
<li><p>性能：除了大量功能外，Envoy还提供极高的吞吐量和低尾延迟差异，同时消耗相对较少的CPU和RAM； </p>
</li>
<li><p>可扩展性：Envoy在L4和L7上提供丰富的可插拔过滤器功能，允许用户轻松添加新功能；</p>
</li>
<li><p>API可配置性：Envoy提供了一组可由控制平面服务实现的管理API，也称为xDS API</p>
<ul>
<li><p>若控制平面实现了这所有的API，则可以使用通用引导配置在整个基础架构中运行Envoy</p>
</li>
<li><p>所有进一步的配置更改都可通过管理服务器无缝地进行动态传递，使得Envoy永远不需要重新启动</p>
</li>
<li><p>于是，这使得Envoy成为一个通用数据平面，当与足够复杂的控制平面相结合时，可大大降低整体操作复杂性</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Envoy xDS API存在v1、v2和v3三个版本</p>
<ul>
<li><p>v1 API 仅使用 JSON/REST，本质上是轮询</p>
</li>
<li><p>v2 API 是 v1 的演进，而不是革命，它是 v1 功能的超集，新的API模式使用 proto3 指定，并同时以gRPC 和 REST + JSON/YAML 端点实现</p>
<ul>
<li>2021年第1季度结束支持</li>
</ul>
</li>
<li><p>v3 API：当前支持的版本，支持start_tls、拒绝传入的tcp连接、4096位的tls密钥、SkyWalking和WASM等 </p>
</li>
</ul>
</li>
<li><p>Envoy业已成为现代服务网格和边缘网关的“ 通用数据平面API ”，Istio、Ambassador和Gloo等项目均是为此数据平面代理提供的控制平面；</p>
</li>
</ul>
<h2 id="Envoy-部署类型1-前端代理Front-Proxy"><a href="#Envoy-部署类型1-前端代理Front-Proxy" class="headerlink" title="Envoy 部署类型1(前端代理Front-Proxy)"></a>Envoy 部署类型1(前端代理Front-Proxy)</h2><p>本文是使用 Envoy 作为前端代理的介绍，仅使用 docker 容器和 docker-compose 做编排在单机中运行，帮助我们从更底层了解 Envoy，当我们将 Envoy 作为 Istio Service Mesh 的 data panel 的时候将更加游刃有余。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20221204165750048.png" alt="image-20221204165750048"></p>
<h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><p>Envoy 中的所有规则配置跟 Kubernetes 一样都是通过 YAML 文件来完成的。在继续下面的步骤之前，首先克隆 Envoy 的 GitHub repo。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/envoyproxy/envoy.git</span><br></pre></td></tr></table></figure>

<h3 id="运行-sandbox-测试"><a href="#运行-sandbox-测试" class="headerlink" title="运行 sandbox 测试"></a>运行 sandbox 测试</h3><p>Envoy 官方提供了以下打包用例：</p>
<ul>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/front_proxy">Front Proxy</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/zipkin_tracing">Zipkin Tracing</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/jaeger_tracing">Jaeger Tracing</a></li>
<li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/grpc_bridge">gRPC Bridge</a></li>
</ul>
<p>全部可以使用 <code>docker-compose</code> 运行，代码可以在 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/envoyproxy/envoy/tree/master/examples">GitHub</a> 找到。</p>
<h3 id="Front-proxy"><a href="#Front-proxy" class="headerlink" title="Front proxy"></a>Front proxy</h3><p>Envoy 在 Envoy mesh 的边缘做反向代理，详细使用方式见 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/front_proxy">Envoy 文档</a>，在此我将解说下以下问题：</p>
<ul>
<li>Envoy 是如何作为进程外架构运行的？</li>
<li>为何说 Envoy 是无侵入式架构？</li>
<li>Envoy 作为边缘反向代理能做什么？</li>
</ul>
<p>本示例的架构图如下所示，此时 Envoy 将作为一个反向代理，类似于 Nginx，但与 Nginx 不同的是它还会作为一个进程，伴随每个服务一起运行在同一个容器中（在 Kubernetes 中可以作为 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://jimmysong.io/kubernetes-handbook/GLOSSARY.html#sidecar">Sidecar</a> 与应用容器一起运行在同一个 Pod 中）。</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://jimmysong.io/kubernetes-handbook/images/envoyproxy-docker-compose.png"><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/envoyproxy-docker-compose.png" alt="Front proxy 部署结构图（转自https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/front_proxy）"></a>图 7.4.2.1：Front proxy 部署结构图（转自<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/front_proxy%EF%BC%89">https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/front_proxy）</a></p>
<p>在此示例中一共有 3 个服务，我们需要为其创建容器编排的 <code>docker-compose.yml</code> 文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">front-envoy:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-frontenvoy</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./front-envoy.yaml:/etc/front-envoy.yaml</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">envoymesh</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8001&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8001:8001&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">service1:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-service</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./service-envoy.yaml:/etc/service-envoy.yaml</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">envoymesh:</span></span><br><span class="line">        <span class="attr">aliases:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">service1</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVICE_NAME=1</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">service2:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-service</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./service-envoy.yaml:/etc/service-envoy.yaml</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">envoymesh:</span></span><br><span class="line">        <span class="attr">aliases:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">service2</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVICE_NAME=2</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">envoymesh:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>使用 docker-compose 启动可以保证三个服务都在同一个网络内，即 <code>frontproxy_envoymesh</code> 网络中。</p>
<p>其中 <code>front-envoy</code> 是前端（边缘）Envoy 服务，用来做反向代理，它使用的是 <code>Dockerfile-frontenvoy</code> 文件来构建镜像的，我们来看下该 <code>Dockerfile</code> 的内容。</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> envoyproxy/envoy:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get -q install -y \</span></span><br><span class="line"><span class="bash">    curl</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /usr/<span class="built_in">local</span>/bin/envoy -c /etc/front-envoy.yaml --service-cluster front-proxy</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>/etc/front-envoy.yaml</code> 是本地的 <code>front-envoy.yaml</code> 挂载进去的。我们看下该文件的内容。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">static_resources:</span></span><br><span class="line">  <span class="attr">listeners:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span></span><br><span class="line">      <span class="attr">socket_address:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">        <span class="attr">port_value:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">filter_chains:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">filters:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.http_connection_manager</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">codec_type:</span> <span class="string">auto</span></span><br><span class="line">          <span class="attr">stat_prefix:</span> <span class="string">ingress_http</span></span><br><span class="line">          <span class="attr">route_config:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">local_route</span></span><br><span class="line">            <span class="attr">virtual_hosts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backend</span></span><br><span class="line">              <span class="attr">domains:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">              <span class="attr">routes:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">                  <span class="attr">prefix:</span> <span class="string">&quot;/service/1&quot;</span></span><br><span class="line">                <span class="attr">route:</span></span><br><span class="line">                  <span class="attr">cluster:</span> <span class="string">service1</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">                  <span class="attr">prefix:</span> <span class="string">&quot;/service/2&quot;</span></span><br><span class="line">                <span class="attr">route:</span></span><br><span class="line">                  <span class="attr">cluster:</span> <span class="string">service2</span></span><br><span class="line">          <span class="attr">http_filters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envoy.router</span></span><br><span class="line">            <span class="attr">config:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">clusters:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service1</span></span><br><span class="line">    <span class="attr">connect_timeout:</span> <span class="number">0.</span><span class="string">25s</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">strict_dns</span></span><br><span class="line">    <span class="attr">lb_policy:</span> <span class="string">round_robin</span></span><br><span class="line">    <span class="attr">http2_protocol_options:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">socket_address:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="string">service1</span></span><br><span class="line">        <span class="attr">port_value:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service2</span></span><br><span class="line">    <span class="attr">connect_timeout:</span> <span class="number">0.</span><span class="string">25s</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">strict_dns</span></span><br><span class="line">    <span class="attr">lb_policy:</span> <span class="string">round_robin</span></span><br><span class="line">    <span class="attr">http2_protocol_options:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">socket_address:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="string">service2</span></span><br><span class="line">        <span class="attr">port_value:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">admin:</span></span><br><span class="line">  <span class="attr">access_log_path:</span> <span class="string">&quot;/dev/null&quot;</span></span><br><span class="line">  <span class="attr">address:</span></span><br><span class="line">    <span class="attr">socket_address:</span></span><br><span class="line">      <span class="attr">address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">      <span class="attr">port_value:</span> <span class="number">8001</span></span><br></pre></td></tr></table></figure>

<p>我们看到其中包括了三大配置项：</p>
<ul>
<li><strong>static_resources</strong>：路由配置信息</li>
<li><strong>cluster</strong>：envoymesh 的服务注册信息</li>
<li><strong>admin</strong>：管理接口，可以通过访问 8001 端口的，访问 <code>/stats</code> 获取当前 envoymesh 的一些统计信息，访问 <code>/server_info</code> 获取 Envoy 的版本信息</li>
</ul>
<p>使用 <code>docker-compose</code> 启动三个容器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">envoy/examples/front-proxy</span><br><span class="line">$ docker-compose up --build -d</span><br><span class="line">$ docker-compose ps</span><br><span class="line">        Name                       Command               State      Ports</span><br><span class="line">-------------------------------------------------------------------------------------------------------------</span><br><span class="line">example_service1_1      /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ... Up       80/tcp</span><br><span class="line">example_service2_1      /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ... Up       80/tcp</span><br><span class="line">example_front-envoy_1   /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ... Up       0.0.0.0:8000-&gt;80/tcp, 0.0.0.0:8001-&gt;8001/tcp</span><br></pre></td></tr></table></figure>

<p>我们下面将过一遍 Envoy 作为前端代理的所有功能，这些功能是通用功能。</p>
<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p>访问 service1 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8000/service/1">http://localhost:8000/service/1</a> 将看到如下输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v localhost:8000/service/1</span><br><span class="line">*</span><br><span class="line">Trying ::1...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to localhost (::1) port 8000 (<span class="comment">#0)</span></span><br><span class="line">&gt; GET /service/1 HTTP/1.1</span><br><span class="line">&gt; Host: localhost:8000</span><br><span class="line">&gt; User-Agent: curl/7.54.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; content-type: text/html; charset=utf-8</span><br><span class="line">&lt; content-length: 89</span><br><span class="line">&lt; server: envoy</span><br><span class="line">&lt; date: Fri, 20 Apr 2018 08:26:33 GMT</span><br><span class="line">&lt; x-envoy-upstream-service-time: 14</span><br><span class="line">&lt;</span><br><span class="line">Hello from behind Envoy (service 1)! hostname: a3e4185a9a49 resolvedhostname: 172.18.0.4</span><br><span class="line">* Connection <span class="comment">#0 to host localhost left intact</span></span><br></pre></td></tr></table></figure>

<p>访问 service2 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8000/service/2">http://localhost:8000/service/2</a> 将看到如下输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">*   Trying ::1...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to localhost (::1) port 8000 (<span class="comment">#0)</span></span><br><span class="line">&gt; GET /service/2 HTTP/1.1</span><br><span class="line">&gt; Host: localhost:8000</span><br><span class="line">&gt; User-Agent: curl/7.54.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; content-type: text/html; charset=utf-8</span><br><span class="line">&lt; content-length: 89</span><br><span class="line">&lt; server: envoy</span><br><span class="line">&lt; date: Fri, 20 Apr 2018 08:27:27 GMT</span><br><span class="line">&lt; x-envoy-upstream-service-time: 10</span><br><span class="line">&lt;</span><br><span class="line">Hello from behind Envoy (service 2)! hostname: f6650e1911a0 resolvedhostname: 172.18.0.3</span><br><span class="line">* Connection <span class="comment">#0 to host localhost left intact</span></span><br></pre></td></tr></table></figure>

<p>我们看到访问请求被路由到了正确的服务后端。</p>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><p>增加 service1 的示例数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose scale service1=3</span><br><span class="line">WARNING: The scale <span class="built_in">command</span> is deprecated. Use the up <span class="built_in">command</span> with the --scale flag instead.</span><br><span class="line">Starting frontproxy_service1_1 ... <span class="keyword">done</span></span><br><span class="line">Creating frontproxy_service1_2 ... <span class="keyword">done</span></span><br><span class="line">Creating frontproxy_service1_3 ... <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ docker-compose ps</span><br><span class="line">          Name                        Command               State                            Ports</span><br><span class="line">---------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">frontproxy_front-envoy_1   /usr/bin/dumb-init -- /bin ...   Up      10000/tcp, 0.0.0.0:8000-&gt;80/tcp, 0.0.0.0:8001-&gt;8001/tcp</span><br><span class="line">frontproxy_service1_1      /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ...   Up      10000/tcp, 80/tcp</span><br><span class="line">frontproxy_service1_2      /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ...   Up      10000/tcp, 80/tcp</span><br><span class="line">frontproxy_service1_3      /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ...   Up      10000/tcp, 80/tcp</span><br><span class="line">frontproxy_service2_1      /bin/sh -c /usr/<span class="built_in">local</span>/bin/ ...   Up      10000/tcp, 80/tcp</span><br></pre></td></tr></table></figure>

<p>我们看到现在 service1 已经有了 3 个实例，现在再访问 service1 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8000/service/1%E3%80%82">http://localhost:8000/service/1。</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span> curl localhost:8000/service/1;sleep 1;<span class="keyword">done</span></span><br><span class="line">Hello from behind Envoy (service 1)! hostname: a3e4185a9a49 resolvedhostname: 172.18.0.4</span><br><span class="line">Hello from behind Envoy (service 1)! hostname: fe44dba64122 resolvedhostname: 172.18.0.5</span><br><span class="line">Hello from behind Envoy (service 1)! hostname: c5b9f1289e0f resolvedhostname: 172.18.0.6</span><br><span class="line">Hello from behind Envoy (service 1)! hostname: a3e4185a9a49 resolvedhostname: 172.18.0.4</span><br><span class="line">Hello from behind Envoy (service 1)! hostname: fe44dba64122 resolvedhostname: 172.18.0.5</span><br><span class="line">Hello from behind Envoy (service 1)! hostname: c5b9f1289e0f resolvedhostname: 172.18.0.6</span><br></pre></td></tr></table></figure>

<p>我们看到对 service1 的已经有负载均衡了，使用的策略是 <code>round_robin</code>，这些都是在 <code>front-envoy.yaml</code> 文件中的 <code>cluster</code> 项下配置的。</p>
<h4 id="admin-端点"><a href="#admin-端点" class="headerlink" title="admin 端点"></a>admin 端点</h4><p>访问 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:8001/">http://localhost:8001</a> 可以看到 Envoy admin 提供以下管理 API 端点。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>/</td>
<td>Admin 主页</td>
</tr>
<tr>
<td>/certs</td>
<td>打印机器上的 certs</td>
</tr>
<tr>
<td>/clusters</td>
<td>upstream cluster 状态</td>
</tr>
<tr>
<td>/config_dump</td>
<td>输出当前的 Envoy 配置</td>
</tr>
<tr>
<td>/cpuprofiler</td>
<td>开启/关闭 CPU profiler</td>
</tr>
<tr>
<td>/healthcheck/fail</td>
<td>导致服务失败健康检查</td>
</tr>
<tr>
<td>/healthcheck/ok</td>
<td>导致服务通过健康检查</td>
</tr>
<tr>
<td>/help</td>
<td>打印管理命令的帮助信息</td>
</tr>
<tr>
<td>/hot_restart_version</td>
<td>打印热重启兼容版本</td>
</tr>
<tr>
<td>/listeners</td>
<td>打印 listener 地址</td>
</tr>
<tr>
<td>/logging</td>
<td>查询/更改日志级别</td>
</tr>
<tr>
<td>/quitquitquit</td>
<td>退出服务</td>
</tr>
<tr>
<td>/reset_counters</td>
<td>将计数器重置为 1</td>
</tr>
<tr>
<td>/runtime</td>
<td>打印运行时值</td>
</tr>
<tr>
<td>/runtime_modify</td>
<td>修改运行时值</td>
</tr>
<tr>
<td>/server_info</td>
<td>打印服务器版本/状态信息</td>
</tr>
<tr>
<td>/stats</td>
<td>打印服务器状态统计信息</td>
</tr>
<tr>
<td>/stats/prometheus</td>
<td>打印 prometheus 格式的服务器状态统计信息</td>
</tr>
</tbody></table>
<p>Envoy 提供了 API 管理端点，可以对 Envoy 进行动态配置。</p>
<h2 id="Envoy-部署类型2-SideCar-Proxy"><a href="#Envoy-部署类型2-SideCar-Proxy" class="headerlink" title="Envoy 部署类型2(SideCar-Proxy)"></a>Envoy 部署类型2(SideCar-Proxy)</h2><blockquote>
<p>Envoy通常用于以容器编排系统为底层环境的服务网格中，并以sidecar的形式与主程序容器运行为单个Pod；非编排系统环境中测试时，可以将主程序与Envoy运行于同一容器，或手动组织主程序容器与Envoy容器共享同一网络名称空间；</p>
</blockquote>
<ul>
<li><p><strong>Service to service only</strong></p>
<ul>
<li><p>Service to service egress listener</p>
<ul>
<li>The port used by applications to talk to other services in the infrastructure</li>
</ul>
</li>
<li><p>Service to service ingress listener</p>
<ul>
<li>The port used by remote Envoys when they want to talk to the local Envoy</li>
</ul>
</li>
<li><p>Optional external service egress listeners</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20221204171125357.png" alt="image-20221204171125357"></p>
<ul>
<li><p><strong>Service to service egress listener</strong></p>
<ul>
<li><p>This is the port used by applications to talk to other services in the infrastructure.</p>
</li>
<li><p>HTTP and gRPC requests use the HTTP/1.1 host header or the HTTP/2 :authority header to indicate which remote cluster the request is destined for. </p>
</li>
<li><p>Envoy handles <strong>service discovery</strong>, <strong>load balancing</strong>, <strong>rate limiting</strong>, etc. depending on the details in the configuration. </p>
</li>
<li><p>Services only need to know about the local Envoy and do not need to concern themselves with network topology, whether they are running in development or production, etc.</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20221204172037623.png" alt="image-20221204172037623"></p>
<ul>
<li><p><strong>Service to service ingress listener</strong></p>
<ul>
<li><p>This is the port used by remote Envoys when they want to talk to the local Envoy. </p>
<ul>
<li><p>Incoming requests are routed to the local service on the configured port(s). </p>
</li>
<li><p>Multiple application ports may be involved depending on application or load balancing needs (for example if the service needs both an HTTP port and a gRPC port). </p>
</li>
</ul>
</li>
<li><p>The local Envoy performs <strong>buffering</strong>, <strong>circuit breaking</strong>, etc. as needed.</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/image-20221204172700154.png" alt="image-20221204172700154"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Waylon Yan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://waylon.whatyouneed.site/2022/11/23/Service-Mesh02/">https://waylon.whatyouneed.site/2022/11/23/Service-Mesh02/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/note/">note</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/11/28/Kubernetes23-helm%E5%9F%BA%E7%A1%80/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Kubernetes23-helm基础</div></div></a></div><div class="next-post pull-right"><a href="/2022/11/06/Service-Mesh01/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Service-Mesh01</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/01/01/MySQL-SQL%E5%AE%A1%E6%A0%B8%E5%B7%A5%E5%85%B7inception/" title="MySQL-SQL审核工具inception"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-01</div><div class="title">MySQL-SQL审核工具inception</div></div></a></div><div><a href="/2022/05/01/Promethues03/" title="Promethues03"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-01</div><div class="title">Promethues03</div></div></a></div><div><a href="/2022/04/29/Promethues01/" title="Promethues01"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-29</div><div class="title">Promethues01</div></div></a></div><div><a href="/2022/04/30/Promethues02/" title="Promethues02"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-30</div><div class="title">Promethues02</div></div></a></div><div><a href="/2022/11/06/Service-Mesh01/" title="Service-Mesh01"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-06</div><div class="title">Service-Mesh01</div></div></a></div><div><a href="/2022/04/02/Terraform%E7%AE%80%E4%BB%8B/" title="Terraform简介"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-02</div><div class="title">Terraform简介</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Waylon Yan</div><div class="author-info__description">tech life sharing</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">251</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">38</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">24</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Waylonwhynot" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:ywl1006@outlook.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">无止境</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#What-is-Envoy"><span class="toc-number">1.</span> <span class="toc-text">What is Envoy?</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">1.1.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%8E%E4%BB%A3%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">负载均衡与代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9C%AF%E8%AF%AD"><span class="toc-number">1.4.</span> <span class="toc-text">基本术语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xDS"><span class="toc-number">1.5.</span> <span class="toc-text">xDS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Envoy-Mesh"><span class="toc-number">1.6.</span> <span class="toc-text">Envoy Mesh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Envoy-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.</span> <span class="toc-text">Envoy 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listener-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.1.</span> <span class="toc-text">Listener 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cluster-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.2.</span> <span class="toc-text">Cluster 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Envoy-Data-Path"><span class="toc-number">1.8.</span> <span class="toc-text">Envoy Data Path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Envoy%E5%87%A0%E4%B8%AA%E6%98%BE%E8%91%97%E7%89%B9%E6%80%A7"><span class="toc-number">1.9.</span> <span class="toc-text">Envoy几个显著特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Envoy-%E9%83%A8%E7%BD%B2%E7%B1%BB%E5%9E%8B1-%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%90%86Front-Proxy"><span class="toc-number">1.10.</span> <span class="toc-text">Envoy 部署类型1(前端代理Front-Proxy)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-number">1.10.1.</span> <span class="toc-text">快速开始</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-sandbox-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.10.2.</span> <span class="toc-text">运行 sandbox 测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Front-proxy"><span class="toc-number">1.10.3.</span> <span class="toc-text">Front proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">1.10.3.1.</span> <span class="toc-text">路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.10.3.2.</span> <span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#admin-%E7%AB%AF%E7%82%B9"><span class="toc-number">1.10.3.3.</span> <span class="toc-text">admin 端点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Envoy-%E9%83%A8%E7%BD%B2%E7%B1%BB%E5%9E%8B2-SideCar-Proxy"><span class="toc-number">1.11.</span> <span class="toc-text">Envoy 部署类型2(SideCar-Proxy)</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/01/28/mongoengine-01/" title="mongoengine-01"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mongoengine-01"/></a><div class="content"><a class="title" href="/2023/01/28/mongoengine-01/" title="mongoengine-01">mongoengine-01</a><time datetime="2023-01-27T18:16:07.000Z" title="Created 2023-01-28 02:16:07">2023-01-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/17/%E5%89%8D%E7%AB%AF-cookie-session-%E5%85%B6%E4%BB%96%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F/" title="前端-cookie-session-其他存储方式"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="前端-cookie-session-其他存储方式"/></a><div class="content"><a class="title" href="/2022/12/17/%E5%89%8D%E7%AB%AF-cookie-session-%E5%85%B6%E4%BB%96%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F/" title="前端-cookie-session-其他存储方式">前端-cookie-session-其他存储方式</a><time datetime="2022-12-17T13:58:36.000Z" title="Created 2022-12-17 21:58:36">2022-12-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/30/Linux-%E4%B8%89%E5%89%91%E5%AE%A2grep-sed-awk/" title="Linux-三剑客grep-sed-awk"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux-三剑客grep-sed-awk"/></a><div class="content"><a class="title" href="/2022/11/30/Linux-%E4%B8%89%E5%89%91%E5%AE%A2grep-sed-awk/" title="Linux-三剑客grep-sed-awk">Linux-三剑客grep-sed-awk</a><time datetime="2022-11-29T17:30:06.000Z" title="Created 2022-11-30 01:30:06">2022-11-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/28/Kubernetes23-helm%E5%9F%BA%E7%A1%80/" title="Kubernetes23-helm基础"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes23-helm基础"/></a><div class="content"><a class="title" href="/2022/11/28/Kubernetes23-helm%E5%9F%BA%E7%A1%80/" title="Kubernetes23-helm基础">Kubernetes23-helm基础</a><time datetime="2022-11-27T17:14:15.000Z" title="Created 2022-11-28 01:14:15">2022-11-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/23/Service-Mesh02/" title="Service-Mesh02"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Service-Mesh02"/></a><div class="content"><a class="title" href="/2022/11/23/Service-Mesh02/" title="Service-Mesh02">Service-Mesh02</a><time datetime="2022-11-23T15:55:24.000Z" title="Created 2022-11-23 23:55:24">2022-11-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Waylon Yan</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>