<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Linux-Puppet-02 | YouNeed</title><meta name="keywords" content="automation"><meta name="author" content="Waylon Yan"><meta name="copyright" content="Waylon Yan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="类、模版语言、模块 一、class 类1）什么是类？　　类是puppet中命名的代码模块，常用于定义一组通用目标的资源，可在puppet全局调用；　　类可以被继承，也可以包含子类；　　具体定义的语法如下： 123class NAME&amp;#123;    ... puppet code ...&amp;#125;  　　其中，在我们定义的时候，需要注意的是：  类的名称只能以小写字母开头，可以包含小字字母、数">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux-Puppet-02">
<meta property="og:url" content="https://waylon.whatyouneed.site/2022/08/26/Linux-Puppet-02/index.html">
<meta property="og:site_name" content="YouNeed">
<meta property="og:description" content="类、模版语言、模块 一、class 类1）什么是类？　　类是puppet中命名的代码模块，常用于定义一组通用目标的资源，可在puppet全局调用；　　类可以被继承，也可以包含子类；　　具体定义的语法如下： 123class NAME&amp;#123;    ... puppet code ...&amp;#125;  　　其中，在我们定义的时候，需要注意的是：  类的名称只能以小写字母开头，可以包含小字字母、数">
<meta property="og:locale">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png">
<meta property="article:published_time" content="2022-08-25T16:00:37.000Z">
<meta property="article:modified_time" content="2022-08-27T15:40:11.343Z">
<meta property="article:author" content="Waylon Yan">
<meta property="article:tag" content="automation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://waylon.whatyouneed.site/2022/08/26/Linux-Puppet-02/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux-Puppet-02',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-27 23:40:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">249</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">37</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">23</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">YouNeed</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Linux-Puppet-02</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-08-25T16:00:37.000Z" title="Created 2022-08-26 00:00:37">2022-08-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-08-27T15:40:11.343Z" title="Updated 2022-08-27 23:40:11">2022-08-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Linux-Puppet-02"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="类、模版语言、模块"><a href="#类、模版语言、模块" class="headerlink" title="类、模版语言、模块"></a>类、模版语言、模块</h1><hr>
<h2 id="一、class-类"><a href="#一、class-类" class="headerlink" title="一、class 类"></a>一、class 类</h2><h3 id="1）什么是类？"><a href="#1）什么是类？" class="headerlink" title="1）什么是类？"></a>1）什么是类？</h3><p>　　类是puppet中命名的代码模块，常用于定义一组通用目标的资源，可在puppet全局调用；<br>　　类可以被继承，也可以包含子类；<br>　　具体定义的语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class NAME&#123;</span><br><span class="line">    ... puppet code ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　其中，在我们定义的时候，需要注意的是：</p>
<ul>
<li>类的名称只能以小写字母开头，可以包含小字字母、数字和下划线。</li>
<li>每个类都会引入一个新的变量scope ，这意味着在任何时候访问类中的变量时，都得使用其完全限定名称。<ul>
<li>不过，在本地 scope 可以重新为 top scope 中的变量赋予一个新值。</li>
</ul>
</li>
</ul>
<p>　　下面，我们来看一个简单的例子：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim class1.pp</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">redis</span> &#123;        <span class="comment">#定义一个类</span></span></span><br><span class="line">        package&#123;<span class="string">&#x27;redis&#x27;</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">ensure</span>  =&gt; installed,</span><br><span class="line">        &#125;   -&gt;</span><br><span class="line"></span><br><span class="line">        file&#123;<span class="string">&#x27;/etc/redis.conf&#x27;</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">ensure</span>  =&gt; file,</span><br><span class="line">            source  =&gt; <span class="string">&#x27;/root/manifests/file/redis.conf&#x27;</span>,</span><br><span class="line">            owner   =&gt; <span class="string">&#x27;redis&#x27;</span>,</span><br><span class="line">            group   =&gt; <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">            mode    =&gt; <span class="string">&#x27;0640&#x27;</span>,</span><br><span class="line">            tag     =&gt; <span class="string">&#x27;redisconf&#x27;</span></span><br><span class="line">        &#125;   ~&gt;</span><br><span class="line"></span><br><span class="line">        service&#123;<span class="string">&#x27;redis&#x27;</span><span class="symbol">:</span></span><br><span class="line">            <span class="keyword">ensure</span>  =&gt; running,</span><br><span class="line">            enable  =&gt; <span class="literal">true</span>,</span><br><span class="line">            hasrestart  =&gt; <span class="literal">true</span>,</span><br><span class="line">            hasstatus   =&gt; <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span> redis    <span class="comment">#调用类</span></span><br></pre></td></tr></table></figure>

<p>　　注意：类只有被调用才会执行。include后可以跟多个类，直接用”,”隔开即可。</p>
<h3 id="2）带有参数的类"><a href="#2）带有参数的类" class="headerlink" title="2）带有参数的类"></a>2）带有参数的类</h3><p>　　我们定义的类也可以进行参数设置，可以进行参数的传递。<br>　　具体语法如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class NAME(parameter1, parameter2) &#123;    #注意，大括号前有一个空格</span><br><span class="line">    ...puppet code...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　我们来看一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim class2.pp</span><br><span class="line">    class instpkg($pkg) &#123;</span><br><span class="line">        package&#123;&quot;$pkg&quot;:</span><br><span class="line">            ensure  &#x3D;&gt; installed,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class&#123;&quot;instpkg&quot;:            #给参数传入值</span><br><span class="line">        pkg     &#x3D;&gt; &#39;memcached&#39;,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>　　注意：<strong>单个主机上</strong>不能被<strong>直接</strong>声明<strong>两次</strong>。<br>　　如果对应的参数未传值的话，执行会报错。<br>　　但是我们可以在定义形参的时候，设定一个默认值，这样的话，我们不传入值的话，就会自动调用默认值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim class3.pp</span><br><span class="line">    class instpkg($pkg&#x3D;&#39;wget&#39;) &#123;</span><br><span class="line">        package&#123;&quot;$pkg&quot;:</span><br><span class="line">            ensure  &#x3D;&gt; installed,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    include instpkg</span><br></pre></td></tr></table></figure>

<p>　　这样的话，我们直接使用<code>include</code>调用即可，就不需要给参数传入值了。<br>　　由上，我们可以总结出，调用类的方式有<strong>两种</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. include CLASS_NAME1, CLASS_NAME2, ...</span><br><span class="line">2. class&#123;&#39;CLASS_NAME&#39;:</span><br><span class="line">       attribute &#x3D;&gt; value,</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>　　我们来看一个比较全面的例子：<br>　　首先，判断我们系统的版本，是6还是7，由此来确定，是安装<code>mysql</code>还是<code>mariadb</code>，同时，使用调用参数的方式来实现如上需求。<br>　　具体实现的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim dbserver.pp</span><br><span class="line">    class dbserver($dbpkg&#x3D;&#39;mariadb-server&#39;,$svc&#x3D;&#39;mariadb&#39;) &#123;    #定义类并给参数赋值</span><br><span class="line">        package&#123;&quot;$dbpkg&quot;:</span><br><span class="line">            ensure  &#x3D;&gt; installed,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        service&#123;&quot;$svc&quot;:</span><br><span class="line">            ensure  &#x3D;&gt; running,</span><br><span class="line">            enable  &#x3D;&gt; true,</span><br><span class="line">            hasrestart  &#x3D;&gt; true,</span><br><span class="line">            hasstatus   &#x3D;&gt; true,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if $operatingsystem &#x3D;&#x3D; &#39;CentOS&#39; &#123;</span><br><span class="line">        if $operatingsystemmajrelease &#x3D;&#x3D; &#39;7&#39; &#123;</span><br><span class="line">            include dbserver        #直接调用类</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            class&#123;&quot;dbserver&quot;:        #调用类并对参数重新赋值</span><br><span class="line">                dbpkg   &#x3D;&gt; &#39;mysql-server&#39;,</span><br><span class="line">                svc     &#x3D;&gt; &#39;mysqld&#39;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3）类的继承"><a href="#3）类的继承" class="headerlink" title="3）类的继承"></a>3）类的继承</h3><p>　　类似于其它编程语言中的类的功能，puppet 的Class 可以被继承，也可以包含子类。<br>　　其定义的语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class SUB_CLASS_NAME inherits PARENT_CLASS_NAME &#123;</span><br><span class="line">    ...puppet code...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　下面我们来看一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">vim class4.pp</span><br><span class="line">    class redis &#123;        #定义class类</span><br><span class="line">        package&#123;&#39;redis&#39;:</span><br><span class="line">            ensure  &#x3D;&gt; installed,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        service&#123;&#39;redis&#39;:</span><br><span class="line">            ensure  &#x3D;&gt; running,</span><br><span class="line">            enable  &#x3D;&gt; true,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class redis::master inherits redis &#123;        #调用父类</span><br><span class="line">        file &#123;&#39;&#x2F;etc&#x2F;redis.conf&#39;:</span><br><span class="line">            ensure  &#x3D;&gt; file,</span><br><span class="line">            source  &#x3D;&gt; &#39;&#x2F;root&#x2F;manifests&#x2F;file&#x2F;redis-master.conf&#39;,</span><br><span class="line">            owner   &#x3D;&gt; &#39;redis&#39;,</span><br><span class="line">            group   &#x3D;&gt; &#39;root&#39;,</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        Service[&#39;redis&#39;] &#123;                        #定义依赖关系</span><br><span class="line">            subscribe   &#x3D;&gt; File[&#39;&#x2F;etc&#x2F;redis.conf&#39;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class redis::slave inherits redis &#123;            #调用父类</span><br><span class="line">        file &#123;&#39;&#x2F;etc&#x2F;redis.conf&#39;:</span><br><span class="line">            ensure  &#x3D;&gt; file,</span><br><span class="line">            source  &#x3D;&gt; &#39;&#x2F;root&#x2F;manifests&#x2F;file&#x2F;redis-slave.conf&#39;,</span><br><span class="line">            owner   &#x3D;&gt; &#39;redis&#39;,</span><br><span class="line">            group   &#x3D;&gt; &#39;root&#39;,</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        Service[&#39;redis&#39;] &#123;                        #定义依赖关系</span><br><span class="line">            subscribe   &#x3D;&gt; File[&#39;&#x2F;etc&#x2F;redis.conf&#39;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>　　一样的，我们的类在调用的时候，可以实现<strong>修改原有值</strong>和<strong>额外新增属性</strong>的功能。</p>
<h4 id="1-新增属性"><a href="#1-新增属性" class="headerlink" title="1.新增属性"></a>1.新增属性</h4><p>　　我们的继承父类的时候，可以定义一些父类原本没有的属性：</p>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212332475-788277314.png" alt="新增属性"></p>
<p>新增属性</p>
<h4 id="2-新增原有值"><a href="#2-新增原有值" class="headerlink" title="2.新增原有值"></a>2.新增原有值</h4><p>　　在继承的类中，我们可以在属性原有值的基础上，使用 +&gt; 进行新增修改：</p>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212332850-1488205981.png" alt="新增原有值"></p>
<p>新增原有值</p>
<h4 id="3-修改原有值"><a href="#3-修改原有值" class="headerlink" title="3.修改原有值"></a>3.修改原有值</h4><p>　　在继承的类中，我们可以直接把原有的值进行覆盖修改，使用 <code>=&gt;</code>进行覆盖即可：</p>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212333178-1102039935.png" alt="修改原有值"></p>
<p>修改原有值</p>
<h4 id="4-整体调用父类，并重写部分值"><a href="#4-整体调用父类，并重写部分值" class="headerlink" title="4.整体调用父类，并重写部分值"></a>4.整体调用父类，并重写部分值</h4><p>　　在继承的类中，我们还可以在整体调用的基础上，根据不同的需求，把父类中的部分值进行重写修改：</p>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212333459-2007144891.png" alt="整体调用父类，并重写部分值"></p>
<p>整体调用父类，并重写部分值</p>
<h2 id="二、模板"><a href="#二、模板" class="headerlink" title="二、模板"></a>二、模板</h2><p>　　模板通常以<code>erb</code>结尾。模板均使用<code>erb</code>语法。<br>　　关于<code>puppet</code>兼容的<code>erb</code>语法，我们可以去官方文档查看，下面附上官方文档地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.puppet.com/puppet/latest/reference/lang_template_erb.html">https://docs.puppet.com/puppet/latest/reference/lang_template_erb.html</a><br>　　以下，附上部分重要内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;%&#x3D; EXPRESSION %&gt; — 插入表达式的值，进行变量替换</span><br><span class="line">&lt;% CODE %&gt; — 执行代码，但不插入值</span><br><span class="line">&lt;%# COMMENT %&gt; — 插入注释</span><br><span class="line">&lt;%% or %%&gt; — 插入%</span><br></pre></td></tr></table></figure>

<p>　　接着我们来看一个实例：</p>
<h3 id="实例1：puppet-模板实现修改-redis-端口地址"><a href="#实例1：puppet-模板实现修改-redis-端口地址" class="headerlink" title="实例1：puppet 模板实现修改 redis 端口地址"></a>实例1：puppet 模板实现修改 redis 端口地址</h3><p>　　我们使用puppet 模板来实现，将redis 监听端口修改为本机的ip地址。<br>　　首先，我们先来定义一个<code>file.pp</code>文件，在该文件中调用我们的模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim file.pp</span><br><span class="line">    file&#123;&#39;&#x2F;tmp&#x2F;redis.conf&#39;:        #仅用于测试模板是否生效，所以放在tmp目录下</span><br><span class="line">        ensure  &#x3D;&gt; file,</span><br><span class="line">        content &#x3D;&gt; template(&#39;&#x2F;root&#x2F;manifests&#x2F;file&#x2F;redis.conf.erb&#39;),        #调用模板文件</span><br><span class="line">        owner   &#x3D;&gt; &#39;redis&#39;,</span><br><span class="line">        group   &#x3D;&gt; &#39;root&#39;,</span><br><span class="line">        mode    &#x3D;&gt; &#39;0640&#39;,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>　　接着，我们去修改配置文件的源，也就是我们的模板文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim file&#x2F;redis.conf.erb</span><br><span class="line">    bind 127.0.0.1 &lt;%&#x3D; @ipaddress_eth0 %&gt;    #修改监听端口</span><br></pre></td></tr></table></figure>

<p>　　修改完成以后，我们就可以执行查看结果了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puppet apply -v file.pp</span><br></pre></td></tr></table></figure>

<p>　　然后，我们去查看一下<code>/tmp/redis.conf</code>文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;tmp&#x2F;redis.conf</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212333615-1359926062.png" alt="监听端口"></p>
<p>监听端口</p>
<p>　　可以看出，我们的变量替换已经成功。</p>
<h2 id="三、模块"><a href="#三、模块" class="headerlink" title="三、模块"></a>三、模块</h2><h3 id="1）什么是模块？"><a href="#1）什么是模块？" class="headerlink" title="1）什么是模块？"></a>1）什么是模块？</h3><p>　　实践中，一般需要把manifest 文件分解成易于理解的结构，例如将类文件、配置文件甚至包括后面将提到的模块文件等分类存放，并且通过某种机制在必要时将它们整合起来。<br>　　这种机制即<strong>模块</strong>，它有助于以结构化、层次化的方式使用puppet，而puppet 则基于“模块自动装载器”。<br>　　从另一个角度来说，模块实际上就是一个按约定的、预定义的结构存放了多个文件或子目录的目录，目录里的这些文件或子目录必须遵循其<strong>命名规范</strong>。</p>
<h3 id="2）模块的命名规范"><a href="#2）模块的命名规范" class="headerlink" title="2）模块的命名规范"></a>2）模块的命名规范</h3><p>　　模块的目录格式如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/1204916-20171222212333756-2010854377.png" alt="目录格式"></p>
<p>目录格式</p>
<p>　　其中，每个文件夹中<strong>存放的内容</strong>及其<strong>要求</strong>如下：</p>
<ul>
<li><p><strong>MODULE NAME</strong>：模块名称，模块名只能以小写字母开头，可以包含小写字母、数字和下划线；但不能使用”main”和”settings”；</p>
</li>
<li><p>manifests/</p>
<p>：</p>
<p>必须要有</p>
<ul>
<li>init.pp：必须一个类定义，类名称必须与模块名称相同；</li>
</ul>
</li>
<li><p>files/</p>
<p>：静态文件；</p>
<ul>
<li>其中，每个文件的访问路径遵循：<code>puppet:///modules/MODULE_NAME/FILE_NAME</code>；</li>
</ul>
</li>
<li><p>templates/</p>
<p>：</p>
<ul>
<li>其中，每个文件的访问路径遵循：<code>tempate(&#39;MOD_NAME/TEMPLATE_FILE_NAME&#39;)</code>；</li>
</ul>
</li>
<li><p>**lib/**：插件目录，常用于存储自定义的facts以及自定义类型；</p>
</li>
<li><p>**spec/**：类似于tests目录，存储lib/目录下插件的使用帮助和范例；</p>
</li>
<li><p>**tests/**：当前模块的使用帮助或使用范例文件；</p>
</li>
</ul>
<h3 id="实例：定义一个redis主从模块"><a href="#实例：定义一个redis主从模块" class="headerlink" title="实例：定义一个redis主从模块"></a>实例：定义一个redis主从模块</h3><p>　　下面我们就来看一个实例来具体的了解应该如何定义一个模块：<br>1）我们先来创建对应的目录格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mkdir modules</span><br><span class="line">[root@master ~]# cd modoules&#x2F;</span><br><span class="line">[root@master modules]# ls</span><br><span class="line">[root@master modules]# mkdir -pv redis&#x2F;&#123;manifests,files,templates,tests,lib,spec&#125;</span><br><span class="line">mkdir: created directory ‘redis’</span><br><span class="line">mkdir: created directory ‘redis&#x2F;manifests’</span><br><span class="line">mkdir: created directory ‘redis&#x2F;files’</span><br><span class="line">mkdir: created directory ‘redis&#x2F;templates’</span><br><span class="line">mkdir: created directory ‘redis&#x2F;tests’</span><br><span class="line">mkdir: created directory ‘redis&#x2F;lib’</span><br><span class="line">mkdir: created directory ‘redis&#x2F;spec’</span><br></pre></td></tr></table></figure>

<p>2）目录格式创建完成之后，我们就可以来创建对应的父类子类文件了。<br>　　首先，我们来创建父类文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master modules]# cd redis&#x2F;</span><br><span class="line">[root@master redis]# vim manifests&#x2F;init.pp </span><br><span class="line">    class redis &#123;</span><br><span class="line">        package&#123;&#39;redis&#39;:</span><br><span class="line">            ensure  &#x3D;&gt; installed,</span><br><span class="line">        &#125; -&gt;</span><br><span class="line"></span><br><span class="line">        service&#123;&#39;redis&#39;:</span><br><span class="line">            ensure  &#x3D;&gt; running,</span><br><span class="line">            enable  &#x3D;&gt; true,</span><br><span class="line">            hasrestart  &#x3D;&gt; true,</span><br><span class="line">            hasstatus   &#x3D;&gt; true,</span><br><span class="line">            require &#x3D;&gt; Package[&#39;redis&#39;],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>　　创建完成后，我们再来创建对应的子类文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master redis]# vim manifests&#x2F;master.pp</span><br><span class="line">    class redis::master inherits redis &#123;</span><br><span class="line">        file &#123;&#39;&#x2F;etc&#x2F;redis.conf&#39;:</span><br><span class="line">            ensure  &#x3D;&gt; file,</span><br><span class="line">            source  &#x3D;&gt; &#39;puppet:&#x2F;&#x2F;&#x2F;modules&#x2F;redis&#x2F;redis-master.conf&#39;,</span><br><span class="line">            owner   &#x3D;&gt; &#39;redis&#39;,</span><br><span class="line">            group   &#x3D;&gt; &#39;root&#39;,</span><br><span class="line">            mode    &#x3D;&gt; &#39;0640&#39;,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Package[&#39;redis&#39;] -&gt; File[&#39;&#x2F;etc&#x2F;redis.conf&#39;] ~&gt; Service[&#39;redis&#39;]</span><br><span class="line">    &#125;</span><br><span class="line">[root@master redis]# vim manifests&#x2F;slave.pp</span><br><span class="line">    class redis::slave($master_ip,$master_port&#x3D;&#39;6379&#39;) inherits redis &#123;</span><br><span class="line">        file &#123;&#39;&#x2F;etc&#x2F;redis.conf&#39;:</span><br><span class="line">            ensure  &#x3D;&gt; file,</span><br><span class="line">            content &#x3D;&gt; template(&#39;redis&#x2F;redis-slave.conf.erb&#39;),</span><br><span class="line">            owner   &#x3D;&gt; &#39;redis&#39;,</span><br><span class="line">            group   &#x3D;&gt; &#39;root&#39;,</span><br><span class="line">            mode    &#x3D;&gt; &#39;0640&#39;,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Package[&#39;redis&#39;] -&gt; File[&#39;&#x2F;etc&#x2F;redis.conf&#39;] ~&gt; Service[&#39;redis&#39;]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>3）准备文件：<br>　　现在我们需要把模板文件准备好，放入我们的<code>templates</code>目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp redis.conf.erb &#x2F;root&#x2F;modules&#x2F;redis&#x2F;templates&#x2F;redis-slave.conf.erb</span><br></pre></td></tr></table></figure>

<p>　　还有我们的静态文件，也要放入我们的<code>files</code>目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp redis.conf &#x2F;root&#x2F;modules&#x2F;redis&#x2F;files&#x2F;redis-master.conf</span><br></pre></td></tr></table></figure>

<p>4）查看目录结构，确定我们是否都已准备完成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master modules]# tree</span><br><span class="line">.</span><br><span class="line">└── redis</span><br><span class="line">    ├── files</span><br><span class="line">    │   └── redis-master.conf</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── manifests</span><br><span class="line">    │   ├── init.pp</span><br><span class="line">    │   ├── master.pp</span><br><span class="line">    │   └── slave.pp</span><br><span class="line">    ├── spec</span><br><span class="line">    ├── templates</span><br><span class="line">    │   └── redis-slave.conf.erb</span><br><span class="line">    └── tests</span><br><span class="line"></span><br><span class="line">7 directories, 5 files</span><br></pre></td></tr></table></figure>

<p>5）现在就可以把我们的准备好的模块放入系统的模块目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master mdoules]# cp -rp redis&#x2F; &#x2F;etc&#x2F;puppet&#x2F;modules&#x2F;</span><br></pre></td></tr></table></figure>

<p>　　注意，模块是不能直接被调用的，只有放在<code>/etc/puppet/modules</code>下，或<code>/usr/share/puppet/modules</code>目录下，使其生效才可以被调用。<br>　　我们可以来查看一下我们的模块到底有哪些：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master mdoules]# puppet module list</span><br><span class="line">&#x2F;etc&#x2F;puppet&#x2F;modules</span><br><span class="line">└── redis (???)</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;puppet&#x2F;modules (no modules installed)</span><br></pre></td></tr></table></figure>

<p>　　可以看出，我们的模块已经定义好了，现在我们就可以直接调用了。<br>6）调用模块<br>　　我们可以直接命令行传入参数来调用我们准备好的模块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master modules]# puppet apply -v --noop -e &quot;class&#123;&#39;redis::slave&#39;: master_ip &#x3D;&gt; &#39;192.168.37.100&#39;&#125;&quot;        #如果有多个参数，直接以逗号隔开即可</span><br></pre></td></tr></table></figure>

<p>　　也可以把我们的调用的类赋值在<code>.pp</code>文件中，然后运行该文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd manifests&#x2F;  </span><br><span class="line">[root@master manifests]# vim redis2.pp</span><br><span class="line">    class&#123;&#39;redis::slave&#39;:</span><br><span class="line">        master_ip &#x3D;&gt; &#39;192.168.37.100&#39;,</span><br><span class="line">    &#125;</span><br><span class="line">[root@master manifests]# puppet apply -e --noop redis2.pp</span><br></pre></td></tr></table></figure>

<p>　　以上。实验完成。<br>　　注意，以上实验是我们在单机模式下进行的，如果是要在master/agent 模式下进行，步骤还会略有不同。</p>
<h2 id="四、master-agent-模型"><a href="#四、master-agent-模型" class="headerlink" title="四、master/agent 模型"></a>四、master/agent 模型</h2><p>　　master/agent模型时通过主机名进行通信的，下面，就来看看 master-agent 模式的puppet运维自动化如何实现：</p>
<h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><h4 id="1、实现前准备"><a href="#1、实现前准备" class="headerlink" title="1、实现前准备"></a>1、实现前准备</h4><p>1）下载包<br>master 端：<code>puppet.noarch</code>，<code>puppet-server.noarch</code><br>agent 端：<code>puppet.noarch</code></p>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212333928-844694007.png" alt="puppet包查询"></p>
<p>puppet包查询</p>
<p>2）主机名解析<br>　　为了方便我们后期的操作，我们可以通过定义<code>/etc/hosts</code>文件实现主机名的解析。如果机器很多的话，可以使用DNS进行解析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim &#x2F;etc&#x2F;hosts</span><br><span class="line">    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">    ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">    192.168.37.111  master.keer.com</span><br><span class="line">    192.168.37.122  server1.keer.com</span><br></pre></td></tr></table></figure>

<p>　　注意，该操作需要在每一台主机上进行。<br>　　修改完成以后，我们可以来测试一下是否已经成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ping server1.keer.com</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212334131-1647169584.png" alt="连通性测试"></p>
<p>连通性测试</p>
<p>3）时间同步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl start chronyd.service</span><br></pre></td></tr></table></figure>

<p>　　所有机器上都开启<code>chronyd.service</code>服务来进行时间同步<br>　　开启过后可以查看一下状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl status chronyd.service</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212334334-735133130.png" alt="时间同步状态"></p>
<p>时间同步状态</p>
<p>　　我们可以使用<code>chronyc sources</code>命令来查看时间源：</p>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212334475-711062639.png" alt="查看时间源"></p>
<p>查看时间源</p>
<h4 id="2、开启-master-端的-puppet-服务"><a href="#2、开启-master-端的-puppet-服务" class="headerlink" title="2、开启 master 端的 puppet 服务"></a>2、开启 master 端的 puppet 服务</h4><p>1）手动前台开启，观察服务开启过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puppet master -v --no-daemonize        #前台运行</span><br></pre></td></tr></table></figure>



<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212334771-2051578219.png" alt="master 初始化过程"></p>
<p>　　整个过程都是自动完成的，其中，每一步的意思如下：<br>　　① 创建key 给CA<br>　　② 创建一个请求给CA<br>　　③ 自签名证书<br>　　④ CA 创建完成<br>　　⑤ 创建证书吊销列表<br>　　⑥ 为当前的master 主机签署证书<br>　　⑦ master 的证书签署完成</p>
<p>2）直接<code>systemctl</code>开启服务，监听在8140端口。</p>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212334990-1873293960.png" alt="开启服务"></p>
<p>开启服务</p>
<h4 id="3、在-agent-端开启服务"><a href="#3、在-agent-端开启服务" class="headerlink" title="3、在 agent 端开启服务"></a>3、在 agent 端开启服务</h4><p>1）在配置文件中指明server端的主机名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# vim &#x2F;etc&#x2F;puppet&#x2F;puppet.conf </span><br><span class="line">    server &#x3D; master.keer.com</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212335131-878601235.png" alt="agent端配置文件"></p>
<p>agent端配置文件</p>
<p>　　接着，我们可以通过<code>puppet config print</code>命令来打印输出我们配置的参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# puppet config print   显示配置文件中的配置参数</span><br><span class="line">[root@server1 ~]# puppet config print --section&#x3D;main   显示main 段的配置参数</span><br><span class="line">[root@server1 ~]# puppet config print --section&#x3D;agent  显示agent 段的配置参数</span><br><span class="line">[root@server1 ~]# puppet config print server   显示server 的配置参数</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212335287-1245093671.png" alt="打印输出参数"></p>
<p>打印输出参数</p>
<p>2）开启 agent 服务</p>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212335428-1083102976.png" alt="开启agent服务"></p>
<p>开启agent服务</p>
<p>　　我们可以发现，他会一直卡在这里等待CA颁发证书。</p>
<p>3）在 master 端签署证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# puppet cert list</span><br><span class="line">  &quot;server1.keer.com&quot; (SHA256) B5:67:51:30:5C:FB:45:BA:7A:73:D5:C5:87:D4:E3:1C:D7:02:BE:DD:CC:7A:E2:F0:28:34:87:86:EF:E7:1D:E4</span><br><span class="line">[root@master ~]# puppet cert sign server1.keer.com        #颁发证书</span><br><span class="line">Notice: Signed certificate request for server1.keer.com</span><br><span class="line">Notice: Removing file Puppet::SSL::CertificateRequest server1.keer.com at &#39;&#x2F;var&#x2F;lib&#x2F;puppet&#x2F;ssl&#x2F;ca&#x2F;requests&#x2F;server1.keer.com.pem&#39;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>master 端管理证书部署的命令语法如下：<br>puppet cert <action> [–all|-a] [<host>]<br>　　action：<br>　　　　list 列出证书请求<br>　　　　sign 签署证书<br>　　　　revoke 吊销证书<br>　　　　clean 吊销指定的客户端的证书，并删除与其相关的所有文件；</host></action></p>
</blockquote>
<p>注意：某agent证书手工吊销后重新生成一次；<br>　　On master host：<br>　　　　puppet cert revoke NODE_NAME<br>　　　　puppet cert clean NODE_NAME<br>　　On agent host：<br>　　　　重新生成的主机系统，直接启动agent；<br>　　　　变换私钥，建议先清理/var/lib/puppet/ssl/目录下的文件</p>
<p>4）终止服务开启，再次开启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 ~]# puppet agent -v --noop --no-daemonize</span><br></pre></td></tr></table></figure>



<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212335568-798504236.png" alt="开启agent端服务"></p>
<p>开启agent端服务</p>
<p>　　可以看出我们的服务开启成功，但是由于master 端没有配置站点清单，所以没有什么动作。</p>
<h4 id="4、配置站点清单，且测试agent-端是否实现"><a href="#4、配置站点清单，且测试agent-端是否实现" class="headerlink" title="4、配置站点清单，且测试agent 端是否实现"></a>4、配置站点清单，且测试agent 端是否实现</h4><p>1）设置站点清单<br>① 查询站点清单应存放的目录，（可以修改，去配置文件修改）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# puppet config print |grep manifest</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212335709-2099732734.png" alt="查询配置文件的参数"></p>
<p>查询配置文件的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd &#x2F;etc&#x2F;puppet&#x2F;manifests&#x2F;</span><br><span class="line">[root@master manifests]# vim site.pp</span><br><span class="line">node &#39;server1.along.com&#39; &#123;</span><br><span class="line">        include redis::master</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>　　分析：就是简单的调用模块，只有模块提前定义好就可以直接调用；我调用的是上边的redis 模块</p>
<p>2）给puppet 用户授权<br>　　因为agent 端要来master 端读取配置，身份是puppet</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master manifests]# chown -R puppet &#x2F;etc&#x2F;puppet&#x2F;modules&#x2F;redis&#x2F;*</span><br></pre></td></tr></table></figure>

<p>3）[root@server1 ~]# puppet agent -v –noop –no-daemonize 手动前台开启agent 端服务</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/1204916-20171222212336037-132598782.png" alt="enter description here"></p>
<p>enter description here</p>
<p>（4）直接开启服务，agent 会自动去master 端获取配置<br>[root@server1 ~]# systemctl start puppetagent 包已下载，服务也开启了</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/1204916-20171222212336225-205714606.png" alt="enter description here"></p>
<p>enter description here</p>
<h4 id="5、节点管理"><a href="#5、节点管理" class="headerlink" title="5、节点管理"></a>5、节点管理</h4><p>site.pp 定义节点的方式</p>
<p>（1）以主机名直接给出相关定义</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node <span class="string">&#x27;NODE_NAME&#x27;</span> &#123;</span><br><span class="line">  ...puppet code ....</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>（2）把功能相近的主机事先按统一格式命名，按统一格式</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node /^web\d+\.magedu\.com/ &#123;</span><br><span class="line">  ...puppet code...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>主机名定义：<br>            主机名(主机角色)#-机架-机房-运营商-区域.域名<br>                www1-rack1-yz-unicom-bj.magedu.com</p>
<p>（3）节点分段管理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">        &#x2F;etc&#x2F;puppet&#x2F;manifests&#x2F;site.pp</span><br><span class="line">            node &#39;basenode&#39; &#123;</span><br><span class="line">                include ntp </span><br><span class="line">            &#125;</span><br><span class="line">            节点定义的继承：</span><br><span class="line">                node web.magedu.com inherits basenode &#123;</span><br><span class="line">                    include nginx::proxy</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">            </span><br><span class="line">清单配置信息可模块化组织：</span><br><span class="line">    nodes&#x2F;</span><br><span class="line">      databases.d&#x2F;</span><br><span class="line">      webservers.d&#x2F;</span><br><span class="line">          unicom.pp</span><br><span class="line">          telcom.pp</span><br><span class="line">      tomcatservers.d&#x2F;</span><br><span class="line">      nodes.d&#x2F;：可通过多个pp文件分别定义各类站点的清单；而后统一导入site.pp，方法如下：</span><br><span class="line"></span><br><span class="line">site.pp文件使用中如下配置：    </span><br><span class="line">import &#39;nodes&#x2F;*.pp&#39;</span><br><span class="line">                </span><br></pre></td></tr></table></figure>



<h2 id="五、puppet文件服务器"><a href="#五、puppet文件服务器" class="headerlink" title="五、puppet文件服务器"></a>五、puppet文件服务器</h2><p>部署配置文件是 Puppet 最常见的用途之一。许多服务都需要一些配置文件， 你可以让 Puppet 使用 file 资源将这些配置文件推送到客户端，如下面的代码所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file &#123; &quot;&#x2F;opt&#x2F;nginx&#x2F;conf.d&#x2F;app_production.conf&quot;:</span><br><span class="line">    source &#x3D;&gt; &quot;puppet:&#x2F;&#x2F;&#x2F;modules&#x2F;app&#x2F;app_production.conf&quot;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>source 参数是这样约定的： puppet:/// 之后的第一部分假定是一个 <strong>挂装点（mount point）</strong> 名称，其余部份被视为一个文件路径，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puppet:&#x2F;&#x2F;&#x2F;&lt;mount point&gt;&#x2F;&lt;path&gt;</span><br></pre></td></tr></table></figure>

<p>通常 <mount point> 的值是一个模块名称，如上例所示。在这个例子中， Puppet 将在如下的位置查找文件：</mount></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">manifests&#x2F;modules&#x2F;app&#x2F;files&#x2F;app_production.conf</span><br></pre></td></tr></table></figure>

<p>modules 是 Puppet 予以特别对待的一个挂装点：它期望接下来的路径组成是一个模块名， 并在模块的 files 目录下针对路径的其余部分寻找文件。</p>
<p>然而 Puppet 也允许你创建自定义的挂装点，你可以为自定义的挂装点设置个别的访问控制， 并将其映射到 Puppetmaster 的不同文件系统位置。 在本节中，我们将展示如何创建和配置这些自定义的挂载点。</p>
<h4 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h4><ol>
<li><p>在 PuppetMaster 的 fileserver.conf 中添加新的一节，将挂装点的名称用方括号括起， path 的值就是 Puppet 将会寻找数据的目录路径，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[san]</span><br><span class="line">    path &#x2F;mnt&#x2F;san&#x2F;mydata&#x2F;puppet</span><br></pre></td></tr></table></figure>
</li>
<li><p>在你的配置清单里，使用 source 指定你的挂载点名称，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &#x3D;&gt; &quot;puppet:&#x2F;&#x2F;&#x2F;san&#x2F;admin&#x2F;users.htpasswd&quot;,</span><br></pre></td></tr></table></figure>

<p>Puppet 会将其转换为如下的路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;mnt&#x2F;san&#x2F;mydata&#x2F;puppet&#x2F;admin&#x2F;users.htpasswd</span><br></pre></td></tr></table></figure>

<p>像这样创建一个自定义挂载点的主要原因就是提高安全性。 例如，你有个秘密的口令文件只需部署到 web 服务器，而其它机器则不需要。 如果有人能够在任何机器上运行 Puppet，并且有合法的证书访问 Puppetmaster， 那么没有人能阻止他像这样执行下面的配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file &#123; &quot;&#x2F;home&#x2F;cracker&#x2F;goodstuff&#x2F;passwords.txt&quot;:</span><br><span class="line">    source &#x3D;&gt; &quot;puppet:&#x2F;&#x2F;&#x2F;web&#x2F;passwords.txt&quot;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>他们可以轻而易举地获取秘密数据。事实上，可以导出 Puppet 仓库的任何人以及 在 Puppetmaster 上有账户的任何人都可以访问此文件。 为了避免这种情况发生的方法之一就是将秘密数据放在自定义挂载点并启用访问控制。</p>
</li>
<li><p>在 fileserver.conf 中添加 allow 和 deny 参数来定义你的挂载点，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[secret]</span><br><span class="line">    &#x2F;data&#x2F;secret</span><br><span class="line">    allow web.example.com</span><br><span class="line">    deny *</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><p>在本例中, 仅允许 web.example.com 访问此文件。 默认的策略是拒绝所有的访问， 因此 deny * 这行是可选的，但它确实是个好的习惯，因为看上去更清晰。 之后 web 服务器就可以使用 file 资源了，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file &#123; &quot;&#x2F;etc&#x2F;passwords.txt&quot;:</span><br><span class="line">    source &#x3D;&gt; &quot;puppet:&#x2F;&#x2F;&#x2F;secret&#x2F;passwords.txt&quot;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果此配置清单是在 web.example.com 上执行，将会正常工作； 若在其它客户端上执行则执行失败。</p>
<h4 id="更多用法"><a href="#更多用法" class="headerlink" title="更多用法"></a>更多用法</h4><p>你也可以将指定的 IP 地址替换为主机名，也可使用 <strong>无类型域间路由(CIDR)</strong> 或使用通配符（wildcard）来表示一组地址，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow 10.0.55.0&#x2F;24</span><br><span class="line">allow 192.168.0.*</span><br></pre></td></tr></table></figure>

<h2 id="六、认证配置文件auth-conf"><a href="#六、认证配置文件auth-conf" class="headerlink" title="六、认证配置文件auth.conf"></a>六、认证配置文件auth.conf</h2><p>Master会根据auth.conf配置文件来限制agent的来源（来源包括IP、域名或环境列表等）。为了网络访问安全，agent再访问master过程中，其使用https协议进行通信交互，基本的访问格式如下：https://{server}:{port}/{environment}/{resource}/{key}</p>
<p><strong>认证配置文件，为puppet提供acl功能，主要应用于puppet的restful API调用</strong>：哪些人有权限调用</p>
<p>auth.conf权限控制列表格式：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Waylonwhynot/whatyouneed_blog_pic@main/pic/201704101491830246459652.png" alt="图片.png"></p>
<p>auth.conf配置文件格式包含7个参数，分别是path、environment、method、auth、allow、allow_ip和deny，每个参数都有自己独立的值，通过这7个参数的自由组合，就形成了agent访问master目录权限控制的ACL。</p>
<p>path：指定ACL的路径。Path后接系统路径、正则表达式、路径前缀和资源等信息。</p>
<p>environment : 它可以包含一个环境或多个环境列表，如果不设置则默认为所有环境。</p>
<p>method : 包含find、search、save和destroy（销毁），多参数用逗号隔开</p>
<p>auth：包含yes或no，any和no或off。默认是yes或on.auth设置成yes或on均表示匹配那些已经通过认证的agent请求。Auth设置成any意味着只匹配认证进行中和没有被认证的请求。Auth设置no或off，均表示匹配未认证过的agent请求。认证过的请求会跳过此ACL。</p>
<p>allow : 值可以是hostname或certname.2.7.1以后的版本还支持正则表达式。</p>
<p>allow_ip：接一个IP或者IP网段，表示允许那些IP范围通过</p>
<p>deny：接一个IP或者多个IP，网段或域名等，表示禁止这些范围访问master的目录权限。</p>
<p># cat /etc/puppet/auth.conf #里面的注释部分有很多例子</p>
<h2 id="七、puppet-多环境管理"><a href="#七、puppet-多环境管理" class="headerlink" title="七、puppet 多环境管理"></a>七、puppet 多环境管理</h2><h3 id="1、配置puppet-conf"><a href="#1、配置puppet-conf" class="headerlink" title="1、配置puppet.conf"></a>1、配置puppet.conf</h3><p>在标签[master]中添加environments环境，其次创建对应的环境标签及配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@puppetmaster ~]# vim &#x2F;etc&#x2F;puppet&#x2F;puppet.conf</span><br><span class="line">[main]</span><br><span class="line">    logdir &#x3D; &#x2F;var&#x2F;log&#x2F;puppet</span><br><span class="line">    rundir &#x3D; &#x2F;var&#x2F;run&#x2F;puppet</span><br><span class="line">    ssldir &#x3D; $vardir&#x2F;ssl</span><br><span class="line">[agent]</span><br><span class="line">    classfile &#x3D; $vardir&#x2F;classes.txt</span><br><span class="line">    localconfig &#x3D; $vardir&#x2F;localconfig</span><br><span class="line">    server &#x3D; puppetmaster.kisspuppet.com</span><br><span class="line">    certname &#x3D; puppetmaster_cert.kisspuppet.com</span><br><span class="line">[master]</span><br><span class="line">    certname &#x3D; puppetmaster.kisspuppet.com</span><br><span class="line">    environments &#x3D; kissdev,kisstmq,kissprd  #添加三个环境的标签名称</span><br><span class="line">[kissdev]</span><br><span class="line">modulepath &#x3D; $confdir&#x2F;environments&#x2F;kissdev&#x2F;environment&#x2F;modules:$confdir&#x2F;environments&#x2F;kissdev&#x2F;application&#x2F;modules  #设置环境的搜索路径</span><br><span class="line">manifest &#x3D; $confdir&#x2F;environments&#x2F;kissdev&#x2F;manifests&#x2F;site.pp  #设置环境的site.pp文件位置</span><br><span class="line">fileserverconfig &#x3D; &#x2F;etc&#x2F;puppet&#x2F;fileserver.conf.kissdev  #设置环境的fileserver</span><br><span class="line"></span><br><span class="line">[kissmq]</span><br><span class="line">modulepath &#x3D; $confdir&#x2F;environments&#x2F;kissmq&#x2F;environment&#x2F;modules:$confdir&#x2F;environments&#x2F;kisstest&#x2F;application&#x2F;modules</span><br><span class="line">manifest &#x3D; $confdir&#x2F;environments&#x2F;kisstest&#x2F;manifests&#x2F;site.pp</span><br><span class="line">fileserverconfig &#x3D; &#x2F;etc&#x2F;puppet&#x2F;fileserver.conf.kisstest</span><br><span class="line"></span><br><span class="line">[kissprd]</span><br><span class="line">modulepath &#x3D; $confdir&#x2F;environments&#x2F;kissprd&#x2F;environment&#x2F;modules:$confdir&#x2F;environments&#x2F;kissprd&#x2F;application&#x2F;modules</span><br><span class="line">manifest &#x3D; $confdir&#x2F;environments&#x2F;kissprd&#x2F;manifests&#x2F;site.pp</span><br><span class="line">fileserverconfig &#x3D; &#x2F;etc&#x2F;puppet&#x2F;fileserver.conf.kissprd</span><br></pre></td></tr></table></figure>

<p><strong>顺便解释一下：</strong>为什么在每个环境下会有environment和application两个目录，其中environment目录是存放基础环境模块的，比如puppet、yum等；而application目录是存在应用环境模块的，比如apache、mysql等。当然也可以放在同一个目录下，如果应用多的话还可以将application进行拆分，一切都是为了方便管理而考虑。</p>
<h3 id="2、创建多环境目录结构"><a href="#2、创建多环境目录结构" class="headerlink" title="2、创建多环境目录结构"></a>2、创建多环境目录结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@puppetmaster environments]# mkdir kissdev</span><br><span class="line">[root@puppetmaster environments]# mkdir kissdev&#x2F;&#123;application&#x2F;modules,environment&#x2F;modules&#125; -p</span><br><span class="line">[root@puppetmaster environments]# tree .</span><br><span class="line">.</span><br><span class="line">└── kissdev</span><br><span class="line">    ├── application</span><br><span class="line">    │   └── modules   #存放应用的模块</span><br><span class="line">    └── environment</span><br><span class="line">        └── modules  #存放基础环境模块</span><br><span class="line"></span><br><span class="line">5 directories, 0 files</span><br><span class="line">[root@puppetmaster environments]# cp kissdev kissmq -rp</span><br><span class="line">[root@puppetmaster environments]# cp kissdev kissprd -rp</span><br><span class="line">[root@puppetmaster environments]# tree .</span><br><span class="line">.</span><br><span class="line">├── kissdev</span><br><span class="line">│   ├── application</span><br><span class="line">│   │   └── modules</span><br><span class="line">│   └── environment</span><br><span class="line">│       └── modules</span><br><span class="line">├── kissmq</span><br><span class="line">│   ├── application</span><br><span class="line">│   │   └── modules</span><br><span class="line">│   └── environment</span><br><span class="line">│       └── modules</span><br><span class="line">└── kissprd</span><br><span class="line">    ├── application</span><br><span class="line">    │   └── modules</span><br><span class="line">    └── environment</span><br><span class="line">        └── modules</span><br><span class="line"></span><br><span class="line">15 directories, 0 files</span><br></pre></td></tr></table></figure>

<h3 id="3、移动默认环境modules中的配置到kissprd对应的环境中"><a href="#3、移动默认环境modules中的配置到kissprd对应的环境中" class="headerlink" title="3、移动默认环境modules中的配置到kissprd对应的环境中"></a>3、移动默认环境modules中的配置到kissprd对应的环境中</h3><p>其中puppet和yum模块属于基础环境模块，motd属于应用环境模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppetmaster environments]# mv &#x2F;etc&#x2F;puppet&#x2F;modules&#x2F;puppet kissprd&#x2F;environment&#x2F;modules&#x2F; </span><br><span class="line">[root@puppetmaster environments]# mv &#x2F;etc&#x2F;puppet&#x2F;modules&#x2F;yum  kissprd&#x2F;environment&#x2F;modules&#x2F; </span><br><span class="line">[root@puppetmaster environments]# mv &#x2F;etc&#x2F;puppet&#x2F;modules&#x2F;motd kissprd&#x2F;application&#x2F;modules&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="4、复制manifests文件至kissprd环境中"><a href="#4、复制manifests文件至kissprd环境中" class="headerlink" title="4、复制manifests文件至kissprd环境中"></a>4、复制manifests文件至kissprd环境中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppetmaster environments]# cp &#x2F;etc&#x2F;puppet&#x2F;manifests kissprd&#x2F; -r</span><br></pre></td></tr></table></figure>

<p>复制完成后整个环境如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@puppetmaster environments]# tree kissprd&#x2F;</span><br><span class="line">kissprd&#x2F;</span><br><span class="line">├── application</span><br><span class="line">│   └── modules</span><br><span class="line">│       └── motd</span><br><span class="line">│           ├── files</span><br><span class="line">│           │   └── etc</span><br><span class="line">│           │       └── motd</span><br><span class="line">│           ├── manifests</span><br><span class="line">│           │   └── init.pp</span><br><span class="line">│           └── templates</span><br><span class="line">├── environment</span><br><span class="line">│   └── modules</span><br><span class="line">│       ├── puppet</span><br><span class="line">│       │   ├── files</span><br><span class="line">│       │   ├── manifests</span><br><span class="line">│       │   │   ├── config.pp</span><br><span class="line">│       │   │   ├── init.pp</span><br><span class="line">│       │   │   ├── install.pp</span><br><span class="line">│       │   │   ├── params.pp</span><br><span class="line">│       │   │   └── service.pp</span><br><span class="line">│       │   └── templates</span><br><span class="line">│       │       └── puppet.conf.erb</span><br><span class="line">│       └── yum</span><br><span class="line">│           ├── files</span><br><span class="line">│           │   ├── etc</span><br><span class="line">│           │   │   └── yum.conf</span><br><span class="line">│           │   └── PM-GPG-KEY</span><br><span class="line">│           │       ├── RPM-GPG-KEY-puppet-release</span><br><span class="line">│           │       ├── RPM-GPG-KEY-redhat-release-rhel5</span><br><span class="line">│           │       └── RPM-GPG-KEY-redhat-release-rhel6</span><br><span class="line">│           ├── manifests</span><br><span class="line">│           │   ├── config.pp</span><br><span class="line">│           │   ├── init.pp</span><br><span class="line">│           │   ├── install.pp</span><br><span class="line">│           │   └── params.pp</span><br><span class="line">│           └── templates</span><br><span class="line">└── manifests</span><br><span class="line">    └── site.pp</span><br><span class="line"></span><br><span class="line">20 directories, 17 files</span><br></pre></td></tr></table></figure>

<h3 id="5、删除掉默认环境manifests中site-pp文件内容"><a href="#5、删除掉默认环境manifests中site-pp文件内容" class="headerlink" title="5、删除掉默认环境manifests中site.pp文件内容"></a>5、删除掉默认环境manifests中site.pp文件内容</h3><p>因为模块已经移除，其次默认环境production已经不再使用了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppetmaster environments]# &gt;&#x2F;etc&#x2F;puppet&#x2F;manifests&#x2F;site.pp </span><br></pre></td></tr></table></figure>

<h3 id="6、创建fileserverconfig文件"><a href="#6、创建fileserverconfig文件" class="headerlink" title="6、创建fileserverconfig文件"></a>6、创建fileserverconfig文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@puppetmaster ~]# cp &#x2F;etc&#x2F;puppet&#x2F;fileserver.conf&#123;,.kissdev&#125;</span><br><span class="line">[root@puppetmaster ~]# cp &#x2F;etc&#x2F;puppet&#x2F;fileserver.conf&#123;,.kissqa&#125;</span><br><span class="line">[root@puppetmaster ~]# cp &#x2F;etc&#x2F;puppet&#x2F;fileserver.conf&#123;,.kissprd&#125;</span><br><span class="line">[root@puppetmaster ~]# ll &#x2F;etc&#x2F;puppet&#x2F;</span><br><span class="line">total 88</span><br><span class="line">-rw-r--r-- 1 root root  2569 Jan  7 07:51 auth.conf</span><br><span class="line">-rw-r--r-- 1 root root    17 Mar  9 17:54 autosign.conf.bak</span><br><span class="line">drwxr-xr-x 5 root root  4096 Mar 27 22:33 environments</span><br><span class="line">-rw-r--r-- 1 root root   381 Jan  7 07:49 fileserver.conf</span><br><span class="line">-rw-r--r-- 1 root root   381 Mar 27 22:46 fileserver.conf.kissdev  #指向kissdev环境</span><br><span class="line">-rw-r--r-- 1 root root   381 Mar 27 22:46 fileserver.conf.kissprd  #指向kissmq环境</span><br><span class="line">-rw-r--r-- 1 root root   381 Mar 27 22:46 fileserver.conf.kissqa   #指向kissdev环境</span><br><span class="line">drwxr-xr-x 2 root root  4096 Mar 25 05:23 manifests</span><br><span class="line">drwxr-xr-x 2 root root  4096 Mar 27 22:40 modules</span><br><span class="line">-rw-r--r-- 1 root root  1063 Mar 27 21:55 puppet.conf</span><br><span class="line">-rw-r--r-- 1 root root   853 Mar  9 00:48 puppet.conf.bak</span><br><span class="line">-rw-r--r-- 1 root root 42031 Mar  9 03:25 puppet.conf.out</span><br></pre></td></tr></table></figure>

<p><strong>7、重启puppetmaster服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppetmaster ~]# &#x2F;etc&#x2F;init.d&#x2F;puppetmaster restart</span><br><span class="line">Stopping puppetmaster:                                     [  OK  ]</span><br><span class="line">Starting puppetmaster:                                     [  OK  ]</span><br></pre></td></tr></table></figure>

<p><strong>8、节点测试验证</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@agent1 ~]# &gt;&#x2F;etc&#x2F;motd </span><br><span class="line">You have new mail in &#x2F;var&#x2F;spool&#x2F;mail&#x2F;root</span><br><span class="line">[root@agent1 ~]# puppet agent -t  #默认请求的是production环境，由于此环境里面没有模块所有不更新</span><br><span class="line">info: Caching catalog for agent1_cert.kisspuppet.com</span><br><span class="line">info: Applying configuration version &#39;1395931884&#39;</span><br><span class="line">notice: Finished catalog run in 0.02 seconds</span><br><span class="line">[root@agent1 ~]# puppet agent -t --environment&#x3D;kissprd  #环境指向kissprd</span><br><span class="line">info: Caching catalog for agent1_cert.kisspuppet.com</span><br><span class="line">info: Applying configuration version &#39;1395931962&#39;</span><br><span class="line">notice: &#x2F;Stage[main]&#x2F;Motd&#x2F;File[&#x2F;etc&#x2F;motd]&#x2F;content: </span><br><span class="line">--- &#x2F;etc&#x2F;motd    2014-03-27 22:52:27.000000000 +0800</span><br><span class="line">+++ &#x2F;tmp&#x2F;puppet-file20140327-26204-29bst1-0    2014-03-27 22:52:44.000000000 +0800</span><br><span class="line">@@ -0,0 +1,3 @@</span><br><span class="line">+--                       --</span><br><span class="line">+--------puppet test---------</span><br><span class="line">+--                       --</span><br><span class="line"></span><br><span class="line">info: FileBucket got a duplicate file &#123;md5&#125;d41d8cd98f00b204e9800998ecf8427e</span><br><span class="line">info: &#x2F;Stage[main]&#x2F;Motd&#x2F;File[&#x2F;etc&#x2F;motd]: Filebucketed &#x2F;etc&#x2F;motd to puppet with sum d41d8cd98f00b204e9800998ecf8427e</span><br><span class="line">notice: &#x2F;Stage[main]&#x2F;Motd&#x2F;File[&#x2F;etc&#x2F;motd]&#x2F;content: content changed &#39;&#123;md5&#125;d41d8cd98f00b204e9800998ecf8427e&#39; to &#39;&#123;md5&#125;87ea3a1af8650395038472457cc7f2b1&#39;</span><br><span class="line">notice: Finished catalog run in 0.68 seconds</span><br><span class="line">[root@agent1 ~]# cat &#x2F;etc&#x2F;motd </span><br><span class="line">--                       --</span><br><span class="line">--------puppet test---------</span><br><span class="line">--                       --</span><br></pre></td></tr></table></figure>

<p><strong>9、节点更改环境</strong></p>
<p>如果节点是主动同步的方式，应该在puppet.conf文件中添加environment配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@agent1 ~]# vim &#x2F;etc&#x2F;puppet&#x2F;puppet.conf</span><br><span class="line"></span><br><span class="line">### config by  puppet ###</span><br><span class="line">[main]</span><br><span class="line">    logdir &#x3D; &#x2F;var&#x2F;log&#x2F;puppet</span><br><span class="line">    rundir &#x3D; &#x2F;var&#x2F;run&#x2F;puppet</span><br><span class="line">    ssldir &#x3D; $vardir&#x2F;ssl</span><br><span class="line"></span><br><span class="line">[agent]</span><br><span class="line">    classfile &#x3D; $vardir&#x2F;classes.txt</span><br><span class="line">    localconfig &#x3D; $vardir&#x2F;localconfig</span><br><span class="line">    server &#x3D; puppetmaster.kisspuppet.com</span><br><span class="line">    certname &#x3D; agent1_cert.kisspuppet.com</span><br><span class="line">    runinterval &#x3D; 10</span><br><span class="line">    environment &#x3D;kissprd   #添加默认环境为kissprd</span><br></pre></td></tr></table></figure>

<p><strong>10、继续测试</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@agent1 ~]# puppet agent -t</span><br><span class="line">info: Caching catalog for agent1_cert.kisspuppet.com</span><br><span class="line">info: Applying configuration version &#39;1395931962&#39;</span><br><span class="line">notice: &#x2F;Stage[main]&#x2F;Motd&#x2F;File[&#x2F;etc&#x2F;motd]&#x2F;content: </span><br><span class="line">--- &#x2F;etc&#x2F;motd    2014-03-27 22:55:43.000000000 +0800</span><br><span class="line">+++ &#x2F;tmp&#x2F;puppet-file20140327-30010-8ada2g-0    2014-03-27 22:56:19.000000000 +0800</span><br><span class="line">@@ -0,0 +1,3 @@</span><br><span class="line">+--                       --</span><br><span class="line">+--------puppet test---------</span><br><span class="line">+--                       --</span><br><span class="line"></span><br><span class="line">info: FileBucket got a duplicate file &#123;md5&#125;d41d8cd98f00b204e9800998ecf8427e</span><br><span class="line">info: &#x2F;Stage[main]&#x2F;Motd&#x2F;File[&#x2F;etc&#x2F;motd]: Filebucketed &#x2F;etc&#x2F;motd to puppet with sum d41d8cd98f00b204e9800998ecf8427e</span><br><span class="line">notice: &#x2F;Stage[main]&#x2F;Motd&#x2F;File[&#x2F;etc&#x2F;motd]&#x2F;content: content changed &#39;&#123;md5&#125;d41d8cd98f00b204e9800998ecf8427e&#39; to &#39;&#123;md5&#125;87ea3a1af8650395038472457cc7f2b1&#39;</span><br><span class="line">notice: &#x2F;Stage[main]&#x2F;Puppet::Config&#x2F;File[&#x2F;etc&#x2F;puppet&#x2F;puppet.conf]&#x2F;content: </span><br><span class="line">--- &#x2F;etc&#x2F;puppet&#x2F;puppet.conf    2014-03-27 22:56:14.000000000 +0800</span><br><span class="line">+++ &#x2F;tmp&#x2F;puppet-file20140327-30010-cmjg48-0    2014-03-27 22:56:19.000000000 +0800</span><br><span class="line">@@ -10,4 +10,3 @@</span><br><span class="line">     server &#x3D; puppetmaster.kisspuppet.com</span><br><span class="line">     certname &#x3D; agent1_cert.kisspuppet.com</span><br><span class="line">     runinterval &#x3D; 10</span><br><span class="line">-    environment &#x3D;kissprd</span><br><span class="line"></span><br><span class="line">info: FileBucket got a duplicate file &#123;md5&#125;43df60b1aa2638c5f10aa7e6be892b77</span><br><span class="line">info: &#x2F;Stage[main]&#x2F;Puppet::Config&#x2F;File[&#x2F;etc&#x2F;puppet&#x2F;puppet.conf]: Filebucketed &#x2F;etc&#x2F;puppet&#x2F;puppet.conf to puppet with sum 43df60b1aa2638c5f10aa7e6be892b77</span><br><span class="line">notice: &#x2F;Stage[main]&#x2F;Puppet::Config&#x2F;File[&#x2F;etc&#x2F;puppet&#x2F;puppet.conf]&#x2F;content: content changed &#39;&#123;md5&#125;43df60b1aa2638c5f10aa7e6be892b77&#39; to &#39;&#123;md5&#125;8c67cb8c039bb6436556b91f0c6678c4&#39;</span><br><span class="line">info: &#x2F;Stage[main]&#x2F;Puppet::Config&#x2F;File[&#x2F;etc&#x2F;puppet&#x2F;puppet.conf]: Scheduling refresh of Class[Puppet::Service]</span><br><span class="line">info: Class[Puppet::Service]: Scheduling refresh of Service[puppet]</span><br><span class="line">notice: &#x2F;Service[puppet]&#x2F;ensure: ensure changed &#39;stopped&#39; to &#39;running&#39;</span><br><span class="line">notice: &#x2F;Service[puppet]: Triggered &#39;refresh&#39; from 1 events</span><br><span class="line">notice: Finished catalog run in 0.68 seconds</span><br><span class="line">[root@agent1 ~]# cat &#x2F;etc&#x2F;motd </span><br><span class="line">--                       --</span><br><span class="line">--------puppet test---------</span><br><span class="line">--                       --</span><br></pre></td></tr></table></figure>

<p><strong>备注：</strong> 记得设置puppet模块中的puppet.conf.erb模板，否则会被还原哦。</p>
<h2 id="八、puppet-kick"><a href="#八、puppet-kick" class="headerlink" title="八、puppet kick"></a>八、puppet kick</h2><p><strong>puppet kick使用详解</strong></p>
<p><strong>简介：</strong></p>
<ol>
<li><p>当我们配置完puppet服务器端和客户端后，客户端会默认半个小时跟服务器端同步，如果我们需要更新重要文件，是不是得立即生效呢，那有什么好的办法吗？答案：有！  </p>
</li>
<li><p>在服务器端使用puppetrun这个命令可以给客户端发送一段信号，告诉客户端立刻跟服务器同步，这样就达到我们的目的了！那怎样配置呢？  </p>
<p>（1）修改客户端上的puppet的配置文件  </p>
<p><code>vi /etc/puppet/puppet.conf  </code></p>
<p>在[agent]后面添加  </p>
<p>listen = true //这个是让puppet监听8139端口。  </p>
<p>（2）修改管户端的puppet的/etc/sysconfig/puppet (可选） </p>
<p><code>vim /etc/sysconfig/puppet </code></p>
<p>PUPPET_SERVER=192-168-0-130.APP.com //改为你对应的puppetmaster的主机名。  </p>
<p>（3）新建namespaceauth.conf这个文件，vi /etc/puppet/namespaceauth.conf添加如下内容：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[puppetrunner]  </span><br><span class="line"></span><br><span class="line">allow *.magedu.com （或者allow master）</span><br></pre></td></tr></table></figure>

<p>（4）还需要修改auth.conf，放开/run api  </p>
<p>   在path /之前添加下内容,加粗部分：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">path &#x2F;run  </span><br><span class="line"></span><br><span class="line">method save  </span><br><span class="line"></span><br><span class="line">allow *  </span><br><span class="line"></span><br><span class="line">path &#x2F;  </span><br><span class="line"></span><br><span class="line">auth any  </span><br></pre></td></tr></table></figure>

<p>然后重启客户端:/etc/init.d/puppet restart  </p>
<p>（5）在服务器端测试一下：执行一下命令  </p>
</li>
<li><p>puppetrun -p 10 –host 192-168-0-131.APP.com 后面也可以加多个客户端主机名！  </p>
</li>
<li><p>而且已经发送了信号给客户端！可以去客户端查看一下效果 tail -fn 100 /var/log/puppet/puppet.log </p>
<p><strong>高版本的puppet没有puppetrun这个命令，可以用如下命令来执行，执行之前跟puppetrun一样需要配置并授权</strong>提示finished表示发送信号完成，相反failed则表示失败。**  </p>
<p><strong>puppet kick -d host 192-168-0-131.APP.com 也可以code 0表示成功。</strong></p>
</li>
</ol>
<p>推送方法，在服务端运行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">puppet kick -p 10 –-host 客户端 </span><br><span class="line">或 </span><br><span class="line">puppetrun -p 10 –-host 客户端</span><br></pre></td></tr></table></figure>

<p>推送命令也可以这样:puppet kick -p 10 客户端1 客户端2</p>
<p>指定所有主机名进行puppet kick -p –all</p>
<p>指定标签时要使用tag参数，且需要在配置资源的时候配置tags参数，代码如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vi init.pp</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> &#123;</span></span><br><span class="line"></span><br><span class="line">file &#123;<span class="string">&#x27;/tmp/$hostname.txt&#x27;</span><span class="symbol">:</span></span><br><span class="line"></span><br><span class="line">  content =&gt; <span class="string">&quot;Testing JSON&quot;</span>，</span><br><span class="line"></span><br><span class="line">  tags =&gt; <span class="string">&quot;tagkick&quot;</span>,</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">puppet kick -p <span class="number">10</span> -t tagkick host1 host2</span><br></pre></td></tr></table></figure>

<h2 id="实战-——-使用master-agent-模型完成完整的redis-主从架构"><a href="#实战-——-使用master-agent-模型完成完整的redis-主从架构" class="headerlink" title="实战 —— 使用master-agent 模型完成完整的redis 主从架构"></a>实战 —— 使用master-agent 模型完成完整的redis 主从架构</h2><h3 id="1）环境准备"><a href="#1）环境准备" class="headerlink" title="1）环境准备"></a>1）环境准备</h3><table>
<thead>
<tr>
<th align="left">机器名称</th>
<th align="left">IP配置</th>
<th align="left">服务角色</th>
</tr>
</thead>
<tbody><tr>
<td align="left">puppet-master</td>
<td align="left">192.168.37.111</td>
<td align="left">puppet的master</td>
</tr>
<tr>
<td align="left">puppet-server1-master-redis</td>
<td align="left">192.168.37.122</td>
<td align="left">puppet的agent，redis 的master</td>
</tr>
<tr>
<td align="left">puppet-server2-slave-redis</td>
<td align="left">192.168.37.133</td>
<td align="left">puppet的agent，redis 的slave</td>
</tr>
</tbody></table>
<h3 id="2）实验前准备"><a href="#2）实验前准备" class="headerlink" title="2）实验前准备"></a>2）实验前准备</h3><p>1）下载包<br>master 端：<code>puppet.noarch</code>，<code>puppet-server.noarch</code><br>agent 端：<code>puppet.noarch</code></p>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212336365-1716942428.png" alt="puppet包查询"></p>
<p>puppet包查询</p>
<p>2）主机名解析<br>　　为了方便我们后期的操作，我们可以通过定义<code>/etc/hosts</code>文件实现主机名的解析。如果机器很多的话，可以使用DNS进行解析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim &#x2F;etc&#x2F;hosts</span><br><span class="line">    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">    ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">    192.168.37.111  master.keer.com</span><br><span class="line">    192.168.37.122  server1.keer.com</span><br><span class="line">    192.168.37.133  server2.keer.com</span><br></pre></td></tr></table></figure>

<p>　　注意，该操作需要在每一台主机上进行。<br>　　修改完成以后，我们可以来测试一下是否已经成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ping server1.keer.com</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212336756-1739440562.png" alt="连通性测试"></p>
<p>连通性测试</p>
<p>3）时间同步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl start chronyd.service</span><br></pre></td></tr></table></figure>

<p>　　三台机器上都开启<code>chronyd.service</code>服务来进行时间同步<br>　　开启过后可以查看一下状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl status chronyd.service</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212336959-958607153.png" alt="时间同步状态"></p>
<p>时间同步状态</p>
<p>　　我们可以使用<code>chronyc sources</code>命令来查看时间源：</p>
<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212337131-673715701.png" alt="查看时间源"></p>
<p>查看时间源</p>
<h3 id="3）开启puppet-的master、agent-服务"><a href="#3）开启puppet-的master、agent-服务" class="headerlink" title="3）开启puppet 的master、agent 服务"></a>3）开启puppet 的master、agent 服务</h3><p>（1）开启服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl start puppetmaster</span><br><span class="line">[root@server1 ~]# systemctl start puppetagent</span><br><span class="line">[root@server2 ~]# systemctl start puppetagent</span><br></pre></td></tr></table></figure>

<p>　　因为server2 是第一次连接，需master 端签署证书</p>
<p>（2）master 签署颁发证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master manifests]# puppet cert list</span><br><span class="line">[root@master ~]# puppet cert sign server2.keer.com</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212337287-158135016.png" alt="master 颁发证书"></p>
<p>master 颁发证书</p>
<h3 id="4）配置站点清单"><a href="#4）配置站点清单" class="headerlink" title="4）配置站点清单"></a>4）配置站点清单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master manifests]# cd &#x2F;etc&#x2F;puppet&#x2F;manifests</span><br><span class="line">[root@master manifests]# vim site.pp    直接调上边完成的模块</span><br><span class="line">node &#39;server1.keer.com&#39; &#123;</span><br><span class="line">    include redis::master</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">node &#39;server2.keer.com&#39; &#123;</span><br><span class="line">    class&#123;&#39;redis::slave&#39;:</span><br><span class="line">        master_ip &#x3D;&gt; &#39;server1.keer.com&#39;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5）检测主从架构"><a href="#5）检测主从架构" class="headerlink" title="5）检测主从架构"></a>5）检测主从架构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server2 ~]# vim &#x2F;etc&#x2F;redis.conf</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212337428-1529511587.png" alt="检测主从架构"></p>
<p>检测主从架构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server2 ~]# redis-cli -a keerya info Replication</span><br></pre></td></tr></table></figure>



<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212337646-1561071344.png" alt="enter description here"></p>
<p>enter description here</p>
<h3 id="6）再添加个模块准备配置进站点清单"><a href="#6）再添加个模块准备配置进站点清单" class="headerlink" title="6）再添加个模块准备配置进站点清单"></a>6）再添加个模块准备配置进站点清单</h3><p>（1） 创建一个 chrony 模块，前准备</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd modules&#x2F;    进入模块工作目录</span><br><span class="line">[root@master modules]# mkdir chrony    创建chrony 的模块</span><br><span class="line">[root@master modules]# mkdir chrony&#x2F;&#123;manifests,files&#125; -pv    创建模块结构</span><br></pre></td></tr></table></figure>

<p>（2）配置chrony 模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master modules]# cd chrony&#x2F;</span><br><span class="line">[root@master chrony]# cp &#x2F;etc&#x2F;chrony.conf files&#x2F;</span><br><span class="line">[root@master puppet]# vim files&#x2F;chrony.conf</span><br><span class="line"># test    #用于测试实验结果</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212337818-474845941.png" alt="enter description here"></p>
<p>添加一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master chrony]# vim manifests&#x2F;init.pp</span><br><span class="line">    class chrony &#123;</span><br><span class="line">            package&#123;&#39;chrony&#39;:</span><br><span class="line">                    ensure &#x3D;&gt; installed</span><br><span class="line">            &#125; -&gt;</span><br><span class="line"></span><br><span class="line">            file&#123;&#39;&#x2F;etc&#x2F;chrony.conf&#39;:</span><br><span class="line">                    ensure  &#x3D;&gt; file,</span><br><span class="line">                    source  &#x3D;&gt; &#39;puppet:&#x2F;&#x2F;&#x2F;modules&#x2F;chrony.conf&#39;,</span><br><span class="line">                    owner   &#x3D;&gt; &#39;root&#39;,</span><br><span class="line">                    group   &#x3D;&gt; &#39;root&#39;,</span><br><span class="line">                    mode    &#x3D;&gt; &#39;0644&#39;</span><br><span class="line">            &#125; ~&gt;</span><br><span class="line"></span><br><span class="line">            service&#123;&#39;chronyd&#39;:</span><br><span class="line">                    ensure  &#x3D;&gt; running,</span><br><span class="line">                    enable  &#x3D;&gt; true,</span><br><span class="line">                    hasrestart &#x3D;&gt; true,</span><br><span class="line">                    hasstatus  &#x3D;&gt; true</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>（3）puppet 添加这个模块，并生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master modules]# cp -rp chrony&#x2F; &#x2F;etc&#x2F;puppet&#x2F;modules&#x2F;</span><br><span class="line">[root@master modules]# puppet module list</span><br></pre></td></tr></table></figure>



<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212337990-11315764.png" alt="查看puppet模块列表"></p>
<p>查看puppet模块列表</p>
<h3 id="7、再配置站点清单"><a href="#7、再配置站点清单" class="headerlink" title="7、再配置站点清单"></a>7、再配置站点清单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd &#x2F;etc&#x2F;puppet&#x2F;manifests&#x2F;</span><br><span class="line">[root@master manifests]# vim site.pp</span><br><span class="line">    node &#39;base&#39; &#123;</span><br><span class="line">        include chrony</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node &#39;server1.keer.com&#39; inherits &#39;base&#39; &#123;</span><br><span class="line">        include redis::master</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node &#39;server2.keer.com&#39; inherits &#39;base&#39; &#123;</span><br><span class="line">        class&#123;&#39;redis::slave&#39;:</span><br><span class="line">            master_ip &#x3D;&gt; &#39;server1.keer.com&#39;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    #node &#x2F;cache[1-7]+\.keer\.com&#x2F; &#123;    #可以用正则匹配多个服务器使用模块</span><br><span class="line">    #       include varnish</span><br><span class="line">    #&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8、测试"><a href="#8、测试" class="headerlink" title="8、测试"></a>8、测试</h3><p>　　我们现在直接去server2机器上，查看我们的配置文件是否已经生效，是否是我们添加过一行的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@server2 ~]# vim &#x2F;etc&#x2F;chrony.conf</span><br></pre></td></tr></table></figure>

<p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171222212338131-2039299297.png" alt="enter description here"></p>
<p>server2上的内容</p>
<p>　　发现我们的实验成功。</p>
<hr>
<p>puppet命令：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.51niux.com/?id=105">http://www.51niux.com/?id=105</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Waylon Yan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://waylon.whatyouneed.site/2022/08/26/Linux-Puppet-02/">https://waylon.whatyouneed.site/2022/08/26/Linux-Puppet-02/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/automation/">automation</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/27/Linux-Puppet-03/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Linux-Puppet-03</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/25/Linux-Puppet/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Linux-Puppet</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/08/27/Linux-Puppet-03/" title="Linux-Puppet-03"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-27</div><div class="title">Linux-Puppet-03</div></div></a></div><div><a href="/2022/08/25/Linux-Puppet/" title="Linux-Puppet"><img class="cover" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-25</div><div class="title">Linux-Puppet</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Waylon Yan</div><div class="author-info__description">tech life sharing</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">249</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">37</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">23</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Waylonwhynot" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:ywl1006@outlook.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">无止境</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B1%BB%E3%80%81%E6%A8%A1%E7%89%88%E8%AF%AD%E8%A8%80%E3%80%81%E6%A8%A1%E5%9D%97"><span class="toc-number">1.</span> <span class="toc-text">类、模版语言、模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81class-%E7%B1%BB"><span class="toc-number">1.1.</span> <span class="toc-text">一、class 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E4%BB%80%E4%B9%88%E6%98%AF%E7%B1%BB%EF%BC%9F"><span class="toc-number">1.1.1.</span> <span class="toc-text">1）什么是类？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E5%B8%A6%E6%9C%89%E5%8F%82%E6%95%B0%E7%9A%84%E7%B1%BB"><span class="toc-number">1.1.2.</span> <span class="toc-text">2）带有参数的类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%89%E7%B1%BB%E7%9A%84%E7%BB%A7%E6%89%BF"><span class="toc-number">1.1.3.</span> <span class="toc-text">3）类的继承</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%96%B0%E5%A2%9E%E5%B1%9E%E6%80%A7"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">1.新增属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%96%B0%E5%A2%9E%E5%8E%9F%E6%9C%89%E5%80%BC"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">2.新增原有值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BF%AE%E6%94%B9%E5%8E%9F%E6%9C%89%E5%80%BC"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">3.修改原有值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%95%B4%E4%BD%93%E8%B0%83%E7%94%A8%E7%88%B6%E7%B1%BB%EF%BC%8C%E5%B9%B6%E9%87%8D%E5%86%99%E9%83%A8%E5%88%86%E5%80%BC"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">4.整体调用父类，并重写部分值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.2.</span> <span class="toc-text">二、模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B1%EF%BC%9Apuppet-%E6%A8%A1%E6%9D%BF%E5%AE%9E%E7%8E%B0%E4%BF%AE%E6%94%B9-redis-%E7%AB%AF%E5%8F%A3%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.1.</span> <span class="toc-text">实例1：puppet 模板实现修改 redis 端口地址</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.</span> <span class="toc-text">三、模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E4%BB%80%E4%B9%88%E6%98%AF%E6%A8%A1%E5%9D%97%EF%BC%9F"><span class="toc-number">1.3.1.</span> <span class="toc-text">1）什么是模块？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E6%A8%A1%E5%9D%97%E7%9A%84%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="toc-number">1.3.2.</span> <span class="toc-text">2）模块的命名规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%EF%BC%9A%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AAredis%E4%B8%BB%E4%BB%8E%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.3.</span> <span class="toc-text">实例：定义一个redis主从模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81master-agent-%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text">四、master&#x2F;agent 模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.4.1.</span> <span class="toc-text">实现步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E5%AE%9E%E7%8E%B0%E5%89%8D%E5%87%86%E5%A4%87"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">1、实现前准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%BC%80%E5%90%AF-master-%E7%AB%AF%E7%9A%84-puppet-%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">2、开启 master 端的 puppet 服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E5%9C%A8-agent-%E7%AB%AF%E5%BC%80%E5%90%AF%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">3、在 agent 端开启服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E9%85%8D%E7%BD%AE%E7%AB%99%E7%82%B9%E6%B8%85%E5%8D%95%EF%BC%8C%E4%B8%94%E6%B5%8B%E8%AF%95agent-%E7%AB%AF%E6%98%AF%E5%90%A6%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">4、配置站点清单，且测试agent 端是否实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86"><span class="toc-number">1.4.1.5.</span> <span class="toc-text">5、节点管理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81puppet%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.5.</span> <span class="toc-text">五、puppet文件服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">操作步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.0.2.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E7%94%A8%E6%B3%95"><span class="toc-number">1.5.0.3.</span> <span class="toc-text">更多用法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E8%AE%A4%E8%AF%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6auth-conf"><span class="toc-number">1.6.</span> <span class="toc-text">六、认证配置文件auth.conf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81puppet-%E5%A4%9A%E7%8E%AF%E5%A2%83%E7%AE%A1%E7%90%86"><span class="toc-number">1.7.</span> <span class="toc-text">七、puppet 多环境管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%85%8D%E7%BD%AEpuppet-conf"><span class="toc-number">1.7.1.</span> <span class="toc-text">1、配置puppet.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%88%9B%E5%BB%BA%E5%A4%9A%E7%8E%AF%E5%A2%83%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">1.7.2.</span> <span class="toc-text">2、创建多环境目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%A7%BB%E5%8A%A8%E9%BB%98%E8%AE%A4%E7%8E%AF%E5%A2%83modules%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E5%88%B0kissprd%E5%AF%B9%E5%BA%94%E7%9A%84%E7%8E%AF%E5%A2%83%E4%B8%AD"><span class="toc-number">1.7.3.</span> <span class="toc-text">3、移动默认环境modules中的配置到kissprd对应的环境中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%A4%8D%E5%88%B6manifests%E6%96%87%E4%BB%B6%E8%87%B3kissprd%E7%8E%AF%E5%A2%83%E4%B8%AD"><span class="toc-number">1.7.4.</span> <span class="toc-text">4、复制manifests文件至kissprd环境中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%88%A0%E9%99%A4%E6%8E%89%E9%BB%98%E8%AE%A4%E7%8E%AF%E5%A2%83manifests%E4%B8%ADsite-pp%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="toc-number">1.7.5.</span> <span class="toc-text">5、删除掉默认环境manifests中site.pp文件内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E5%88%9B%E5%BB%BAfileserverconfig%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.6.</span> <span class="toc-text">6、创建fileserverconfig文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81puppet-kick"><span class="toc-number">1.8.</span> <span class="toc-text">八、puppet kick</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98-%E2%80%94%E2%80%94-%E4%BD%BF%E7%94%A8master-agent-%E6%A8%A1%E5%9E%8B%E5%AE%8C%E6%88%90%E5%AE%8C%E6%95%B4%E7%9A%84redis-%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84"><span class="toc-number">1.9.</span> <span class="toc-text">实战 —— 使用master-agent 模型完成完整的redis 主从架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.9.1.</span> <span class="toc-text">1）环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E5%AE%9E%E9%AA%8C%E5%89%8D%E5%87%86%E5%A4%87"><span class="toc-number">1.9.2.</span> <span class="toc-text">2）实验前准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%89%E5%BC%80%E5%90%AFpuppet-%E7%9A%84master%E3%80%81agent-%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.9.3.</span> <span class="toc-text">3）开启puppet 的master、agent 服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%EF%BC%89%E9%85%8D%E7%BD%AE%E7%AB%99%E7%82%B9%E6%B8%85%E5%8D%95"><span class="toc-number">1.9.4.</span> <span class="toc-text">4）配置站点清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%EF%BC%89%E6%A3%80%E6%B5%8B%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84"><span class="toc-number">1.9.5.</span> <span class="toc-text">5）检测主从架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%EF%BC%89%E5%86%8D%E6%B7%BB%E5%8A%A0%E4%B8%AA%E6%A8%A1%E5%9D%97%E5%87%86%E5%A4%87%E9%85%8D%E7%BD%AE%E8%BF%9B%E7%AB%99%E7%82%B9%E6%B8%85%E5%8D%95"><span class="toc-number">1.9.6.</span> <span class="toc-text">6）再添加个模块准备配置进站点清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E5%86%8D%E9%85%8D%E7%BD%AE%E7%AB%99%E7%82%B9%E6%B8%85%E5%8D%95"><span class="toc-number">1.9.7.</span> <span class="toc-text">7、再配置站点清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.8.</span> <span class="toc-text">8、测试</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/11/28/Kubernetes23-helm%E5%9F%BA%E7%A1%80/" title="Kubernetes23-helm基础"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes23-helm基础"/></a><div class="content"><a class="title" href="/2022/11/28/Kubernetes23-helm%E5%9F%BA%E7%A1%80/" title="Kubernetes23-helm基础">Kubernetes23-helm基础</a><time datetime="2022-11-27T17:14:15.000Z" title="Created 2022-11-28 01:14:15">2022-11-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/23/Service-Mesh02/" title="Service-Mesh02"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Service-Mesh02"/></a><div class="content"><a class="title" href="/2022/11/23/Service-Mesh02/" title="Service-Mesh02">Service-Mesh02</a><time datetime="2022-11-23T15:55:24.000Z" title="Created 2022-11-23 23:55:24">2022-11-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/06/Service-Mesh01/" title="Service-Mesh01"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Service-Mesh01"/></a><div class="content"><a class="title" href="/2022/11/06/Service-Mesh01/" title="Service-Mesh01">Service-Mesh01</a><time datetime="2022-11-06T15:03:07.000Z" title="Created 2022-11-06 23:03:07">2022-11-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/27/Linux-Puppet-03/" title="Linux-Puppet-03"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux-Puppet-03"/></a><div class="content"><a class="title" href="/2022/08/27/Linux-Puppet-03/" title="Linux-Puppet-03">Linux-Puppet-03</a><time datetime="2022-08-27T15:39:57.000Z" title="Created 2022-08-27 23:39:57">2022-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/26/Linux-Puppet-02/" title="Linux-Puppet-02"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux-Puppet-02"/></a><div class="content"><a class="title" href="/2022/08/26/Linux-Puppet-02/" title="Linux-Puppet-02">Linux-Puppet-02</a><time datetime="2022-08-25T16:00:37.000Z" title="Created 2022-08-26 00:00:37">2022-08-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Waylon Yan</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>